<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Planejamento de Eventos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 20px; }
        .nav-voltar { max-width: 1400px; margin: 0 auto 30px auto; text-align: left; }
        .btn-voltar { background-color: #e9ecef; color: #495057; border: 1px solid #dee2e6; padding: 10px 20px; border-radius: 8px; font-weight: bold; font-size: 1em; text-decoration: none; }
        .page-container { max-width: 1400px; margin: auto; }
        .card { background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 30px; }
        h1, h2, h3 { text-align: center; color: #333; margin-top: 0; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; align-items: flex-end; }
        .form-item { display: flex; flex-direction: column; }
        .form-item label { margin-bottom: 8px; font-weight: bold; color: #555; }
        .form-item input, .form-item select, .form-item textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 1em; box-sizing: border-box; }
        .form-actions { grid-column: 1 / -1; display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .btn { padding: 12px 25px; border: none; border-radius: 6px; font-size: 1em; font-weight: bold; cursor: pointer; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        
        #lista-eventos-gerenciamento table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #lista-eventos-gerenciamento th, #lista-eventos-gerenciamento td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        #lista-eventos-gerenciamento th { background-color: #f8f9fa; }
        .btn-tabela { padding: 6px 10px; font-size: 0.9em; margin-right: 5px; }
        .status-cancelado { text-decoration: line-through; color: #999; }
        
        /* Estilos do Cronograma Visual */
        #cronograma-visual { padding: 20px; }
        .semestre { margin-bottom: 50px; }
        .semestre h2 { background-color: #34495e; color: white; padding: 10px; border-radius: 8px; }
        .timeline { display: flex; position: relative; height: 350px; border-top: 4px solid #7f8c8d; border-bottom: 4px solid #7f8c8d; }
        .month { flex: 1; text-align: center; font-weight: bold; color: #34495e; padding-top: 10px; border-left: 1px solid #ddd; position: relative; }
        .month:first-child { border-left: none; }
        .event-node { position: absolute; width: 150px; text-align: center; transform: translateX(-50%); }
        .event-node .line { width: 2px; background-color: #8e44ad; margin: 0 auto; }
        .event-node .diamond { width: 20px; height: 20px; background-color: #8e44ad; transform: rotate(45deg); margin: 0 auto; }
        .event-node .details { margin-top: 10px; font-size: 0.85em; background: #fff; padding: 5px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .event-node.feriado .diamond { background-color: #7f8c8d; }
        .event-node.feriado .line { background-color: #7f8c8d; }
        .event-node.cancelado .details { text-decoration: line-through; background-color: #f1f2f6; color: #a4b0be; }
        .event-node.cancelado .diamond { background-color: #a4b0be; }
        .event-node.cancelado .line { background-color: #a4b0be; }
        .event-node[data-position="top"] { bottom: 50%; margin-bottom: 25px; }
        .event-node[data-position="top"] .line { height: 50px; }
        .event-node[data-position="bottom"] { top: 50%; margin-top: 25px; }
        .event-node[data-position="bottom"] .line { height: 50px; }
        .feriados-lista { padding: 10px; text-align: left; font-size: 0.9em; color: #555; }
    </style>
</head>
<body>
    <nav class="nav-voltar">
        <a href="/dashboard.html" class="btn-voltar">⬅ Voltar para o Dashboard</a>
    </nav>

    <div id="acesso-negado" style="display: none;"><h1>Acesso Negado</h1></div>

    <div id="main-content" class="page-container" style="display: none;">
        <div class="card">
            <h2>Gestão de Eventos</h2>
            <form id="form-evento">
                <div class="form-grid">
                    <div class="form-item" style="grid-column: 1 / -1;"><label for="titulo">Título do Evento</label><input type="text" id="titulo" required></div>
                    <div class="form-item"><label for="dataInicio">Data de Início</label><input type="date" id="dataInicio" required></div>
                    <div class="form-item"><label for="dataFim">Data de Fim (opcional)</label><input type="date" id="dataFim"></div>
                    <div class="form-item"><label for="tipo">Tipo de Evento</label><select id="tipo"><option value="evento">Evento</option><option value="palestra">Palestra</option><option value="feriado">Feriado</option></select></div>
                    <div class="form-item" style="grid-column: 1 / -1;"><label for="detalhes">Detalhes (ex: Palestrante, local, etc.)</label><textarea id="detalhes" rows="2"></textarea></div>
                </div>
                <div class="form-actions">
                    <button type="button" id="btn-cancelar-edicao" class="btn-secondary" style="display: none;">Cancelar Edição</button>
                    <button type="submit" id="btn-salvar" class="btn-primary">Salvar Evento</button>
                </div>
            </form>
        </div>

        <div class="card">
            <h2>Eventos Cadastrados</h2>
            <div id="lista-eventos-gerenciamento"></div>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Cronograma Visual</h2>
                <button id="btn-gerar-pdf" class="btn-secondary">Gerar PDF</button>
            </div>
            <div id="cronograma-visual">
                </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, setDoc, deleteDoc, query, orderBy, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { protegerPagina } from '/auth.js';

        const firebaseConfig = {
        apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU",
        authDomain: "voluntarios-ativos---cepat.firebaseapp.com",
        projectId: "voluntarios-ativos---cepat",
        storageBucket: "voluntarios-ativos---cepat.firebasestorage.app",
        messagingSenderId: "66122858261",
        appId: "1:66122858261:web:7fa21f1805463b5c08331c"
    };
        initializeApp(firebaseConfig);

        protegerPagina(['super-admin', 'diretor', 'tesoureiro', 'conselheiro', 'produtor-evento'])
            .then(user => {
                document.getElementById('main-content').style.display = 'block';
                inicializarPagina(user);
            })
            .catch(error => {
                document.getElementById('acesso-negado').style.display = 'block';
                console.error(error.message);
            });

        function inicializarPagina(user) {
            const db = getFirestore();
            const eventosCollection = collection(db, 'eventos');
            const form = document.getElementById('form-evento');
            const btnCancelarEdicao = document.getElementById('btn-cancelar-edicao');
            let editandoId = null;

            onSnapshot(query(eventosCollection, orderBy("dataInicio", "desc")), (snapshot) => {
                renderizarListaGerenciamento(snapshot.docs);
                renderizarCronograma(snapshot.docs);
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const evento = {
                    titulo: document.getElementById('titulo').value,
                    detalhes: document.getElementById('detalhes').value,
                    dataInicio: Timestamp.fromDate(new Date(document.getElementById('dataInicio').value + 'T12:00:00Z')),
                    dataFim: document.getElementById('dataFim').value ? Timestamp.fromDate(new Date(document.getElementById('dataFim').value + 'T12:00:00Z')) : null,
                    tipo: document.getElementById('tipo').value,
                    status: 'ativo'
                };

                if (editandoId) {
                    await setDoc(doc(db, 'eventos', editandoId), evento);
                    alert('Evento atualizado com sucesso!');
                } else {
                    evento.criadoEm = serverTimestamp();
                    evento.criadoPor = user.displayName || user.email;
                    await addDoc(eventosCollection, evento);
                    alert('Evento salvo com sucesso!');
                }
                form.reset();
                editandoId = null;
                btnCancelarEdicao.style.display = 'none';
            });

            btnCancelarEdicao.addEventListener('click', () => {
                form.reset();
                editandoId = null;
                btnCancelarEdicao.style.display = 'none';
            });

            document.getElementById('lista-eventos-gerenciamento').addEventListener('click', async (e) => {
                const target = e.target;
                const id = target.dataset.id;
                if (!id) return;
                const eventoRef = doc(db, 'eventos', id);

                if (target.classList.contains('btn-edit')) {
                    const docSnap = await getDoc(eventoRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        document.getElementById('titulo').value = data.titulo;
                        document.getElementById('detalhes').value = data.detalhes;
                        document.getElementById('dataInicio').value = data.dataInicio.toDate().toISOString().split('T')[0];
                        document.getElementById('dataFim').value = data.dataFim ? data.dataFim.toDate().toISOString().split('T')[0] : '';
                        document.getElementById('tipo').value = data.tipo;
                        editandoId = id;
                        btnCancelarEdicao.style.display = 'inline-block';
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                } else if (target.classList.contains('btn-cancel')) {
                    if (confirm('Tem certeza que deseja cancelar este evento?')) {
                        await updateDoc(eventoRef, { status: 'cancelado' });
                    }
                }
            });

            document.getElementById('btn-gerar-pdf').addEventListener('click', () => {
                const cronogramaElement = document.getElementById('cronograma-visual');
                alert('Gerando PDF do cronograma...');
                html2canvas(cronogramaElement, { scale: 2 }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('landscape', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const imgWidth = canvas.width;
                    const imgHeight = canvas.height;
                    const ratio = imgWidth / imgHeight;
                    let newWidth = pdfWidth;
                    let newHeight = newWidth / ratio;
                    if (newHeight > pdfHeight) {
                        newHeight = pdfHeight;
                        newWidth = newHeight * ratio;
                    }
                    pdf.addImage(imgData, 'PNG', 0, 0, newWidth, newHeight);
                    pdf.save(`cronograma-eventos.pdf`);
                });
            });

            function renderizarListaGerenciamento(docs) {
                const container = document.getElementById('lista-eventos-gerenciamento');
                if (docs.empty) {
                    container.innerHTML = '<p>Nenhum evento cadastrado.</p>';
                    return;
                }
                const table = document.createElement('table');
                table.innerHTML = `<thead><tr><th>Data</th><th>Evento</th><th>Tipo</th><th>Status</th><th>Ações</th></tr></thead><tbody></tbody>`;
                const tbody = table.querySelector('tbody');
                docs.forEach(doc => {
                    const evento = doc.data();
                    const tr = document.createElement('tr');
                    const hoje = new Date();
                    const eventoPassou = evento.dataInicio.toDate() < hoje;
                    tr.innerHTML = `
                        <td>${evento.dataInicio.toDate().toLocaleDateString('pt-BR')}</td>
                        <td>${evento.titulo}</td>
                        <td>${evento.tipo}</td>
                        <td class="${evento.status === 'cancelado' ? 'status-cancelado' : ''}">${evento.status}</td>
                        <td>
                            <button class="btn-tabela btn-edit" data-id="${doc.id}" ${eventoPassou ? 'disabled title="Não é possível editar eventos passados"' : ''}>Editar</button>
                            <button class="btn-tabela btn-cancel" data-id="${doc.id}" ${evento.status === 'cancelado' || eventoPassou ? 'disabled' : ''}>Cancelar</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                container.innerHTML = '';
                container.appendChild(table);
            }

            function renderizarCronograma(docs) {
                const container = document.getElementById('cronograma-visual');
                container.innerHTML = '';
                const eventos = docs.map(doc => ({...doc.data(), id: doc.id}));
                
                const semestres = { 1: [], 2: [] };
                eventos.forEach(e => {
                    const mes = e.dataInicio.toDate().getMonth();
                    if(mes < 6) semestres[1].push(e);
                    else semestres[2].push(e);
                });

                [1, 2].forEach(s => {
                    if (semestres[s].length > 0) {
                        const semestreDiv = document.createElement('div');
                        semestreDiv.className = 'semestre';
                        semestreDiv.innerHTML = `<h2>${s}º SEMESTRE</h2><div class="timeline" id="timeline-${s}"></div><div class="feriados-lista" id="feriados-${s}"></div>`;
                        container.appendChild(semestreDiv);
                        
                        const timeline = document.getElementById(`timeline-${s}`);
                        const feriadosLista = document.getElementById(`feriados-${s}`);
                        const mesesDoSemestre = s === 1 ? [0,1,2,3,4,5] : [6,7,8,9,10,11];
                        
                        mesesDoSemestre.forEach(mesIndex => {
                            const mesNome = new Date(2000, mesIndex).toLocaleString('pt-BR', { month: 'long' }).toUpperCase();
                            const monthDiv = document.createElement('div');
                            monthDiv.className = 'month';
                            monthDiv.textContent = mesNome;
                            timeline.appendChild(monthDiv);
                        });

                        let feriadosHtml = '<strong>Feriados do período:</strong> ';
                        let feriadosAdicionados = [];

                        semestres[s].sort((a,b) => a.dataInicio.toDate() - b.dataInicio.toDate()).forEach((evento, index) => {
                            if (evento.tipo === 'feriado') {
                                feriadosAdicionados.push(`${evento.dataInicio.toDate().getDate()}/${evento.dataInicio.toDate().getMonth() + 1} - ${evento.titulo}`);
                                return;
                            }

                            const dataEvento = evento.dataInicio.toDate();
                            const mesDoEvento = dataEvento.getMonth();
                            const diaDoEvento = dataEvento.getDate();
                            const diasNoMes = new Date(dataEvento.getFullYear(), mesDoEvento + 1, 0).getDate();
                            
                            const offsetMes = mesesDoSemestre.indexOf(mesDoEvento) * (100 / 6);
                            const offsetDia = (diaDoEvento / diasNoMes) * (100 / 6);
                            const totalOffset = offsetMes + offsetDia;
                            
                            const node = document.createElement('div');
                            node.className = `event-node ${evento.status === 'cancelado' ? 'cancelado' : ''}`;
                            node.style.left = `${totalOffset}%`;
                            node.dataset.position = index % 2 === 0 ? 'top' : 'bottom';
                            
                            let dataTexto = dataEvento.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'});
                            if (evento.dataFim && evento.dataFim.toDate().getDate() !== dataEvento.getDate()) {
                                dataTexto += ` e ${evento.dataFim.toDate().toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'})}`;
                            }

                            node.innerHTML = `
                                <div class="line"></div>
                                <div class="diamond"></div>
                                <div class="details">
                                    <strong>${dataTexto}</strong><br>
                                    ${evento.titulo}
                                </div>
                            `;
                            timeline.appendChild(node);
                        });

                        feriadosLista.innerHTML = feriadosAdicionados.join(' | ');
                    }
                });
            }
        }
    </script>
</body>
</html>