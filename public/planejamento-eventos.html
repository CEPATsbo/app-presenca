<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Planejamento de Eventos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 20px; }
        .nav-voltar { max-width: 1400px; margin: 0 auto 30px auto; text-align: left; }
        .btn-voltar { background-color: #e9ecef; color: #495057; border: 1px solid #dee2e6; padding: 10px 20px; border-radius: 8px; font-weight: bold; font-size: 1em; text-decoration: none; transition: background-color 0.2s; }
        .btn-voltar:hover { background-color: #dee2e6; }
        .page-container { max-width: 1400px; margin: auto; }
        .card { background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 30px; }
        h1, h2, h3 { text-align: center; color: #333; margin-top: 0; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; align-items: flex-end; }
        .form-item { display: flex; flex-direction: column; }
        .form-item label { margin-bottom: 8px; font-weight: bold; color: #555; }
        .form-item input, .form-item select, .form-item textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 1em; box-sizing: border-box; }
        .form-actions { grid-column: 1 / -1; display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .btn { padding: 12px 25px; border: none; border-radius: 6px; font-size: 1em; font-weight: bold; cursor: pointer; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        
        #lista-eventos-gerenciamento table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #lista-eventos-gerenciamento th, #lista-eventos-gerenciamento td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        #lista-eventos-gerenciamento th { background-color: #f8f9fa; }
        .btn-tabela { padding: 6px 10px; font-size: 0.9em; margin-right: 5px; cursor: pointer; border-radius: 4px; border: 1px solid #ccc;}
        .btn-edit { background-color: #1976d2; color: white; border-color: #1976d2;}
        .btn-cancel { background-color: #c62828; color: white; border-color: #c62828;}
        .status-cancelado td { text-decoration: line-through; color: #999; }
        .header-gestao-eventos { display: flex; justify-content: space-between; align-items: center; }
        
        /* --- ESTILOS DA TIMELINE (COPIADO DA TV) --- */
        #cronograma-visual { padding: 40px 0; overflow-x: auto; }
        .semestre { margin-bottom: 60px; }
        .semestre h2 { background-color: #34495e; color: white; padding: 10px; border-radius: 8px; font-size: 1.5em; }
        .timeline { 
            display: grid; 
            position: relative; 
            padding: 150px 0; /* Espaço para nós */
        }
        .timeline-axis { 
            position: absolute; 
            top: 50%; 
            left: 0; 
            right: 0; 
            height: 10px; /* Linha central grossa */
            background-color: #0d47a1; /* Azul escuro */
            border-radius: 5px;
            transform: translateY(-50%); 
            z-index: 1; 
        }
        .month-grid-container { display: contents; }
        .month { 
            text-align: center; 
            font-weight: bold; 
            color: #34495e; 
            position: relative; 
            border-right: 1px dotted #ccc; 
            display: flex; 
            justify-content: center; 
            align-items: center;
        }
        .month:last-child { border-right: none; }
        .month-label { 
            background-color: #f0f2f5; 
            padding: 0 15px; 
            font-size: 1.2em; 
            z-index: 2; 
        }
        
        .event-node { 
            grid-row: 1; 
            position: relative; 
            width: 130px; 
            z-index: 5; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }
        .event-node .details { 
            order: 1; 
            font-size: 0.85em; 
            background: #fff; 
            padding: 8px 10px; /* Ajustado */
            border-radius: 8px; /* Ajustado */
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Ajustado */
            line-height: 1.4; 
            text-align: center;
            border: 1px solid #ddd;
            min-width: 120px;
        }
        /* NOVO NÓ CIRCULAR */
        .event-node .node-circle {
            order: 2;
            width: 20px; /* Tamanho do nó no admin */
            height: 20px;
            background-color: #0d47a1; /* Cor do nó */
            border: 3px solid #f0f2f5; /* Espaço interno (usa cor de fundo) */
            border-radius: 50%;
            box-shadow: 0 0 0 3px #0d47a1; /* Anel externo */
            z-index: 5;
            margin: 5px auto;
        }
        .event-node .line { 
            order: 3; 
            width: 3px; /* Linha de conexão */
            background-color: #0d47a1; 
        }
        .event-node .details strong { display: block; font-size: 1.1em; }
        
        .event-node[data-position="top"] { align-self: end; padding-bottom: 10px; }
        .event-node[data-position="bottom"] { align-self: start; padding-top: 10px; flex-direction: column-reverse; }

        .event-node.cancelado { opacity: 0.6; }
        .event-node.cancelado .details { text-decoration: line-through; background-color: #e9ecef; }
        .event-node.cancelado .node-circle { 
            background-color: #777; 
            box-shadow: 0 0 0 3px #777; 
        }
        .event-node.cancelado .line { 
            background-color: #777; 
        }
        
        .tooltip-text { visibility: hidden; width: 180px; background-color: #333; color: #fff; text-align: center; border-radius: 6px; padding: 8px; position: absolute; z-index: 100; bottom: 125%; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .event-node:hover .tooltip-text { visibility: visible; opacity: 1; }

        .feriados-lista { margin-top: 20px; padding-top: 15px; text-align: center; font-size: 0.9em; color: #555; border-top: 1px dashed #ccc; }
        
        /* --- ESTILOS DO NOVO MODAL DE FERIADOS --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none; /* Começa oculto */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
        }
        .modal-content h3 {
            margin-top: 0;
            color: #34495e;
        }
        #lista-feriados-importar {
            max-height: 40vh;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            background: #f9f9f9;
        }
        #lista-feriados-importar label {
            display: block;
            margin-bottom: 12px;
            font-size: 1.1em;
            cursor: pointer;
        }
        #lista-feriados-importar input {
            margin-right: 12px;
            width: 18px;
            height: 18px;
            vertical-align: middle;
        }
        .modal-actions {
            margin-top: 25px;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }
        /* --- FIM DOS ESTILOS DO MODAL --- */
    </style>
</head>
<body>
    <nav class="nav-voltar">
        <a href="/dashboard.html" class="btn-voltar">⬅ Voltar para o Dashboard</a>
    </nav>
    <div id="acesso-negado" style="display: none;"><h1>Acesso Negado</h1></div>
    <div id="main-content" class="page-container" style="display: none;">
        <div class="card">
            <h2>Gestão de Eventos</h2>
            <form id="form-evento">
                <div class="form-grid">
                    <div class="form-item" style="grid-column: 1 / -1;"><label for="titulo">Título do Evento</label><input type="text" id="titulo" required></div>
                    <div class="form-item"><label for="dataInicio">Data de Início</label><input type="date" id="dataInicio" required></div>
                    <div class="form-item"><label for="dataFim">Data de Fim (opcional)</label><input type="date" id="dataFim"></div>
                    <div class="form-item"><label for="tipo">Tipo</label><select id="tipo"><option value="evento">Evento</option><option value="palestra">Palestra</option><option value="feriado">Feriado</option></select></div>
                    <div class="form-item" style="grid-column: 1 / -1;"><label for="detalhes">Detalhes (ex: Palestrante, local, etc.)</label><textarea id="detalhes" rows="2"></textarea></div>
                </div>
                <div class="form-actions">
                    <button type="button" id="btn-cancelar-edicao" class="btn-secondary" style="display: none;">Cancelar Edição</button>
                    <button type="submit" id="btn-salvar" class="btn-primary">Salvar Evento</button>
                </div>
            </form>
        </div>
        <div class="card">
            <div class="header-gestao-eventos">
                <h2>Eventos Cadastrados</h2>
                <button id="btn-carregar-feriados" class="btn-success">Importar Feriados Nacionais</button>
            </div>
            <div id="lista-eventos-gerenciamento"></div>
        </div>
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Cronograma Visual</h2>
                <button id="btn-gerar-pdf" class="btn-secondary">Gerar PDF</button>
            </div>
            <div id="cronograma-visual"></div>
        </div>
    </div>

    <div id="modal-feriados" class="modal-overlay">
        <div class="modal-content">
            <h3>Importar Feriados Nacionais</h3>
            <p id="modal-feriados-status">Buscando feriados... (Isso pode levar um momento)</p>
            <div id="lista-feriados-importar">
                </div>
            <div class="modal-actions">
                <button id="btn-modal-cancelar" class="btn-secondary">Cancelar</button>
                <button id="btn-modal-importar" class="btn-primary" disabled>Importar Selecionados</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, setDoc, query, orderBy, serverTimestamp, Timestamp, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { protegerPagina } from '/auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU",
            authDomain: "voluntarios-ativos---cepat.firebaseapp.com",
            projectId: "voluntarios-ativos---cepat",
            storageBucket: "voluntarios-ativos---cepat.firebasestorage.app",
            messagingSenderId: "66122858261",
            appId: "1:66122858261:web:7fa21f1805463b5c08331c"
        };
        initializeApp(firebaseConfig);

        protegerPagina(['super-admin', 'diretor', 'tesoureiro', 'conselheiro', 'produtor-evento'])
            .then(user => {
                document.getElementById('main-content').style.display = 'block';
                inicializarPagina(user);
            })
            .catch(error => {
                document.getElementById('acesso-negado').style.display = 'block';
                console.error(error.message);
            });

        function inicializarPagina(user) {
            const db = getFirestore();
            const eventosCollection = collection(db, 'eventos');
            const logAuditoriaCollection = collection(db, 'log_auditoria'); 
            const form = document.getElementById('form-evento');
            const btnCancelarEdicao = document.getElementById('btn-cancelar-edicao');
            let editandoId = null;
            let eventosAtuais = []; // Cache local dos eventos

            async function registrarLog(acao, detalhes) {
                if (!user) return;
                try {
                    await addDoc(logAuditoriaCollection, {
                        acao: acao,
                        autor: { uid: user.uid, nome: user.displayName || user.email },
                        timestamp: serverTimestamp(),
                        detalhes: detalhes
                    });
                } catch (error) {
                    console.error("Erro ao registrar log:", error);
                }
            }

            onSnapshot(query(eventosCollection, orderBy("dataInicio", "asc")), (snapshot) => {
                eventosAtuais = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); // Atualiza o cache
                renderizarListaGerenciamento(eventosAtuais);
                renderizarCronograma(eventosAtuais);
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // Correção de Fuso Horário (UTC 12:00)
                const dataInicioInput = document.getElementById('dataInicio').value;
                const dataFimInput = document.getElementById('dataFim').value;

                const evento = {
                    titulo: document.getElementById('titulo').value,
                    detalhes: document.getElementById('detalhes').value,
                    // Salva a data como se fosse meio-dia UTC para evitar problemas de fuso
                    dataInicio: Timestamp.fromDate(new Date(dataInicioInput + 'T12:00:00Z')),
                    dataFim: dataFimInput ? Timestamp.fromDate(new Date(dataFimInput + 'T12:00:00Z')) : null,
                    tipo: document.getElementById('tipo').value,
                    status: 'ativo'
                };

                if (editandoId) {
                    const docRef = doc(db, 'eventos', editandoId);
                    const docSnap = await getDoc(docRef);
                    const dadosAntigos = docSnap.data();

                    await setDoc(docRef, evento, { merge: true });
                    await registrarLog("EDITOU_EVENTO", { eventoId: editandoId, dadosAntigos, dadosNovos: evento });
                    alert('Evento atualizado com sucesso!');
                } else {
                    evento.criadoEm = serverTimestamp();
                    evento.criadoPor = user.displayName || user.email;
                    const docRef = await addDoc(eventosCollection, evento);
                    await registrarLog("CRIOU_EVENTO", { eventoId: docRef.id, ...evento });
                    alert('Evento salvo com sucesso!');
                }
                form.reset();
                editandoId = null;
                btnCancelarEdicao.style.display = 'none';
            });

            btnCancelarEdicao.addEventListener('click', () => {
                form.reset();
                editandoId = null;
                btnCancelarEdicao.style.display = 'none';
            });

            document.getElementById('lista-eventos-gerenciamento').addEventListener('click', async (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const id = target.dataset.id;
                if (!id) return;
                const eventoRef = doc(db, 'eventos', id);

                if (target.classList.contains('btn-edit')) {
                    const docSnap = await getDoc(eventoRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        document.getElementById('titulo').value = data.titulo;
                        document.getElementById('detalhes').value = data.detalhes || '';
                        // Converte Timestamp do UTC 12:00 de volta para YYYY-MM-DD
                        document.getElementById('dataInicio').value = data.dataInicio.toDate().toISOString().split('T')[0];
                        document.getElementById('dataFim').value = data.dataFim ? data.dataFim.toDate().toISOString().split('T')[0] : '';
                        document.getElementById('tipo').value = data.tipo;
                        editandoId = id;
                        btnCancelarEdicao.style.display = 'inline-block';
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                } else if (target.classList.contains('btn-cancel')) {
                    if (confirm('Tem certeza que deseja cancelar este evento?')) {
                        const docSnap = await getDoc(eventoRef);
                        const dadosAntigos = docSnap.data();
                        await updateDoc(eventoRef, { status: 'cancelado' });
                        await registrarLog("CANCELOU_EVENTO", { eventoId: id, titulo: dadosAntigos.titulo });
                    }
                }
            });

            document.getElementById('btn-gerar-pdf').addEventListener('click', () => {
                const cronogramaElement = document.getElementById('cronograma-visual');
                alert('Gerando PDF do cronograma...');
                html2canvas(cronogramaElement, { scale: 2, backgroundColor: '#f0f2f5' }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('landscape', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const imgWidth = canvas.width;
                    const imgHeight = canvas.height;
                    const ratio = imgWidth / imgHeight;
                    let newWidth = pdfWidth;
                    let newHeight = newWidth / ratio;
                    if (newHeight > pdfHeight) {
                        newHeight = pdfHeight;
                        newWidth = newHeight * ratio;
                    }
                    const xOffset = (pdfWidth - newWidth) / 2;
                    const yOffset = (pdfHeight - newHeight) / 2;
                    pdf.addImage(imgData, 'PNG', xOffset, yOffset, newWidth, newHeight);
                    pdf.save(`cronograma-eventos-${new Date().getFullYear()}.pdf`);
                });
            });

            function renderizarListaGerenciamento(eventos) {
                const container = document.getElementById('lista-eventos-gerenciamento');
                if (!eventos || eventos.length === 0) {
                    container.innerHTML = '<p>Nenhum evento cadastrado.</p>';
                    return;
                }
                const table = document.createElement('table');
                table.innerHTML = `<thead><tr><th>Data</th><th>Evento</th><th>Tipo</th><th>Status</th><th>Ações</th></tr></thead><tbody></tbody>`;
                const tbody = table.querySelector('tbody');
                
                // Exibe em ordem reversa (mais novos primeiro)
                [...eventos].reverse().forEach(evento => {
                    const tr = document.createElement('tr');
                    tr.className = evento.status === 'cancelado' ? 'status-cancelado' : '';
                    
                    const hoje = new Date();
                    hoje.setUTCHours(0,0,0,0); // Comparação em UTC
                    const dataEvento = evento.dataInicio.toDate();
                    
                    const eventoPassou = dataEvento < hoje;
                    
                    tr.innerHTML = `
                        <td>${dataEvento.toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</td>
                        <td>${evento.titulo}</td>
                        <td>${evento.tipo}</td>
                        <td>${evento.status}</td>
                        <td>
                            <button class="btn-tabela btn-edit" data-id="${evento.id}" ${eventoPassou ? 'disabled title="Não é possível editar eventos passados"' : ''}>Editar</button>
                            <button class="btn-tabela btn-cancel" data-id="${evento.id}" ${evento.status === 'cancelado' || eventoPassou ? 'disabled' : ''}>Cancelar</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                container.innerHTML = '';
                container.appendChild(table);
            }

            // ### FUNÇÃO renderizarCronograma ATUALIZADA (ESTÉTICA) ###
            function renderizarCronograma(eventos) {
                const container = document.getElementById('cronograma-visual');
                container.innerHTML = '';
                
                const anoAtual = new Date().getFullYear();
                const semestres = {
                    1: { de: new Date(anoAtual, 0, 1), ate: new Date(anoAtual, 5, 30), eventos: [] },
                    2: { de: new Date(anoAtual, 6, 1), ate: new Date(anoAtual, 11, 31), eventos: [] }
                };

                eventos.forEach(e => {
                    const dataEvento = e.dataInicio.toDate();
                    if(dataEvento.getFullYear() !== anoAtual) return;
                    const mes = dataEvento.getUTCMonth(); // 0-11
                    if(mes < 6) semestres[1].eventos.push(e);
                    else semestres[2].eventos.push(e);
                });

                for (const s in semestres) {
                    const semestre = semestres[s];
                    const semestreDiv = document.createElement('div');
                    semestreDiv.className = 'semestre';
                    semestreDiv.innerHTML = `<h2>${s}º SEMESTRE</h2><div class="timeline" id="timeline-${s}"><div class="month-grid-container"></div><div class="timeline-axis"></div></div><div class="feriados-lista" id="feriados-${s}"></div>`;
                    container.appendChild(semestreDiv);
                    
                    const timeline = document.getElementById(`timeline-${s}`);
                    const monthGridContainer = timeline.querySelector('.month-grid-container');
                    const feriadosLista = document.getElementById(`feriados-${s}`);
                    
                    const totalDiasSemestre = Math.round((semestre.ate - semestre.de) / (1000 * 60 * 60 * 24)) + 1;
                    timeline.style.gridTemplateColumns = `repeat(${totalDiasSemestre}, 1fr)`;

                    let diaCount = 1;
                    for(let mesIndex = semestre.de.getMonth(); mesIndex <= semestre.ate.getMonth(); mesIndex++) {
                        const mesNome = new Date(anoAtual, mesIndex).toLocaleString('pt-BR', { month: 'long' }).toUpperCase();
                        const diasNoMes = new Date(anoAtual, mesIndex + 1, 0).getDate();
                        const monthDiv = document.createElement('div');
                        monthDiv.className = 'month';
                        monthDiv.style.gridColumn = `${diaCount} / span ${diasNoMes}`;
                        monthDiv.innerHTML = `<span class="month-label">${mesNome}</span>`;
                        monthGridContainer.appendChild(monthDiv);
                        diaCount += diasNoMes;
                    }
                    
                    let feriadosAdicionados = [];
                    const placement = {}; 

                    semestre.eventos.forEach(evento => {
                        const dataEvento = evento.dataInicio.toDate();
                        if (evento.tipo === 'feriado') {
                            feriadosAdicionados.push(`${dataEvento.getUTCDate()}/${dataEvento.getUTCMonth() + 1} - ${evento.titulo}`);
                            return;
                        }
                        
                        const diaNoSemestre = Math.floor((dataEvento - semestre.de) / (1000 * 60 * 60 * 24)) + 1;
                        
                        let nivel = 0;
                        let posicao = 'top'; 
                        while (true) {
                            const chavePosicao = `${posicao}-${nivel}`;
                            const posHorizontal = diaNoSemestre;
                            if (!placement[chavePosicao] || Math.abs(posHorizontal - placement[chavePosicao]) > 10) {
                                placement[chavePosicao] = posHorizontal;
                                break;
                            }
                            posicao = (posicao === 'top') ? 'bottom' : 'top';
                            if (posicao === 'top') nivel++;
                        }
                        
                        const node = document.createElement('div');
                        node.className = `event-node ${evento.status === 'cancelado' ? 'cancelado' : ''}`;
                        node.style.gridColumn = `${diaNoSemestre} / span 1`;
                        node.dataset.position = posicao;
                        
                        const alturaBase = 60; 
                        const alturaLinha = 30 + (nivel * alturaBase);
                        
                        let nodeHTML;
                        // ### MUDANÇA ESTÉTICA AQUI: .diamond -> .node-circle ###
                        if (posicao === 'top') {
                            node.style.paddingBottom = `${alturaLinha}px`;
                            nodeHTML = `<div class="details"></div><div class="node-circle"></div><div class="line" style="height: ${alturaLinha}px;"></div>`;
                        } else {
                            node.style.paddingTop = `${alturaLinha}px`;
                            nodeHTML = `<div class="line" style="height: ${alturaLinha}px;"></div><div class="node-circle"></div><div class="details"></div>`;
                        }
                        node.innerHTML = nodeHTML;

                        let dataTexto = dataEvento.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit', timeZone: 'UTC'});
                        if (evento.dataFim && evento.dataFim.toDate().getTime() !== dataEvento.getTime()) {
                            dataTexto += ` a ${evento.dataFim.toDate().toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit', timeZone: 'UTC'})}`;
                        }
                        
                        const detailsDiv = node.querySelector('.details');
                        detailsDiv.innerHTML = `<strong>${dataTexto}</strong>${evento.titulo}`;
                        
                        const tooltipSpan = document.createElement('span');
                        tooltipSpan.className = 'tooltip-text';
                        tooltipSpan.textContent = evento.detalhes || 'Sem detalhes.';
                        node.appendChild(tooltipSpan);
                        
                        timeline.appendChild(node);
                    });

                    if(feriadosAdicionados.length > 0) {
                        feriadosLista.innerHTML = `<strong>Feriados do período:</strong> ${feriadosAdicionados.sort((a,b) => new Date(a.split(' - ')[0].split('/').reverse().join('-')) - new Date(b.split(' - ')[0].split('/').reverse().join('-'))).join(' | ')}`;
                    } else {
                         feriadosLista.style.display = 'none';
                    }
                }
            }

            // ### INÍCIO DA NOVA LÓGICA DE IMPORTAÇÃO DE FERIADOS ###
            
            const modalFeriados = document.getElementById('modal-feriados');
            const btnCarregarFeriados = document.getElementById('btn-carregar-feriados');
            const btnModalCancelar = document.getElementById('btn-modal-cancelar');
            const btnModalImportar = document.getElementById('btn-modal-importar');
            const listaFeriadosImportar = document.getElementById('lista-feriados-importar');
            const modalFeriadosStatus = document.getElementById('modal-feriados-status');
            
            let feriadosParaImportar = [];

            btnCarregarFeriados.addEventListener('click', async () => {
                modalFeriados.style.display = 'flex';
                modalFeriadosStatus.textContent = 'Buscando feriados... (Isso pode levar um momento)';
                btnModalImportar.disabled = true;
                listaFeriadosImportar.innerHTML = '';
                feriadosParaImportar = [];
                
                try {
                    const anoAtual = new Date().getFullYear();
                    const anoSeguinte = anoAtual + 1;
                    
                    // Busca feriados do ano atual e do próximo
                    const [respAtual, respSeguinte] = await Promise.all([
                        fetch(`https://brasilapi.com.br/api/feriados/v1/${anoAtual}`),
                        fetch(`https://brasilapi.com.br/api/feriados/v1/${anoSeguinte}`)
                    ]);
                    
                    const feriadosApiAtual = await respAtual.json();
                    const feriadosApiSeguinte = await respSeguinte.json();
                    
                    const todosFeriadosApi = [...feriadosApiAtual, ...feriadosApiSeguinte];
                    
                    // Filtra apenas feriados nacionais que ainda não estão no DB
                    const feriadosJaCadastrados = new Set(
                        eventosAtuais
                            .filter(e => e.tipo === 'feriado')
                            .map(e => e.dataInicio.toDate().toISOString().split('T')[0])
                    );

                    feriadosParaImportar = todosFeriadosApi
                        .filter(f => f.type === 'national' && !feriadosJaCadastrados.has(f.date));

                    abrirModalFeriados(feriadosParaImportar);

                } catch (error) {
                    console.error("Erro ao buscar feriados:", error);
                    modalFeriadosStatus.textContent = "Erro ao buscar feriados. Tente novamente.";
                }
            });

            function abrirModalFeriados(feriados) {
                if (feriados.length === 0) {
                    modalFeriadosStatus.textContent = `Nenhum novo feriado nacional encontrado para ${new Date().getFullYear()} ou ${new Date().getFullYear() + 1}.`;
                    return;
                }

                modalFeriadosStatus.textContent = `Selecione os feriados que deseja importar:`;
                btnModalImportar.disabled = false;
                
                feriados.forEach(feriado => {
                    const dataFormatada = new Date(feriado.date + 'T12:00:00Z').toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit', year: 'numeric', timeZone: 'UTC'});
                    const id = `feriado-${feriado.date}`;
                    listaFeriadosImportar.innerHTML += `
                        <div>
                            <label for="${id}">
                                <input type="checkbox" id="${id}" value="${feriado.date}" data-nome="${feriado.name}" checked>
                                <strong>${feriado.name}</strong> (${dataFormatada})
                            </label>
                        </div>
                    `;
                });
            }

            btnModalCancelar.addEventListener('click', () => {
                modalFeriados.style.display = 'none';
            });

            btnModalImportar.addEventListener('click', async () => {
                const checkboxes = listaFeriadosImportar.querySelectorAll('input[type="checkbox"]:checked');
                if (checkboxes.length === 0) {
                    alert("Nenhum feriado selecionado.");
                    return;
                }

                btnModalImportar.disabled = true;
                btnModalImportar.textContent = 'Importando...';
                
                const promessas = [];
                checkboxes.forEach(cb => {
                    const novoFeriado = {
                        titulo: cb.dataset.nome,
                        detalhes: "Feriado Nacional",
                        dataInicio: Timestamp.fromDate(new Date(cb.value + 'T12:00:00Z')), // Salva em UTC
                        dataFim: null,
                        tipo: 'feriado',
                        status: 'ativo',
                        criadoEm: serverTimestamp(),
                        criadoPor: "Importação Automática"
                    };
                    promessas.push(addDoc(eventosCollection, novoFeriado));
                });

                try {
                    await Promise.all(promessas);
                    await registrarLog("IMPORTACAO_FERIADOS", { quantidade: promessas.length });
                    alert(`${promessas.length} feriado(s) importado(s) com sucesso!`);
                    modalFeriados.style.display = 'none';
                } catch (error) {
                    console.error("Erro ao salvar feriados:", error);
                    alert("Ocorreu um erro ao salvar os feriados.");
                    btnModalImportar.disabled = false;
                    btnModalImportar.textContent = 'Importar Selecionados';
                }
            });
            // ### FIM DA NOVA LÓGICA DE IMPORTAÇÃO DE FERIADOS ###
        }
    </script>
</body>
</html>