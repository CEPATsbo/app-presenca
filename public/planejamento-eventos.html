<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Planejamento de Eventos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 20px; }
        .nav-voltar { max-width: 1400px; margin: 0 auto 30px auto; text-align: left; }
        .btn-voltar { background-color: #e9ecef; color: #495057; border: 1px solid #dee2e6; padding: 10px 20px; border-radius: 8px; font-weight: bold; font-size: 1em; text-decoration: none; transition: background-color 0.2s; }
        .btn-voltar:hover { background-color: #dee2e6; }
        .page-container { max-width: 1400px; margin: auto; }
        .card { background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 30px; }
        h1, h2, h3 { text-align: center; color: #333; margin-top: 0; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; align-items: flex-end; }
        .form-item { display: flex; flex-direction: column; }
        .form-item label { margin-bottom: 8px; font-weight: bold; color: #555; }
        .form-item input, .form-item select, .form-item textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 1em; box-sizing: border-box; }
        .form-actions { grid-column: 1 / -1; display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .btn { padding: 12px 25px; border: none; border-radius: 6px; font-size: 1em; font-weight: bold; cursor: pointer; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        
        #lista-eventos-gerenciamento table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #lista-eventos-gerenciamento th, #lista-eventos-gerenciamento td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        #lista-eventos-gerenciamento th { background-color: #f8f9fa; }
        .btn-tabela { padding: 6px 10px; font-size: 0.9em; margin-right: 5px; cursor: pointer; border-radius: 4px; border: 1px solid #ccc;}
        .btn-edit { background-color: #1976d2; color: white; border-color: #1976d2;}
        .btn-cancel { background-color: #c62828; color: white; border-color: #c62828;}
        .status-cancelado td { text-decoration: line-through; color: #999; }
        
        /* Estilos do Cronograma Visual Aprimorado */
        #cronograma-visual { padding: 20px; overflow-x: auto; } /* Permite rolagem se a tela for pequena */
        .semestre { margin-bottom: 50px; }
        .semestre h2 { background-color: #34495e; color: white; padding: 10px; border-radius: 8px; }
        .timeline { display: flex; position: relative; min-height: 350px; align-items: center; border-top: 4px solid #7f8c8d; border-bottom: 4px solid #7f8c8d; }
        .month { flex: 1; text-align: center; font-weight: bold; color: #34495e; position: relative; height: 100%; border-right: 1px dotted #ccc; min-width: 200px; }
        .month:last-child { border-right: none; }
        .month-label { position: absolute; width: 100%; top: calc(50% - 12px); transform: translateY(-50%); font-size: 1.1em; }
        
        .event-node { position: absolute; width: 120px; text-align: center; transform: translateX(-50%); cursor: help; z-index: 10; }
        .event-node .line { width: 2px; margin: 0 auto; background-color: #2E7D32; }
        .event-node .diamond { width: 20px; height: 20px; background-color: #2E7D32; transform: rotate(45deg); margin: 0 auto; border: 2px solid white; }
        .event-node .details { font-size: 0.8em; background: #fff; padding: 5px; border-radius: 4px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); line-height: 1.3; }
        .event-node .details strong { display: block; }
        
        /* Posicionamento e linhas com base no nível */
        .event-node[data-position="top"] { bottom: 50%; }
        .event-node[data-position="top"] .details { margin-bottom: 8px; }
        .event-node[data-position="bottom"] { top: 50%; }
        .event-node[data-position="bottom"] .details { margin-top: 8px; }

        .event-node.cancelado { opacity: 0.6; }
        .event-node.cancelado .details { text-decoration: line-through; }
        .event-node.cancelado .diamond, .event-node.cancelado .line { background-color: #a4b0be; }

        .feriados-lista { margin-top: 20px; padding-top: 15px; text-align: center; font-size: 0.9em; color: #555; border-top: 1px dashed #ccc; }
    </style>
</head>
<body>
    <nav class="nav-voltar">
        <a href="/dashboard.html" class="btn-voltar">⬅ Voltar para o Dashboard</a>
    </nav>
    <div id="acesso-negado" style="display: none;"><h1>Acesso Negado</h1></div>
    <div id="main-content" class="page-container" style="display: none;">
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Cronograma Visual</h2>
                <button id="btn-gerar-pdf" class="btn-secondary">Gerar PDF</button>
            </div>
            <div id="cronograma-visual"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, setDoc, query, orderBy, serverTimestamp, Timestamp, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { protegerPagina } from '/auth.js';

        const firebaseConfig = {
        apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU",
        authDomain: "voluntarios-ativos---cepat.firebaseapp.com",
        projectId: "voluntarios-ativos---cepat",
        storageBucket: "voluntarios-ativos---cepat.firebasestorage.app",
        messagingSenderId: "66122858261",
        appId: "1:66122858261:web:7fa21f1805463b5c08331c"
    };
        initializeApp(firebaseConfig);

        protegerPagina(['super-admin', 'diretor', 'tesoureiro', 'conselheiro', 'produtor-evento'])
            .then(user => {
                document.getElementById('main-content').style.display = 'block';
                inicializarPagina(user);
            })
            .catch(error => {
                document.getElementById('acesso-negado').style.display = 'block';
                console.error(error.message);
            });

        function inicializarPagina(user) {
            const db = getFirestore();
            const eventosCollection = collection(db, 'eventos');
            const form = document.getElementById('form-evento');
            // ... (resto do seu código de inicialização) ...
            
            onSnapshot(query(eventosCollection, orderBy("dataInicio", "asc")), (snapshot) => {
                const eventos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderizarListaGerenciamento(eventos);
                renderizarCronograma(eventos);
            });
            
            // ... (todas as suas outras funções como form.addEventListener, etc., permanecem intactas) ...

            // ===================================================================
            // NOVA LÓGICA DE RENDERIZAÇÃO DO CRONOGRAMA
            // ===================================================================
            function renderizarCronograma(eventos) {
                const container = document.getElementById('cronograma-visual');
                container.innerHTML = '';
                
                const semestres = { 1: [], 2: [] };
                eventos.forEach(e => {
                    const mes = e.dataInicio.toDate().getUTCMonth();
                    if(mes < 6) semestres[1].push(e);
                    else semestres[2].push(e);
                });

                [1, 2].forEach(s => {
                    const eventosSemestre = semestres[s];
                    if (eventosSemestre.length === 0) return;

                    const semestreDiv = document.createElement('div');
                    semestreDiv.className = 'semestre';
                    semestreDiv.innerHTML = `<h2>${s}º SEMESTRE</h2><div class="timeline" id="timeline-${s}"></div><div class="feriados-lista" id="feriados-${s}"></div>`;
                    container.appendChild(semestreDiv);
                    
                    const timeline = document.getElementById(`timeline-${s}`);
                    const feriadosLista = document.getElementById(`feriados-${s}`);
                    const mesesDoSemestre = s === 1 ? [0,1,2,3,4,5] : [6,7,8,9,10,11];
                    
                    mesesDoSemestre.forEach(mesIndex => {
                        const mesNome = new Date(2000, mesIndex).toLocaleString('pt-BR', { month: 'long' }).toUpperCase();
                        const monthDiv = document.createElement('div');
                        monthDiv.className = 'month';
                        monthDiv.innerHTML = `<span class="month-label">${mesNome}</span>`;
                        timeline.appendChild(monthDiv);
                    });

                    let feriadosAdicionados = [];
                    const placement = {}; // Objeto para controlar o posicionamento e evitar sobreposição

                    eventosSemestre.forEach(evento => {
                        if(evento.tipo === 'feriado') {
                            const dataEvento = evento.dataInicio.toDate();
                            feriadosAdicionados.push(`${dataEvento.getUTCDate()}/${dataEvento.getUTCMonth() + 1} - ${evento.titulo}`);
                            return;
                        }

                        const dataEvento = evento.dataInicio.toDate();
                        const diaDoEvento = dataEvento.getUTCDate();
                        const mesDoEvento = dataEvento.getUTCMonth();
                        const diasNoMes = new Date(dataEvento.getUTCFullYear(), mesDoEvento + 1, 0).getDate();
                        
                        const offsetMes = mesesDoSemestre.indexOf(mesDoEvento) * (100 / 6);
                        const offsetDia = (diaDoEvento / diasNoMes) * (100 / 6);
                        const totalOffset = offsetMes + offsetDia;
                        
                        // Lógica de níveis para evitar sobreposição
                        let nivel = 0;
                        let posicao = 'top';
                        let colisao = true;
                        while(colisao) {
                            colisao = false;
                            const chavePosicao = `${posicao}-${nivel}`;
                            if(placement[chavePosicao]) {
                                const ultimaPosicao = placement[chavePosicao];
                                const distancia = totalOffset - ultimaPosicao;
                                if(distancia < 10) { // Se estiver a menos de 10% de distância, há colisão
                                    colisao = true;
                                    if(posicao === 'top') {
                                        posicao = 'bottom';
                                    } else {
                                        posicao = 'top';
                                        nivel++;
                                    }
                                }
                            }
                        }
                        placement[`${posicao}-${nivel}`] = totalOffset;
                        
                        const node = document.createElement('div');
                        node.className = `event-node ${evento.tipo} ${evento.status === 'cancelado' ? 'cancelado' : ''}`;
                        node.style.left = `${totalOffset}%`;
                        
                        const alturaBase = 40; // Altura da caixa de detalhes + margem
                        const alturaLinha = 30 + (nivel * alturaBase);
                        
                        if (posicao === 'top') {
                            node.style.bottom = '50%';
                            node.style.marginBottom = `${12 + (nivel * alturaBase)}px`;
                            node.innerHTML = `<div class="details"><strong>...</strong>...</div><div class="diamond"></div><div class="line" style="height: ${alturaLinha}px;"></div>`;
                        } else {
                            node.style.top = '50%';
                            node.style.marginTop = `${12 + (nivel * alturaBase)}px`;
                            node.innerHTML = `<div class="line" style="height: ${alturaLinha}px;"></div><div class="diamond"></div><div class="details"><strong>...</strong>...</div>`;
                        }

                        let dataTexto = dataEvento.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit', timeZone: 'UTC'});
                        if (evento.dataFim && evento.dataFim.toDate().getUTCDate() !== dataEvento.getUTCDate()) {
                            dataTexto += ` e ${evento.dataFim.toDate().toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit', timeZone: 'UTC'})}`;
                        }
                        
                        const detailsDiv = node.querySelector('.details');
                        detailsDiv.innerHTML = `<strong>${dataTexto}</strong>${evento.titulo}`;
                        node.title = `${evento.titulo}${evento.detalhes ? ': ' + evento.detalhes : ''}`;
                        
                        timeline.appendChild(node);
                    });

                    if(feriadosAdicionados.length > 0) {
                        feriadosLista.innerHTML = `<strong>Feriados do período:</strong> ${feriadosAdicionados.join(' | ')}`;
                    }
                });
            }
        }
    </script>
</body>
</html>