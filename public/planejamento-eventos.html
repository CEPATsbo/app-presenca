<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Planejamento de Eventos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 20px; }
        .nav-voltar { max-width: 1400px; margin: 0 auto 30px auto; text-align: left; }
        .btn-voltar { background-color: #e9ecef; color: #495057; border: 1px solid #dee2e6; padding: 10px 20px; border-radius: 8px; font-weight: bold; font-size: 1em; text-decoration: none; }
        .page-container { max-width: 1400px; margin: auto; }
        .card { background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 30px; }
        h1, h2 { text-align: center; color: #333; margin-top: 0; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; align-items: flex-end; }
        .form-item { display: flex; flex-direction: column; }
        .form-item label { margin-bottom: 8px; font-weight: bold; color: #555; }
        .form-item input, .form-item select, .form-item textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 1em; }
        .form-actions { grid-column: 1 / -1; display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .btn { padding: 12px 25px; border: none; border-radius: 6px; font-size: 1em; font-weight: bold; cursor: pointer; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        
        #lista-eventos-gerenciamento table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #lista-eventos-gerenciamento th, #lista-eventos-gerenciamento td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        .status-cancelado { text-decoration: line-through; color: #999; }

        /* --- NOVO LAYOUT DO CRONOGRAMA EM CAIXAS --- */
        .semestre-container { margin-bottom: 50px; background: #fff; padding: 20px; border-radius: 15px; }
        .semestre-header { background-color: #34495e; color: white; padding: 15px; border-radius: 8px; font-size: 1.6em; text-align: center; margin-bottom: 20px; }
        
        .grid-meses { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); /* 3 meses por linha */
            gap: 20px; 
        }
        .caixa-mes { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            border-radius: 10px; 
            padding: 15px; 
            min-height: 200px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .caixa-mes h3 { 
            margin-top: 0; 
            padding-bottom: 10px; 
            border-bottom: 2px solid #0d47a1; 
            color: #0d47a1; 
            text-align: left; 
            font-size: 1.2em;
        }
        .lista-eventos-mes { list-style: none; padding: 0; margin: 0; }
        .item-evento-mes { 
            padding: 8px 0; 
            border-bottom: 1px solid #eee; 
            font-size: 0.9em; 
        }
        .item-evento-mes:last-child { border-bottom: none; }
        .item-evento-mes strong { color: #2c3e50; font-size: 0.95em; }
        .item-evento-mes span { display: block; color: #666; font-size: 0.85em; }
        .ev-feriado { color: #c62828 !important; font-weight: bold; }
        .ev-cancelado { text-decoration: line-through; opacity: 0.6; }
    </style>
</head>
<body>
    <nav class="nav-voltar"><a href="/dashboard.html" class="btn-voltar">⬅ Voltar</a></nav>
    <div id="main-content" class="page-container" style="display: none;">
        <div class="card">
            <h2>Gestão de Eventos</h2>
            <form id="form-evento">
                <div class="form-grid">
                    <div class="form-item" style="grid-column: 1 / -1;"><label>Título</label><input type="text" id="titulo" required></div>
                    <div class="form-item"><label>Início</label><input type="date" id="dataInicio" required></div>
                    <div class="form-item"><label>Fim (Opcional)</label><input type="date" id="dataFim"></div>
                    <div class="form-item"><label>Tipo</label><select id="tipo"><option value="evento">Evento</option><option value="palestra">Palestra</option><option value="feriado">Feriado</option></select></div>
                    <div class="form-item" style="grid-column: 1 / -1;"><label>Detalhes</label><textarea id="detalhes" rows="2"></textarea></div>
                </div>
                <div class="form-actions">
                    <button type="button" id="btn-cancelar-edicao" class="btn" style="display: none;">Cancelar</button>
                    <button type="submit" id="btn-salvar" class="btn btn-primary">Salvar Evento</button>
                </div>
            </form>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Eventos Cadastrados</h2>
                <button id="btn-carregar-feriados" class="btn btn-success">Importar Feriados</button>
            </div>
            <div id="lista-eventos-gerenciamento"></div>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Cronograma Visual 2026</h2>
                <button id="btn-gerar-pdf" class="btn">Gerar PDF</button>
            </div>
            <div id="cronograma-visual"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, setDoc, query, orderBy, serverTimestamp, Timestamp, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-functions.js";
        import { protegerPagina } from '/auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU",
            authDomain: "voluntarios-ativos---cepat.firebaseapp.com",
            projectId: "voluntarios-ativos---cepat",
            storageBucket: "voluntarios-ativos---cepat.firebasestorage.app",
            messagingSenderId: "66122858261",
            appId: "1:66122858261:web:7fa21f1805463b5c08331c"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        protegerPagina(['super-admin', 'diretor', 'tesoureiro', 'conselheiro', 'produtor-evento'])
            .then(user => {
                document.getElementById('main-content').style.display = 'block';
                inicializarPagina(user);
            });

        function inicializarPagina(user) {
            const functions = getFunctions(app, 'southamerica-east1');
            const importarFeriadosNacionais = httpsCallable(functions, 'importarFeriadosNacionais');
            const eventosColl = collection(db, 'eventos');
            const logColl = collection(db, 'log_auditoria');
            const form = document.getElementById('form-evento');
            let editandoId = null;

            async function registrarLog(acao, detalhes) {
                await addDoc(logColl, { acao, autor: { uid: user.uid, nome: user.displayName || user.email }, timestamp: serverTimestamp(), detalhes });
            }

            onSnapshot(query(eventosColl, orderBy("dataInicio", "asc")), (snapshot) => {
                const eventos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderizarListaGerenciamento(eventos);
                renderizarCronograma(eventos);
            });

            form.onsubmit = async (e) => {
                e.preventDefault();
                const dI = document.getElementById('dataInicio').value;
                const dF = document.getElementById('dataFim').value;
                const ev = {
                    titulo: document.getElementById('titulo').value,
                    detalhes: document.getElementById('detalhes').value,
                    dataInicio: Timestamp.fromDate(new Date(dI + 'T12:00:00Z')),
                    dataFim: dF ? Timestamp.fromDate(new Date(dF + 'T12:00:00Z')) : null,
                    tipo: document.getElementById('tipo').value,
                    status: 'ativo'
                };
                if (editandoId) {
                    await setDoc(doc(db, 'eventos', editandoId), ev, { merge: true });
                    await registrarLog("EDITOU_EVENTO", { titulo: ev.titulo });
                } else {
                    ev.criadoEm = serverTimestamp();
                    await addDoc(eventosColl, ev);
                    await registrarLog("CRIOU_EVENTO", { titulo: ev.titulo });
                }
                form.reset(); editandoId = null;
            };

            function renderizarListaGerenciamento(evs) {
                const container = document.getElementById('lista-eventos-gerenciamento');
                let html = `<table><thead><tr><th>Data</th><th>Título</th><th>Ações</th></tr></thead><tbody>`;
                evs.slice().reverse().forEach(ev => {
                    const data = ev.dataInicio.toDate().toLocaleDateString('pt-BR', {timeZone:'UTC'});
                    html += `<tr class="${ev.status === 'cancelado'?'status-cancelado':''}">
                        <td>${data}</td><td>${ev.titulo}</td>
                        <td><button class="btn-edit" onclick="window.editarEvento('${ev.id}')">Editar</button></td></tr>`;
                });
                container.innerHTML = html + `</tbody></table>`;
            }

            window.editarEvento = async (id) => {
                const docSnap = await getDoc(doc(db, 'eventos', id));
                const data = docSnap.data();
                document.getElementById('titulo').value = data.titulo;
                document.getElementById('dataInicio').value = data.dataInicio.toDate().toISOString().split('T')[0];
                editandoId = id;
                window.scrollTo(0,0);
            };

            function renderizarCronograma(eventos) {
                const container = document.getElementById('cronograma-visual');
                container.innerHTML = '';
                const ano = 2026;
                const mesesNomes = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

                const semestres = [
                    { nome: "1º SEMESTRE", meses: [0, 1, 2, 3, 4, 5] },
                    { nome: "2º SEMESTRE", meses: [6, 7, 8, 9, 10, 11] }
                ];

                semestres.forEach(sem => {
                    const sDiv = document.createElement('div');
                    sDiv.className = 'semestre-container';
                    sDiv.innerHTML = `<div class="semestre-header">${sem.nome} ${ano}</div><div class="grid-meses" id="grid-${sem.nome}"></div>`;
                    container.appendChild(sDiv);

                    const grid = sDiv.querySelector('.grid-meses');
                    sem.meses.forEach(mIdx => {
                        const caixa = document.createElement('div');
                        caixa.className = 'caixa-mes';
                        caixa.innerHTML = `<h3>${mesesNomes[mIdx]}</h3><ul class="lista-eventos-mes"></ul>`;
                        
                        const lista = caixa.querySelector('ul');
                        const evsDoMes = eventos.filter(ev => {
                            const d = ev.dataInicio.toDate();
                            return d.getFullYear() === ano && d.getUTCMonth() === mIdx;
                        });

                        if (evsDoMes.length === 0) {
                            lista.innerHTML = `<li style="color:#999; font-style:italic">Nenhum evento.</li>`;
                        } else {
                            evsDoMes.forEach(ev => {
                                const d = ev.dataInicio.toDate();
                                const item = document.createElement('li');
                                item.className = `item-evento-mes ${ev.status === 'cancelado'?'ev-cancelado':''}`;
                                const feriadoClasse = ev.tipo === 'feriado' ? 'ev-feriado' : '';
                                item.innerHTML = `<strong class="${feriadoClasse}">${d.getUTCDate().toString().padStart(2,'0')}/${(mIdx+1).toString().padStart(2,'0')} - ${ev.titulo}</strong>
                                                  <span>${ev.detalhes || ''}</span>`;
                                lista.appendChild(item);
                            });
                        }
                        grid.appendChild(caixa);
                    });
                });
            }

            document.getElementById('btn-carregar-feriados').onclick = async () => {
                if(confirm("Importar feriados?")) {
                    const res = await importarFeriadosNacionais();
                    alert(res.data.message);
                }
            };

            document.getElementById('btn-gerar-pdf').onclick = () => {
                html2canvas(document.getElementById('cronograma-visual')).then(canvas => {
                    const img = canvas.toDataURL('image/png');
                    const pdf = new jspdf.jsPDF('l', 'mm', 'a4');
                    pdf.addImage(img, 'PNG', 10, 10, 280, 150);
                    pdf.save('cronograma.pdf');
                });
            };
        }
    </script>
</body>
</html>