<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cáritas - Painel de Gestão Social</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f4f6f9; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .header { width: 100%; max-width: 1100px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 1px solid #e0e0e0; }
        .btn-voltar { background-color: #7f8c8d; color: white; padding: 10px 18px; border-radius: 8px; text-decoration: none; font-weight: bold; font-size: 0.9em; display: flex; align-items: center; gap: 8px; }
        .welcome-section { width: 100%; max-width: 1100px; text-align: center; margin-bottom: 40px; }
        .welcome-section h1 { color: #2c3e50; margin: 0; font-size: 2.2em; }
        .welcome-section p { color: #7f8c8d; margin-top: 10px; font-size: 1.1em; }

        /* Grid de Estatísticas */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; width: 100%; max-width: 1100px; margin-bottom: 40px; }
        .stat-box { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); text-align: center; border-bottom: 5px solid #e67e22; }
        .stat-box span { color: #95a5a6; font-size: 0.85em; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        .stat-box h2 { margin: 10px 0 0 0; color: #2c3e50; font-size: 2em; }

        /* Grid de Menu */
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 25px; width: 100%; max-width: 1100px; }
        .menu-item { background-color: white; padding: 35px 25px; border-radius: 15px; text-align: center; text-decoration: none; color: #2c3e50; transition: all 0.3s ease; border: 1px solid #eee; display: flex; flex-direction: column; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .menu-item:hover { transform: translateY(-8px); box-shadow: 0 12px 30px rgba(0,0,0,0.12); border-color: #e67e22; }
        .menu-item i { font-size: 3.5em; color: #e67e22; margin-bottom: 20px; }
        .menu-item h3 { margin: 0 0 12px 0; font-size: 1.4em; }
        .menu-item p { margin: 0; color: #7f8c8d; font-size: 0.95em; line-height: 1.4; }
        .badge-natal { background-color: #c0392b; color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.65em; font-weight: bold; margin-left: 5px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div class="header">
        <a href="/dashboard.html" class="btn-voltar"><i class="fas fa-arrow-left"></i> Painel Geral</a>
        <img src="/logo-cepat.png" alt="Logo CEPAT" style="height: 60px;">
    </div>

    <div class="welcome-section">
        <h1>Módulo Cáritas</h1>
        <p>Gestão da Assistência Social e Acolhimento Fraterno às Famílias</p>
    </div>

    <div class="stats-grid">
        <div class="stat-box">
            <span>Famílias Ativas</span>
            <h2 id="stats-familias">--</h2> </div>
        <div class="stat-box">
            <span>Cestas este Mês</span>
            <h2 id="stats-cestas">0</h2> </div>
        <div class="stat-box">
            <span>Próximo Domingo Social</span>
            <h2 id="stats-data">--/--</h2> </div>
    </div>

    <div class="menu-grid">
        <a href="/assistencia-familias.html" class="menu-item">
            <i class="fas fa-users"></i>
            <h3>Famílias</h3>
            <p>Cadastrar novos núcleos familiares, gerenciar dependentes e endereços.</p>
        </a>
        <a href="/assistencia-cestas.html" class="menu-item">
            <i class="fas fa-shopping-basket"></i>
            <h3>Cestas Básicas</h3>
            <p>Registrar entregas mensais e histórico de benefícios.</p>
        </a>
        <a href="/assistencia-padrinhos.html" class="menu-item">
            <i class="fas fa-gift"></i>
            <h3>Padrinhos <span id="badge-campanha" class="badge-natal">Campanha</span></h3>
            <p>Gerenciar apadrinhamento de crianças para datas especiais.</p>
        </a>
        <a href="/assistencia-etiquetas.html" class="menu-item">
            <i class="fas fa-tags"></i>
            <h3>Etiquetas de Natal</h3>
            <p>Identificação para os presentes (Nome, Roupa, Calçado e Padrinho).</p>
        </a>
        <a href="/assistencia-planner.html" class="menu-item">
            <i class="fas fa-calendar-check"></i>
            <h3>Planner de Escala</h3>
            <p>Escalar voluntários para as atividades sociais.</p>
        </a>
        <a href="/assistencia-consulta-escala.html" class="menu-item">
            <i class="fas fa-clipboard-list"></i>
            <h3>Consultar Escalas</h3>
            <p>Visualizar as equipes escaladas para os próximos trabalhos.</p>
        </a>

        <a href="/assistencia-estoque.html" class="menu-item">
    <i class="fas fa-boxes"></i>
    <h3>Controle de Estoque</h3>
    <p>Gerenciar saldo de cestas prontas e insumos avulsos com alertas de estoque baixo e modo híbrido.</p>
</a>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, query, where, getCountFromServer, Timestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { protegerPagina } from '/auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU",
            authDomain: "voluntarios-ativos---cepat.firebaseapp.com",
            projectId: "voluntarios-ativos---cepat",
            storageBucket: "voluntarios-ativos---cepat.firebasestorage.app",
            messagingSenderId: "66122858261",
            appId: "1:66122858261:web:7fa21f1805463b5c08331c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        protegerPagina(['super-admin', 'diretor', 'tesoureiro', 'caritas', 'conselheiro', 'entrevistador'])
            .then(() => inicializarDashboard())
            .catch(() => window.location.href = '/dashboard.html');

        async function inicializarDashboard() {
            const agora = new Date();
            const inicioMes = new Date(agora.getFullYear(), agora.getMonth(), 1);
            const tsInicio = Timestamp.fromDate(inicioMes);

            try {
                // Contagem de Famílias
                const qFam = query(collection(db, "familiasAssistidas"), where("statusGeral", "==", "Ativa"));
                const snapFam = await getCountFromServer(qFam);
                document.getElementById('stats-familias').textContent = snapFam.data().count;

                // Contagem de Cestas (Usando campo 'data' conforme registros)
                const qCes = query(collection(db, "entregasCestas"), where("data", ">=", tsInicio));
                const snapCes = await getCountFromServer(qCes);
                document.getElementById('stats-cestas').textContent = snapCes.data().count;

                // Próximo Domingo
                document.getElementById('stats-data').textContent = calcularTerceiroDomingo();

                // Mostrar/Ocultar Badge de Natal baseado no mês (Dezembro)
                if(agora.getMonth() === 11) document.getElementById('badge-campanha').style.display = 'inline';

            } catch (e) { console.error("Erro no Dashboard:", e); }
        }

        function calcularTerceiroDomingo() {
            const hoje = new Date();
            let mes = hoje.getMonth(), ano = hoje.getFullYear();
            const obterTerceiro = (m, a) => {
                let d = new Date(a, m, 1), doms = [];
                while (d.getMonth() === m) {
                    if (d.getDay() === 0) doms.push(new Date(d));
                    d.setDate(d.getDate() + 1);
                }
                return doms[2];
            };
            let dataSoc = obterTerceiro(mes, ano);
            if (hoje > dataSoc) { 
                mes++; if(mes > 11){ mes=0; ano++; }
                dataSoc = obterTerceiro(mes, ano);
            }
            return dataSoc.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        }
    </script>
</body>
</html>