<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEPAT - Módulo Cáritas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f4f6f9; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .nav-header { width: 100%; max-width: 1100px; display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; }
        .btn-painel { background-color: #6c757d; color: white; padding: 10px 15px; border-radius: 8px; text-decoration: none; font-weight: bold; font-size: 0.9em; }
        .container { width: 100%; max-width: 1100px; }
        .header-titulo { text-align: center; margin-bottom: 30px; }
        .header-titulo h1 { color: #2c3e50; margin: 0; }
        .header-titulo p { color: #7f8c8d; margin: 5px 0 0 0; }

        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-bottom: 4px solid #e67e22; transition: 0.3s; }
        .stat-card h4 { margin: 0; color: #95a5a6; font-size: 0.75em; text-transform: uppercase; }
        .stat-card p { margin: 8px 0 0 0; font-size: 1.8em; font-weight: bold; color: #2c3e50; }

        .card-prontidao { grid-column: 1 / -1; background: #e8f5e9; border: 2px solid #27ae60; display: flex; justify-content: space-between; align-items: center; padding: 20px 30px; border-radius: 15px; cursor: pointer; border-bottom: none; }
        .card-prontidao:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0,0,0,0.1); }
        .info-prontidao h2 { margin: 0; font-size: 2.2em; color: #1b5e20; }
        .info-prontidao span { color: #2e7d32; font-weight: bold; text-transform: uppercase; font-size: 0.9em; }
        .alerta-gargalo { text-align: right; max-width: 500px; }
        .alerta-gargalo b { color: #c0392b; display: block; font-size: 0.95em; }

        #painel-validade-viva { background: #fff3e0; border: 2px solid #e67e22; border-radius: 12px; padding: 20px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .alerta-titulo { margin: 0 0 10px 0; color: #d35400; display: flex; align-items: center; gap: 10px; font-size: 1.1em; }
        .alerta-subtitulo { font-size: 0.85em; color: #a04000; margin-bottom: 15px; display: block; font-weight: 500; }
        .grid-alertas-vivos { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px; }
        .card-alerta-vivo { background: white; padding: 12px; border-radius: 8px; border-left: 5px solid #e74c3c; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        .menu-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .menu-item { background: white; padding: 20px; border-radius: 12px; text-decoration: none; text-align: center; color: #2c3e50; transition: 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; align-items: center; gap: 12px; border: 1px solid #eee; min-height: 180px; }
        .menu-item:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); border-color: #e67e22; }
        .menu-item i { font-size: 2.2em; color: #e67e22; }
        .menu-item h3 { margin: 0; font-size: 1.1em; }
        .menu-item p { margin: 0; font-size: 0.8em; color: #7f8c8d; line-height: 1.3; }

        @media (max-width: 992px) { .menu-grid { grid-template-columns: repeat(2, 1fr); } .stats-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 600px) { .stats-grid, .menu-grid { grid-template-columns: 1fr; } .card-prontidao { flex-direction: column; text-align: center; gap: 15px; } .alerta-gargalo { text-align: center; } }
    </style>
</head>
<body>
    <header class="nav-header">
        <a href="/dashboard.html" class="btn-painel"><i class="fas fa-arrow-left"></i> Painel Geral</a>
        <img src="/logo-cepat.png" alt="Logo CEPAT" style="height: 50px;">
    </header>

    <main class="container">
        <div class="header-titulo">
            <h1>Módulo Cáritas</h1>
            <p>Gestão da Assistência Social e Acolhimento Fraterno</p>
        </div>

        <section class="stats-grid">
            <div class="stat-card card-prontidao" onclick="window.location='/assistencia-estoque.html'">
                <div class="info-prontidao">
                    <span id="label-status">Status das Cestas Básicas</span>
                    <h2 id="total-cestas-prontas">--</h2>
                </div>
                <div class="alerta-gargalo">
                    <b id="item-limitante">Sincronizando...</b>
                </div>
            </div>

            <div class="stat-card"><h4>Famílias Ativas</h4><p id="total-familias">--</p></div>
            <div class="stat-card"><h4>Cestas Entregues (Mês)</h4><p id="total-entregas">0</p></div>
            <div class="stat-card"><h4>Próximo Domingo</h4><p id="data-domingo">--/--</p></div>
        </section>

        <section id="painel-validade-viva" style="display: none;">
            <h3 class="alerta-titulo"><i class="fas fa-exclamation-triangle fa-beat"></i> ALERTA: VENCIMENTO CRÍTICO</h3>
            <span class="alerta-subtitulo">Itens com validade crítica para a entrega de <b id="data-ref-domingo">--/--</b>:</span>
            <div id="lista-alertas-vivos" class="grid-alertas-vivos"></div>
        </section>

        <section class="menu-grid">
            <a href="/assistencia-familias.html" class="menu-item"><i class="fas fa-users"></i><h3>Famílias</h3><p>Cadastros e prontuários sociais.</p></a>
            <a href="/assistencia-cestas.html" class="menu-item"><i class="fas fa-shopping-basket"></i><h3>Cestas Básicas</h3><p>Registrar entregas mensais.</p></a>
            <a href="/assistencia-montagem.html" class="menu-item"><i class="fas fa-clipboard-check"></i><h3>Linha de Montagem</h3><p>Checklist visual e ordem de validade (FEFO).</p></a>
            <a href="/assistencia-padrinhos.html" class="menu-item"><i class="fas fa-gift"></i><h3>Padrinhos</h3><p>Gestão de apadrinhamento.</p></a>
            <a href="/assistencia-planner.html" class="menu-item"><i class="fas fa-calendar-check"></i><h3>Planner de Escala</h3><p>Escalar voluntários para o Domingo Social.</p></a>
            <a href="/assistencia-estoque.html" class="menu-item"><i class="fas fa-boxes"></i><h3>Controle de Estoque</h3><p>Gestão de saldo e validades.</p></a>
            <a href="/assistencia-relatorios.html" class="menu-item"><i class="fas fa-file-invoice"></i><h3>Relatórios</h3><p>Prestação de contas mensal.</p></a>
            <a href="/estatisticas.html" class="menu-item"><i class="fas fa-chart-line"></i><h3>Estatísticas</h3><p>Indicadores e gráficos sociais.</p></a>
        </section>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, where, Timestamp, doc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { protegerPagina } from '/auth.js';

        const firebaseConfig = { apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU", authDomain: "voluntarios-ativos---cepat.firebaseapp.com", projectId: "voluntarios-ativos---cepat", storageBucket: "voluntarios-ativos---cepat.firebasestorage.app", messagingSenderId: "66122858261", appId: "1:66122858261:web:7fa21f1805463b5c08331c" };
        const db = getFirestore(initializeApp(firebaseConfig));

        protegerPagina(['super-admin','diretor','tesoureiro','conselheiro','recepcionista','bibliotecario','irradiador','dirigente-escola','secretario-escola','produtor-eventos','entrevistador','caritas']).then(() => {
            const domSoc = calcularProximoDomingoSocial();
            document.getElementById('data-domingo').innerText = domSoc.toLocaleDateString('pt-BR').substring(0, 5);
            document.getElementById('data-ref-domingo').innerText = domSoc.toLocaleDateString('pt-BR');

            const limiteStr = new Date(domSoc.getTime() + 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

            let estoqueGlobal = [];
            let configCesta = null; // Alterado para null para checagem de carregamento
            let metaGlobal = 14; 
            let entregasRealizadas = 0;

            onSnapshot(query(collection(db, "familiasAssistidas"), where("statusGeral", "==", "Ativa")), s => {
                document.getElementById('total-familias').innerText = s.size;
            });
            
            const inicioMes = new Date(); inicioMes.setDate(1); inicioMes.setHours(0,0,0,0);
            onSnapshot(query(collection(db, "entregasCestas"), where("data", ">=", Timestamp.fromDate(inicioMes))), s => {
                entregasRealizadas = s.size;
                document.getElementById('total-entregas').innerText = entregasRealizadas;
                recalcularProntidao();
            });

            onSnapshot(doc(db, "configuracoes", "cesta_padrao"), d => {
                if (d.exists()) {
                    configCesta = d.data().itens || {};
                    metaGlobal = d.data().meta || 14;
                    recalcularProntidao();
                }
            });

            onSnapshot(collection(db, "estoque_caritas"), snap => {
                estoqueGlobal = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                recalcularProntidao();
                
                const painel = document.getElementById('painel-validade-viva');
                const lista = document.getElementById('lista-alertas-vivos');
                let criticos = estoqueGlobal.filter(i => i.validade && i.validade <= limiteStr && i.quantidade > 0);

                if (criticos.length > 0) {
                    painel.style.display = 'block';
                    lista.innerHTML = criticos.map(i => {
                        const p = i.validade.split('-');
                        return `<div class="card-alerta-vivo"><b>${i.nome}</b><br><small style="color:#e74c3c">Vence: ${p[2]}/${p[1]}/${p[0]}</small><br><small>Saldo: ${i.quantidade} un.</small></div>`;
                    }).join('');
                } else { painel.style.display = 'none'; }
            });

            function recalcularProntidao() {
                // SÓ CALCULA SE JÁ TIVER CARREGADO CONFIG E ESTOQUE
                if (!configCesta || estoqueGlobal.length === 0) return;
                
                let montaveis = Infinity;
                let itemGargalo = "";
                const metaRestante = Math.max(0, metaGlobal - entregasRealizadas);

                Object.entries(configCesta).forEach(([id, qtdNecessaria]) => {
                    const item = estoqueGlobal.find(i => i.id === id);
                    const saldo = item ? (item.quantidade || 0) : 0;
                    const capacidade = Math.floor(saldo / qtdNecessaria);
                    
                    if (capacidade < montaveis) {
                        montaveis = capacidade;
                        itemGargalo = item ? item.nome : "Item não vinculado";
                    }
                });

                const total = montaveis === Infinity ? 0 : montaveis;
                const display = document.getElementById('total-cestas-prontas');
                const label = document.getElementById('item-limitante');
                
                display.innerText = `${total} Cestas`;
                
                if (total < metaRestante) {
                    label.innerHTML = `⚠️ <b>${itemGargalo}</b> limita a meta de ${metaRestante} restantes.`;
                } else {
                    label.innerHTML = `<span style="color:#2e7d32">✅ Estoque pronto para atender as ${metaRestante} famílias restantes!</span>`;
                }
            }
        });

        function calcularProximoDomingoSocial() {
            const hoje = new Date();
            function buscar(y, m) {
                let dom = 0;
                for (let d = 1; d <= 31; d++) {
                    let dt = new Date(y, m, d);
                    if (dt.getDay() === 0 && ++dom === 3) return dt;
                }
            }
            let res = buscar(hoje.getFullYear(), hoje.getMonth());
            if (hoje > res) res = buscar(hoje.getMonth() === 11 ? hoje.getFullYear()+1 : hoje.getFullYear(), (hoje.getMonth()+1)%12);
            return res;
        }
    </script>
</body>
</html>