<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arquivo Geral - Atendimento Espiritual</title>
    <style>
        :root { --cor-primaria: #007bff; --cor-borda: #ddd; --fundo-selecionado: #e9ecef; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f6f9; margin: 0; padding: 20px; }
        .container { width: 100%; max-width: 1400px; margin: 0 auto; background-color: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 6px 24px rgba(0,0,0,0.1); }
        .nav-voltar { margin-bottom: 20px; }
        .btn, .btn-voltar, .btn-editar, .btn-acao { background-color: var(--cor-primaria); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; text-decoration: none; display: inline-block; cursor: pointer; }
        .btn-voltar { background-color: #6c757d; }
        .btn-acao { background-color: #28a745; width: 100%; box-sizing: border-box; text-align: center; margin: 10px 15px; padding: 12px; width: calc(100% - 30px); }
        .hidden { display: none; }

        .filtros-container { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        .alfabeto-filtro { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; }
        .alfabeto-filtro button { font-size: 0.9em; width: 35px; height: 35px; border: 1px solid #ccc; background-color: #fff; border-radius: 50%; cursor: pointer; transition: background-color 0.2s, color 0.2s; }
        .alfabeto-filtro button.ativo { background-color: var(--cor-primaria); color: white; border-color: var(--cor-primaria); }
        #campo-busca { width: 100%; padding: 12px; font-size: 1.1em; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }

        .main-grid { display: grid; grid-template-columns: 350px 1fr; gap: 30px; min-height: 60vh; }
        .lista-assistidos-col { border-right: 1px solid var(--cor-borda); padding-right: 20px; }
        #lista-assistidos { list-style-type: none; padding: 0; margin: 0; max-height: 60vh; overflow-y: auto; }
        /* Estilo para o item da lista */
        #lista-assistidos li {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-weight: 500;
            display: flex; /* Para alinhar o √≠cone */
            align-items: center; /* Para alinhar o √≠cone */
            gap: 8px; /* Espa√ßo entre √≠cone e nome */
        }
        #lista-assistidos li:hover { background-color: var(--fundo-selecionado); }
        #lista-assistidos li.selecionado { background-color: var(--cor-primaria); color: white; font-weight: bold; }
        /* Estilo para o √≠cone de pend√™ncia */
        .icone-pendente { color: #ffc107; font-weight: bold; font-size: 1.1em; /* Ajuste o tamanho se necess√°rio */ }


        .detalhes-assistido-col h2 { text-align: center; margin-top: 0; }
        #historico-container { max-height: 60vh; overflow-y: auto; }
        .ciclo-tratamento { border: 1px solid var(--cor-borda); border-radius: 8px; margin-bottom: 20px; }
        .ciclo-header { background-color: #f8f9fa; padding: 15px; border-bottom: 1px solid var(--cor-borda); font-weight: bold; display: flex; justify-content: space-between; flex-wrap: wrap; }
        .ciclo-header .status-ativo { color: #28a745; }
        .ciclo-header .status-concluido { color: #6c757d; }
        .atendimentos-lista { list-style-type: none; padding: 0; margin: 0; }
        .atendimentos-lista li { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid #eee; }
        .atendimentos-lista li:last-child { border-bottom: none; }
        .atendimento-info { display: flex; align-items: center; gap: 10px; }
        .btn-editar { background-color: #17a2b8; padding: 6px 12px; border-radius: 6px; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="container">
        <nav class="nav-voltar"><a href="/dashboard-ae.html" class="btn-voltar">‚¨Ö Voltar para o Painel AE</a></nav>
        <div id="acesso-negado" class="hidden"><h1>Acesso Negado</h1></div>

        <div id="main-content">
            <header>
                <h1 style="text-align: center;">Arquivo e Edi√ß√£o de Entrevistas</h1>
            </header>
            <section class="filtros-container">
                <div id="alfabeto-filtro" class="alfabeto-filtro"></div>
                <input type="search" id="campo-busca" placeholder="üîé Buscar assistido por nome...">
            </section>
            <main class="main-grid">
                <div class="lista-assistidos-col">
                    <h2 style="margin-top:0;">Assistidos</h2>
                    <ul id="lista-assistidos"><p>Carregando assistidos...</p></ul>
                </div>
                <div class="detalhes-assistido-col">
                    <div id="detalhes-assistido">
                        <p style="text-align: center; color: #666; margin-top: 50px;">Selecione um assistido na lista √† esquerda para ver seu hist√≥rico.</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        // Importar 'documentId' para a query 'in'
        import { getFirestore, collection, doc, getDoc, query, where, getDocs, orderBy, Timestamp, addDoc, serverTimestamp, documentId } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { protegerPagina } from '/auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU",
            authDomain: "voluntarios-ativos---cepat.firebaseapp.com",
            projectId: "voluntarios-ativos---cepat",
            storageBucket: "voluntarios-ativos---cepat.firebasestorage.app",
            messagingSenderId: "66122858261",
            appId: "1:66122858261:web:7fa21f1805463b5c08331c"
        };
        initializeApp(firebaseConfig);

        protegerPagina(['entrevistador', 'tesoureiro', 'conselheiro', 'diretor', 'super-admin']).then(user => {
            document.getElementById('main-content').classList.remove('hidden');
            inicializarPagina(user);
        }).catch(err => {
            document.getElementById('acesso-negado').classList.remove('hidden');
        });

        function inicializarPagina(user) {
            const db = getFirestore();
            const assistidosRef = collection(db, 'assistidos');
            const tratamentosRef = collection(db, 'tratamentos_ae');
            const atendimentosRef = collection(db, 'atendimentos_ae');
            const logAuditoriaRef = collection(db, 'log_auditoria');

            let assistidoAtualmenteSelecionado = null;
            let debounceTimer;
            // Armazena os IDs dos assistidos com pend√™ncias
            let assistidosComPendencias = new Set();

            const ui = {
                alfabetoFiltro: document.getElementById('alfabeto-filtro'),
                campoBusca: document.getElementById('campo-busca'),
                listaAssistidos: document.getElementById('lista-assistidos'),
                detalhesAssistido: document.getElementById('detalhes-assistido'),
            };

            async function registrarLog(acao, detalhes) {
                try {
                    await addDoc(logAuditoriaRef, {
                        timestamp: serverTimestamp(),
                        autor: { uid: user.uid, nome: user.displayName || 'Usu√°rio do Sistema' },
                        acao: acao,
                        detalhes: detalhes
                    });
                } catch (error) {
                    console.error("Erro ao registrar log:", error);
                }
            }

            function gerarBotoesAlfabeto() {
                const alfabeto = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('');
                alfabeto.forEach(letra => {
                    const btn = document.createElement('button');
                    btn.textContent = letra;
                    btn.dataset.letra = letra;
                    ui.alfabetoFiltro.appendChild(btn);
                });
                const btnTodos = document.createElement('button');
                btnTodos.textContent = 'Todos';
                btnTodos.dataset.letra = '';
                btnTodos.classList.add('ativo'); // Bot√£o "Todos" come√ßa ativo
                ui.alfabetoFiltro.appendChild(btnTodos);
            }

            // ===================================================================
            // IN√çCIO DA √ÅREA MODIFICADA: carregarAssistidos e renderizarListaAssistidos
            // ===================================================================
            async function carregarAssistidos(filtroLetra = '', termoBusca = '') {
                ui.listaAssistidos.innerHTML = '<p>Buscando...</p>';
                let assistidosParaExibir = [];
                // Determina se a vis√£o √© padr√£o (sem filtro/busca) ou filtrada
                const isVisaoPadrao = !filtroLetra && !termoBusca;

                try {
                    // 1. Buscar SEMPRE os IDs com pend√™ncias (para o √≠cone)
                    // Esta busca acontece independentemente do filtro principal
                    const qPendingInterviews = query(atendimentosRef,
                        where("detalhes_preenchidos", "==", false),
                        where("entrevistador", "==", "Aguardando Detalhes")
                        // NOTA: Pode precisar de √≠ndice! Verifique o console.
                    );
                    const pendingSnapshot = await getDocs(qPendingInterviews);
                    assistidosComPendencias = new Set(pendingSnapshot.docs.map(doc => doc.data().assistidoId));
                    // console.log(`Encontrados ${assistidosComPendencias.size} assistidos com pend√™ncias.`); // Log de debug (opcional)

                    // 2. L√≥gica de busca principal
                    // CASO A: Filtro de letra ou busca por nome (mostra TODOS que batem com o filtro)
                    if (!isVisaoPadrao) {
                        let q;
                        if (termoBusca) {
                            const termo = termoBusca.toLowerCase();
                            q = query(assistidosRef, where('nome_lower', '>=', termo), where('nome_lower', '<=', termo + '\uf8ff'), orderBy('nome_lower'));
                        } else { // filtroLetra
                            const proximaLetra = String.fromCharCode(filtroLetra.charCodeAt(0) + 1);
                            q = query(assistidosRef, where('nome', '>=', filtroLetra), where('nome', '<', proximaLetra), orderBy('nome'));
                        }
                        const snapshot = await getDocs(q);
                        assistidosParaExibir = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        // console.log(`Busca/Filtro: Exibindo ${assistidosParaExibir.length} assistidos.`); // Log de debug (opcional)

                    // CASO B: Vis√£o padr√£o (sem filtro/busca) - mostra Ativos + Pendentes
                    } else {
                        // Busca IDs com tratamentos ativos
                        const qActiveTreatments = query(tratamentosRef, where('status', '==', 'ativo'));
                        const activeSnapshot = await getDocs(qActiveTreatments);
                        const activeAssistidoIds = new Set(activeSnapshot.docs.map(doc => doc.data().assistidoId));
                        // console.log(`Encontrados ${activeAssistidoIds.size} assistidos com tratamentos ativos.`); // Log de debug (opcional)

                        // Combina os IDs (Ativos + Pendentes)
                        const idsParaMostrar = new Set([...activeAssistidoIds, ...assistidosComPendencias]);
                        // console.log(`Total de IDs √∫nicos para mostrar (Ativos OU Pendentes): ${idsParaMostrar.size}`); // Log de debug (opcional)

                        if (idsParaMostrar.size > 0) {
                            // Converte Set para Array para usar na query 'in'
                            const idsArray = Array.from(idsParaMostrar);

                            // Firestore limita 'in' a 30 IDs por query.
                            // Se tiver mais, precisa dividir em m√∫ltiplas queries.
                            const MAX_IDS_PER_QUERY = 30; // Limite atual do Firestore
                            if (idsArray.length > MAX_IDS_PER_QUERY) {
                                console.warn(`A lista de assistidos ativos/pendentes (${idsArray.length}) excede o limite de ${MAX_IDS_PER_QUERY} do Firestore. Exibindo apenas os primeiros ${MAX_IDS_PER_QUERY}.`);
                                // Limita o array para a primeira query (pode-se implementar pagina√ß√£o ou m√∫ltiplas queries aqui)
                                idsArray.splice(MAX_IDS_PER_QUERY);
                            }

                            // Query usando documentId() e 'in'
                            const qDefault = query(assistidosRef, where(documentId(), 'in', idsArray));
                            const defaultSnapshot = await getDocs(qDefault);
                            assistidosParaExibir = defaultSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                            // Ordena alfabeticamente AP√ìS buscar, pois 'in' n√£o garante ordem
                            assistidosParaExibir.sort((a, b) => a.nome.localeCompare(b.nome));
                            // console.log(`Vis√£o Padr√£o: Exibindo ${assistidosParaExibir.length} assistidos (Ativos ou Pendentes).`); // Log de debug (opcional)
                        } else {
                             // console.log("Nenhum assistido ativo ou com pend√™ncias encontrado."); // Log de debug (opcional)
                             assistidosParaExibir = []; // Lista vazia
                        }
                    }

                    // 3. Renderiza a lista (passando as pend√™ncias para o √≠cone)
                    renderizarListaAssistidos(assistidosParaExibir, assistidosComPendencias);

                    // 4. Seleciona assistido da URL (se houver)
                    const params = new URLSearchParams(window.location.search);
                    const assistidoIdUrl = params.get('assistidoId');
                    if (assistidoIdUrl) {
                        const assistidoParaMostrar = assistidosParaExibir.find(a => a.id === assistidoIdUrl);
                        // Se o assistido da URL est√° na lista atual, seleciona-o
                        if (assistidoParaMostrar) {
                            const liCorrespondente = ui.listaAssistidos.querySelector(`[data-assistido-id="${assistidoIdUrl}"]`);
                            if (liCorrespondente && !liCorrespondente.classList.contains('selecionado')) { // Evita recarregar se j√° selecionado
                                liCorrespondente.classList.add('selecionado');
                                mostrarDetalhes(assistidoParaMostrar, user);
                            }
                        } else if (!assistidoAtualmenteSelecionado || assistidoAtualmenteSelecionado.id !== assistidoIdUrl) {
                            // Se o assistido da URL N√ÉO est√° na lista atual E n√£o √© o j√° selecionado,
                            // carrega ele individualmente para mostrar o hist√≥rico.
                            console.log(`Assistido da URL (${assistidoIdUrl}) n√£o est√° na lista filtrada. Carregando individualmente...`);
                            const docRef = doc(db, 'assistidos', assistidoIdUrl);
                            const docSnap = await getDoc(docRef);
                            if (docSnap.exists()) {
                                // Adiciona temporariamente √† lista para sele√ß√£o visual (opcional)
                                const tempAssistido = { id: docSnap.id, ...docSnap.data() };
                                renderizarListaAssistidos([tempAssistido, ...assistidosParaExibir], assistidosComPendencias); // Adiciona no in√≠cio
                                const liCorrespondente = ui.listaAssistidos.querySelector(`[data-assistido-id="${assistidoIdUrl}"]`);
                                if (liCorrespondente) liCorrespondente.classList.add('selecionado');
                                mostrarDetalhes(tempAssistido, user);
                            } else {
                                 ui.detalhesAssistido.innerHTML = `<p class="erro">Assistido com ID ${assistidoIdUrl} n√£o encontrado.</p>`;
                            }
                        }
                    // Se n√£o veio ID na URL e nenhum est√° selecionado, limpa detalhes
                    } else if (assistidosParaExibir.length > 0 && !assistidoAtualmenteSelecionado) {
                         ui.detalhesAssistido.innerHTML = `<p style="text-align: center; color: #666; margin-top: 50px;">Selecione um assistido na lista √† esquerda para ver seu hist√≥rico.</p>`;
                    } else if (assistidosParaExibir.length === 0){
                         // Se a lista resultante est√° vazia, limpa detalhes
                         ui.detalhesAssistido.innerHTML = `<p style="text-align: center; color: #666; margin-top: 50px;">Nenhum assistido encontrado.</p>`;
                    }


                } catch (error) {
                    console.error("Erro ao carregar assistidos:", error);
                    ui.listaAssistidos.innerHTML = '<p style="color: red;">Erro ao carregar lista.</p>';
                    if (error.code === 'failed-precondition') {
                         alert("Erro: O Firestore precisa de um √≠ndice para esta consulta. Verifique o console (F12) para o link de cria√ß√£o do √≠ndice ou detalhes.");
                         console.error("Link para criar √≠ndice (copie e cole no navegador se n√£o for clic√°vel):", error.message.substring(error.message.indexOf('https://console.firebase.google.com')));
                     }
                }
            }

            function renderizarListaAssistidos(assistidos, pendingAssistidoIds) {
                ui.listaAssistidos.innerHTML = ''; // Limpa a lista existente
                if (assistidos.length === 0) {
                    ui.listaAssistidos.innerHTML = '<p>Nenhum assistido encontrado para os crit√©rios atuais.</p>';
                    return;
                }
                assistidos.forEach(assistido => {
                    const li = document.createElement('li');
                    let liContent = '';
                    // Adiciona o √≠cone se o ID do assistido estiver no Set de pend√™ncias
                    if (pendingAssistidoIds.has(assistido.id)) {
                        liContent += '<span class="icone-pendente">üìù</span>'; // Adiciona √≠cone antes do nome
                    }
                    liContent += assistido.nome; // Adiciona o nome

                    li.innerHTML = liContent; // Define o conte√∫do HTML (renderiza o span)
                    li.dataset.assistidoId = assistido.id;

                    // Marca como selecionado se for o assistido atualmente carregado
                    if(assistidoAtualmenteSelecionado && assistido.id === assistidoAtualmenteSelecionado.id){
                        li.classList.add('selecionado');
                    }

                    li.addEventListener('click', () => {
                        // Desmarca outros itens
                        document.querySelectorAll('#lista-assistidos li').forEach(el => el.classList.remove('selecionado'));
                        // Marca o item clicado
                        li.classList.add('selecionado');
                        // Mostra os detalhes
                        mostrarDetalhes(assistido, user);
                    });
                    ui.listaAssistidos.appendChild(li);
                });
            }
            // ===================================================================
            // FIM DA √ÅREA MODIFICADA
            // ===================================================================

            // --- Listener para filtro de letra ---
            ui.alfabetoFiltro.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    document.querySelectorAll('#alfabeto-filtro button').forEach(btn => btn.classList.remove('ativo'));
                    e.target.classList.add('ativo');
                    ui.campoBusca.value = ''; // Limpa busca
                    assistidoAtualmenteSelecionado = null; // Limpa sele√ß√£o
                    ui.detalhesAssistido.innerHTML = `<p style="text-align: center; color: #666; margin-top: 50px;">Carregando lista...</p>`; // Feedback visual
                    carregarAssistidos(e.target.dataset.letra, ''); // Carrega filtrado
                }
            });

            // --- Listener para campo de busca ---
            ui.campoBusca.addEventListener('input', (e) => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    document.querySelectorAll('#alfabeto-filtro button').forEach(btn => btn.classList.remove('ativo')); // Desativa letras
                    assistidoAtualmenteSelecionado = null; // Limpa sele√ß√£o
                    ui.detalhesAssistido.innerHTML = `<p style="text-align: center; color: #666; margin-top: 50px;">Carregando lista...</p>`; // Feedback visual
                    carregarAssistidos('', e.target.value); // Carrega com busca
                }, 500);
            });

            // --- Listener para recarregar hist√≥rico ao focar na janela ---
            window.addEventListener('focus', () => {
                if (assistidoAtualmenteSelecionado) {
                    // Recarrega apenas se um assistido estiver selecionado
                    mostrarDetalhes(assistidoAtualmenteSelecionado, user);
                }
            });

            // --- Inicializa√ß√£o ---
            gerarBotoesAlfabeto();
            carregarAssistidos(); // Carrega a lista padr√£o inicial (ativos + pendentes)
        }
    </script>
</body>
</html>