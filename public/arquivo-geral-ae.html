<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arquivo Geral - Atendimento Espiritual</title>
    <style>
        :root { --cor-primaria: #007bff; --cor-borda: #ddd; --fundo-selecionado: #e9ecef; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f6f9; margin: 0; padding: 20px; }
        .container { width: 100%; max-width: 1400px; margin: 0 auto; background-color: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 6px 24px rgba(0,0,0,0.1); }
        .nav-voltar { margin-bottom: 20px; }
        .btn, .btn-voltar, .btn-editar, .btn-acao { background-color: var(--cor-primaria); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; text-decoration: none; display: inline-block; cursor: pointer; }
        .btn-voltar { background-color: #6c757d; }
        .btn-acao { background-color: #28a745; width: 100%; box-sizing: border-box; text-align: center; margin: 10px 15px; padding: 12px; width: calc(100% - 30px); }
        .hidden { display: none; }

        .filtros-container { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        .alfabeto-filtro { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; }
        .alfabeto-filtro button { font-size: 0.9em; width: 35px; height: 35px; border: 1px solid #ccc; background-color: #fff; border-radius: 50%; cursor: pointer; transition: background-color 0.2s, color 0.2s; }
        .alfabeto-filtro button.ativo { background-color: var(--cor-primaria); color: white; border-color: var(--cor-primaria); }
        #campo-busca { width: 100%; padding: 12px; font-size: 1.1em; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }

        .main-grid { display: grid; grid-template-columns: 350px 1fr; gap: 30px; min-height: 60vh; }
        .lista-assistidos-col { border-right: 1px solid var(--cor-borda); padding-right: 20px; }
        /* --- NOVO: Estilo para o cabe√ßalho da lista --- */
        .lista-assistidos-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px; /* Ajuste conforme necess√°rio */
        }
        .lista-assistidos-header h2 {
             margin: 0; /* Remove margem padr√£o do h2 */
        }
        /* --- NOVO: Estilo para o bot√£o de atualizar --- */
        #btn-atualizar-lista {
            font-size: 0.8em;
            padding: 5px 10px;
            background-color: #6c757d;
            border-radius: 6px;
        }

        #lista-assistidos { list-style-type: none; padding: 0; margin: 0; max-height: calc(60vh - 50px); /* Ajusta altura para caber bot√£o */ overflow-y: auto; }
        #lista-assistidos li { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 8px; }
        #lista-assistidos li:hover { background-color: var(--fundo-selecionado); }
        #lista-assistidos li.selecionado { background-color: var(--cor-primaria); color: white; font-weight: bold; }
        .icone-pendente { color: #ffc107; font-weight: bold; font-size: 1.1em; /* Ajuste o tamanho se necess√°rio */ }


        .detalhes-assistido-col h2 { text-align: center; margin-top: 0; }
        #historico-container { max-height: 60vh; overflow-y: auto; }
        .ciclo-tratamento { border: 1px solid var(--cor-borda); border-radius: 8px; margin-bottom: 20px; }
        .ciclo-header { background-color: #f8f9fa; padding: 15px; border-bottom: 1px solid var(--cor-borda); font-weight: bold; display: flex; justify-content: space-between; flex-wrap: wrap; }
        .ciclo-header .status-ativo { color: #28a745; }
        .ciclo-header .status-concluido { color: #6c757d; }
        .atendimentos-lista { list-style-type: none; padding: 0; margin: 0; }
        .atendimentos-lista li { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid #eee; }
        .atendimentos-lista li:last-child { border-bottom: none; }
        .atendimento-info { display: flex; align-items: center; gap: 10px; }
        .btn-editar { background-color: #17a2b8; padding: 6px 12px; border-radius: 6px; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="container">
        <nav class="nav-voltar"><a href="/dashboard-ae.html" class="btn-voltar">‚¨Ö Voltar para o Painel AE</a></nav>
        <div id="acesso-negado" class="hidden"><h1>Acesso Negado</h1></div>

        <div id="main-content">
            <header>
                <h1 style="text-align: center;">Arquivo e Edi√ß√£o de Entrevistas</h1>
            </header>
            <section class="filtros-container">
                <div id="alfabeto-filtro" class="alfabeto-filtro"></div>
                <input type="search" id="campo-busca" placeholder="üîé Buscar assistido por nome...">
            </section>
            <main class="main-grid">
                <div class="lista-assistidos-col">
                    <div class="lista-assistidos-header">
                        <h2 style="margin-top:0;">Assistidos</h2>
                        <button id="btn-atualizar-lista" class="btn">Atualizar Lista üîÑ</button>
                    </div>
                    <ul id="lista-assistidos"><p>Carregando assistidos...</p></ul>
                </div>
                <div class="detalhes-assistido-col">
                    <div id="detalhes-assistido">
                        <p style="text-align: center; color: #666; margin-top: 50px;">Selecione um assistido na lista √† esquerda para ver seu hist√≥rico.</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        // Importar 'documentId' para a query 'in'
        import { getFirestore, collection, doc, getDoc, query, where, getDocs, orderBy, Timestamp, addDoc, serverTimestamp, documentId } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { protegerPagina } from '/auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU",
            authDomain: "voluntarios-ativos---cepat.firebaseapp.com",
            projectId: "voluntarios-ativos---cepat",
            storageBucket: "voluntarios-ativos---cepat.firebasestorage.app",
            messagingSenderId: "66122858261",
            appId: "1:66122858261:web:7fa21f1805463b5c08331c"
        };
        initializeApp(firebaseConfig);

        protegerPagina(['entrevistador', 'tesoureiro', 'conselheiro', 'diretor', 'super-admin']).then(user => {
            document.getElementById('main-content').classList.remove('hidden');
            inicializarPagina(user);
        }).catch(err => {
            document.getElementById('acesso-negado').classList.remove('hidden');
        });

        function inicializarPagina(user) {
            const db = getFirestore();
            const assistidosRef = collection(db, 'assistidos');
            const tratamentosRef = collection(db, 'tratamentos_ae');
            const atendimentosRef = collection(db, 'atendimentos_ae');
            const logAuditoriaRef = collection(db, 'log_auditoria');

            let assistidoAtualmenteSelecionado = null;
            let debounceTimer;
            // Armazena os IDs dos assistidos com pend√™ncias
            let assistidosComPendencias = new Set();

            const ui = {
                alfabetoFiltro: document.getElementById('alfabeto-filtro'),
                campoBusca: document.getElementById('campo-busca'),
                listaAssistidos: document.getElementById('lista-assistidos'),
                detalhesAssistido: document.getElementById('detalhes-assistido'),
                // --- NOVO: Refer√™ncia ao bot√£o ---
                btnAtualizarLista: document.getElementById('btn-atualizar-lista')
            };

            async function registrarLog(acao, detalhes) {
                try {
                    await addDoc(logAuditoriaRef, {
                        timestamp: serverTimestamp(),
                        autor: { uid: user.uid, nome: user.displayName || 'Usu√°rio do Sistema' },
                        acao: acao,
                        detalhes: detalhes
                    });
                } catch (error) {
                    console.error("Erro ao registrar log:", error);
                }
            }

            function gerarBotoesAlfabeto() {
                const alfabeto = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('');
                alfabeto.forEach(letra => {
                    const btn = document.createElement('button');
                    btn.textContent = letra;
                    btn.dataset.letra = letra;
                    ui.alfabetoFiltro.appendChild(btn);
                });
                const btnTodos = document.createElement('button');
                btnTodos.textContent = 'Todos';
                btnTodos.dataset.letra = '';
                btnTodos.classList.add('ativo'); // Bot√£o "Todos" come√ßa ativo
                ui.alfabetoFiltro.appendChild(btnTodos);
            }

             async function prepararReavaliacao(ciclo, user) {
                if (!confirm(`Preparar a 5¬™ Semana (Reavalia√ß√£o) para o ciclo iniciado em ${ciclo.dataInicio.toDate().toLocaleDateString('pt-br')}?`)) {
                    return;
                }
                const btn = document.getElementById(`btn-preparar-${ciclo.id}`);
                btn.disabled = true; btn.textContent = 'Criando...';
                try {
                    const novoAtendimento = { assistidoId: ciclo.assistidoId, tratamentoId: ciclo.id, tipo: 'tratamento_semanal', dataAtendimento: null, semana: 5, entrevistador: 'Aguardando Decis√£o', passeRecomendado: ciclo.passe_ciclo_atual, notas: '', detalhes_preenchidos: false, decisao_pre_registrada: false, criadoPor: { uid: user.uid, nome: user.displayName || 'Usu√°rio do Sistema' }, criadoEm: serverTimestamp() };
                    const docRef = await addDoc(atendimentosRef, novoAtendimento);
                    registrarLog('Prepara√ß√£o de Reavalia√ß√£o (AE)', { assistidoId: ciclo.assistidoId, tratamentoId: ciclo.id, atendimentoId: docRef.id });
                    alert('Placeholder da 5¬™ Semana criado. Voc√™ j√° pode registrar a decis√£o do colegiado.');
                    mostrarDetalhes(assistidoAtualmenteSelecionado, user); // Recarrega
                } catch (error) {
                    console.error("Erro ao preparar reavalia√ß√£o:", error); alert("Falha ao criar o registro da 5¬™ semana.");
                    btn.disabled = false; btn.textContent = 'Preparar Reavalia√ß√£o (5¬™ Semana)';
                }
            }

            function renderizarHistorico(assistido, ciclos, todosAtendimentos, user) {
                const dnFormatado = assistido.dn ? new Date(assistido.dn + 'T12:00:00').toLocaleDateString('pt-br') : 'N√£o informado';
                let html = `<h2>Hist√≥rico de ${assistido.nome}</h2>`;
                html += `<p><strong>DN:</strong> ${dnFormatado} | <strong>Telefone:</strong> ${assistido.telefone || 'N√£o informado'}</p>`;
                html += '<div id="historico-container">';
                if (ciclos.length > 0) {
                    ciclos.forEach(ciclo => {
                        const dataInicio = ciclo.dataInicio ? ciclo.dataInicio.toDate().toLocaleDateString('pt-br') : 'N/A';
                        const statusClasse = ciclo.status === 'ativo' ? 'status-ativo' : 'status-concluido';
                        html += `<div class="ciclo-tratamento"><div class="ciclo-header"><span>In√≠cio: ${dataInicio} | Passe do Ciclo: ${ciclo.passe_ciclo_atual || 'N/A'}</span><span class="${statusClasse}">${ciclo.status.replace(/_/g, ' ')}</span></div><ul class="atendimentos-lista">`;
                        const atendimentosDoCiclo = todosAtendimentos.filter(a => a.tratamentoId === ciclo.id);
                        const atendimentosValidos = atendimentosDoCiclo.filter(a => a.tipo !== 'falta');
                        atendimentosValidos.sort((a, b) => a.dataAtendimento?.toMillis() - b.dataAtendimento?.toMillis());
                        const semana5JaExiste = atendimentosValidos.find(a => a.semana === 5);
                        if (atendimentosDoCiclo.length === 0) { html += '<li>Nenhum atendimento registrado.</li>'; }
                        else { atendimentosDoCiclo.sort((a, b) => a.dataAtendimento?.toMillis() - b.dataAtendimento?.toMillis()).forEach(a => { html += renderizarItemAtendimento(a, ciclo.passe_ciclo_atual); }); }
                        if (ciclo.status === 'ativo' && atendimentosValidos.length === 4 && !semana5JaExiste) { html += `<button id="btn-preparar-${ciclo.id}" class="btn-acao">Preparar Reavalia√ß√£o (5¬™ Semana)</button>`; }
                        html += `</ul></div>`;
                    });
                }
                const passesAvulsos = todosAtendimentos.filter(a => a.tipo === 'avulso');
                if (passesAvulsos.length > 0) {
                    html += `<div class="ciclo-tratamento"><div class="ciclo-header"><span>Passes Avulsos</span></div><ul class="atendimentos-lista">`;
                    passesAvulsos.sort((a, b) => a.dataAtendimento?.toMillis() - b.dataAtendimento?.toMillis()).forEach(a => { html += renderizarItemAtendimento(a, null); });
                    html += `</ul></div>`;
                }
                if (ciclos.length === 0 && passesAvulsos.length === 0) { html += '<p>Nenhum atendimento registrado.</p>'; }
                html += '</div>';
                ui.detalhesAssistido.innerHTML = html;
                ciclos.forEach(ciclo => { const btn = document.getElementById(`btn-preparar-${ciclo.id}`); if (btn) { btn.addEventListener('click', () => prepararReavaliacao(ciclo, user)); } });
            }

            function renderizarItemAtendimento(a, passe_ciclo_atual) {
                const dataAtendimento = a.dataAtendimento ? a.dataAtendimento.toDate().toLocaleDateString('pt-br') : "Aguardando Presen√ßa";
                let tipoAtendimento = a.tipo?.replace(/_/g, ' ') || 'N/A';
                let infoExtra = ''; let botaoEditarHtml = ''; let iconeHtml = ''; let precisaEntrevista = false;
                if (a.tipo !== 'falta' && a.tipo !== 'avulso') {
                    const semanaNum = a.semana || 0;
                    if ([1, 4, 5].includes(semanaNum)) { precisaEntrevista = true; }
                    if (['P3A', 'P3B'].includes(passe_ciclo_atual) && [2, 3].includes(semanaNum)) { precisaEntrevista = true; }
                }
                if (a.tipo === 'avulso') { tipoAtendimento = 'Passe Avulso'; infoExtra = `(${a.passeRecomendado})`; }
                else if (a.tipo === 'falta') { tipoAtendimento = 'Falta'; infoExtra = ''; }
                else { tipoAtendimento = `Semana ${a.semana || '?'}`; infoExtra = `(${a.passeRecomendado})`; }

                if (precisaEntrevista) {
                    if (a.semana === 5 && a.decisao_pre_registrada === true && a.dataAtendimento === null) { iconeHtml = '<span>üîµ</span>'; tipoAtendimento = "Reavalia√ß√£o (Decis√£o Pronta)"; }
                    else if (a.detalhes_preenchidos === true) { iconeHtml = '<span>‚úÖ</span>'; }
                    else { iconeHtml = '<span>üìù</span>'; } // Pendente
                    botaoEditarHtml = `<a href="/entrevista-ae.html?atendimentoId=${a.id}" target="_blank" class="btn btn-editar">Ver / Editar</a>`;
                }
                let estiloItem = ''; if (a.dataAtendimento === null && a.semana === 5) { estiloItem = 'style="background-color: #fffbe6;"'; }
                return `<li ${estiloItem}><div class="atendimento-info">${iconeHtml}<span><strong>${dataAtendimento}</strong> - ${tipoAtendimento} ${infoExtra}</span></div>${botaoEditarHtml}</li>`;
            }

            async function carregarAssistidos(filtroLetra = '', termoBusca = '') {
                ui.listaAssistidos.innerHTML = '<p>Buscando...</p>';
                let assistidosParaExibir = [];
                const isVisaoPadrao = !filtroLetra && !termoBusca;

                try {
                    // 1. Buscar SEMPRE os IDs com pend√™ncias (para o √≠cone)
                    const qPendingInterviews = query(atendimentosRef,
                        where("detalhes_preenchidos", "==", false),
                        where("entrevistador", "==", "Aguardando Detalhes")
                        // NOTA: Pode precisar de √≠ndice! Verifique o console.
                    );
                    const pendingSnapshot = await getDocs(qPendingInterviews);
                    assistidosComPendencias = new Set(pendingSnapshot.docs.map(doc => doc.data().assistidoId));
                    // console.log(`Encontrados ${assistidosComPendencias.size} assistidos com pend√™ncias.`); // Log de debug (opcional)

                    // 2. L√≥gica de busca principal
                    if (!isVisaoPadrao) { // Filtro ou Busca Ativos
                        let q;
                        if (termoBusca) {
                            const termo = termoBusca.toLowerCase();
                            q = query(assistidosRef, where('nome_lower', '>=', termo), where('nome_lower', '<=', termo + '\uf8ff'), orderBy('nome_lower'));
                        } else { // filtroLetra
                            const proximaLetra = String.fromCharCode(filtroLetra.charCodeAt(0) + 1);
                            q = query(assistidosRef, where('nome', '>=', filtroLetra), where('nome', '<', proximaLetra), orderBy('nome'));
                        }
                        const snapshot = await getDocs(q);
                        assistidosParaExibir = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        // console.log(`Busca/Filtro: Exibindo ${assistidosParaExibir.length} assistidos.`); // Log de debug (opcional)

                    } else { // Vis√£o Padr√£o (Ativos + Pendentes)
                        const qActiveTreatments = query(tratamentosRef, where('status', '==', 'ativo'));
                        const activeSnapshot = await getDocs(qActiveTreatments);
                        const activeAssistidoIds = new Set(activeSnapshot.docs.map(doc => doc.data().assistidoId));
                        // console.log(`Encontrados ${activeAssistidoIds.size} assistidos com tratamentos ativos.`); // Log de debug (opcional)

                        const idsParaMostrar = new Set([...activeAssistidoIds, ...assistidosComPendencias]);
                        // console.log(`Total de IDs √∫nicos para mostrar (Ativos OU Pendentes): ${idsParaMostrar.size}`); // Log de debug (opcional)

                        if (idsParaMostrar.size > 0) {
                            const idsArray = Array.from(idsParaMostrar);
                            const MAX_IDS_PER_QUERY = 30;
                            if (idsArray.length > MAX_IDS_PER_QUERY) {
                                console.warn(`A lista de assistidos ativos/pendentes (${idsArray.length}) excede o limite de ${MAX_IDS_PER_QUERY} do Firestore. Exibindo apenas os primeiros ${MAX_IDS_PER_QUERY}.`);
                                idsArray.splice(MAX_IDS_PER_QUERY);
                            }
                            // Usar documentId() importado
                            const qDefault = query(assistidosRef, where(documentId(), 'in', idsArray));
                            const defaultSnapshot = await getDocs(qDefault);
                            assistidosParaExibir = defaultSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            assistidosParaExibir.sort((a, b) => a.nome.localeCompare(b.nome));
                            // console.log(`Vis√£o Padr√£o: Exibindo ${assistidosParaExibir.length} assistidos (Ativos ou Pendentes).`); // Log de debug (opcional)
                        } else {
                             // console.log("Nenhum assistido ativo ou com pend√™ncias encontrado."); // Log de debug (opcional)
                             assistidosParaExibir = [];
                        }
                    }

                    // 3. Renderiza a lista
                    renderizarListaAssistidos(assistidosParaExibir, assistidosComPendencias);

                    // 4. Seleciona assistido da URL ou limpa detalhes
                    const params = new URLSearchParams(window.location.search);
                    const assistidoIdUrl = params.get('assistidoId');
                    if (assistidoIdUrl) {
                        const assistidoParaMostrar = assistidosParaExibir.find(a => a.id === assistidoIdUrl);
                        if (assistidoParaMostrar) {
                            const liCorrespondente = ui.listaAssistidos.querySelector(`[data-assistido-id="${assistidoIdUrl}"]`);
                            if (liCorrespondente && !liCorrespondente.classList.contains('selecionado')) {
                                liCorrespondente.classList.add('selecionado');
                                mostrarDetalhes(assistidoParaMostrar, user);
                            }
                        } else if (!assistidoAtualmenteSelecionado || assistidoAtualmenteSelecionado.id !== assistidoIdUrl) {
                            console.log(`Assistido da URL (${assistidoIdUrl}) n√£o est√° na lista filtrada. Carregando individualmente...`);
                            const docRef = doc(db, 'assistidos', assistidoIdUrl);
                            const docSnap = await getDoc(docRef);
                            if (docSnap.exists()) {
                                const tempAssistido = { id: docSnap.id, ...docSnap.data() };
                                // Temporariamente adiciona √† lista para sele√ß√£o visual
                                renderizarListaAssistidos([tempAssistido, ...assistidosParaExibir].sort((a,b)=>a.nome.localeCompare(b.nome)), assistidosComPendencias);
                                const liCorrespondente = ui.listaAssistidos.querySelector(`[data-assistido-id="${assistidoIdUrl}"]`);
                                if (liCorrespondente) liCorrespondente.classList.add('selecionado');
                                mostrarDetalhes(tempAssistido, user);
                            } else { ui.detalhesAssistido.innerHTML = `<p class="erro">Assistido com ID ${assistidoIdUrl} n√£o encontrado.</p>`; }
                        }
                    } else if (assistidosParaExibir.length > 0 && !assistidoAtualmenteSelecionado) {
                         ui.detalhesAssistido.innerHTML = `<p style="text-align: center; color: #666; margin-top: 50px;">Selecione um assistido na lista √† esquerda para ver seu hist√≥rico.</p>`;
                    } else if (assistidosParaExibir.length === 0){
                         ui.detalhesAssistido.innerHTML = `<p style="text-align: center; color: #666; margin-top: 50px;">Nenhum assistido encontrado.</p>`;
                    }

                } catch (error) {
                    console.error("Erro ao carregar assistidos:", error);
                    ui.listaAssistidos.innerHTML = '<p style="color: red;">Erro ao carregar lista.</p>';
                    if (error.code === 'failed-precondition') {
                         alert("Erro: O Firestore precisa de um √≠ndice para esta consulta. Verifique o console (F12) para o link de cria√ß√£o do √≠ndice ou detalhes.");
                         // Tenta extrair e logar o link do √≠ndice
                         const urlMatch = error.message.match(/https?:\/\/[^\s]+/);
                         if(urlMatch && urlMatch[0]){
                             console.error("Link para criar √≠ndice (copie e cole no navegador):", urlMatch[0]);
                         }
                     }
                }
            }

            function renderizarListaAssistidos(assistidos, pendingAssistidoIds) {
                ui.listaAssistidos.innerHTML = '';
                if (assistidos.length === 0) {
                    ui.listaAssistidos.innerHTML = '<p>Nenhum assistido encontrado para os crit√©rios atuais.</p>';
                    return;
                }
                assistidos.forEach(assistido => {
                    const li = document.createElement('li');
                    let liContent = '';
                    if (pendingAssistidoIds.has(assistido.id)) {
                        liContent += '<span class="icone-pendente">üìù</span>'; // √çcone antes do nome
                    }
                    liContent += assistido.nome; // Nome

                    li.innerHTML = liContent;
                    li.dataset.assistidoId = assistido.id;

                    if(assistidoAtualmenteSelecionado && assistido.id === assistidoAtualmenteSelecionado.id){
                        li.classList.add('selecionado');
                    }

                    li.addEventListener('click', () => {
                        document.querySelectorAll('#lista-assistidos li').forEach(el => el.classList.remove('selecionado'));
                        li.classList.add('selecionado');
                        mostrarDetalhes(assistido, user); // Chama a fun√ß√£o definida neste escopo
                    });
                    ui.listaAssistidos.appendChild(li);
                });
            }

            async function mostrarDetalhes(assistido, user) {
                assistidoAtualmenteSelecionado = assistido; // Atualiza a vari√°vel global
                ui.detalhesAssistido.innerHTML = `<h2>Hist√≥rico de ${assistido.nome}</h2><p>Carregando hist√≥rico...</p>`;

                await registrarLog('Visualiza√ß√£o de Hist√≥rico (AE)', {
                    assistidoId: assistido.id,
                    assistidoNome: assistido.nome
                });

                const qTratamentos = query(tratamentosRef, where('assistidoId', '==', assistido.id), orderBy('dataInicio', 'desc'));
                const tratamentosSnapshot = await getDocs(qTratamentos);
                const ciclos = tratamentosSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const qAtendimentos = query(atendimentosRef, where('assistidoId', '==', assistido.id), orderBy('dataAtendimento', 'desc'));
                const atendimentosSnapshot = await getDocs(qAtendimentos);
                const todosAtendimentos = atendimentosSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                renderizarHistorico(assistido, ciclos, todosAtendimentos, user); // Chama a fun√ß√£o que monta o HTML do hist√≥rico
            }


            // --- Listener para filtro de letra ---
            ui.alfabetoFiltro.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const letraSelecionada = e.target.dataset.letra;
                    document.querySelectorAll('#alfabeto-filtro button').forEach(btn => btn.classList.remove('ativo'));
                    e.target.classList.add('ativo');
                    ui.campoBusca.value = '';
                    assistidoAtualmenteSelecionado = null;
                    ui.detalhesAssistido.innerHTML = `<p style="text-align: center; color: #666; margin-top: 50px;">Carregando lista...</p>`;
                    carregarAssistidos(letraSelecionada, '');
                }
            });

            // --- Listener para campo de busca ---
            ui.campoBusca.addEventListener('input', (e) => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    const termoBusca = e.target.value;
                    document.querySelectorAll('#alfabeto-filtro button').forEach(btn => btn.classList.remove('ativo'));
                    // Se a busca for limpa, ativa o bot√£o "Todos" e carrega a lista padr√£o
                    if (!termoBusca) {
                        const btnTodos = ui.alfabetoFiltro.querySelector('button[data-letra=""]');
                        if(btnTodos) btnTodos.classList.add('ativo');
                    }
                    assistidoAtualmenteSelecionado = null;
                    ui.detalhesAssistido.innerHTML = `<p style="text-align: center; color: #666; margin-top: 50px;">Carregando lista...</p>`;
                    carregarAssistidos('', termoBusca); // Passa '' como filtroLetra
                }, 500);
            });

            // --- Listener para o bot√£o Atualizar Lista ---
            ui.btnAtualizarLista.addEventListener('click', () => {
                console.log("Bot√£o Atualizar clicado."); // Log para debug
                // Descobre qual filtro est√° ativo (letra ou busca)
                const filtroLetraAtivo = ui.alfabetoFiltro.querySelector('button.ativo')?.dataset.letra || '';
                const termoBuscaAtivo = ui.campoBusca.value;

                // Mostra feedback visual
                ui.listaAssistidos.innerHTML = '<p>Atualizando lista...</p>';
                if (!assistidoAtualmenteSelecionado) { // S√≥ limpa detalhes se nenhum estiver selecionado
                     ui.detalhesAssistido.innerHTML = `<p style="text-align: center; color: #666; margin-top: 50px;">Selecione um assistido...</p>`;
                }

                // Chama carregarAssistidos com os filtros/busca atuais
                carregarAssistidos(filtroLetraAtivo, termoBuscaAtivo);
            });

            // --- Listener para recarregar hist√≥rico AO VOLTAR PARA A ABA ---
            window.addEventListener('focus', () => {
                if (assistidoAtualmenteSelecionado) {
                    console.log("Janela focada, recarregando detalhes..."); // Log para debug
                    // Recarrega apenas os detalhes do assistido selecionado
                    mostrarDetalhes(assistidoAtualmenteSelecionado, user);
                }
            });

            // --- Inicializa√ß√£o ---
            gerarBotoesAlfabeto();
            carregarAssistidos(); // Carga inicial
        }
    </script>
</body>
</html>