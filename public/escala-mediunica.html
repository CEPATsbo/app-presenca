<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Escala Mediúnica Dinâmica</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f6f9; margin: 0; padding: 20px; }
        .nav-voltar { max-width: 1400px; width: 100%; margin: 0 auto 20px auto; }
        .btn-voltar { background-color: #e9ecef; color: #495057; border: 1px solid #dee2e6; padding: 10px 20px; border-radius: 8px; font-weight: bold; text-decoration: none; display: inline-block; }
        
        .container { background-color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 100%; max-width: 98vw; margin: 0 auto; box-sizing: border-box; }
        h1 { text-align: center; color: #333; margin-top: 0; }
        
        .controles { display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; gap: 15px; flex-wrap: wrap; }
        .config-grupo { display: flex; align-items: center; gap: 15px; }
        input[type="month"] { padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 1em; }
        
        .toggle-passado { display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: bold; color: #555; background: #fff; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; }
        .toggle-passado input { width: 18px; height: 18px; cursor: pointer; }

        .btn-acao { padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; border: none; display: flex; align-items: center; gap: 8px; }
        .btn-carregar { background-color: #0277BD; color: white; }
        .btn-salvar { background-color: #2e7d32; color: white; }
        .btn-imprimir { background-color: #555; color: white; }

        .table-responsive { width: 100%; max-height: 70vh; overflow: auto; border: 1px solid #ddd; border-radius: 8px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.8em; }
        th, td { border: 1px solid #dee2e6; padding: 8px; text-align: center; min-width: 85px; }

        thead th { position: sticky; top: 0; z-index: 20; background-color: #2c3e50; color: white; }
        thead tr:nth-child(2) th { top: 35px; background-color: #ecf0f1; color: #34495e; z-index: 20; }

        .nome-col { text-align: left; font-weight: bold; min-width: 200px; background-color: #fff; position: sticky; left: 0; z-index: 10; border-right: 3px solid #0277BD; }
        th.nome-col { z-index: 30; top: 0; left: 0; background-color: #34495e; }

        .check-box { width: 20px; height: 20px; cursor: pointer; }
        #acesso-negado { display: none; text-align: center; padding: 50px; }

        /* ============================================================
           REGRAS DE IMPRESSÃO
        ============================================================ */
        @media print {
            @page { size: landscape; margin: 1cm; }
            body { background-color: white; padding: 0; }
            .nav-voltar, .controles, .btn-acao { display: none !important; }
            .container { box-shadow: none; border: none; width: 100%; max-width: 100%; padding: 0; }
            .table-responsive { max-height: none; overflow: visible; border: none; }
            table { font-size: 7pt; width: 100%; table-layout: auto; }
            th, td { border: 0.5pt solid #000 !important; padding: 4px !important; }
            thead th, .nome-col { position: static !important; background-color: #f0f0f0 !important; color: black !important; }
            
            /* Transformar checkboxes marcados em um "X" para o papel */
            input[type="checkbox"] { display: none; }
            input[type="checkbox"]:checked::after {
                content: "X";
                display: block;
                text-align: center;
                font-weight: bold;
                color: black;
                font-size: 10pt;
            }
            /* Exibir o X mesmo com o input escondido */
            td:has(input[type="checkbox"]:checked) {
                background-color: transparent !important;
            }
            td:has(input[type="checkbox"]:checked)::before {
                content: "X";
                font-weight: bold;
            }
        }
    </style>
</head>
<body>
    <nav class="nav-voltar">
        <a href="/dashboard.html" class="btn-voltar">⬅ Voltar para o Dashboard</a>
    </nav>

    <div id="acesso-negado">
        <h1>Acesso Negado</h1>
        <p>Apenas diretores e administradores podem gerenciar a escala.</p>
    </div>

    <div id="main-content" style="display: none;">
        <div class="container">
            <h1 id="titulo-pagina">Gestão de Escala Mediúnica</h1>
            
            <div class="controles">
                <div class="config-grupo">
                    <label><strong>Mês:</strong></label>
                    <input type="month" id="mes-referencia">
                    
                    <label class="toggle-passado">
                        <input type="checkbox" id="check-ver-passado"> 
                        <i class="fas fa-history"></i> Consultar Passado
                    </label>

                    <button id="btn-carregar" class="btn-acao btn-carregar">
                        <i class="fas fa-sync-alt"></i> Gerar Tabela
                    </button>
                </div>

                <div class="config-grupo">
                    <button id="btn-imprimir" class="btn-acao btn-imprimir">
                        <i class="fas fa-print"></i> Imprimir Escala
                    </button>
                    <button id="btn-salvar" class="btn-acao btn-salvar">
                        <i class="fas fa-save"></i> Salvar no Sistema
                    </button>
                </div>
            </div>

            <div class="table-responsive">
                <table id="tabela-escala">
                    <thead id="thead-escala"></thead>
                    <tbody id="tbody-escala">
                        <tr><td style="padding: 40px;">Selecione o mês e clique em "Gerar Tabela".</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, setDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { protegerPagina } from '/auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU",
            authDomain: "voluntarios-ativos---cepat.firebaseapp.com",
            projectId: "voluntarios-ativos---cepat",
            storageBucket: "voluntarios-ativos---cepat.firebasestorage.app",
            messagingSenderId: "66122858261",
            appId: "1:66122858261:web:7fa21f1805463b5c08331c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        protegerPagina(['super-admin', 'diretor', 'tesoureiro', 'conselheiro', 'entrevistador'])
            .then(() => {
                document.getElementById('main-content').style.display = 'block';
                const inputMes = document.getElementById('mes-referencia');
                const hoje = new Date();
                inputMes.value = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}`;
                carregarTabela();
            })
            .catch(() => {
                document.getElementById('acesso-negado').style.display = 'block';
            });

        function obterDatasTrabalho(ano, mes) {
            let datas = [];
            let data = new Date(ano, mes, 1);
            let contadorDomingo = 0;
            while (data.getMonth() === mes) {
                let diaSemana = data.getDay();
                let diaMes = data.getDate();
                let diaFormatado = `${diaMes.toString().padStart(2, '0')}/${(mes + 1).toString().padStart(2, '0')}`;
                let idData = `${ano}-${(mes + 1).toString().padStart(2, '0')}-${diaMes.toString().padStart(2, '0')}`;
                let configs = null;
                if (diaSemana === 2) configs = { dia: 'Ter', jobs: ['Harm. 19h', 'Salas 19h30'] };
                else if (diaSemana === 4) configs = { dia: 'Qui', jobs: ['Vibra 19h20', 'Col. Med 19h'] };
                else if (diaSemana === 5) configs = { dia: 'Sex', jobs: ['Harm. 19h', 'Trab. Med'] };
                else if (diaSemana === 6) configs = { dia: 'Sáb', jobs: ['Harm. 08:30'] };
                else if (diaSemana === 0) {
                    contadorDomingo++;
                    if (contadorDomingo === 3) configs = { dia: 'Dom', jobs: ['Cáritas 08:30'] };
                }
                if (configs) datas.push({ id: idData, label: diaFormatado, dia: configs.dia, jobs: configs.jobs });
                data.setDate(data.getDate() + 1);
            }
            return datas;
        }

        async function carregarTabela() {
            const val = document.getElementById('mes-referencia').value;
            const [ano, mesStr] = val.split('-');
            const mes = parseInt(mesStr) - 1;
            const mostrarTudo = document.getElementById('check-ver-passado').checked;
            const hoje = new Date(); hoje.setHours(0,0,0,0);
            
            // Atualiza o título da página para a impressão saber o mês
            document.getElementById('titulo-pagina').textContent = `Escala Mediúnica - ${mesStr}/${ano}`;

            let todasDatas = obterDatasTrabalho(parseInt(ano), mes);
            let datasFiltradas = mostrarTudo ? todasDatas : todasDatas.filter(d => new Date(d.id + 'T00:00:00') >= hoje);

            const tbody = document.getElementById('tbody-escala');
            if (todasDatas.length > 0 && datasFiltradas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="padding:40px; color: #e67e22;">Não há datas futuras. Marque "Consultar Passado".</td></tr>';
                return;
            }

            const q = query(collection(db, "voluntarios"), where("isMedium", "==", true), orderBy("nome"));
            const [snapMediuns, snapEscala] = await Promise.all([
                getDocs(q),
                getDoc(doc(db, "escalas_mediunicas", val))
            ]);
            
            renderizarTabela(datasFiltradas, snapMediuns.docs.map(d => ({ id: d.id, nome: d.data().nome })), snapEscala.exists() ? snapEscala.data().escalados : {});
        }

        function renderizarTabela(datas, mediuns, dados) {
            const thead = document.getElementById('thead-escala');
            const tbody = document.getElementById('tbody-escala');
            let head1 = `<tr><th rowspan="2" class="nome-col">Médium</th>`;
            let head2 = `<tr>`;
            datas.forEach(d => {
                head1 += `<th colspan="${d.jobs.length}">${d.dia} ${d.label}</th>`;
                d.jobs.forEach(j => head2 += `<th>${j}</th>`);
            });
            thead.innerHTML = head1 + '</tr>' + head2 + '</tr>';

            let bodyHtml = '';
            mediuns.forEach(m => {
                bodyHtml += `<tr><td class="nome-col">${m.nome}</td>`;
                datas.forEach(d => {
                    d.jobs.forEach(j => {
                        const key = `${d.id}_${j.replace(/\s+/g, '_')}`;
                        const checked = dados[key] && dados[key].includes(m.id) ? 'checked' : '';
                        bodyHtml += `<td><input type="checkbox" class="check-box" data-uid="${m.id}" data-key="${key}" ${checked}></td>`;
                    });
                });
                bodyHtml += `</tr>`;
            });
            tbody.innerHTML = bodyHtml;
        }

        document.getElementById('btn-salvar').onclick = async () => {
            const checks = document.querySelectorAll('.check-box');
            const escalados = {};
            const mesId = document.getElementById('mes-referencia').value;
            const escalaRef = doc(db, "escalas_mediunicas", mesId);
            const escalaSnap = await getDoc(escalaRef);
            let dadosCompletos = escalaSnap.exists() ? escalaSnap.data().escalados : {};

            checks.forEach(c => {
                const key = c.dataset.key;
                if (!escalados[key]) escalados[key] = [];
                if (c.checked) escalados[key].push(c.dataset.uid);
            });

            try {
                await setDoc(escalaRef, { escalados: { ...dadosCompletos, ...escalados }, ultimaAtualizacao: new Date() });
                alert("Escala salva!");
            } catch (e) { alert("Erro: " + e.message); }
        };

        // Função de Impressão
        document.getElementById('btn-imprimir').onclick = () => {
            window.print();
        };

        document.getElementById('btn-carregar').onclick = carregarTabela;
        document.getElementById('check-ver-passado').onchange = carregarTabela;
    </script>
</body>
</html>