<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Gerenciar Escala Mediúnica</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f6f9; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .nav-voltar { max-width: 1100px; width: 100%; margin-bottom: 20px; }
        .btn-voltar { background-color: #e9ecef; color: #495057; border: 1px solid #dee2e6; padding: 10px 20px; border-radius: 8px; font-weight: bold; text-decoration: none; display: inline-block; }
        .container { background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 100%; max-width: 1100px; }
        h1 { text-align: center; color: #333; margin-top: 0; }
        .controles { display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .input-group { display: flex; align-items: center; gap: 10px; }
        input[type="month"] { padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 1em; }
        .btn-acao { padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; border: none; transition: opacity 0.2s; }
        .btn-carregar { background-color: #0277BD; color: white; }
        .btn-salvar { background-color: #2e7d32; color: white; }
        .btn-acao:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .table-responsive { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85em; }
        th, td { border: 1px solid #dee2e6; padding: 10px; text-align: center; }
        th { background-color: #34495e; color: white; white-space: nowrap; }
        .header-dia { background-color: #2c3e50; font-weight: bold; }
        .nome-col { text-align: left; font-weight: bold; min-width: 180px; background-color: #fff; position: sticky; left: 0; z-index: 10; }
        .check-box { width: 20px; height: 20px; cursor: pointer; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        tr:hover { background-color: #e9ecef; }
        
        #acesso-negado { display: none; text-align: center; margin-top: 50px; }
    </style>
</head>
<body>
    <nav class="nav-voltar">
        <a href="/dashboard.html" class="btn-voltar">⬅ Voltar para o Dashboard</a>
    </nav>

    <div id="acesso-negado">
        <h1>Acesso Negado</h1>
        <p>Você não tem permissão para acessar esta página.</p>
    </div>

    <div id="main-content" style="display: none;">
        <div class="container">
            <h1>Escala Mediúnica Mensal</h1>
            
            <div class="controles">
                <div class="input-group">
                    <label for="mes-referencia"><strong>Mês/Ano:</strong></label>
                    <input type="month" id="mes-referencia">
                    <button id="btn-carregar" class="btn-acao btn-carregar">
                        <i class="fas fa-sync"></i> Carregar Escala
                    </button>
                </div>
                <button id="btn-salvar-escala" class="btn-acao btn-salvar">
                    <i class="fas fa-save"></i> Salvar Alterações
                </button>
            </div>

            <div class="table-responsive">
                <table id="tabela-escala">
                    <thead>
                        <tr>
                            <th rowspan="2" class="nome-col">Médium</th>
                            <th colspan="2" class="header-dia">Terça-feira</th>
                            <th colspan="2" class="header-dia">Quinta-feira</th>
                            <th colspan="2" class="header-dia">Sexta-feira</th>
                            <th class="header-dia">Sábado</th>
                            <th class="header-dia">Domingo (3º)</th>
                        </tr>
                        <tr>
                            <th>Harm. 19h</th>
                            <th>Salas 19h30</th>
                            <th>Vibra 19h20</th>
                            <th>Col. Med 19h</th>
                            <th>Harm. 19h</th>
                            <th>Trab. Med</th>
                            <th>Harm. 08:30</th>
                            <th>Cáritas 08:30</th>
                        </tr>
                    </thead>
                    <tbody id="lista-corpo">
                        <tr><td colspan="9">Selecione o mês e clique em carregar...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, setDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { protegerPagina } from '/auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU",
            authDomain: "voluntarios-ativos---cepat.firebaseapp.com",
            projectId: "voluntarios-ativos---cepat",
            storageBucket: "voluntarios-ativos---cepat.firebasestorage.app",
            messagingSenderId: "66122858261",
            appId: "1:66122858261:web:7fa21f1805463b5c08331c"
        };

        initializeApp(firebaseConfig);
        const db = getFirestore();

        protegerPagina(['super-admin', 'diretor', 'tesoureiro', 'conselheiro', 'entrevistador'])
            .then(() => {
                document.getElementById('main-content').style.display = 'block';
                inicializarPagina();
            })
            .catch(() => {
                document.getElementById('acesso-negado').style.display = 'block';
            });

        function inicializarPagina() {
            const inputMes = document.getElementById('mes-referencia');
            const btnCarregar = document.getElementById('btn-carregar');
            const btnSalvar = document.getElementById('btn-salvar-escala');
            const corpoTabela = document.getElementById('lista-corpo');

            const hoje = new Date();
            inputMes.value = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}`;

            async function buscarDadosEscala() {
                btnCarregar.disabled = true;
                corpoTabela.innerHTML = '<tr><td colspan="9">Buscando médiuns ativos...</td></tr>';
                
                try {
                    const q = query(collection(db, "voluntarios"), where("isMedium", "==", true), orderBy("nome"));
                    const snapMediuns = await getDocs(q);
                    const listaMediuns = snapMediuns.docs.map(d => ({ id: d.id, nome: d.data().nome }));

                    if (listaMediuns.length === 0) {
                        corpoTabela.innerHTML = '<tr><td colspan="9">Nenhum voluntário marcado como Médium encontrado. Verifique o cadastro de voluntários.</td></tr>';
                        return;
                    }

                    const idMes = inputMes.value; 
                    const escalaRef = doc(db, "escalas_mediunicas", idMes);
                    const escalaSnap = await getDoc(escalaRef);
                    const dadosSalvos = escalaSnap.exists() ? escalaSnap.data().escalados : {};

                    renderizarTabela(listaMediuns, dadosSalvos);
                } catch (error) {
                    console.error("Erro ao carregar:", error);
                    alert("Erro ao carregar dados. Verifique sua conexão ou se há voluntários marcados como médiuns.");
                } finally {
                    btnCarregar.disabled = false;
                }
            }

            function renderizarTabela(mediuns, dados) {
                corpoTabela.innerHTML = '';
                const trabalhos = [
                    'terca_19h_passe', 'terca_1930_salas', 
                    'quinta_1920_vibra', 'quinta_19h_col',
                    'sexta_19h_vinha', 'sexta_trab_med',
                    'sabado_0830_passe', 'domingo_caritas'
                ];

                mediuns.forEach(m => {
                    const tr = document.createElement('tr');
                    let html = `<td class="nome-col">${m.nome}</td>`;
                    
                    trabalhos.forEach(trab => {
                        const isChecked = dados[trab] && dados[trab].includes(m.id) ? 'checked' : '';
                        html += `<td><input type="checkbox" class="check-box" data-uid="${m.id}" data-job="${trab}" ${isChecked}></td>`;
                    });
                    
                    tr.innerHTML = html;
                    corpoTabela.appendChild(tr);
                });
            }

            btnSalvar.onclick = async () => {
                const idMes = inputMes.value;
                if (!idMes) return alert("Selecione um mês.");

                btnSalvar.disabled = true;
                const checkboxes = document.querySelectorAll('.check-box');
                const escalados = {};

                checkboxes.forEach(cb => {
                    if (cb.checked) {
                        const job = cb.dataset.job;
                        if (!escalados[job]) escalados[job] = [];
                        escalados[job].push(cb.dataset.uid);
                    }
                });

                try {
                    await setDoc(doc(db, "escalas_mediunicas", idMes), {
                        mesReferencia: idMes,
                        atualizadoEm: new Date(),
                        escalados: escalados
                    });
                    alert(`Escala de ${idMes} salva com sucesso!`);
                } catch (e) {
                    alert("Erro ao salvar escala: " + e.message);
                } finally {
                    btnSalvar.disabled = false;
                }
            };

            btnCarregar.onclick = buscarDadosEscala;
            
            // Carregar automaticamente ao abrir a página
            buscarDadosEscala();
        }
    </script>
</body>
</html>