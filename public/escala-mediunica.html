<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Gerenciar Escala Mediúnica Dinâmica</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f6f9; margin: 0; padding: 20px; }
        .container { background-color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 100%; max-width: 1400px; margin: 0 auto; }
        .controles { display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; gap: 10px; flex-wrap: wrap; }
        
        /* Tabela com scroll horizontal para muitas datas */
        .table-responsive { width: 100%; overflow-x: auto; border: 1px solid #ddd; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8em; }
        th, td { border: 1px solid #dee2e6; padding: 8px; text-align: center; min-width: 60px; }
        
        /* Cabeçalhos fixos */
        .nome-col { text-align: left; font-weight: bold; min-width: 180px; background-color: #fff; position: sticky; left: 0; z-index: 10; border-right: 2px solid #ddd; }
        th.nome-col { background-color: #34495e; color: white; }
        
        .header-data { background-color: #2c3e50; color: white; font-size: 0.9em; }
        .header-trabalho { background-color: #ecf0f1; font-size: 0.75em; font-weight: bold; color: #7f8c8d; }
        
        .btn-save { background-color: #2e7d32; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .check-box { width: 18px; height: 18px; cursor: pointer; }
        
        /* Cores por dia para facilitar visualização */
        .col-terca { border-left: 2px solid #3498db; }
        .col-quinta { border-left: 2px solid #e67e22; }
        .col-sexta { border-left: 2px solid #9b59b6; }
        .col-domingo { background-color: #fff3cd; }
    </style>
</head>
<body>
    <div class="container">
        <a href="/dashboard.html" style="text-decoration: none; color: #666;">⬅ Voltar</a>
        <h1 style="text-align: center;">Gestão de Escala Mediúnica</h1>
        
        <div class="controles">
            <div>
                <label><strong>Mês/Ano:</strong></label>
                <input type="month" id="mes-referencia">
                <button id="btn-gerar" class="btn-save" style="background-color: #0277BD;">Gerar Tabela</button>
            </div>
            <div id="status-save"></div>
            <button id="btn-salvar" class="btn-save">Salvar Escala Mensal</button>
        </div>

        <div class="table-responsive">
            <table id="tabela-escala">
                <thead id="thead-escala"></thead>
                <tbody id="tbody-escala">
                    <tr><td style="padding: 40px;">Selecione o mês e clique em "Gerar Tabela"</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, setDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { protegerPagina } from '/auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU",
            authDomain: "voluntarios-ativos---cepat.firebaseapp.com",
            projectId: "voluntarios-ativos---cepat",
            storageBucket: "voluntarios-ativos---cepat.firebasestorage.app",
            messagingSenderId: "66122858261",
            appId: "1:66122858261:web:7fa21f1805463b5c08331c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const inputMes = document.getElementById('mes-referencia');
        const thead = document.getElementById('thead-escala');
        const tbody = document.getElementById('tbody-escala');

        // Proteção de página
        protegerPagina(['super-admin', 'diretor', 'tesoureiro', 'conselheiro', 'entrevistador']);

        // Define mês atual (Janeiro 2026 conforme contexto)
        const hoje = new Date();
        inputMes.value = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}`;

        async function gerarEscala() {
            const [ano, mesStr] = inputMes.value.split('-');
            const mes = parseInt(mesStr) - 1;
            const datasNoMes = obterDatasTrabalho(ano, mes);
            
            // Busca Médiuns e Escala Salva
            const q = query(collection(db, "voluntarios"), where("isMedium", "==", true), orderBy("nome"));
            const [snapMediuns, snapEscala] = await Promise.all([
                getDocs(q),
                getDoc(doc(db, "escalas_mediunicas", inputMes.value))
            ]);
            
            const mediuns = snapMediuns.docs.map(d => ({ id: d.id, nome: d.data().nome }));
            const dadosSalvos = snapEscala.exists() ? snapEscala.data().escalados : {};

            renderizarTabela(datasNoMes, mediuns, dadosSalvos);
        }

        function obterDatasTrabalho(ano, mes) {
            let datas = [];
            let data = new Date(ano, mes, 1);
            let contadorDomingo = 0;

            while (data.getMonth() === mes) {
                let diaSemana = data.getDay(); // 0=Dom, 2=Ter, 4=Qui, 5=Sex, 6=Sab
                let diaMes = data.getDate();
                let dataFormatada = `${diaMes.toString().padStart(2, '0')}/${(mes + 1).toString().padStart(2, '0')}`;
                let idData = `${ano}-${(mes + 1).toString().padStart(2, '0')}-${diaMes.toString().padStart(2, '0')}`;

                if (diaSemana === 2) { // Terça
                    datas.push({ id: idData, label: dataFormatada, dia: 'Ter', trabalhos: ['Harm. 19h', 'Salas 19h30'], classe: 'col-terca' });
                } else if (diaSemana === 4) { // Quinta
                    datas.push({ id: idData, label: dataFormatada, dia: 'Qui', trabalhos: ['Vibra 19h20', 'Col. Med 19h'], classe: 'col-quinta' });
                } else if (diaSemana === 5) { // Sexta
                    datas.push({ id: idData, label: dataFormatada, dia: 'Sex', trabalhos: ['Harm. 19h', 'Trab. Med'], classe: 'col-sexta' });
                } else if (diaSemana === 6) { // Sábado
                    datas.push({ id: idData, label: dataFormatada, dia: 'Sáb', trabalhos: ['Harm. 08:30'] });
                } else if (diaSemana === 0) { // Domingo
                    contadorDomingo++;
                    if (contadorDomingo === 3) { // 3º Domingo (Cáritas)
                        datas.push({ id: idData, label: dataFormatada, dia: 'Dom', trabalhos: ['Cáritas 08:30'], classe: 'col-domingo' });
                    }
                }
                data.setDate(data.getDate() + 1);
            }
            return datas;
        }

        function renderizarTabela(datas, mediuns, dados) {
            // Cabeçalho - Linha 1: Datas
            let htmlHead = `<tr><th rowspan="2" class="nome-col">Médium</th>`;
            datas.forEach(d => {
                htmlHead += `<th colspan="${d.trabalhos.length}" class="header-data ${d.classe || ''}">${d.dia} ${d.label}</th>`;
            });
            htmlHead += `</tr><tr>`;

            // Cabeçalho - Linha 2: Trabalhos
            datas.forEach(d => {
                d.trabalhos.forEach(t => {
                    htmlHead += `<th class="header-trabalho">${t}</th>`;
                });
            });
            htmlHead += `</tr>`;
            thead.innerHTML = htmlHead;

            // Corpo da Tabela
            let htmlBody = '';
            mediuns.forEach(m => {
                htmlBody += `<tr><td class="nome-col">${m.nome}</td>`;
                datas.forEach(d => {
                    d.trabalhos.forEach(t => {
                        const idCheck = `${d.id}_${t.replace(/\s+/g, '_')}`;
                        const isChecked = dados[idCheck] && dados[idCheck].includes(m.id) ? 'checked' : '';
                        htmlBody += `<td><input type="checkbox" class="check-box" data-uid="${m.id}" data-key="${idCheck}" ${isChecked}></td>`;
                    });
                });
                htmlBody += `</tr>`;
            });
            tbody.innerHTML = htmlBody;
        }

        document.getElementById('btn-salvar').onclick = async () => {
            const checks = document.querySelectorAll('.check-box');
            const escalados = {};
            
            checks.forEach(c => {
                if (c.checked) {
                    const key = c.dataset.key;
                    if (!escalados[key]) escalados[key] = [];
                    escalados[key].push(c.dataset.uid);
                }
            });

            try {
                await setDoc(doc(db, "escalas_mediunicas", inputMes.value), {
                    escalados: escalados,
                    ultimaAtualizacao: new Date()
                });
                alert("Escala salva com sucesso!");
            } catch (e) { alert("Erro ao salvar: " + e.message); }
        };

        document.getElementById('btn-gerar').onclick = gerarEscala;
    </script>
</body>
</html>