<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cáritas - Gerador de Ofícios Institucionais</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --bg: #f4f6f9; --white: #ffffff; --primary: #2c3e50; --orange: #e67e22; --green: #27ae60; --grey: #7f8c8d; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .nav-header { width: 100%; max-width: 800px; display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; }
        .btn-voltar { background-color: var(--grey); color: white; padding: 10px 15px; border-radius: 8px; text-decoration: none; font-weight: bold; font-size: 0.9em; display: flex; align-items: center; gap: 8px; }
        .container { background: var(--white); padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); width: 100%; max-width: 800px; box-sizing: border-box; }
        h1 { color: var(--primary); margin-top: 0; border-bottom: 2px solid var(--orange); padding-bottom: 10px; }
        .form-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
        label { font-weight: bold; font-size: 0.9em; color: var(--primary); }
        input, select, textarea { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1em; width: 100%; box-sizing: border-box; }
        .btn-gerar { background: var(--green); color: white; border: none; padding: 15px; border-radius: 8px; width: 100%; font-size: 1.1em; font-weight: bold; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px; transition: 0.3s; }
        .btn-gerar:hover { background: #219150; }
        .alert-warm { background: #fff3e0; border-left: 4px solid var(--orange); padding: 15px; margin-bottom: 20px; font-size: 0.9em; color: #5d4037; }
    </style>
</head>
<body>

    <header class="nav-header">
        <a href="/modulo-caritas.html" class="btn-voltar"><i class="fas fa-arrow-left"></i> Painel Cáritas</a>
        <img src="/logo-cepat.png" alt="Logo" style="height: 50px;">
    </header>

    <main class="container">
        <h1><i class="fas fa-heart"></i> Emissor de Ofícios Solidários</h1>
        
        <div class="alert-warm">
            Este modelo utiliza uma linguagem mais acolhedora, focada na missão de amparo às famílias da nossa região.
        </div>

        <form id="form-oficio">
            <div class="form-group">
                <label>Estabelecimento / Destinatário</label>
                <input type="text" id="destinatario" placeholder="Ex: À Gerência do Supermercado Crema" required>
            </div>

            <div class="form-group">
                <label>Estratégia do Pedido</label>
                <select id="tipo-lista">
                    <option value="completa">Lista Institucional (Apresentar todos os itens necessários)</option>
                    <option value="faltantes">Lista de Urgência (Focar apenas no que falta no estoque)</option>
                </select>
            </div>

            <div class="form-group">
                <label>Mensagem Personalizada (Opcional)</label>
                <textarea id="observacoes" rows="3" placeholder="Algo específico sobre esta entrega ou agradecimento especial..."></textarea>
            </div>

            <button type="submit" class="btn-gerar" id="btn-submit">
                <i class="fas fa-file-pdf"></i> GERAR OFÍCIO HUMANIZADO
            </button>
        </form>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, doc, getDoc, getDocs, setDoc, runTransaction, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";
        import { protegerPagina } from '/auth.js';

        const firebaseConfig = { apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU", authDomain: "voluntarios-ativos---cepat.firebaseapp.com", projectId: "voluntarios-ativos---cepat", storageBucket: "voluntarios-ativos---cepat.firebasestorage.app", messagingSenderId: "66122858261", appId: "1:66122858261:web:7fa21f1805463b5c08331c" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const DADOS_CASA = { 
            nome: "CASA ESPÍRITA PAULO DE TARSO", 
            cnpj: "12.253.749/0001-20", 
            endereco: "RUA DO CROMO, 780, VL. PANTANO II - SANTA BÁRBARA D'OESTE - SP", 
            cidade: "Santa Bárbara D'Oeste" 
        };

        protegerPagina(['super-admin', 'diretor', 'caritas']);

        document.getElementById('form-oficio').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            btn.disabled = true;

            try {
                const counterRef = doc(db, "counters", "oficios_caritas");
                let num = 0;
                await runTransaction(db, async (t) => {
                    const snap = await t.get(counterRef);
                    num = snap.exists() ? snap.data().lastNumber + 1 : 1;
                    t.set(counterRef, { lastNumber: num });
                });

                const configSnap = await getDoc(doc(db, "configuracoes", "cesta_padrao"));
                const estoqueSnap = await getDocs(collection(db, "estoque_caritas"));
                
                const meta = configSnap.data()?.meta || 14;
                const itensCesta = configSnap.data()?.itens || {};
                const saldoEstoque = {}; const nomesProdutos = {};
                estoqueSnap.forEach(d => { saldoEstoque[d.id] = d.data().quantidade || 0; nomesProdutos[d.id] = d.data().nome; });

                const tipo = document.getElementById('tipo-lista').value;
                let lista = [];

                Object.entries(itensCesta).forEach(([id, qtdPorCesta]) => {
                    const totalNec = qtdPorCesta * meta;
                    const falta = Math.max(0, totalNec - (saldoEstoque[id] || 0));
                    if (tipo === 'completa') {
                        lista.push({ nome: nomesProdutos[id] || id, qtd: "" });
                    } else if (tipo === 'faltantes' && falta > 0) {
                        lista.push({ nome: nomesProdutos[id] || id, qtd: `${falta} un.` });
                    }
                });

                await gerarPDF(num, lista, tipo);

                await setDoc(doc(db, "oficios_emitidos", `OF_${num}_2026`), {
                    numero: num, ano: 2026, destinatario: document.getElementById('destinatario').value, data: serverTimestamp(), tipo: tipo
                });

                alert(`Ofício Solidário ${num}/2026 gerado com sucesso!`);
            } catch (err) { alert("Erro: " + err.message); }
            finally { btn.disabled = false; }
        };

        async function gerarPDF(num, itens, tipo) {
        const { jsPDF } = window.jspdf;
        const docPdf = new jsPDF();
        const dataStr = new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });

        // CABEÇALHO (Papel Timbrado)
        docPdf.setFontSize(14).setFont("helvetica", "bold").text(DADOS_CASA.nome, 105, 20, { align: "center" });
        docPdf.setFontSize(10).setFont("helvetica", "normal").text(`CNPJ: ${DADOS_CASA.cnpj}`, 105, 26, { align: "center" });
        docPdf.text(DADOS_CASA.endereco, 105, 31, { align: "center" });
        docPdf.line(20, 35, 190, 35);

        docPdf.setFontSize(12).text(`${DADOS_CASA.cidade}, ${dataStr}`, 190, 45, { align: "right" });
        docPdf.setFont("helvetica", "bold").text(`OFÍCIO CÁRITAS Nº ${num}/2026`, 20, 55);

        docPdf.setFont("helvetica", "normal").text(`Ao Sr(a). Responsável do`, 20, 65);
        docPdf.setFont("helvetica", "bold").text(document.getElementById('destinatario').value, 20, 70);

        const textoAbertura = "Ao cumprimentá-lo(a) cordialmente, a Casa Espírita Paulo de Tarso, instituição sem fins lucrativos, vem, por meio deste, solicitar a valorosa colaboração de sua conceituada empresa para a nossa obra de caridade.";
        const textoMissao = "Nossa instituição desenvolve um trabalho contínuo de assistência social em Santa Bárbara D'Oeste, visando amparar famílias em situação de vulnerabilidade através do projeto CÁRITAS.";
        const textoAcao = "Para fortalecer nossas ações e garantir o atendimento digno, necessitamos de doações dos itens abaixo relacionados:";

        let cursorY = 85;
        [textoAbertura, textoMissao, textoAcao].forEach(txt => {
            const lines = docPdf.splitTextToSize(txt, 170);
            docPdf.text(lines, 20, cursorY);
            cursorY += (lines.length * 7);
        });

        const head = tipo === 'completa' ? [['Item']] : [['Item', 'Necessidade Atual']];
        const body = itens.map(i => tipo === 'completa' ? [i.nome] : [i.nome, i.qtd]);

        docPdf.autoTable({
            startY: cursorY + 5,
            head: head,
            body: body,
            theme: 'grid',
            headStyles: { fillGray: 230, textColor: 0, fontStyle: 'bold' }
        });

        // FECHAMENTO DINÂMICO (CORREÇÃO DE SOBREPOSIÇÃO)
        let currentY = docPdf.lastAutoTable.finalY + 15;
        const textoFechamento = "Toda a doação recebida será destinada integralmente às famílias assistidas. Certos de sua generosidade e compromisso com o bem-estar da nossa comunidade, agradecemos antecipadamente pela atenção e apoio.";
        const linesFim = docPdf.splitTextToSize(textoFechamento, 170);
        
        // Verifica se cabe na página antes de escrever
        if (currentY + 40 > 280) { docPdf.addPage(); currentY = 25; }
        
        docPdf.setFont("helvetica", "normal").text(linesFim, 20, currentY);
        currentY += (linesFim.length * 7) + 5;

        const obs = document.getElementById('observacoes').value;
        if (obs) {
            docPdf.setFont("helvetica", "italic").text(docPdf.splitTextToSize(`Obs: ${obs}`, 170), 20, currentY);
            currentY += 15;
        }

        // ASSINATURA (POSIÇÃO DINÂMICA E TAMANHO REDUZIDO)
        const sigY = Math.max(currentY + 20, 245); // Tenta manter no fundo, mas respeita o texto
        try {
            const sigUrl = await getDownloadURL(ref(storage, "handwritten-tcfTNx.png"));
            // Tamanho menor (35x11) para evitar pixelado e sobreposição
            docPdf.addImage(sigUrl, 'PNG', 88, sigY - 18, 35, 11); 
        } catch (e) { console.warn("Assinatura offline."); }
        
        docPdf.setFont("helvetica", "bold").setFontSize(11).text("Márcia Camacho", 105, sigY, { align: "center" });
        docPdf.setFontSize(9).setFont("helvetica", "normal").text("Presidente - Casa Espírita Paulo de Tarso", 105, sigY + 5, { align: "center" });

        docPdf.save(`Oficio_Solidario_Caritas_${num}.pdf`);
    }
</script>
</body>
</html>