<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Gerenciar Cardápio da Cantina</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f6f9; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; box-sizing: border-box; }
        .nav-voltar { max-width: 900px; width:100%; margin: 0 auto 30px auto; text-align: left; }
        .btn-voltar { background-color: #e9ecef; color: #495057; border: 1px solid #dee2e6; padding: 10px 20px; border-radius: 8px; font-weight: bold; font-size: 1em; text-decoration: none; }
        .container { background-color: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); width: 100%; max-width: 900px; margin-bottom: 30px; }
        h1, h2 { text-align: center; color: #333; margin-top: 0; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-item { display: flex; flex-direction: column; }
        .form-item label { margin-bottom: 5px; font-weight: bold; color: #555; }
        .form-item input, .form-item select, .form-item textarea { padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 1em; }
        .form-actions { grid-column: 1 / -1; display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn { padding: 12px 25px; border: none; border-radius: 6px; font-size: 1em; font-weight: bold; cursor: pointer; }
        .btn-primary { background-color: #28a745; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 30px; }
        th, td { padding: 12px 15px; border-bottom: 1px solid #eee; text-align: left; }
        th { background-color: #f8f9fa; }
        
        /* Estilos para o Checkbox de Disponível */
        .disponivel-col { text-align: center; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #28a745; }
        input:checked + .slider:before { transform: translateX(22px); }

        .actions-table button { margin-right: 5px; padding: 5px 10px; border-radius: 4px; cursor: pointer; border: 1px solid #ccc; }
        .btn-edit { background-color: #007bff; color: white; }
        .btn-delete { background-color: #dc3545; color: white; }
    </style>
</head>
<body>
    <nav class="nav-voltar">
        <a href="/dashboard.html" class="btn-voltar">⬅ Voltar para o Dashboard</a>
    </nav>
    <div id="acesso-negado" style="display: none;"><h1>Acesso Negado</h1></div>

    <div id="main-content" class="container" style="display: none;">
        <h1>Gerenciar Cardápio "Amor e Luz"</h1>
        <form id="form-item-cantina">
            <p style="text-align: center; margin-top: 0; color: #555;">Use este formulário para adicionar novos itens ao inventário da cantina.</p>
            <input type="hidden" id="itemId">
            <div class="form-grid">
                <div class="form-item"><label for="nome">Nome do Item</label><input type="text" id="nome" required></div>
                <div class="form-item"><label for="categoria">Categoria</label><select id="categoria" required><option value="Salgados">Salgados</option><option value="Doces">Doces</option><option value="Bebidas">Bebidas</option><option value="Outros">Outros</option></select></div>
                <div class="form-item"><label for="preco">Preço (R$)</label><input type="number" id="preco" step="0.01" required></div>
                <div class="form-item"><label for="descricao">Descrição (opcional)</label><input type="text" id="descricao"></div>
            </div>
            <div class="form-actions">
                <button type="button" id="btn-cancelar" class="btn btn-secondary" style="display: none;">Cancelar</button>
                <button type="submit" class="btn btn-primary">Salvar Item</button>
            </div>
        </form>
        <hr style="margin: 40px 0;">
        <h2>Inventário da Cantina (Cardápio Mestre)</h2>
        <p style="text-align: center; margin-top: 0; color: #555;">Marque um item como "Disponível" para que ele apareça no cardápio do dia e no PDV.</p>
        <table id="tabela-itens">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Categoria</th>
                    <th>Preço</th>
                    <th class="disponivel-col">Disponível Hoje?</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, setDoc, getDoc, deleteDoc, query, orderBy, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-functions.js";
        import { protegerPagina } from '/auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU",
            authDomain: "voluntarios-ativos---cepat.firebaseapp.com",
            projectId: "voluntarios-ativos---cepat",
            storageBucket: "voluntarios-ativos---cepat.firebasestorage.app",
            messagingSenderId: "66122858261",
            appId: "1:66122858261:web:7fa21f1805463b5c08331c"
        };
        initializeApp(firebaseConfig);

        protegerPagina(['super-admin', 'diretor', 'tesoureiro', 'conselheiro', 'produtor-evento'])
            .then(user => {
                document.getElementById('main-content').style.display = 'block';
                inicializarPagina(user);
            });
        
        function inicializarPagina(user) {
            const db = getFirestore();
            const functions = getFunctions(undefined, 'southamerica-east1');
            const registrarLogDeAcesso = httpsCallable(functions, 'registrarLogDeAcesso');
            const form = document.getElementById('form-item-cantina');
            const tabelaItens = document.getElementById('tabela-itens').querySelector('tbody');

            // A função carregarEventos() foi removida.

            const carregarItens = () => {
                // Query simplificada para buscar TODOS os itens, ordenados por categoria e nome
                const qItens = query(
                    collection(db, "cantina_itens"), 
                    orderBy("categoria"), 
                    orderBy("nome")
                );

                onSnapshot(qItens, (snapshot) => {
                    const itens = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    tabelaItens.innerHTML = '';
                    itens.forEach(item => {
                        const tr = document.createElement('tr');
                        const isDisponivel = item.disponivelHoje === true;
                        
                        tr.innerHTML = `
                            <td><strong>${item.nome}</strong><br><small>${item.descricao || ''}</small></td>
                            <td>${item.categoria}</td>
                            <td>${Number(item.preco).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                            <td class="disponivel-col">
                                <label class="switch">
                                    <input type="checkbox" class="toggle-disponivel" data-id="${item.id}" ${isDisponivel ? 'checked' : ''}>
                                    <span class="slider"></span>
                                </label>
                            </td>
                            <td class="actions-table">
                                <button class="btn-edit" data-id="${item.id}">Editar</button>
                                <button class="btn-delete" data-id="${item.id}">Apagar</button>
                            </td>
                        `;
                        tabelaItens.appendChild(tr);
                    });
                }, (error) => {
                    console.error("Erro ao carregar itens da cantina:", error);
                    tabelaItens.innerHTML = '<tr><td colspan="5">Ocorreu um erro ao carregar os itens.</td></tr>';
                });
            };

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // Lógica de evento removida
                const item = {
                    nome: document.getElementById('nome').value,
                    categoria: document.getElementById('categoria').value,
                    preco: parseFloat(document.getElementById('preco').value),
                    descricao: document.getElementById('descricao').value,
                };
                const id = document.getElementById('itemId').value;

                if (id) {
                    // Se está editando, apenas atualiza os dados do item
                    await setDoc(doc(db, 'cantina_itens', id), item, { merge: true });
                    registrarLogDeAcesso({ acao: 'EDITOU_ITEM_CANTINA', detalhes: { itemId: id, nome: item.nome } });
                    alert('Item atualizado com sucesso!');
                } else {
                    // Se está criando, adiciona os campos de controle
                    item.criadoEm = serverTimestamp();
                    item.disponivelHoje = false; // Por padrão, um item novo não está disponível
                    const docRef = await addDoc(collection(db, 'cantina_itens'), item);
                    registrarLogDeAcesso({ acao: 'CRIOU_ITEM_CANTINA', detalhes: { itemId: docRef.id, nome: item.nome } });
                    alert('Item salvo com sucesso!');
                }
                form.reset();
                document.getElementById('itemId').value = '';
                document.getElementById('btn-cancelar').style.display = 'none';
            });
            
            // NOVO LISTENER: Para o clique no Checkbox "Disponível Hoje?"
            tabelaItens.addEventListener('change', async (e) => {
                if (e.target.classList.contains('toggle-disponivel')) {
                    const id = e.target.dataset.id;
                    const novoStatus = e.target.checked;
                    
                    const itemRef = doc(db, 'cantina_itens', id);
                    try {
                        await updateDoc(itemRef, {
                            disponivelHoje: novoStatus
                        });
                        console.log(`Item ${id} atualizado para ${novoStatus}`);
                    } catch (err) {
                        console.error("Erro ao atualizar status do item: ", err);
                        alert("Erro ao mudar o status do item.");
                        // Reverte o checkbox em caso de falha
                        e.target.checked = !novoStatus;
                    }
                }
            });

            tabelaItens.addEventListener('click', async (e) => {
                const target = e.target;
                const id = target.dataset.id;
                if (!id) return;

                if (target.classList.contains('btn-edit')) {
                    const docRef = doc(db, 'cantina_itens', id);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        document.getElementById('itemId').value = id;
                        // Campo 'evento' removido
                        document.getElementById('nome').value = data.nome;
                        document.getElementById('categoria').value = data.categoria;
                        document.getElementById('preco').value = data.preco;
                        document.getElementById('descricao').value = data.descricao || '';
                        document.getElementById('btn-cancelar').style.display = 'inline-block';
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                } else if (target.classList.contains('btn-delete')) {
                    if (confirm('Tem certeza que deseja apagar este item PERMANENTEMENTE do inventário?')) {
                        const docRef = doc(db, 'cantina_itens', id);
                        const docSnap = await getDoc(docRef);
                        const nomeItem = docSnap.exists() ? docSnap.data().nome : 'Item Desconhecido';
                        
                        await deleteDoc(docRef);
                        registrarLogDeAcesso({ acao: 'APAGOU_ITEM_CANTINA', detalhes: { itemId: id, nome: nomeItem } });
                    }
                }
            });

            document.getElementById('btn-cancelar').addEventListener('click', () => {
                form.reset();
                document.getElementById('itemId').value = '';
                document.getElementById('btn-cancelar').style.display = 'none';
            });

            // carregarEventos() foi removido daqui
            carregarItens();
        }
    </script>
</body>
</html>