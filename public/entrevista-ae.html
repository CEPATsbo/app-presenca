<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entrevista - Assistência Espiritual</title>
    <style>
        :root { --cor-primaria: #007bff; --cor-borda: #ddd; --fundo-desabilitado: #f9f9f9; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .container { width: 100%; max-width: 900px; background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 6px 24px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .nav-voltar { width: 100%; max-width: 900px; margin-bottom: 20px; }
        .btn, .btn-voltar { background-color: var(--cor-primaria); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; font-size: 1em; text-decoration: none; cursor: pointer; transition: background-color 0.3s; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-voltar { background-color: #6c757d; }
        .btn-success { background-color: #28a745; }
        .btn-secondary { background-color: #6c757d; }
        .btn-danger { background-color: #dc3545; }
        h1, h2, h3, h4 { color: #333; text-align: center; }
        fieldset { border: 1px solid var(--cor-borda); border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        legend { font-weight: bold; font-size: 1.2em; color: #0056b3; padding: 0 10px; }
        .form-item { display: flex; flex-direction: column; }
        .form-item label { margin-bottom: 5px; font-weight: bold; color: #555; }
        .form-item input, .form-item select, .form-item textarea { padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 1em; width: 100%; box-sizing: border-box; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end; }
        .hidden { display: none; }
        .grid-entrevista { display: grid; grid-template-columns: 250px 1fr; gap: 20px; }
        #lista-fila { list-style-type: none; padding: 0; margin: 0; max-height: 70vh; overflow-y: auto; }
        #lista-fila li { padding: 15px; border: 1px solid var(--cor-borda); border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: background-color 0.2s; }
        #lista-fila li.selecionado { background-color: #cce5ff; border-color: var(--cor-primaria); font-weight: bold; }
        .multiselect { position: relative; }
        .select-box { border: 1px solid #ccc; border-radius: 6px; padding: 10px; cursor: pointer; }
        .checkboxes { position: absolute; background: white; border: 1px solid var(--cor-borda); border-radius: 6px; z-index: 100; max-height: 150px; overflow-y: auto; padding: 5px; width: 100%; box-sizing: border-box; }
        .actions-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        @media (max-width: 768px) { .grid-entrevista { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <nav class="nav-voltar"><a href="/dashboard.html" class="btn-voltar">⬅ Voltar para o Dashboard</a></nav>
    <div id="acesso-negado" class="container hidden"><h1>Acesso Negado</h1></div>

    <div id="main-content" class="container hidden">
        <h1>Painel de Entrevistas</h1>
        <p style="text-align: center; margin-top: -10px;">Selecione um assistido da fila para registrar o atendimento.</p>
        <div class="grid-entrevista">
            <div>
                <h3>Aguardando Entrevista</h3>
                <ul id="lista-fila"></ul>
            </div>
            <div id="painel-formulario">
                <h3>Ficha de Atendimento</h3>
                <div id="formulario-container">
                    <p>Selecione um assistido à esquerda.</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, onSnapshot, updateDoc, query, where, orderBy, Timestamp, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { protegerPagina } from '/auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU",
            authDomain: "voluntarios-ativos---cepat.firebaseapp.com",
            projectId: "voluntarios-ativos---cepat",
            storageBucket: "voluntarios-ativos---cepat.firebasestorage.app",
            messagingSenderId: "66122858261",
            appId: "1:66122858261:web:7fa21f1805463b5c08331c"
        };
        initializeApp(firebaseConfig);

        protegerPagina(['entrevistador', 'diretor', 'super-admin']).then(user => {
            document.getElementById('main-content').classList.remove('hidden');
            inicializarPagina(user);
        }).catch(err => {
            document.getElementById('acesso-negado').classList.remove('hidden');
            document.getElementById('main-content').classList.add('hidden');
        });

        function inicializarPagina(user) {
            const db = getFirestore();
            const filaRef = collection(db, 'fila_atendimento_ae');
            const tratamentosRef = collection(db, 'tratamentos_ae');
            const atendimentosRef = collection(db, 'atendimentos_ae');
            
            const ui = {
                listaFila: document.getElementById('lista-fila'),
                formularioContainer: document.getElementById('formulario-container'),
            };

            const hojeInicio = new Date();
            hojeInicio.setHours(0, 0, 0, 0);

            const qFila = query(filaRef, 
                where("chegadaEm", ">=", Timestamp.fromDate(hojeInicio)), 
                where("status", "==", "chamado_entrevista"), 
                orderBy("chegadaEm", "asc")
            );

            onSnapshot(qFila, (snapshot) => {
                ui.listaFila.innerHTML = '';
                if (snapshot.empty) {
                    ui.listaFila.innerHTML = '<li>Ninguém na fila.</li>';
                    return;
                }
                snapshot.forEach(doc => {
                    const atendimento = { id: doc.id, ...doc.data() };
                    const li = document.createElement('li');
                    li.textContent = atendimento.nomeAssistido;
                    li.dataset.atendimentoId = atendimento.id;
                    li.addEventListener('click', () => carregarFormulario(atendimento));
                    ui.listaFila.appendChild(li);
                });
            });

            async function carregarFormulario(atendimento) {
                document.querySelectorAll('#lista-fila li').forEach(el => el.classList.remove('selecionado'));
                document.querySelector(`li[data-atendimento-id="${atendimento.id}"]`).classList.add('selecionado');
                ui.formularioContainer.innerHTML = '<p>Carregando dados do tratamento...</p>';

                if (!atendimento.tratamentoId) {
                    ui.formularioContainer.innerHTML = '<p class="erro">Erro: Este atendimento não está vinculado a uma assistência.</p>';
                    return;
                }

                const tratamentoDoc = await getDoc(doc(db, 'tratamentos_ae', atendimento.tratamentoId));
                if (!tratamentoDoc.exists()) {
                    ui.formularioContainer.innerHTML = '<p class="erro">Erro: Ciclo de assistência não encontrado.</p>';
                    return;
                }
                const tratamento = { id: tratamentoDoc.id, ...tratamentoDoc.data() };

                const qSemanas = query(atendimentosRef, where("tratamentoId", "==", tratamento.id), where("tipo", "!=", "falta"));
                const semanasSnapshot = await getDocs(qSemanas);
                const semanaNum = semanasSnapshot.size; 

                const passe = tratamento.passe_ciclo_atual;
                
                let formHtml = '';
                if (semanaNum === 0) { // Primeira vez absoluta
                    formHtml = criarFormularioPrimeiraVez(tratamento);
                } else if (semanaNum === 4) { // Quinta semana (índice 4) é a de reavaliação
                    formHtml = criarFormularioSemanal(semanaNum + 1, passe, true); 
                } else if (passe === 'P3A' || passe === 'P3B' || semanaNum === 3) { // 4a semana é índice 3
                    formHtml = criarFormularioSemanal(semanaNum + 1, passe, false);
                } else {
                    formHtml = `<p>Este assistido não requer entrevista completa hoje. Apenas confirme o encaminhamento para o passe no tablet.</p>`;
                }
                ui.formularioContainer.innerHTML = formHtml;

                // Adicionar listeners para os botões e componentes do formulário recém-criado
                document.getElementById('btn-salvar-entrevista')?.addEventListener('click', () => salvarEntrevista(atendimento, tratamento, semanaNum + 1));
            }

            // FUNÇÃO COMPLETA
            const gerarOpcoesPasse = (selecionado = '') => {
                const passes = ['P1', 'P2', 'P3A', 'P3B', 'P4A', 'P4B', 'CH'];
                let html = '<option value="">Selecione...</option>';
                passes.forEach(p => { html += `<option value="${p}" ${p === selecionado ? 'selected' : ''}>${p}</option>`; });
                return html;
            };

            function criarFormularioPrimeiraVez(tratamento) {
                const entrevista = tratamento.primeiraEntrevista;
                return `
                    <fieldset>
                        <legend>ENTREVISTA DE 1ª VEZ OU DE REINICIO</legend>
                        <div class="form-grid">
                            <div class="form-item"><label>DATA:</label><input type="text" value="${entrevista.data.toDate().toLocaleDateString('pt-BR')}" disabled></div>
                            <div class="form-item"><label>ENTREVISTADOR:</label><input type="text" id="entrevistador-nome" value="${entrevista.entrevistador}" required></div>
                        </div>
                        <div class="form-item" style="margin-top: 15px;">
                            <label for="entrevista-notas">Descrição da Entrevista:</label>
                            <textarea id="entrevista-notas" rows="10">${entrevista.notas || ''}</textarea>
                        </div>
                        <div class="actions-grid" style="margin-top: 15px;">
                            <button id="btn-salvar-entrevista" type="button" class="btn btn-success" style="grid-column: 1 / -1;">Salvar Entrevista</button>
                        </div>
                    </fieldset>
                `;
            }

            function criarFormularioSemanal(semanaNum, passeDe, mostrarColegiado) {
                const dataHoje = new Date().toISOString().split('T')[0];
                let colegiadoHtml = '';
                if (mostrarColegiado) {
                    colegiadoHtml = `<hr><h5>Colegiado</h5>
                        <div class="form-grid">
                            <div class="form-item"><label for="colegiado-de">DE:</label><select id="colegiado-de" disabled>${gerarOpcoesPasse(passeDe)}</select></div>
                            <div class="form-item"><label for="colegiado-para">PARA:</label><select id="colegiado-para">${gerarOpcoesPasse()}</select></div>
                        </div>
                        <div class="form-item" style="margin-top:15px;"><label>Encaminhamentos:</label><div class="multiselect">
                            <div class="select-box" tabindex="0">Selecione...</div>
                            <div id="retorno-encaminhamentos-opcoes" class="checkboxes hidden">
                                <label><input type="checkbox" value="ENL"/> ENL</label><label><input type="checkbox" value="Leituras"/> Leituras</label>
                                <label><input type="checkbox" value="EAE"/> EAE</label><label><input type="checkbox" value="Voluntariado"/> Voluntariado</label>
                                <label><input type="checkbox" value="Médico"/> Médico</label><label><input type="checkbox" value="Alimento"/> Alimento</label>
                                <label><input type="checkbox" value="Natureza"/> Natureza</label><label><input type="checkbox" value="Mocidade"/> Mocidade</label>
                                <label><input type="checkbox" value="Evangelização"/> Evangelização</label>
                            </div></div></div>
                        <div class="form-grid" style="margin-top:15px;"><div class="form-item"><label for="colegiado-data">Data:</label><input type="date" id="colegiado-data"></div><div class="form-item"><label for="colegiado-resp">Responsável:</label><input type="text" id="colegiado-resp"></div></div>
                        <button id="btn-dar-alta" type="button" class="btn btn-danger" style="width: 100%; margin-top: 10px;">Dar Alta</button>
                    `;
                }
                return `<fieldset><legend>Registro da ${semanaNum}ª Semana</legend>
                    <div class="form-grid"><div class="form-item"><label>Data:</label><input type="date" value="${dataHoje}" disabled></div><div class="form-item"><label for="entrevistador-nome">Entrevistador:</label><input type="text" id="entrevistador-nome" required></div></div>
                    <div class="form-item" style="margin-top: 15px;"><label for="entrevista-notas">Descrição da Entrevista:</label><textarea id="entrevista-notas" rows="4"></textarea></div>
                    <hr><h5>Entrevista</h5><div class="form-grid"><div class="form-item"><label for="retorno-passe">Passe:</label><select id="retorno-passe" required>${gerarOpcoesPasse(passeDe)}</select></div><div class="form-item"><label for="retorno-inicio">Início:</label><input type="time" id="retorno-inicio"></div><div class="form-item"><label for="retorno-fim">Fim:</label><input type="time" id="retorno-fim"></div></div>
                    <div class="form-item" style="margin-top:15px;"><label>Evolução:</label><div style="display:flex; gap: 15px;"><label><input type="radio" name="evolucao" value="melhorou"> Melhorou</label><label><input type="radio" name="evolucao" value="piorou"> Piorou</label><label><input type="radio" name="evolucao" value="na_mesma" checked> Na Mesma</label></div></div>
                    ${colegiadoHtml}
                    <button id="btn-salvar-entrevista" type="button" class="btn btn-primary" style="width: 100%; margin-top: 20px;">Salvar Atendimento da Semana</button>
                </fieldset>`;
            }
            
            async function salvarEntrevista(atendimento, tratamento, semanaNum) {
                // Lógica de salvamento virá aqui
                console.log("Salvando dados para:", atendimento, tratamento, "Semana:", semanaNum);
                alert("Lógica de salvamento a ser implementada.");
            }
        }
    </script>
</body>
</html>