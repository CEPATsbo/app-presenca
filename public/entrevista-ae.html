<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Atendimento - AE</title>
    <style>
        :root { --cor-primaria: #007bff; --cor-borda: #ddd; --fundo-desabilitado: #e9ecef; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .container { width: 100%; max-width: 900px; background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 6px 24px rgba(0,0,0,0.1); margin: auto; }
        .nav-voltar { width: 100%; max-width: 900px; margin: auto; margin-bottom: 20px; }
        .btn, .btn-voltar { background-color: var(--cor-primaria); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; font-size: 1em; text-decoration: none; cursor: pointer; transition: background-color 0.3s; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-voltar { background-color: #6c757d; }
        .btn-success { background-color: #28a745; }
        .btn-danger { background-color: #dc3545; }
        .btn-secondary { background-color: #6c757d; }
        h1, h3 { color: #333; text-align: center; }
        fieldset { border: 1px solid var(--cor-borda); border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        legend { font-weight: bold; font-size: 1.2em; color: #0056b3; padding: 0 10px; }
        .form-item { display: flex; flex-direction: column; }
        .form-item label { margin-bottom: 5px; font-weight: bold; color: #555; }
        .form-item input, .form-item select, .form-item textarea, .form-item .readonly-input { padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 1em; width: 100%; box-sizing: border-box; }
        .form-item .readonly-input { background-color: var(--fundo-desabilitado); }
        .form-item input:disabled, .form-item select:disabled, .form-item textarea:disabled { background-color: var(--fundo-desabilitado); cursor: not-allowed; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end; }
        .multiselect { position: relative; }
        .select-box { border: 1px solid #ccc; border-radius: 6px; padding: 10px; cursor: pointer; background-color: #fff; min-height: 1.5em; }
        .select-box[disabled] { background-color: var(--fundo-desabilitado); cursor: not-allowed; }
        
        /* --- INﾃ垢IO DAS MODIFICAﾃﾃ髭S CSS (Checkboxes) --- */
        .checkboxes {
            display: none; position: absolute; background: white; border: 1px solid var(--cor-borda);
            border-radius: 6px; z-index: 100; max-height: 200px; overflow-y: auto;
            padding: 5px 10px; 
            /* width: 100%; */ /* REMOVIDO */
            box-sizing: border-box;
            top: 100%;
            margin-top: 2px;
            left: 0;
            /* NOVO: Define uma largura mﾃ｡xima e mﾃｭnima */
            max-width: 300px; 
            width: max-content; 
            min-width: 200px;
        }
        .checkboxes label {
            display: flex;
            align-items: center;
            gap: 4px; /* Diminui o espaﾃｧo */
            padding: 5px 0; /* Espaﾃｧamento vertical */
            margin: 0;
            cursor: pointer;
            font-size: 0.95em;
        }
        .checkboxes label input[type="checkbox"] {
             margin: 0;
             flex-shrink: 0;
        }
        /* --- FIM DAS MODIFICAﾃﾃ髭S CSS --- */
        
        .checkboxes.visible { display: block; }
        .erro { color: #dc3545; font-weight: bold; text-align: center; }
        .hidden { display: none; }
        .botoes-colegiado { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .data-aviso { font-weight: bold; color: #0056b3; }
        .colegiado-travado p { text-align:center; font-weight: bold; }
        .colegiado-travado .status-alta { color: #dc3545; }
        .colegiado-travado .status-novo-ciclo { color: #007bff; }

    </style>
</head>
<body>
    {/* */}
    <nav class="nav-voltar"><a href="#" id="btn-voltar-fecha" class="btn-voltar">筮 Voltar para o Painel AE (Fecha Aba)</a></nav>
    <div id="acesso-negado" class="container hidden"><h1>Acesso Negado</h1></div>

    <div id="main-content" class="container">
        <h1>Detalhes do Atendimento</h1>
        <p style="text-align: center; margin-top: -10px;">Adicione ou edite as informaﾃｧﾃｵes do atendimento.</p>
        <div id="formulario-container">
            <p>Carregando dados do atendimento...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, updateDoc, query, where, Timestamp, getDocs, writeBatch, serverTimestamp, limit, addDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { protegerPagina } from '/auth.js';

        // ===================================================================
        // CORREﾃﾃグ DO ERRO (app/duplicate-app)
        // A config do Firebase ainda ﾃｩ necessﾃ｡ria se o auth.js nﾃ｣o a exportar,
        // mas a INICIALIZAﾃﾃグ (initializeApp) ﾃｩ removida.
        // ===================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU",
            authDomain: "voluntarios-ativos---cepat.firebaseapp.com",
            projectId: "voluntarios-ativos---cepat",
            storageBucket: "voluntarios-ativos---cepat.firebasestorage.app",
            messagingSenderId: "66122858261",
            appId: "1:66122858261:web:7fa21f1805463b5c08331c"
        };
        // initializeApp(firebaseConfig); // <-- LINHA REMOVIDA (Esta era a causa do erro)
        const auth = getAuth(); // Apenas obtemos o auth; a app jﾃ｡ foi iniciada pelo auth.js
        // ===================================================================
        // FIM DA CORREﾃﾃグ
        // ===================================================================

        protegerPagina(['entrevistador', 'tesoureiro', 'conselheiro', 'diretor', 'super-admin']).then(user => {
            inicializarPagina(user);
        }).catch(err => {
            document.getElementById('acesso-negado').classList.remove('hidden');
            document.getElementById('main-content').classList.add('hidden');
        });

        function inicializarPagina(user) {
            const db = getFirestore(); // Apenas obtemos o Firestore
            const tratamentosRef = collection(db, 'tratamentos_ae');
            const atendimentosRef = collection(db, 'atendimentos_ae');
            const filaRef = collection(db, 'fila_atendimento_ae');
            const logAuditoriaRef = collection(db, 'log_auditoria');

            const formularioContainer = document.getElementById('formulario-container');
            const params = new URLSearchParams(window.location.search);
            const atendimentoIdParaEditar = params.get('atendimentoId');
            
            // --- MODIFICAﾃﾃグ JAVASCRIPT: Botﾃ｣o Voltar/Fechar ---
            const btnVoltarFecha = document.getElementById('btn-voltar-fecha');
            if(btnVoltarFecha) {
                btnVoltarFecha.addEventListener('click', (e) => {
                    e.preventDefault(); 
                    console.log('Tentando fechar a janela...');
                    window.close();
                    setTimeout(() => {
                        console.log('window.close() pode ter falhado. Redirecionando...');
                        window.location.href = '/arquivo-geral-ae.html';
                    }, 300);
                });
            }

            if (atendimentoIdParaEditar) {
                carregarFormularioParaEdicao(atendimentoIdParaEditar);
            } else {
                formularioContainer.innerHTML = `<p class="erro">Nenhum atendimento selecionado.</p>`;
            }

            async function registrarLog(acao, detalhes) {
                try {
                    await addDoc(logAuditoriaRef, {
                        timestamp: serverTimestamp(),
                        autor: { uid: user.uid, nome: user.displayName || 'Usuﾃ｡rio do Sistema' },
                        acao: acao,
                        detalhes: detalhes
                    });
                } catch (error) {
                    console.error("Erro ao registrar log:", error);
                }
            }

            function manipularEstadoFormulario(travado) {
                const form = formularioContainer.querySelector('fieldset');
                if (!form) return;
                form.querySelectorAll('input:not(#colegiado-de), select:not(#colegiado-de), textarea, input[name="evolucao"]').forEach(el => {
                    if (!el.classList.contains('readonly-input')) {
                        el.disabled = travado;
                    }
                });
                // --- MODIFICAﾃﾃグ JAVASCRIPT: Alvo nos checkboxes, nﾃ｣o no selectBox ---
                form.querySelectorAll('.checkboxes input[type="checkbox"]').forEach(checkbox => {
                    checkbox.disabled = travado;
                });
                // const selectBox = form.querySelector('.select-box'); // Linha removida
                // if (selectBox) { ... } // Bloco removido
                // --- FIM DA MODIFICAﾃﾃグ ---

                const colegiadoSection = form.querySelector('.colegiado-section');
                if (colegiadoSection) {
                    const decisaoSalva = colegiadoSection.classList.contains('colegiado-travado');
                    form.querySelectorAll('#colegiado-para, #colegiado-notas').forEach(el => el.disabled = (travado || decisaoSalva));
                     // --- MODIFICAﾃﾃグ JAVASCRIPT: Alvo nos checkboxes ---
                     form.querySelectorAll('.checkboxes input[type="checkbox"]').forEach(checkbox => {
                         checkbox.disabled = (travado || decisaoSalva);
                     });
                     // const selectBox = form.querySelector('.select-box'); // Linha removida
                     // if (selectBox) { ... } // Bloco removido
                }
                const btnSalvar = document.getElementById('btn-salvar-entrevista');
                if(btnSalvar) btnSalvar.style.display = travado ? 'none' : 'block';
                const btnHabilitarExistente = document.getElementById('btn-habilitar-edicao');
                if(btnHabilitarExistente) btnHabilitarExistente.remove();
                if (travado) {
                    const btnHabilitar = document.createElement('button');
                    btnHabilitar.id = 'btn-habilitar-edicao';
                    btnHabilitar.className = 'btn btn-secondary';
                    btnHabilitar.style.width = '100%';
                    btnHabilitar.style.marginTop = '10px';
                    btnHabilitar.innerHTML = '白 Habilitar Ediﾃｧﾃ｣o';
                    btnHabilitar.type = 'button';
                    btnHabilitar.onclick = () => {
                        if (confirm('Tem certeza que deseja editar esta entrevista?')) {
                            manipularEstadoFormulario(false);
                        }
                    };
                    form.appendChild(btnHabilitar);
                }
            }


            async function carregarFormularioParaEdicao(atendimentoId) {
                const atendimentoDocRef = doc(db, 'atendimentos_ae', atendimentoId);
                const atendimentoDoc = await getDoc(atendimentoDocRef);
                if (!atendimentoDoc.exists()) { formularioContainer.innerHTML = `<p class="erro">Atendimento com ID ${atendimentoId} nﾃ｣o encontrado.</p>`; return; }
                const atendimento = { id: atendimentoDoc.id, ...atendimentoDoc.data() };
                const assistidoDoc = await getDoc(doc(db, 'assistidos', atendimento.assistidoId));
                const nomeAssistido = assistidoDoc.exists() ? assistidoDoc.data().nome : "Assistido nﾃ｣o encontrado";
                const formHtml = criarFormulario(atendimento);
                formularioContainer.innerHTML = formHtml;
                preencherFormulario(atendimento, nomeAssistido);
                const isFaseDeDecisao = (atendimento.semana === 5 && atendimento.dataAtendimento === null);
                const travar = atendimento.detalhes_preenchidos === true || (isFaseDeDecisao && atendimento.decisaoColegiadoSalva === true);
                manipularEstadoFormulario(travar);
                document.getElementById('btn-salvar-decisao')?.addEventListener('click', () => salvarDecisaoColegiado(atendimento, atendimentoDocRef));
                document.getElementById('btn-salvar-entrevista')?.addEventListener('click', () => salvarEntrevistaCompleta(atendimento, atendimentoDocRef));
                document.getElementById('btn-dar-alta')?.addEventListener('click', () => darAlta(atendimento, atendimentoDocRef));

                // --- MODIFICAﾃﾃグ JAVASCRIPT: Lﾃｳgica do select-box removida ---
                // const selectBox = document.querySelector('.select-box');
                // const checkboxes = document.querySelector('.checkboxes');
                // if (selectBox && checkboxes) { ... }
                // --- FIM DA MODIFICAﾃﾃグ ---
            }


            async function salvarDecisaoColegiado(atendimento, atendimentoDocRef) {
                const btn = document.getElementById('btn-salvar-decisao');
                btn.disabled = true;
                btn.textContent = 'Salvando Decisﾃ｣o...';
                const passePara = document.getElementById('colegiado-para')?.value;
                if (!passePara) { alert('Por favor, selecione um passe no campo "PARA:" para registrar a migraﾃｧﾃ｣o.'); btn.disabled = false; btn.textContent = 'Salvar Decisﾃ｣o e Iniciar Novo Ciclo'; return; }
                const colegiadoNotas = document.getElementById('colegiado-notas')?.value.trim() || "Reavaliaﾃｧﾃ｣o: Encaminhado para novo ciclo.";
                const encaminhamentos = Array.from(document.querySelectorAll('.checkboxes input:checked')).map(cb => cb.value);
                try {
                    const dadosParaAtualizar = { passePara: passePara, colegiadoNotas: colegiadoNotas, encaminhamentos: encaminhamentos, decisao_pre_registrada: true, decisaoColegiadoSalva: true };
                    await updateDoc(atendimentoDocRef, dadosParaAtualizar);
                    registrarLog('Decisﾃ｣o de Reavaliaﾃｧﾃ｣o Prﾃｩ-Registrada (AE)', { assistidoId: atendimento.assistidoId, atendimentoId: atendimento.id, assistidoNome: document.getElementById('assistido-nome').textContent, dePasse: atendimento.passeRecomendado, paraPasse: passePara });
                    alert('Decisﾃ｣o de "Novo Ciclo" prﾃｩ-registrada com sucesso! Ela serﾃ｡ ativada quando o assistido registrar presenﾃｧa.');
                    manipularEstadoFormulario(true);
                    carregarFormularioParaEdicao(atendimento.id);
                } catch (error) {
                    console.error("Erro ao salvar decisﾃ｣o:", error); alert("Falha ao salvar a decisﾃ｣o. Tente novamente.");
                    btn.disabled = false; btn.textContent = 'Salvar Decisﾃ｣o e Iniciar Novo Ciclo';
                }
            }

            async function darAlta(atendimento, atendimentoDocRef) {
                const btn = document.getElementById('btn-dar-alta');
                btn.disabled = true;
                if (confirm(`Tem certeza que deseja programar a alta para este assistido?`)) {
                    const colegiadoNotas = document.getElementById('colegiado-notas')?.value.trim() || "Atendimento de reavaliaﾃｧﾃ｣o finalizado com alta.";
                    const encaminhamentos = Array.from(document.querySelectorAll('.checkboxes input:checked')).map(cb => cb.value);
                    try {
                        const dadosParaAtualizar = { tipo: 'alta_programada', colegiadoNotas: colegiadoNotas, encaminhamentos: encaminhamentos, decisao_pre_registrada: true, decisaoColegiadoSalva: true, detalhes_preenchidos: true };
                        await updateDoc(atendimentoDocRef, dadosParaAtualizar);
                        registrarLog('Registro de Alta Programada (AE)', { assistidoId: atendimento.assistidoId, atendimentoId: atendimento.id, assistidoNome: document.getElementById('assistido-nome').textContent });
                        alert('Alta programada com sucesso! O tratamento serﾃ｡ encerrado quando o assistido registrar presenﾃｧa.');
                        manipularEstadoFormulario(true);
                        carregarFormularioParaEdicao(atendimento.id);
                    } catch (error) {
                        console.error("Erro ao programar alta:", error); alert("Falha ao programar a alta. Tente novamente.");
                        btn.disabled = false;
                    }
                } else {
                    btn.disabled = false;
                }
            }

            // --- MODIFICAﾃﾃグ JAVASCRIPT: salvarEntrevistaCompleta (remove horarioInicio/Fim) ---
            async function salvarEntrevistaCompleta(atendimento, atendimentoDocRef) {
                const btn = document.getElementById('btn-salvar-entrevista');
                const entrevistadorNome = document.getElementById('entrevistador-nome').value.trim();
                const entrevistaNotas = document.getElementById('entrevista-notas').value.trim();
                const isReavaliacaoForm = !!document.getElementById('colegiado-notas');

                if (!entrevistadorNome || !entrevistaNotas) { alert('Campos "Entrevistador" e "Descriﾃｧﾃ｣o da Entrevista" sﾃ｣o obrigatﾃｳrios.'); return; }
                if (isReavaliacaoForm) {
                    const colegiadoNotas = document.getElementById('colegiado-notas')?.value.trim();
                    if (!colegiadoNotas) { alert('Para reavaliaﾃｧﾃ｣o (ou 1ﾂｪ semana pﾃｳs-migraﾃｧﾃ｣o), "Orientaﾃｧﾃｵes do Colegiado" ﾃｩ obrigatﾃｳrio.'); return; }
                }

                btn.disabled = true; btn.textContent = 'Salvando...';
                try {
                    const dadosParaAtualizar = {
                        entrevistador: entrevistadorNome,
                        notas: entrevistaNotas,
                        // horarioInicio e horarioFim removidos
                        evolucao: document.querySelector('input[name="evolucao"]:checked')?.value || null,
                        colegiadoNotas: document.getElementById('colegiado-notas')?.value.trim() || null,
                        encaminhamentos: Array.from(document.querySelectorAll('.checkboxes input:checked')).map(cb => cb.value),
                        detalhes_preenchidos: true
                    };
                    await updateDoc(atendimentoDocRef, dadosParaAtualizar);
                    registrarLog('Preenchimento de Entrevista (AE)', { assistidoId: atendimento.assistidoId, atendimentoId: atendimento.id, semana: atendimento.semana, assistidoNome: document.getElementById('assistido-nome').textContent });
                    alert('Entrevista salva com sucesso!');
                    manipularEstadoFormulario(true);
                } catch (error) {
                    console.error("Erro ao salvar entrevista completa:", error); alert("Falha ao salvar. Tente novamente.");
                    btn.disabled = false; btn.textContent = 'Salvar Alteraﾃｧﾃｵes';
                }
            }

            function preencherFormulario(atendimento, nomeAssistido) {
                document.getElementById('assistido-nome').textContent = nomeAssistido;
                if (document.getElementById('entrevistador-nome')) {
                    if (atendimento.entrevistador && atendimento.entrevistador !== 'Aguardando Detalhes' && atendimento.entrevistador !== 'Passe Direto' && atendimento.entrevistador !== 'Aguardando Decisﾃ｣o') {
                         document.getElementById('entrevistador-nome').value = atendimento.entrevistador;
                    } else if (!atendimento.detalhes_preenchidos) {
                         document.getElementById('entrevistador-nome').value = user.displayName || '';
                    } else {
                         document.getElementById('entrevistador-nome').value = '';
                    }
                }
                if (document.getElementById('entrevista-notas')) { document.getElementById('entrevista-notas').value = atendimento.notas || ''; }
                // campos horarioInicio/Fim removidos
                if (document.querySelector('input[name="evolucao"]')) {
                    const evolucaoSalva = atendimento.evolucao || 'na_mesma';
                    const evolucaoRadio = document.querySelector(`input[name="evolucao"][value="${evolucaoSalva}"]`);
                    if (evolucaoRadio) evolucaoRadio.checked = true;
                }
                if (document.getElementById('colegiado-para')) {
                    if (atendimento.passePara) { document.getElementById('colegiado-para').value = atendimento.passePara; }
                    if (atendimento.tipo === 'alta_programada' || atendimento.tipo === 'alta') {
                        const selectPara = document.getElementById('colegiado-para');
                        if (!selectPara.querySelector('option[value="alta"]')) { selectPara.innerHTML += `<option value="alta">ALTA PROGRAMADA</option>`; }
                        selectPara.value = 'alta';
                    }
                }
                 if (document.getElementById('colegiado-notas')) { document.getElementById('colegiado-notas').value = atendimento.colegiadoNotas || ''; }
                 // --- MODIFICAﾃﾃグ: Lﾃｳgica do select-box removida ---
                 if (atendimento.encaminhamentos && atendimento.encaminhamentos.length > 0) {
                     atendimento.encaminhamentos.forEach(val => {
                         const checkbox = document.querySelector(`.checkboxes input[value="${val}"]`);
                         if (checkbox) checkbox.checked = true;
                     });
                 }
                 // --- FIM DA MODIFICAﾃﾃグ ---
            }

            const gerarOpcoesPasse = (selecionado = '') => {
                const passes = ['P1', 'P2', 'P3A', 'P3B', 'P4A', 'P4B', 'CH'];
                let html = '<option value="">Selecione...</option>';
                passes.forEach(p => { html += `<option value="${p}" ${p === selecionado ? 'selected' : ''}>${p}</option>`; });
                return html;
            };

            // ===================================================================
            // INﾃ垢IO DA MODIFICAﾃﾃグ JAVASCRIPT: Funﾃｧﾃ｣o criarFormulario
            // ===================================================================
            function criarFormulario(atendimento) {
                const semanaNum = atendimento.semana;
                const passeDe = atendimento.passeRecomendado;
                const isInicioRealDeTratamento = (semanaNum === 1 && !atendimento.decisao_pre_registrada && !atendimento.passePara && atendimento.tipo !== 'alta_programada');
                const isFaseDeDecisao5Semana = (semanaNum === 5 && atendimento.decisaoColegiadoSalva !== true && atendimento.dataAtendimento === null);
                const incluiSecaoColegiado = (semanaNum === 5 || (semanaNum === 1 && (atendimento.passePara || atendimento.tipo === 'alta_programada')));

                let legenda = '';
                if (isInicioRealDeTratamento) { legenda = "Entrevista de Inﾃｭcio de Tratamento"; }
                else if (semanaNum === 1 && !isInicioRealDeTratamento) { legenda = "Detalhes do Atendimento da 1ﾂｪ Semana (Novo Ciclo)"; }
                else if (atendimento.tipo === 'alta' || atendimento.tipo === 'alta_programada') { legenda = `Entrevista de Encerramento (Alta)`; }
                else { legenda = `Detalhes do Atendimento da ${semanaNum}ﾂｪ Semana`; }

                const dataAtendimento = atendimento.dataAtendimento ? atendimento.dataAtendimento.toDate().toLocaleDateString('pt-br') : `<span class="data-aviso">Decisﾃ｣o Prﾃｩ-Registro (Aguardando Presenﾃｧa)</span>`;

                let acompanhamentoHtml = '';
                if (!isInicioRealDeTratamento) {
                    // Campos de Inﾃｭcio e Fim REMOVIDOS daqui
                    acompanhamentoHtml = `<hr><h5>Detalhes do Passe</h5><div class="form-grid">
                            <div class="form-item"><label for="retorno-passe">Passe:</label><input type="text" id="retorno-passe" class="readonly-input" value="${passeDe || 'N/A'}" readonly></div>
                        </div>
                        <div class="form-item" style="margin-top:15px;"><label>Evoluﾃｧﾃ｣o:</label><div style="display:flex; gap: 15px;"><label><input type="radio" name="evolucao" value="melhorou"> Melhorou</label><label><input type="radio" name="evolucao" value="piorou"> Piorou</label><label><input type="radio" name="evolucao" value="na_mesma" checked> Na Mesma</label></div></div>`;
                }

                let colegiadoHtml = '';
                if (incluiSecaoColegiado) {
                    let botoesColegiadoHtml = ''; let statusColegiadoHtml = ''; let classeColegiado = 'colegiado-section';
                    if (isFaseDeDecisao5Semana) {
                        botoesColegiadoHtml = `<div class="botoes-colegiado"><button id="btn-salvar-decisao" type="button" class="btn btn-success">Salvar Decisﾃ｣o e Iniciar Novo Ciclo</button><button id="btn-dar-alta" type="button" class="btn btn-danger">Confirmar e Dar Alta</button></div>`;
                    } else if (atendimento.decisaoColegiadoSalva === true) {
                         classeColegiado += ' colegiado-travado';
                         if (atendimento.tipo === 'alta_programada' || atendimento.tipo === 'alta') { statusColegiadoHtml = `<p class="status-alta">ALTA PROGRAMADA. Aguardando presenﾃｧa para encerrar.</p>`; }
                         else if (atendimento.passePara) { statusColegiadoHtml = `<p class="status-novo-ciclo">NOVO CICLO (${atendimento.passePara}) PROGRAMADO. Aguardando presenﾃｧa para iniciar.</p>`; }
                    }

                    // --- HTML MODIFICADO: Remove .multiselect e .select-box ---
                    colegiadoHtml = `<hr><div class="${classeColegiado}"><h5>Colegiado</h5>
                            <div class="form-grid">
                               <div class="form-item"><label for="colegiado-de">DE (Passe Anterior):</label><select id="colegiado-de" class="readonly-input" disabled>${gerarOpcoesPasse(passeDe)}</select></div>
                               <div class="form-item"><label for="colegiado-para">PARA (Mudar o passe):</label><select id="colegiado-para">${gerarOpcoesPasse()}</select></div>
                            </div>
                            <div class="form-item" style="margin-top:15px;">
                                <label>Encaminhamentos (Mﾃｺltipla Escolha):</label>
                                {/* O div .checkboxes agora estﾃ｡ diretamente aqui */}
                                <div class="checkboxes">
                                    <label><input type="checkbox" value="ENL"/> ENL</label><label><input type="checkbox" value="LEITURAS"/> Leituras</label><label><input type="checkbox" value="EAE"/> EAE</label><label><input type="checkbox" value="VOLUNTARIADO"/> Voluntariado</label><label><input type="checkbox" value="Mﾃ吋ICO"/> Mﾃｩdico</label><label><input type="checkbox" value="ALIMENTO"/> Alimento</label><label><input type="checkbox" value="NATUREZA"/> Natureza</label><label><input type="checkbox" value="MOCIDADE"/> Mocidade</label><label><input type="checkbox" value="EVANGELIZAﾃﾃグ"/> Evangelizaﾃｧﾃ｣o</label>
                                </div>
                            </div>
                            <div class="form-item" style="margin-top: 15px;"><label for="colegiado-notas">Orientaﾃｧﾃｵes do Colegiado:</label><textarea id="colegiado-notas" rows="4"></textarea></div>
                            ${statusColegiadoHtml}
                            ${botoesColegiadoHtml}
                         </div>`;
                    // --- FIM DA MODIFICAﾃﾃグ HTML ---
                }

                const botoesHtml = `<button id="btn-salvar-entrevista" type="button" class="btn btn-primary" style="width: 100%; margin-top: 20px;">Salvar Alteraﾃｧﾃｵes</button>`;
                return `<fieldset><legend>${legenda}</legend>
                        <div class="form-grid" style="background-color: #f8f9fa; padding: 10px; border-radius: 6px;">
                            <div class="form-item"><label>Assistido:</label><h3 id="assistido-nome" style="text-align:left; margin:0;">Carregando...</h3></div>
                            <div class="form-item"><label>Data do Atendimento:</label><p id="data-atendimento" style="margin:0;">${dataAtendimento}</p></div>
                        </div><hr>
                        <div class="form-grid">
                            <div class="form-item"><label for="entrevistador-nome">Entrevistador:</label><input type="text" id="entrevistador-nome"></div>
                        </div>
                        <div class="form-item" style="margin-top: 15px;"><label for="entrevista-notas">Descriﾃｧﾃ｣o da Entrevista:</label><textarea id="entrevista-notas" rows="6"></textarea></div>
                        ${acompanhamentoHtml}
                        ${colegiadoHtml}
                        ${botoesHtml}
                </fieldset>`;
            }
            // ===================================================================
            // FIM DA MODIFICAﾃﾃグ JAVASCRIPT
            // ===================================================================

        } // Fim da funﾃｧﾃ｣o inicializarPagina
    </script>
</body>
</html>