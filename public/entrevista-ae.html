<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entrevista - Atendimento Espiritual</title>
    <style>
        :root { --cor-primaria: #007bff; --cor-borda: #ddd; --fundo-desabilitado: #f9f9f9; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .container { width: 100%; max-width: 1100px; background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 6px 24px rgba(0,0,0,0.1); margin: auto; }
        .nav-voltar { width: 100%; max-width: 1100px; margin: auto; margin-bottom: 20px; }
        .btn, .btn-voltar { background-color: var(--cor-primaria); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; font-size: 1em; text-decoration: none; cursor: pointer; transition: background-color 0.3s; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-voltar { background-color: #6c757d; }
        .btn-success { background-color: #28a745; }
        .btn-secondary { background-color: #6c757d; }
        .btn-danger { background-color: #dc3545; }
        h1, h2, h3, h4 { color: #333; text-align: center; }
        fieldset { border: 1px solid var(--cor-borda); border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        legend { font-weight: bold; font-size: 1.2em; color: #0056b3; padding: 0 10px; }
        .form-item { display: flex; flex-direction: column; }
        .form-item label { margin-bottom: 5px; font-weight: bold; color: #555; }
        .form-item input, .form-item select, .form-item textarea { padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 1em; width: 100%; box-sizing: border-box; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end; }
        .hidden { display: none; }
        .grid-entrevista { display: grid; grid-template-columns: 300px 1fr; gap: 30px; }
        #lista-fila { list-style-type: none; padding: 0; margin: 0; max-height: 70vh; overflow-y: auto; border: 1px solid var(--cor-borda); border-radius: 8px; }
        #lista-fila li { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: background-color 0.2s; }
        #lista-fila li:last-child { border-bottom: none; }
        #lista-fila li.selecionado { background-color: #cce5ff; border-left: 5px solid var(--cor-primaria); font-weight: bold; }
        .multiselect { position: relative; }
        .select-box { border: 1px solid #ccc; border-radius: 6px; padding: 10px; cursor: pointer; }
        .checkboxes { position: absolute; background: white; border: 1px solid var(--cor-borda); border-radius: 6px; z-index: 100; max-height: 150px; overflow-y: auto; padding: 5px; width: 100%; box-sizing: border-box; }
        .actions-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .erro { color: #dc3545; font-weight: bold; }
        @media (max-width: 900px) { .grid-entrevista { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <nav class="nav-voltar"><a href="/dashboard.html" class="btn-voltar">⬅ Voltar para o Dashboard</a></nav>
    <div id="acesso-negado" class="container hidden"><h1>Acesso Negado</h1></div>

    <div id="main-content" class="container hidden">
        <h1>Painel de Entrevistas</h1>
        <p style="text-align: center; margin-top: -10px;">Selecione um assistido da fila para registrar o atendimento.</p>
        <div class="grid-entrevista">
            <div>
                <h3>Aguardando Entrevista</h3>
                <ul id="lista-fila"></ul>
            </div>
            <div id="painel-formulario">
                <h3>Ficha de Atendimento</h3>
                <div id="formulario-container">
                    <p>Selecione um assistido à esquerda.</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, onSnapshot, updateDoc, query, where, orderBy, Timestamp, getDocs, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { protegerPagina } from '/auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU",
            authDomain: "voluntarios-ativos---cepat.firebaseapp.com",
            projectId: "voluntarios-ativos---cepat",
            storageBucket: "voluntarios-ativos---cepat.firebasestorage.app",
            messagingSenderId: "66122858261",
            appId: "1:66122858261:web:7fa21f1805463b5c08331c"
        };
        initializeApp(firebaseConfig);

        const formatarDataParaInput = (dataObj) => {
            if (!dataObj) return '';
            const data = new Date(dataObj.getTime() - (dataObj.getTimezoneOffset() * 60000));
            return data.toISOString().split("T")[0];
        };

        protegerPagina(['entrevistador', 'diretor', 'super-admin']).then(user => {
            document.getElementById('main-content').classList.remove('hidden');
            inicializarPagina(user);
        }).catch(err => {
            document.getElementById('acesso-negado').classList.remove('hidden');
            document.getElementById('main-content').classList.add('hidden');
        });

        function inicializarPagina(user) {
            const db = getFirestore();
            const filaRef = collection(db, 'fila_atendimento_ae');
            const tratamentosRef = collection(db, 'tratamentos_ae');
            const atendimentosRef = collection(db, 'atendimentos_ae');
            
            const ui = {
                listaFila: document.getElementById('lista-fila'),
                formularioContainer: document.getElementById('formulario-container'),
            };

            const hojeInicio = new Date();
            hojeInicio.setHours(0, 0, 0, 0);

            const qFila = query(filaRef, where("chegadaEm", ">=", Timestamp.fromDate(hojeInicio)), where("status", "==", "chamado_entrevista"), orderBy("chegadaEm", "asc"));

            onSnapshot(qFila, (snapshot) => {
                ui.listaFila.innerHTML = '';
                if (snapshot.empty) {
                    ui.listaFila.innerHTML = '<li>Ninguém na fila.</li>';
                    ui.formularioContainer.innerHTML = '<p>Selecione um assistido à esquerda.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const atendimento = { id: doc.id, ...doc.data() };
                    const li = document.createElement('li');
                    li.textContent = atendimento.nomeAssistido;
                    li.dataset.atendimentoId = atendimento.id;
                    li.addEventListener('click', () => carregarFormulario(atendimento));
                    ui.listaFila.appendChild(li);
                });
            });

            async function carregarFormulario(atendimento) {
                document.querySelectorAll('#lista-fila li').forEach(el => el.classList.remove('selecionado'));
                document.querySelector(`li[data-atendimento-id="${atendimento.id}"]`).classList.add('selecionado');
                ui.formularioContainer.innerHTML = '<p>Carregando dados do tratamento...</p>';

                if (!atendimento.tratamentoId) {
                    ui.formularioContainer.innerHTML = '<p class="erro">Erro: Este atendimento não está vinculado a uma assistência.</p>';
                    return;
                }

                const tratamentoDoc = await getDoc(doc(db, 'tratamentos_ae', atendimento.tratamentoId));
                if (!tratamentoDoc.exists()) {
                    ui.formularioContainer.innerHTML = '<p class="erro">Erro: Ciclo de assistência não encontrado.</p>';
                    return;
                }
                const tratamento = { id: tratamentoDoc.id, ...tratamentoDoc.data() };

                const qSemanas = query(atendimentosRef, where("tratamentoId", "==", tratamento.id), where("tipo", "!=", "falta"));
                const semanasSnapshot = await getDocs(qSemanas);
                const semanaNum = semanasSnapshot.size;

                const passe = tratamento.passe_ciclo_atual;
                
                let formHtml = '';
                if (semanaNum === 0) {
                    formHtml = criarFormularioPrimeiraVez(tratamento);
                } else if (semanaNum === 4) {
                    formHtml = criarFormularioSemanal(semanaNum + 1, passe, true); 
                } else if (passe === 'P3A' || passe === 'P3B' || semanaNum === 3) {
                    formHtml = criarFormularioSemanal(semanaNum + 1, passe, false);
                } else {
                    formHtml = `<p>Este assistido não requer entrevista completa hoje. Apenas confirme o encaminhamento para o passe no tablet.</p>`;
                }
                ui.formularioContainer.innerHTML = formHtml;
                
                document.getElementById('btn-salvar-entrevista')?.addEventListener('click', () => salvarEntrevista(atendimento, tratamento, semanaNum));
            }

            const gerarOpcoesPasse = (selecionado = '') => {
                const passes = ['P1', 'P2', 'P3A', 'P3B', 'P4A', 'P4B', 'CH'];
                let html = '<option value="">Selecione...</option>';
                passes.forEach(p => { html += `<option value="${p}" ${p === selecionado ? 'selected' : ''}>${p}</option>`; });
                return html;
            };
            
            function criarFormularioPrimeiraVez(tratamento) {
                const entrevistadorPadrao = user.displayName || '';
                return `
                    <fieldset>
                        <legend>ENTREVISTA DE 1ª VEZ OU DE REINICIO</legend>
                        <div class="form-grid">
                            <div class="form-item"><label>DATA:</label><input type="text" value="${new Date().toLocaleDateString('pt-BR')}" disabled></div>
                            <div class="form-item"><label>ENTREVISTADOR:</label><input type="text" id="entrevistador-nome" value="${entrevistadorPadrao}" required></div>
                        </div>
                        <div class="form-item" style="margin-top: 15px;">
                            <label for="entrevista-notas">Descrição da Entrevista:</label>
                            <textarea id="entrevista-notas" rows="10"></textarea>
                        </div>
                        <div class="actions-grid" style="margin-top: 15px;">
                            <button id="btn-salvar-entrevista" type="button" class="btn btn-success" style="grid-column: 1 / -1;">Salvar Entrevista e Finalizar</button>
                        </div>
                    </fieldset>
                `;
            }

            function criarFormularioSemanal(semanaNum, passeDe, mostrarColegiado) {
                 /* ... (código para formulário semanal completo virá aqui) ... */
            }
            
            async function salvarEntrevista(atendimento, tratamento, semanaNum) {
                const entrevistador = document.getElementById('entrevistador-nome').value;
                const notas = document.getElementById('entrevista-notas').value;
                if (!entrevistador) {
                    alert("O nome do entrevistador é obrigatório.");
                    return;
                }

                const batch = writeBatch(db);

                if (semanaNum === 0) { // Salvando a 1ª Semana
                    const tratamentoDocRef = doc(db, 'tratamentos_ae', tratamento.id);
                    batch.update(tratamentoDocRef, {
                        "primeiraEntrevista": {
                            data: Timestamp.now(),
                            entrevistador: entrevistador,
                            notas: notas
                        }
                    });
                    
                    batch.set(doc(atendimentosRef), {
                        assistidoId: tratamento.assistidoId,
                        tratamentoId: tratamento.id,
                        tipo: 'tratamento_semanal',
                        dataAtendimento: serverTimestamp(),
                        entrevistador: entrevistador,
                        passeRecomendado: tratamento.passe_ciclo_atual,
                        notas: notas
                    });
                } else {
                    // Lógica para salvar outras semanas (não implementada ainda)
                }
                
                const filaDocRef = doc(db, 'fila_atendimento_ae', atendimento.id);
                batch.update(filaDocRef, { status: 'entrevista_concluida' });

                try {
                    await batch.commit();
                    alert('Atendimento registrado com sucesso!');
                    ui.formularioContainer.innerHTML = '<p>Selecione um assistido à esquerda.</p>';
                } catch(error) {
                    console.error("Erro ao salvar entrevista: ", error);
                    alert("Falha ao salvar. Tente novamente.");
                }
            }
        }
    </script>
</body>
</html>