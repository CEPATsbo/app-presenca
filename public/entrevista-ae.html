<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Atendimento - AE</title>
    <style>
        :root { --cor-primaria: #007bff; --cor-borda: #ddd; --fundo-desabilitado: #e9ecef; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .container { width: 100%; max-width: 900px; background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 6px 24px rgba(0,0,0,0.1); margin: auto; }
        .nav-voltar { width: 100%; max-width: 900px; margin: auto; margin-bottom: 20px; }
        .btn, .btn-voltar { background-color: var(--cor-primaria); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; font-size: 1em; text-decoration: none; cursor: pointer; transition: background-color 0.3s; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-voltar { background-color: #6c757d; }
        .btn-success { background-color: #28a745; }
        .btn-danger { background-color: #dc3545; }
        .btn-secondary { background-color: #6c757d; }
        h1, h3 { color: #333; text-align: center; }
        fieldset { border: 1px solid var(--cor-borda); border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        legend { font-weight: bold; font-size: 1.2em; color: #0056b3; padding: 0 10px; }
        .form-item { display: flex; flex-direction: column; }
        .form-item label { margin-bottom: 5px; font-weight: bold; color: #555; }
        .form-item input, .form-item select, .form-item textarea, .form-item .readonly-input { padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 1em; width: 100%; box-sizing: border-box; }
        .form-item .readonly-input { background-color: var(--fundo-desabilitado); }
        .form-item input:disabled, .form-item select:disabled, .form-item textarea:disabled { background-color: var(--fundo-desabilitado); cursor: not-allowed; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end; }
        .multiselect { position: relative; }
        .select-box { border: 1px solid #ccc; border-radius: 6px; padding: 10px; cursor: pointer; background-color: #fff; min-height: 1.5em; }
        .select-box[disabled] { background-color: var(--fundo-desabilitado); cursor: not-allowed; }
        .checkboxes { 
            display: none; position: absolute; background: white; border: 1px solid var(--cor-borda); 
            border-radius: 6px; z-index: 100; max-height: 200px; overflow-y: auto; 
            padding: 5px; width: 100%; box-sizing: border-box;
            top: 100%;
            margin-top: 2px;
            left: 0;
        }
        .checkboxes.visible { display: block; }
        .erro { color: #dc3545; font-weight: bold; text-align: center; }
        .hidden { display: none; }
        .botoes-colegiado { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .data-aviso { font-weight: bold; color: #0056b3; }
    </style>
</head>
<body>
    <nav class="nav-voltar"><a href="/arquivo-geral-ae.html" class="btn-voltar">‚¨Ö Voltar para o Painel AE</a></nav>
    <div id="acesso-negado" class="container hidden"><h1>Acesso Negado</h1></div>

    <div id="main-content" class="container">
        <h1>Detalhes do Atendimento</h1>
        <p style="text-align: center; margin-top: -10px;">Adicione ou edite as informa√ß√µes do atendimento.</p>
        <div id="formulario-container">
            <p>Carregando dados do atendimento...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, updateDoc, query, where, Timestamp, getDocs, writeBatch, serverTimestamp, limit, addDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { protegerPagina } from '/auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU",
            authDomain: "voluntarios-ativos---cepat.firebaseapp.com",
            projectId: "voluntarios-ativos---cepat",
            storageBucket: "voluntarios-ativos---cepat.firebasestorage.app",
            messagingSenderId: "66122858261",
            appId: "1:66122858261:web:7fa21f1805463b5c08331c"
        };
        initializeApp(firebaseConfig);
        const auth = getAuth();

        protegerPagina(['entrevistador', 'tesoureiro', 'conselheiro', 'diretor', 'super-admin']).then(user => {
            inicializarPagina(user);
        }).catch(err => {
            document.getElementById('acesso-negado').classList.remove('hidden');
            document.getElementById('main-content').classList.add('hidden');
        });

        function inicializarPagina(user) {
            const db = getFirestore();
            const tratamentosRef = collection(db, 'tratamentos_ae');
            const atendimentosRef = collection(db, 'atendimentos_ae');
            const filaRef = collection(db, 'fila_atendimento_ae');
            const logAuditoriaRef = collection(db, 'log_auditoria');
            
            const formularioContainer = document.getElementById('formulario-container');
            const params = new URLSearchParams(window.location.search);
            const atendimentoIdParaEditar = params.get('atendimentoId');

            if (atendimentoIdParaEditar) {
                carregarFormularioParaEdicao(atendimentoIdParaEditar);
            } else {
                formularioContainer.innerHTML = `<p class="erro">Nenhum atendimento selecionado.</p>`;
            }

            async function registrarLog(acao, detalhes) {
                try {
                    await addDoc(logAuditoriaRef, {
                        timestamp: serverTimestamp(),
                        autor: { uid: user.uid, nome: user.displayName || 'Usu√°rio do Sistema' },
                        acao: acao,
                        detalhes: detalhes
                    });
                } catch (error) {
                    console.error("Erro ao registrar log:", error);
                }
            }

            function manipularEstadoFormulario(travado) {
                const form = formularioContainer.querySelector('fieldset');
                if (!form) return;
                form.querySelectorAll('input, select, textarea').forEach(el => {
                    if (!el.classList.contains('readonly-input')) {
                        el.disabled = travado;
                    }
                });
                const selectBox = form.querySelector('.select-box');
                if (selectBox) {
                    travado ? selectBox.setAttribute('disabled', 'disabled') : selectBox.removeAttribute('disabled');
                }
                const btnSalvar = document.getElementById('btn-salvar-entrevista');
                if(btnSalvar) btnSalvar.style.display = travado ? 'none' : 'block';
                
                const btnHabilitarExistente = document.getElementById('btn-habilitar-edicao');
                if(btnHabilitarExistente) btnHabilitarExistente.remove();
                if (travado) {
                    const btnHabilitar = document.createElement('button');
                    btnHabilitar.id = 'btn-habilitar-edicao';
                    btnHabilitar.className = 'btn btn-secondary';
                    btnHabilitar.style.width = '100%';
                    btnHabilitar.style.marginTop = '10px';
                    btnHabilitar.innerHTML = 'üîí Habilitar Edi√ß√£o';
                    btnHabilitar.type = 'button';
                    btnHabilitar.onclick = () => {
                        if (confirm('Tem certeza que deseja editar esta entrevista?')) {
                            manipularEstadoFormulario(false);
                        }
                    };
                    form.appendChild(btnHabilitar);
                }
            }

            async function carregarFormularioParaEdicao(atendimentoId) {
                const atendimentoDocRef = doc(db, 'atendimentos_ae', atendimentoId);
                const atendimentoDoc = await getDoc(atendimentoDocRef);
                if (!atendimentoDoc.exists()) {
                    formularioContainer.innerHTML = `<p class="erro">Atendimento com ID ${atendimentoId} n√£o encontrado.</p>`;
                    return;
                }
                const atendimento = { id: atendimentoDoc.id, ...atendimentoDoc.data() };
                const assistidoDoc = await getDoc(doc(db, 'assistidos', atendimento.assistidoId));
                const nomeAssistido = assistidoDoc.exists() ? assistidoDoc.data().nome : "Assistido n√£o encontrado";
                const formHtml = criarFormulario(atendimento);
                formularioContainer.innerHTML = formHtml;
                preencherFormulario(atendimento, nomeAssistido);
                
                // Trava o formul√°rio se os detalhes estiverem preenchidos,
                // OU se a decis√£o do colegiado j√° foi salva (mesmo que aguardando presen√ßa)
                const travar = atendimento.detalhes_preenchidos === true || atendimento.decisaoColegiadoSalva === true;
                manipularEstadoFormulario(travar);
                
                document.getElementById('btn-salvar-decisao')?.addEventListener('click', () => salvarDecisaoColegiado(atendimento, atendimentoDocRef));
                document.getElementById('btn-salvar-entrevista')?.addEventListener('click', () => salvarEntrevistaCompleta(atendimento, atendimentoDocRef));
                document.getElementById('btn-dar-alta')?.addEventListener('click', () => darAlta(atendimento, atendimentoDocRef));
                
                const selectBox = document.querySelector('.select-box');
                const checkboxes = document.querySelector('.checkboxes');
                if (selectBox && checkboxes) {
                    selectBox.addEventListener('click', () => { 
                        if (!selectBox.hasAttribute('disabled')) {
                            checkboxes.classList.toggle('visible');
                        }
                    });
                    checkboxes.addEventListener('change', () => {
                        const selecionados = Array.from(checkboxes.querySelectorAll('input:checked')).map(cb => cb.value);
                        selectBox.textContent = selecionados.length > 0 ? selecionados.join(', ') : 'Selecione...';
                    });
                    document.addEventListener('click', (e) => {
                        if (selectBox && !selectBox.contains(e.target) && !checkboxes.contains(e.target)) {
                            checkboxes.classList.remove('visible');
                        }
                    });
                }
            }

            // ===================================================================
            // IN√çCIO DA √ÅREA MODIFICADA (AJUSTE 2 - ETAPA 2)
            // ===================================================================

            async function salvarDecisaoColegiado(atendimento, atendimentoDocRef) {
                const btn = document.getElementById('btn-salvar-decisao');
                btn.disabled = true;
                btn.textContent = 'Salvando Decis√£o...';

                const passePara = document.getElementById('colegiado-para')?.value;
                if (!passePara) {
                    alert('Por favor, selecione um passe no campo "PARA:" para registrar a migra√ß√£o.');
                    btn.disabled = false;
                    btn.textContent = 'Salvar Decis√£o e Iniciar Novo Ciclo';
                    return;
                }
                
                const colegiadoNotas = document.getElementById('colegiado-notas')?.value.trim() || "Reavalia√ß√£o: Encaminhado para novo ciclo.";
                const encaminhamentos = Array.from(document.querySelectorAll('.checkboxes input:checked')).map(cb => cb.value);

                try {
                    const dadosParaAtualizar = {
                        passePara: passePara,
                        colegiadoNotas: colegiadoNotas,
                        encaminhamentos: encaminhamentos,
                        decisao_pre_registrada: true, // Flag para o novo fluxo
                        decisaoColegiadoSalva: true   // Trava os bot√µes do colegiado
                    };
                    
                    await updateDoc(atendimentoDocRef, dadosParaAtualizar);

                    registrarLog('Decis√£o de Reavalia√ß√£o Pr√©-Registrada (AE)', {
                        assistidoId: atendimento.assistidoId,
                        atendimentoId: atendimento.id,
                        assistidoNome: document.getElementById('assistido-nome').textContent,
                        dePasse: atendimento.passeRecomendado,
                        paraPasse: passePara
                    });
                    
                    alert('Decis√£o de "Novo Ciclo" pr√©-registrada com sucesso! Ela ser√° ativada quando o assistido registrar presen√ßa.');
                    manipularEstadoFormulario(true); // Trava o formul√°rio

                } catch (error) {
                    console.error("Erro ao salvar decis√£o:", error);
                    alert("Falha ao salvar a decis√£o. Tente novamente.");
                    btn.disabled = false;
                    btn.textContent = 'Salvar Decis√£o e Iniciar Novo Ciclo';
                }
            }
            
            async function darAlta(atendimento, atendimentoDocRef) {
                const btn = document.getElementById('btn-dar-alta');
                btn.disabled = true;
                
                if (confirm(`Tem certeza que deseja programar a alta para este assistido?`)) {
                    
                    const colegiadoNotas = document.getElementById('colegiado-notas')?.value.trim() || "Atendimento de reavalia√ß√£o finalizado com alta.";
                    const encaminhamentos = Array.from(document.querySelectorAll('.checkboxes input:checked')).map(cb => cb.value);

                    try {
                        const dadosParaAtualizar = {
                            tipo: 'alta_programada',
                            colegiadoNotas: colegiadoNotas,
                            encaminhamentos: encaminhamentos,
                            decisao_pre_registrada: true, // Flag para o novo fluxo
                            decisaoColegiadoSalva: true,  // Trava os bot√µes do colegiado
                            detalhes_preenchidos: true    // Considera preenchido
                        };

                        await updateDoc(atendimentoDocRef, dadosParaAtualizar);

                        registrarLog('Registro de Alta Programada (AE)', {
                            assistidoId: atendimento.assistidoId,
                            atendimentoId: atendimento.id,
                            assistidoNome: document.getElementById('assistido-nome').textContent
                        });

                        alert('Alta programada com sucesso! O tratamento ser√° encerrado quando o assistido registrar presen√ßa.');
                        manipularEstadoFormulario(true); // Trava o formul√°rio
                    } catch (error) {
                        console.error("Erro ao programar alta:", error);
                        alert("Falha ao programar a alta. Tente novamente.");
                        btn.disabled = false;
                    }
                } else {
                    btn.disabled = false;
                }
            }

            async function salvarEntrevistaCompleta(atendimento, atendimentoDocRef) {
                const btn = document.getElementById('btn-salvar-entrevista');
                
                const entrevistadorNome = document.getElementById('entrevistador-nome').value.trim();
                const entrevistaNotas = document.getElementById('entrevista-notas').value.trim();
                const isReavaliacao = (atendimento.semana === 5 || !!atendimento.passePara || atendimento.tipo === 'alta_programada');

                if (!entrevistadorNome || !entrevistaNotas) {
                    alert('Para marcar a entrevista como conclu√≠da, os campos "Entrevistador" e "Descri√ß√£o da Entrevista" s√£o obrigat√≥rios.');
                    return;
                }
                if (isReavaliacao) {
                    const colegiadoNotas = document.getElementById('colegiado-notas')?.value.trim();
                    if (!colegiadoNotas) {
                        alert('Para concluir uma reavalia√ß√£o, o campo "Orienta√ß√µes do Colegiado" tamb√©m √© obrigat√≥rio.');
                        return;
                    }
                }
                
                btn.disabled = true;
                btn.textContent = 'Salvando...';

                try {
                    const dadosParaAtualizar = {
                        entrevistador: entrevistadorNome,
                        notas: entrevistaNotas,
                        horarioInicio: document.getElementById('retorno-inicio')?.value || null,
                        horarioFim: document.getElementById('retorno-fim')?.value || null,
                        evolucao: document.querySelector('input[name="evolucao"]:checked')?.value || null,
                        colegiadoNotas: document.getElementById('colegiado-notas')?.value.trim() || null,
                        encaminhamentos: Array.from(document.querySelectorAll('.checkboxes input:checked')).map(cb => cb.value),
                        detalhes_preenchidos: true
                    };

                    await updateDoc(atendimentoDocRef, dadosParaAtualizar);

                    registrarLog('Preenchimento de Entrevista (AE)', {
                        assistidoId: atendimento.assistidoId,
                        atendimentoId: atendimento.id,
                        semana: atendimento.semana,
                        assistidoNome: document.getElementById('assistido-nome').textContent
                    });
                    
                    alert('Entrevista salva com sucesso!');
                    manipularEstadoFormulario(true);

                } catch (error) {
                    console.error("Erro ao salvar entrevista completa:", error);
                    alert("Falha ao salvar. Tente novamente.");
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Salvar Altera√ß√µes';
                }
            }
            
            function preencherFormulario(atendimento, nomeAssistido) {
                document.getElementById('assistido-nome').textContent = nomeAssistido;
                if (document.getElementById('entrevistador-nome')) {
                    if (atendimento.entrevistador && atendimento.entrevistador !== 'Aguardando Detalhes' && atendimento.entrevistador !== 'Passe Direto') {
                        document.getElementById('entrevistador-nome').value = atendimento.entrevistador;
                    } else {
                        document.getElementById('entrevistador-nome').value = user.displayName || '';
                    }
                }
                if (document.getElementById('entrevista-notas')) {
                    document.getElementById('entrevista-notas').value = atendimento.notas || '';
                }
                if (document.getElementById('retorno-inicio')) {
                    document.getElementById('retorno-inicio').value = atendimento.horarioInicio || '';
                }
                if (document.getElementById('retorno-fim')) {
                    document.getElementById('retorno-fim').value = atendimento.horarioFim || '';
                }
                if (document.querySelector('input[name="evolucao"]')) {
                        if (atendimento.evolucao) {
                            const evolucaoRadio = document.querySelector(`input[name="evolucao"][value="${atendimento.evolucao}"]`);
                            if (evolucaoRadio) evolucaoRadio.checked = true;
                        }
                }
                if (document.getElementById('colegiado-para')) {
                    if (atendimento.passePara) {
                        document.getElementById('colegiado-para').value = atendimento.passePara;
                    }
                    // Se for alta programada, desabilita a sele√ß√£o de "PARA"
                    if (atendimento.tipo === 'alta_programada') {
                        const selectPara = document.getElementById('colegiado-para');
                        selectPara.disabled = true;
                        // Adiciona uma op√ß√£o de "ALTA" se n√£o existir
                        if (!selectPara.querySelector('option[value="alta"]')) {
                             selectPara.innerHTML += `<option value="alta">ALTA PROGRAMADA</option>`;
                        }
                        selectPara.value = 'alta';
                    }
                    if (document.getElementById('colegiado-notas')) {
                            document.getElementById('colegiado-notas').value = atendimento.colegiadoNotas || '';
                    }
                    if (atendimento.encaminhamentos && atendimento.encaminhamentos.length > 0) {
                        const selectBox = document.querySelector('.select-box');
                        selectBox.textContent = atendimento.encaminhamentos.join(', ');
                        atendimento.encaminhamentos.forEach(val => {
                            const checkbox = document.querySelector(`.checkboxes input[value="${val}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                }
            }
            
            const gerarOpcoesPasse = (selecionado = '') => {
                const passes = ['P1', 'P2', 'P3A', 'P3B', 'P4A', 'P4B', 'CH'];
                let html = '<option value="">Selecione...</option>';
                passes.forEach(p => { html += `<option value="${p}" ${p === selecionado ? 'selected' : ''}>${p}</option>`; });
                return html;
            };

            function criarFormulario(atendimento) {
                const semanaNum = atendimento.semana;
                const passeDe = atendimento.passeRecomendado;
                
                // A reavalia√ß√£o √© a semana 5, ou se j√° tiver uma decis√£o de "passePara" ou "alta_programada"
                const isReavaliacao = (atendimento.semana === 5 || !!atendimento.passePara || atendimento.tipo === 'alta_programada');
                
                const isInicioRealDeTratamento = (atendimento.semana === 1 && !atendimento.passePara);
                
                // --- L√ìGICA DE DATA ATUALIZADA ---
                const dataAtendimento = atendimento.dataAtendimento 
                    ? atendimento.dataAtendimento.toDate().toLocaleDateString('pt-br') 
                    : `<span class="data-aviso">Decis√£o Pr√©-Registro (Aguardando Presen√ßa)</span>`;
                
                let acompanhamentoHtml = '';
                if (!isInicioRealDeTratamento) {
                    acompanhamentoHtml = `<hr><h5>Detalhes do Passe</h5><div class="form-grid">
                            <div class="form-item"><label for="retorno-passe">Passe:</label><input type="text" id="retorno-passe" class="readonly-input" value="${passeDe}" readonly></div>
                            <div class="form-item"><label for="retorno-inicio">In√≠cio:</label><input type="time" id="retorno-inicio"></div>
                            <div class="form-item"><label for="retorno-fim">Fim:</label><input type="time" id="retorno-fim"></div>
                        </div>
                        <div class="form-item" style="margin-top:15px;"><label>Evolu√ß√£o:</label><div style="display:flex; gap: 15px;"><label><input type="radio" name="evolucao" value="melhorou"> Melhorou</label><label><input type="radio" name="evolucao" value="piorou"> Piorou</label><label><input type="radio" name="evolucao" value="na_mesma" checked> Na Mesma</label></div></div>`;
                }

                let colegiadoHtml = '';
                let botoesHtml = '';

                if (isReavaliacao) {
                    let botoesColegiadoHtml = '';
                    
                    // Mostra os bot√µes de decis√£o APENAS se a decis√£o ainda n√£o foi salva
                    if (!atendimento.decisaoColegiadoSalva) {
                        botoesColegiadoHtml = `<div class="botoes-colegiado">
                            <button id="btn-salvar-decisao" type="button" class="btn btn-success">Salvar Decis√£o e Iniciar Novo Ciclo</button>
                            <button id="btn-dar-alta" type="button" class="btn btn-danger">Confirmar e Dar Alta</button>
                        </div>`;
                    } else if (atendimento.tipo === 'alta_programada') {
                        botoesColegiadoHtml = `<p style="text-align:center; font-weight: bold; color: #dc3545;">ALTA PROGRAMADA. Aguardando presen√ßa para encerrar o tratamento.</p>`;
                    } else if (atendimento.passePara) {
                         botoesColegiadoHtml = `<p style="text-align:center; font-weight: bold; color: #007bff;">NOVO CICLO ( ${atendimento.passePara} ) PROGRAMADO. Aguardando presen√ßa para iniciar.</p>`;
                    }

                    colegiadoHtml = `<hr><h5>Colegiado</h5>
                            <div class="form-grid"><div class="form-item"><label for="colegiado-de">DE:</label><select id="colegiado-de" class="readonly-input" disabled>${gerarOpcoesPasse(passeDe)}</select></div><div class="form-item"><label for="colegiado-para">PARA (Mudar o passe):</label><select id="colegiado-para">${gerarOpcoesPasse()}</select></div></div>
                            <div class="form-item" style="margin-top:15px;"><label>Encaminhamentos (M√∫ltipla Escolha):</label><div class="multiselect">
                                <div class="select-box" tabindex="0">Selecione...</div>
                                <div class="checkboxes">
                                    <label><input type="checkbox" value="ENL"/> ENL</label><label><input type="checkbox" value="LEITURAS"/> Leituras</label><label><input type="checkbox" value="EAE"/> EAE</label><label><input type="checkbox" value="VOLUNTARIADO"/> Voluntariado</label><label><input type="checkbox" value="M√âDICO"/> M√©dico</label><label><input type="checkbox" value="ALIMENTO"/> Alimento</label><label><input type="checkbox" value="NATUREZA"/> Natureza</label><label><input type="checkbox" value="MOCIDADE"/> Mocidade</label><label><input type="checkbox" value="EVANGELIZA√á√ÉO"/> Evangeliza√ß√£o</label>
                                </div></div></div>
                            <div class="form-item" style="margin-top: 15px;"><label for="colegiado-notas">Orienta√ß√µes do Colegiado:</label><textarea id="colegiado-notas" rows="4"></textarea></div>
                            ${botoesColegiadoHtml}`;
                    
                    botoesHtml = `<button id="btn-salvar-entrevista" type="button" class="btn btn-primary" style="width: 100%; margin-top: 20px;">Salvar Altera√ß√µes</button>`;
                } else {
                    botoesHtml = `<button id="btn-salvar-entrevista" type="button" class="btn btn-primary" style="width: 100%; margin-top: 20px;">Salvar Altera√ß√µes</button>`;
                }

                const legenda = isInicioRealDeTratamento ? "Entrevista de In√≠cio de Tratamento" : `Detalhes do Atendimento da ${semanaNum}¬™ Semana`;

                return `<fieldset><legend>${legenda}</legend>
                        <div class="form-grid" style="background-color: #f8f9fa; padding: 10px; border-radius: 6px;">
                            <div class="form-item"><label>Assistido:</label><h3 id="assistido-nome" style="text-align:left; margin:0;">Carregando...</h3></div>
                            <div class="form-item"><label>Data do Atendimento:</label><p id="data-atendimento" style="margin:0;">${dataAtendimento}</p></div>
                        </div><hr>
                        <div class="form-grid">
                            <div class="form-item"><label for="entrevistador-nome">Entrevistador:</label><input type="text" id="entrevistador-nome"></div>
                        </div>
                        <div class="form-item" style="margin-top: 15px;"><label for="entrevista-notas">Descri√ß√£o da Entrevista:</label><textarea id="entrevista-notas" rows="6"></textarea></div>
                        ${acompanhamentoHtml}
                        ${colegiadoHtml}
                        ${botoesHtml}
                </fieldset>`;
            }
            
            // Esta fun√ß√£o foi removida pois sua l√≥gica foi incorporada em `darAlta` e `salvarDecisaoColegiado`
            // async function encontrarFilaDoDia(atendimento) { ... }

            // ===================================================================
            // FIM DA √ÅREA MODIFICADA
            // ===================================================================
        }
    </script>
</body>
</html>