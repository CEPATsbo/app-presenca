<!DOCTYPE html>
<html lang="pt-br">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Detalhes do Atendimento - AE</title>
Â  Â  <style>
Â  Â  Â  Â  :root { --cor-primaria: #007bff; --cor-borda: #ddd; --fundo-desabilitado: #e9ecef; }
Â  Â  Â  Â  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
Â  Â  Â  Â  .container { width: 100%; max-width: 900px; background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 6px 24px rgba(0,0,0,0.1); margin: auto; }
Â  Â  Â  Â  .nav-voltar { width: 100%; max-width: 900px; margin: auto; margin-bottom: 20px; }
Â  Â  Â  Â  .btn, .btn-voltar { background-color: var(--cor-primaria); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; font-size: 1em; text-decoration: none; cursor: pointer; transition: background-color 0.3s; }
Â  Â  Â  Â  .btn:disabled { background-color: #ccc; cursor: not-allowed; }
Â  Â  Â  Â  .btn-voltar { background-color: #6c757d; }
Â  Â  Â  Â  .btn-success { background-color: #28a745; }
Â  Â  Â  Â  .btn-danger { background-color: #dc3545; }
Â  Â  Â  Â  .btn-secondary { background-color: #6c757d; }
Â  Â  Â  Â  h1, h3 { color: #333; text-align: center; }
Â  Â  Â  Â  fieldset { border: 1px solid var(--cor-borda); border-radius: 8px; padding: 20px; margin-bottom: 20px; }
Â  Â  Â  Â  legend { font-weight: bold; font-size: 1.2em; color: #0056b3; padding: 0 10px; }
Â  Â  Â  Â  .form-item { display: flex; flex-direction: column; }
Â  Â  Â  Â  .form-item label { margin-bottom: 5px; font-weight: bold; color: #555; }
Â  Â  Â  Â  .form-item input, .form-item select, .form-item textarea, .form-item .readonly-input { padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 1em; width: 100%; box-sizing: border-box; }
Â  Â  Â  Â  .form-item .readonly-input { background-color: var(--fundo-desabilitado); }
Â  Â  Â  Â  .form-item input:disabled, .form-item select:disabled, .form-item textarea:disabled { background-color: var(--fundo-desabilitado); cursor: not-allowed; }
Â  Â  Â  Â  .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end; }
Â  Â  Â  Â  .multiselect { position: relative; }
Â  Â  Â  Â  .select-box { border: 1px solid #ccc; border-radius: 6px; padding: 10px; cursor: pointer; background-color: #fff; min-height: 1.5em; }
Â  Â  Â  Â  .select-box[disabled] { background-color: var(--fundo-desabilitado); cursor: not-allowed; }
Â  Â  Â  Â  .checkboxes { display: none; position: absolute; background: white; border: 1px solid var(--cor-borda); border-radius: 6px; z-index: 100; max-height: 200px; overflow-y: auto; padding: 5px; width: 100%; box-sizing: border-box; }
Â  Â  Â  Â  .checkboxes.visible { display: block; }
Â  Â  Â  Â  .checkboxes label { display: block; padding: 5px 8px; }
Â  Â  Â  Â  .checkboxes label:hover { background-color: #f0f0f0; }
Â  Â  Â  Â  .erro { color: #dc3545; font-weight: bold; text-align: center; }
Â  Â  Â  Â  .hidden { display: none; }
Â  Â  Â  Â  .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 1000; display: flex; align-items: center; justify-content: center; }
Â  Â  Â  Â  .modal-content { background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 100%; max-width: 400px; }
Â  Â  Â  Â  .modal-header { text-align: center; margin-bottom: 20px; }
Â  Â  Â  Â  .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
Â  Â  Â  Â  .info-text { font-size: 0.8em; color: #6c757d; margin-top: -10px; margin-bottom: 10px; text-align: center; }
Â  Â  </style>
</head>
<body>
Â  Â  <nav class="nav-voltar"><a href="/arquivo-geral-ae.html" class="btn-voltar">â¬… Voltar para o Arquivo Geral</a></nav>
Â  Â  <div id="acesso-negado" class="container hidden"><h1>Acesso Negado</h1></div>

Â  Â  <div id="main-content" class="container">
Â  Â  Â  Â  <h1>Detalhes do Atendimento</h1>
Â  Â  Â  Â  <p style="text-align: center; margin-top: -10px;">Adicione ou edite as informaÃ§Ãµes do atendimento.</p>
Â  Â  Â  Â  <div id="formulario-container">
Â  Â  Â  Â  Â  Â  <p>Carregando dados do atendimento...</p>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="reauth-modal" class="modal-overlay hidden">
Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  Â  <div class="modal-header">
Â  Â  Â  Â  Â  Â  Â  Â  <h3>Habilitar EdiÃ§Ã£o</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <p>Para sua seguranÃ§a, por favor, confirme sua identidade digitando sua senha novamente.</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <form id="reauth-form" onsubmit="return false;">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-item">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="reauth-email">Email:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="info-text">Seu email de login (nÃ£o pode ser alterado).</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="email" id="reauth-email" class="readonly-input" readonly>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-item">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="reauth-password">Senha:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="reauth-password" required autocomplete="current-password">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <p id="reauth-error" class="erro hidden"></p>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="modal-actions">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="btn-reauth-cancel" class="btn btn-secondary">Cancelar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" id="btn-reauth-confirm" class="btn btn-success">Confirmar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <script type="module">
Â  Â  Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
Â  Â  Â  Â  import { getFirestore, collection, doc, getDoc, updateDoc, query, where, Timestamp, getDocs, writeBatch, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
Â  Â  Â  Â  import { getAuth, EmailAuthProvider, reauthenticateWithCredential } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
Â  Â  Â  Â  import { protegerPagina } from '/auth.js';

Â  Â  Â  Â  const firebaseConfig = {
Â  Â  Â  Â  Â  Â  apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU",
Â  Â  Â  Â  Â  Â  authDomain: "voluntarios-ativos---cepat.firebaseapp.com",
Â  Â  Â  Â  Â  Â  projectId: "voluntarios-ativos---cepat",
Â  Â  Â  Â  Â  Â  storageBucket: "voluntarios-ativos---cepat.firebasestorage.app",
Â  Â  Â  Â  Â  Â  messagingSenderId: "66122858261",
Â  Â  Â  Â  Â  Â  appId: "1:66122858261:web:7fa21f1805463b5c08331c"
Â  Â  Â  Â  };
Â  Â  Â  Â  initializeApp(firebaseConfig);
Â  Â  Â  Â  const auth = getAuth();

Â  Â  Â  Â  protegerPagina(['entrevistador', 'diretor', 'super-admin']).then(user => {
Â  Â  Â  Â  Â  Â  document.getElementById('main-content').classList.remove('hidden');
Â  Â  Â  Â  Â  Â  inicializarPagina(user);
Â  Â  Â  Â  }).catch(err => {
Â  Â  Â  Â  Â  Â  document.getElementById('acesso-negado').classList.remove('hidden');
Â  Â  Â  Â  Â  Â  document.getElementById('main-content').classList.add('hidden');
Â  Â  Â  Â  });

Â  Â  Â  Â  function inicializarPagina(user) {
Â  Â  Â  Â  Â  Â  const db = getFirestore();
Â  Â  Â  Â  Â  Â  const tratamentosRef = collection(db, 'tratamentos_ae');
Â  Â  Â  Â  Â  Â  const atendimentosRef = collection(db, 'atendimentos_ae');
Â  Â  Â  Â  Â  Â  const filaRef = collection(db, 'fila_atendimento_ae');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const ui = {
Â  Â  Â  Â  Â  Â  Â  Â  formularioContainer: document.getElementById('formulario-container'),
Â  Â  Â  Â  Â  Â  Â  Â  modal: document.getElementById('reauth-modal'),
Â  Â  Â  Â  Â  Â  Â  Â  reauthForm: document.getElementById('reauth-form'),
Â  Â  Â  Â  Â  Â  Â  Â  reauthEmail: document.getElementById('reauth-email'),
Â  Â  Â  Â  Â  Â  Â  Â  reauthPassword: document.getElementById('reauth-password'),
Â  Â  Â  Â  Â  Â  Â  Â  reauthError: document.getElementById('reauth-error'),
Â  Â  Â  Â  Â  Â  Â  Â  btnReauthCancel: document.getElementById('btn-reauth-cancel'),
Â  Â  Â  Â  Â  Â  Â  Â  btnReauthConfirm: document.getElementById('btn-reauth-confirm'),
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  const params = new URLSearchParams(window.location.search);
Â  Â  Â  Â  Â  Â  const atendimentoIdParaEditar = params.get('atendimentoId');

Â  Â  Â  Â  Â  Â  if (atendimentoIdParaEditar) {
Â  Â  Â  Â  Â  Â  Â  Â  carregarFormularioParaEdicao(atendimentoIdParaEditar);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â ui.formularioContainer.innerHTML = `<p class="erro">Nenhum atendimento selecionado. Acesse esta pÃ¡gina a partir de um link de ediÃ§Ã£o no histÃ³rico do assistido.</p>`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function travarFormulario() {
Â  Â  Â  Â  Â  Â  Â  Â  const form = ui.formularioContainer.querySelector('fieldset');
Â  Â  Â  Â  Â  Â  Â  Â  if (!form) return;
Â  Â  Â  Â  Â  Â  Â  Â  form.querySelectorAll('input, select, textarea').forEach(el => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!el.classList.contains('readonly-input')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  el.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  const selectBox = form.querySelector('.select-box');
Â  Â  Â  Â  Â  Â  Â  Â  if (selectBox) selectBox.setAttribute('disabled', 'disabled');

Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('btn-salvar-entrevista').classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  const btnAlta = document.getElementById('btn-dar-alta');
Â  Â  Â  Â  Â  Â  Â  Â  if(btnAlta) btnAlta.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const btnHabilitarExistente = document.getElementById('btn-habilitar-edicao');
Â  Â  Â  Â  Â  Â  Â  Â  if(btnHabilitarExistente) btnHabilitarExistente.remove();

Â  Â  Â  Â  Â  Â  Â  Â  const btnHabilitar = document.createElement('button');
Â  Â  Â  Â  Â  Â  Â  Â  btnHabilitar.id = 'btn-habilitar-edicao';
Â  Â  Â  Â  Â  Â  Â  Â  btnHabilitar.className = 'btn btn-secondary';
Â  Â  Â  Â  Â  Â  Â  Â  btnHabilitar.style.width = '100%';
Â  Â  Â  Â  Â  Â  Â  Â  btnHabilitar.style.marginTop = '10px';
Â  Â  Â  Â  Â  Â  Â  Â  btnHabilitar.innerHTML = 'ðŸ”’ Habilitar EdiÃ§Ã£o';
Â  Â  Â  Â  Â  Â  Â  Â  btnHabilitar.type = 'button';
Â  Â  Â  Â  Â  Â  Â  Â  btnHabilitar.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ui.reauthEmail.value = user.email;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ui.modal.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ui.reauthPassword.focus();
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  form.appendChild(btnHabilitar);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function destravarFormulario() {
Â  Â  Â  Â  Â  Â  Â  Â  const form = ui.formularioContainer.querySelector('fieldset');
Â  Â  Â  Â  Â  Â  Â  Â  if (!form) return;
Â  Â  Â  Â  Â  Â  Â  Â  form.querySelectorAll('input, select, textarea').forEach(el => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(!el.classList.contains('readonly-input')) el.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const selectBox = form.querySelector('.select-box');
Â  Â  Â  Â  Â  Â  Â  Â  if (selectBox) selectBox.removeAttribute('disabled');

Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('btn-salvar-entrevista').classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  const btnAlta = document.getElementById('btn-dar-alta');
Â  Â  Â  Â  Â  Â  Â  Â  if(btnAlta) btnAlta.classList.remove('hidden');

Â  Â  Â  Â  Â  Â  Â  Â  const btnHabilitar = document.getElementById('btn-habilitar-edicao');
Â  Â  Â  Â  Â  Â  Â  Â  if (btnHabilitar) btnHabilitar.remove();
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  ui.reauthForm.addEventListener('submit', async (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  const password = ui.reauthPassword.value;
Â  Â  Â  Â  Â  Â  Â  Â  if (!password) return;

Â  Â  Â  Â  Â  Â  Â  Â  ui.btnReauthConfirm.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  ui.reauthError.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  const credential = EmailAuthProvider.credential(user.email, password);

Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await reauthenticateWithCredential(user, credential);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  destravarFormulario();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ui.modal.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ui.reauthForm.reset();
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Erro de reautenticaÃ§Ã£o:", error.code);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential' || error.code === 'auth/invalid-login-credentials') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ui.reauthError.textContent = 'Senha incorreta. Tente novamente.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ui.reauthError.textContent = 'Ocorreu um erro. Tente novamente mais tarde.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ui.reauthError.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ui.btnReauthConfirm.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  ui.btnReauthCancel.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  ui.modal.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  ui.reauthForm.reset();
Â  Â  Â  Â  Â  Â  Â  Â  ui.reauthError.classList.add('hidden');
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  async function carregarFormularioParaEdicao(atendimentoId) {
Â  Â  Â  Â  Â  Â  Â  Â  const atendimentoDocRef = doc(db, 'atendimentos_ae', atendimentoId);
Â  Â  Â  Â  Â  Â  Â  Â  const atendimentoDoc = await getDoc(atendimentoDocRef);

Â  Â  Â  Â  Â  Â  Â  Â  if (!atendimentoDoc.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ui.formularioContainer.innerHTML = `<p class="erro">Atendimento com ID ${atendimentoId} nÃ£o encontrado.</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  const atendimento = { id: atendimentoDoc.id, ...atendimentoDoc.data() };
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const assistidoDoc = await getDoc(doc(db, 'assistidos', atendimento.assistidoId));
Â  Â  Â  Â  Â  Â  Â  Â  const nomeAssistido = assistidoDoc.exists() ? assistidoDoc.data().nome : "Assistido nÃ£o encontrado";

Â  Â  Â  Â  Â  Â  Â  Â  const isQuintaSemana = atendimento.semana === 5;
Â  Â  Â  Â  Â  Â  Â  Â  const formHtml = criarFormulario(atendimento.semana, atendimento.passeRecomendado, isQuintaSemana, atendimento);
Â  Â  Â  Â  Â  Â  Â  Â  ui.formularioContainer.innerHTML = formHtml;
Â  Â  Â  Â  Â  Â  Â  Â  preencherFormulario(atendimento, nomeAssistido);

Â  Â  Â  Â  Â  Â  Â  Â  if (atendimento.detalhes_preenchidos === true) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  travarFormulario();
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('btn-salvar-entrevista')?.addEventListener('click', () => salvarEdicao(atendimento));
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('btn-dar-alta')?.addEventListener('click', () => darAlta(atendimento));
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const selectBox = document.querySelector('.select-box');
Â  Â  Â  Â  Â  Â  Â  Â  const checkboxes = document.querySelector('.checkboxes');
Â  Â  Â  Â  Â  Â  Â  Â  if (selectBox && checkboxes) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selectBox.addEventListener('click', () => { if (selectBox.getAttribute('disabled') === null) checkboxes.classList.toggle('visible'); });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  checkboxes.addEventListener('change', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const selecionados = Array.from(checkboxes.querySelectorAll('input:checked')).map(cb => cb.value);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selectBox.textContent = selecionados.length > 0 ? selecionados.join(', ') : 'Selecione...';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (selectBox && !selectBox.contains(e.target) && !checkboxes.contains(e.target)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  checkboxes.classList.remove('visible');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  function preencherFormulario(atendimento, nomeAssistido) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('assistido-nome').textContent = nomeAssistido;
Â  Â  Â  Â  Â  Â  Â  Â  if (document.getElementById('entrevistador-nome')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('entrevistador-nome').value = atendimento.entrevistador === 'Aguardando Detalhes' || atendimento.entrevistador === 'Passe Direto' ? user.displayName : (atendimento.entrevistador || '');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (document.getElementById('entrevista-notas')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('entrevista-notas').value = atendimento.notas || '';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (document.getElementById('retorno-inicio')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('retorno-inicio').value = atendimento.horarioInicio || '';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (document.getElementById('retorno-fim')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('retorno-fim').value = atendimento.horarioFim || '';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (atendimento.evolucao) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const evolucaoRadio = document.querySelector(`input[name="evolucao"][value="${atendimento.evolucao}"]`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (evolucaoRadio) evolucaoRadio.checked = true;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (atendimento.semana === 5) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (document.getElementById('colegiado-para') && atendimento.passePara) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('colegiado-para').value = atendimento.passePara;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (document.getElementById('colegiado-notas')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('colegiado-notas').value = atendimento.colegiadoNotas || '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (atendimento.encaminhamentos && atendimento.encaminhamentos.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const selectBox = document.querySelector('.select-box');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selectBox.textContent = atendimento.encaminhamentos.join(', ');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  atendimento.encaminhamentos.forEach(val => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const checkbox = document.querySelector(`.checkboxes input[value="${val}"]`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (checkbox) checkbox.checked = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const gerarOpcoesPasse = (selecionado = '') => {
Â  Â  Â  Â  Â  Â  Â  Â  const passes = ['P1', 'P2', 'P3A', 'P3B', 'P4A', 'P4B', 'CH'];
Â  Â  Â  Â  Â  Â  Â  Â  let html = '<option value="">Selecione...</option>';
Â  Â  Â  Â  Â  Â  Â  Â  passes.forEach(p => { html += `<option value="${p}" ${p === selecionado ? 'selected' : ''}>${p}</option>`; });
Â  Â  Â  Â  Â  Â  Â  Â  return html;
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  function criarFormulario(semanaNum, passeDe, mostrarColegiado, atendimento) {
Â  Â  Â  Â  Â  Â  Â  Â  const dataAtendimento = atendimento.dataAtendimento ? atendimento.dataAtendimento.toDate().toLocaleDateString('pt-br') : new Date().toLocaleDateString('pt-br');
Â  Â  Â  Â  Â  Â  Â  Â  let colegiadoHtml = '';
Â  Â  Â  Â  Â  Â  Â  Â  if (mostrarColegiado) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  colegiadoHtml = `<hr><h5>Colegiado</h5>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-grid"><div class="form-item"><label for="colegiado-de">DE:</label><select id="colegiado-de" class="readonly-input" disabled>${gerarOpcoesPasse(passeDe)}</select></div><div class="form-item"><label for="colegiado-para">PARA (Mudar o passe):</label><select id="colegiado-para">${gerarOpcoesPasse()}</select></div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-item" style="margin-top:15px;"><label>Encaminhamentos (MÃºltipla Escolha):</label><div class="multiselect">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="select-box" tabindex="0">Selecione...</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="checkboxes">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label><input type="checkbox" value="ENL"/> ENL</label><label><input type="checkbox" value="LEITURAS"/> Leituras</label><label><input type="checkbox" value="EAE"/> EAE</label><label><input type="checkbox" value="VOLUNTARIADO"/> Voluntariado</label><label><input type="checkbox" value="MÃ‰DICO"/> MÃ©dico</label><label><input type="checkbox" value="ALIMENTO"/> Alimento</label><label><input type="checkbox" value="NATUREZA"/> Natureza</label><label><input type="checkbox" value="MOCIDADE"/> Mocidade</label><label><input type="checkbox" value="EVANGELIZAÃ‡ÃƒO"/> EvangelizaÃ§Ã£o</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div></div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-item" style="margin-top: 15px;"><label for="colegiado-notas">OrientaÃ§Ãµes do Colegiado:</label><textarea id="colegiado-notas" rows="4"></textarea></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="btn-dar-alta" type="button" class="btn btn-danger" style="width: 100%; margin-top: 10px;">Confirmar e Dar Alta</button>`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return `<fieldset><legend>Detalhes do Atendimento da ${semanaNum}Âª Semana</legend>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-grid" style="background-color: #f8f9fa; padding: 10px; border-radius: 6px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-item"><label>Assistido:</label><h3 id="assistido-nome" style="text-align:left; margin:0;">Carregando...</h3></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-item"><label>Data do Atendimento:</label><p id="data-atendimento" style="margin:0; font-weight:bold;">${dataAtendimento}</p></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div><hr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-item"><label for="entrevistador-nome">Entrevistador:</label><input type="text" id="entrevistador-nome" value="${user.displayName || ''}"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-item" style="margin-top: 15px;"><label for="entrevista-notas">DescriÃ§Ã£o da Entrevista:</label><textarea id="entrevista-notas" rows="6"></textarea></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <hr><h5>Detalhes do Passe</h5><div class="form-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-item"><label for="retorno-passe">Passe:</label><input type="text" id="retorno-passe" class="readonly-input" value="${passeDe}" readonly></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-item"><label for="retorno-inicio">InÃ­cio:</label><input type="time" id="retorno-inicio"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-item"><label for="retorno-fim">Fim:</label><input type="time" id="retorno-fim"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-item" style="margin-top:15px;"><label>EvoluÃ§Ã£o:</label><div style="display:flex; gap: 15px;"><label><input type="radio" name="evolucao" value="melhorou"> Melhorou</label><label><input type="radio" name="evolucao" value="piorou"> Piorou</label><label><input type="radio" name="evolucao" value="na_mesma" checked> Na Mesma</label></div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${colegiadoHtml}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="btn-salvar-entrevista" type="button" class="btn btn-primary" style="width: 100%; margin-top: 20px;">Salvar AlteraÃ§Ãµes</button>
Â  Â  Â  Â  Â  Â  Â  Â  </fieldset>`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  async function encontrarFilaDoDia(atendimento) {
Â  Â  Â  Â  Â  Â  Â  Â  if (!atendimento.atendimentoId) { // Fallback para a busca antiga se a ponte nÃ£o existir
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dataDoAtendimento = atendimento.dataAtendimento.toDate();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const inicioDoDia = new Date(dataDoAtendimento.setHours(0,0,0,0));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const fimDoDia = new Date(dataDoAtendimento.setHours(23,59,59,999));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const q = query(filaRef, where("assistidoId", "==", atendimento.assistidoId), where("chegadaEm", ">=", Timestamp.fromDate(inicioDoDia)), where("chegadaEm", "<=", Timestamp.fromDate(fimDoDia)), limit(1));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const filaSnapshot = await getDocs(q);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!filaSnapshot.empty) return filaSnapshot.docs[0].ref;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  // Busca pela ponte de ligaÃ§Ã£o
Â  Â  Â  Â  Â  Â  Â  Â  const q = query(filaRef, where("atendimentoId", "==", atendimento.id), limit(1));
Â  Â  Â  Â  Â  Â  Â  Â  const filaSnapshot = await getDocs(q);
Â  Â  Â  Â  Â  Â  Â  Â  if (!filaSnapshot.empty) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return filaSnapshot.docs[0].ref;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  async function salvarEdicao(atendimento) {
Â  Â  Â  Â  Â  Â  Â  Â  const btn = document.getElementById('btn-salvar-entrevista');
Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  btn.textContent = 'Salvando...';

Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const batch = writeBatch(db);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const atendimentoDocRef = doc(db, 'atendimentos_ae', atendimento.id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dadosParaAtualizar = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  entrevistador: document.getElementById('entrevistador-nome').value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  notas: document.getElementById('entrevista-notas').value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  horarioInicio: document.getElementById('retorno-inicio').value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  horarioFim: document.getElementById('retorno-fim').value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  evolucao: document.querySelector('input[name="evolucao"]:checked').value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  detalhes_preenchidos: true
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (atendimento.semana === 5) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const passePara = document.getElementById('colegiado-para')?.value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const filaDocRef = await encontrarFilaDoDia(atendimento);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (passePara) { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const tratamentoDocRef = doc(db, 'tratamentos_ae', atendimento.tratamentoId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  batch.update(tratamentoDocRef, { status: 'concluido_por_reavaliacao', dataFim: serverTimestamp() });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const novoTratamentoRef = doc(tratamentosRef);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  batch.set(novoTratamentoRef, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  assistidoId: atendimento.assistidoId, dataInicio: serverTimestamp(), status: 'ativo',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  faltas_acumuladas: 0, passe_ciclo_atual: passePara
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dadosParaAtualizar.tratamentoId = novoTratamentoRef.id;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dadosParaAtualizar.semana = 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dadosParaAtualizar.passePara = passePara;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (filaDocRef) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  batch.update(filaDocRef, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tratamentoId: novoTratamentoRef.id,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  semana_atual: 1,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  passeRecomendado: passePara,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  decisao_registrada: true
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if(filaDocRef) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  batch.update(filaDocRef, { decisao_registrada: true });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dadosParaAtualizar.colegiadoNotas = document.getElementById('colegiado-notas').value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dadosParaAtualizar.encaminhamentos = Array.from(document.querySelectorAll('.checkboxes input:checked')).map(cb => cb.value);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  batch.update(atendimentoDocRef, dadosParaAtualizar);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await batch.commit();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert('Detalhes do atendimento atualizados com sucesso!');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  travarFormulario();

Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Erro ao salvar ediÃ§Ã£o:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("Falha ao salvar. Tente novamente.");
Â  Â  Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.textContent = 'Salvar AlteraÃ§Ãµes';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  async function darAlta(atendimento) {
Â  Â  Â  Â  Â  Â  Â  Â  Â const btn = document.getElementById('btn-dar-alta');
Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  if (confirm(`Tem certeza que deseja dar alta para este assistido?`)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const batch = writeBatch(db);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const tratamentoDocRef = doc(db, 'tratamentos_ae', atendimento.tratamentoId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  batch.update(tratamentoDocRef, { status: 'concluido_com_alta', dataFim: serverTimestamp() });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const atendimentoDocRef = doc(db, 'atendimentos_ae', atendimento.id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  batch.update(atendimentoDocRef, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â tipo: 'alta',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â colegiadoNotas: document.getElementById('colegiado-notas')?.value || "Atendimento de reavaliaÃ§Ã£o finalizado com alta.",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â detalhes_preenchidos: true
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const filaDocRef = await encontrarFilaDoDia(atendimento);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (filaDocRef) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  batch.update(filaDocRef, { decisao_registrada: true });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await batch.commit();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert('Alta registrada! O tratamento foi encerrado.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  travarFormulario();
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â btn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  </script>
</body>
</html>