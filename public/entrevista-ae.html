<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Atendimento - AE</title>
    <style>
        :root { --cor-primaria: #007bff; --cor-borda: #ddd; --fundo-desabilitado: #f9f9f9; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .container { width: 100%; max-width: 900px; background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 6px 24px rgba(0,0,0,0.1); margin: auto; }
        .nav-voltar { width: 100%; max-width: 900px; margin: auto; margin-bottom: 20px; }
        .btn, .btn-voltar { background-color: var(--cor-primaria); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; font-size: 1em; text-decoration: none; cursor: pointer; transition: background-color 0.3s; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-voltar { background-color: #6c757d; }
        .btn-success { background-color: #28a745; }
        .btn-danger { background-color: #dc3545; }
        h1, h3 { color: #333; text-align: center; }
        fieldset { border: 1px solid var(--cor-borda); border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        legend { font-weight: bold; font-size: 1.2em; color: #0056b3; padding: 0 10px; }
        .form-item { display: flex; flex-direction: column; }
        .form-item label { margin-bottom: 5px; font-weight: bold; color: #555; }
        .form-item input, .form-item select, .form-item textarea, .form-item .readonly-input { padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 1em; width: 100%; box-sizing: border-box; }
        .form-item .readonly-input { background-color: #e9ecef; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end; }
        .multiselect { position: relative; }
        .select-box { border: 1px solid #ccc; border-radius: 6px; padding: 10px; cursor: pointer; background-color: #fff; min-height: 1.5em; }
        .checkboxes { display: none; position: absolute; background: white; border: 1px solid var(--cor-borda); border-radius: 6px; z-index: 100; max-height: 200px; overflow-y: auto; padding: 5px; width: 100%; box-sizing: border-box; }
        .checkboxes.visible { display: block; }
        .checkboxes label { display: block; padding: 5px 8px; }
        .checkboxes label:hover { background-color: #f0f0f0; }
        .erro { color: #dc3545; font-weight: bold; text-align: center; }
    </style>
</head>
<body>
    <nav class="nav-voltar"><a href="/arquivo-geral-ae.html" class="btn-voltar">⬅ Voltar para o Arquivo Geral</a></nav>
    <div id="acesso-negado" class="container hidden"><h1>Acesso Negado</h1></div>

    <div id="main-content" class="container">
        <h1>Detalhes do Atendimento</h1>
        <p style="text-align: center; margin-top: -10px;">Adicione ou edite as informações do atendimento.</p>
        <div id="formulario-container">
            <p>Carregando dados do atendimento...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, updateDoc, query, where, Timestamp, getDocs, writeBatch, serverTimestamp, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { protegerPagina } from '/auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU",
            authDomain: "voluntarios-ativos---cepat.firebaseapp.com",
            projectId: "voluntarios-ativos---cepat",
            storageBucket: "voluntarios-ativos---cepat.firebasestorage.app",
            messagingSenderId: "66122858261",
            appId: "1:66122858261:web:7fa21f1805463b5c08331c"
        };
        initializeApp(firebaseConfig);

        protegerPagina(['entrevistador', 'diretor', 'super-admin']).then(user => {
            document.getElementById('main-content').classList.remove('hidden');
            inicializarPagina(user);
        }).catch(err => {
            document.getElementById('acesso-negado').classList.remove('hidden');
            document.getElementById('main-content').classList.add('hidden');
        });

        function inicializarPagina(user) {
            const db = getFirestore();
            const tratamentosRef = collection(db, 'tratamentos_ae');
            const atendimentosRef = collection(db, 'atendimentos_ae');
            const filaRef = collection(db, 'fila_atendimento_ae');
            
            const ui = {
                formularioContainer: document.getElementById('formulario-container'),
            };

            const params = new URLSearchParams(window.location.search);
            const atendimentoIdParaEditar = params.get('atendimentoId');

            if (atendimentoIdParaEditar) {
                carregarFormularioParaEdicao(atendimentoIdParaEditar);
            } else {
                 ui.formularioContainer.innerHTML = `<p class="erro">Nenhum atendimento selecionado. Acesse esta página a partir de um link de edição no histórico do assistido.</p>`;
            }

            async function carregarFormularioParaEdicao(atendimentoId) {
                 const atendimentoDocRef = doc(db, 'atendimentos_ae', atendimentoId);
                const atendimentoDoc = await getDoc(atendimentoDocRef);

                if (!atendimentoDoc.exists()) {
                    ui.formularioContainer.innerHTML = `<p class="erro">Atendimento com ID ${atendimentoId} não encontrado.</p>`;
                    return;
                }
                const atendimento = { id: atendimentoDoc.id, ...atendimentoDoc.data() };
                
                const assistidoDoc = await getDoc(doc(db, 'assistidos', atendimento.assistidoId));
                const nomeAssistido = assistidoDoc.exists() ? assistidoDoc.data().nome : "Assistido não encontrado";

                const isQuintaSemana = atendimento.semana === 5;
                const formHtml = criarFormulario(atendimento.semana, atendimento.passeRecomendado, isQuintaSemana, atendimento);
                ui.formularioContainer.innerHTML = formHtml;
                preencherFormulario(atendimento, nomeAssistido);

                document.getElementById('btn-salvar-entrevista')?.addEventListener('click', () => salvarEdicao(atendimento));
                document.getElementById('btn-dar-alta')?.addEventListener('click', () => darAlta(atendimento));
                
                const selectBox = document.querySelector('.select-box');
                const checkboxes = document.querySelector('.checkboxes');
                if (selectBox && checkboxes) {
                    selectBox.addEventListener('click', () => { checkboxes.classList.toggle('visible'); });
                    checkboxes.addEventListener('change', () => {
                        const selecionados = Array.from(checkboxes.querySelectorAll('input:checked')).map(cb => cb.value);
                        selectBox.textContent = selecionados.length > 0 ? selecionados.join(', ') : 'Selecione...';
                    });
                    document.addEventListener('click', (e) => {
                        if (!selectBox.contains(e.target) && !checkboxes.contains(e.target)) {
                            checkboxes.classList.remove('visible');
                        }
                    });
                }
            }

            function preencherFormulario(atendimento, nomeAssistido) {
                document.getElementById('assistido-nome').textContent = nomeAssistido;
                if (document.getElementById('entrevistador-nome')) {
                    document.getElementById('entrevistador-nome').value = atendimento.entrevistador === 'Aguardando Detalhes' || atendimento.entrevistador === 'Passe Direto' ? user.displayName : (atendimento.entrevistador || '');
                }
                if (document.getElementById('entrevista-notas')) {
                    document.getElementById('entrevista-notas').value = atendimento.notas || '';
                }
                if (document.getElementById('retorno-inicio')) {
                    document.getElementById('retorno-inicio').value = atendimento.horarioInicio || '';
                }
                if (document.getElementById('retorno-fim')) {
                    document.getElementById('retorno-fim').value = atendimento.horarioFim || '';
                }
                if (atendimento.evolucao) {
                    const evolucaoRadio = document.querySelector(`input[name="evolucao"][value="${atendimento.evolucao}"]`);
                    if (evolucaoRadio) evolucaoRadio.checked = true;
                }
                if (atendimento.semana === 5) {
                    if (document.getElementById('colegiado-para') && atendimento.passePara) {
                        document.getElementById('colegiado-para').value = atendimento.passePara;
                    }
                    if (document.getElementById('colegiado-notas')) {
                         document.getElementById('colegiado-notas').value = atendimento.colegiadoNotas || '';
                    }
                    if (atendimento.encaminhamentos && atendimento.encaminhamentos.length > 0) {
                        const selectBox = document.querySelector('.select-box');
                        selectBox.textContent = atendimento.encaminhamentos.join(', ');
                        atendimento.encaminhamentos.forEach(val => {
                            const checkbox = document.querySelector(`.checkboxes input[value="${val}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                }
            }

            const gerarOpcoesPasse = (selecionado = '') => { /* ...código completo aqui... */ };
            function criarFormulario(semanaNum, passeDe, mostrarColegiado, atendimento) { /* ...código completo aqui... */ }

            async function salvarEdicao(atendimento) {
                const btn = document.getElementById('btn-salvar-entrevista');
                btn.disabled = true;
                btn.textContent = 'Salvando...';

                try {
                    const batch = writeBatch(db);
                    const atendimentoDocRef = doc(db, 'atendimentos_ae', atendimento.id);
                    
                    const dadosParaAtualizar = {
                        entrevistador: document.getElementById('entrevistador-nome').value,
                        notas: document.getElementById('entrevista-notas').value,
                        horarioInicio: document.getElementById('retorno-inicio').value,
                        horarioFim: document.getElementById('retorno-fim').value,
                        evolucao: document.querySelector('input[name="evolucao"]:checked').value
                    };
                    
                    if (atendimento.semana === 5) {
                        const passePara = document.getElementById('colegiado-para')?.value;
                        if (passePara) { 
                            const tratamentoDocRef = doc(db, 'tratamentos_ae', atendimento.tratamentoId);
                            batch.update(tratamentoDocRef, { status: 'concluido_por_reavaliacao', dataFim: serverTimestamp() });
                            
                            const novoTratamentoRef = doc(tratamentosRef);
                            batch.set(novoTratamentoRef, {
                                assistidoId: atendimento.assistidoId, dataInicio: serverTimestamp(), status: 'ativo',
                                faltas_acumuladas: 0, passe_ciclo_atual: passePara
                            });
                            
                            dadosParaAtualizar.tratamentoId = novoTratamentoRef.id;
                            dadosParaAtualizar.semana = 1;
                            dadosParaAtualizar.passePara = passePara;
                            
                            const filaQuery = query(filaRef, where("assistidoId", "==", atendimento.assistidoId), where("chegadaEm", ">=", new Date(new Date().setHours(0,0,0,0))));
                            const filaSnapshot = await getDocs(filaQuery);
                            if (!filaSnapshot.empty) {
                                const filaDocRef = filaSnapshot.docs[0].ref;
                                batch.update(filaDocRef, {
                                    tratamentoId: novoTratamentoRef.id,
                                    semana_atual: 1,
                                    passeRecomendado: passePara
                                });
                            }
                        }
                        dadosParaAtualizar.colegiadoNotas = document.getElementById('colegiado-notas').value;
                        dadosParaAtualizar.encaminhamentos = Array.from(document.querySelectorAll('.checkboxes input:checked')).map(cb => cb.value);
                    }

                    batch.update(atendimentoDocRef, dadosParaAtualizar);
                    await batch.commit();
                    alert('Detalhes do atendimento atualizados com sucesso!');

                } catch (error) {
                    console.error("Erro ao salvar edição:", error);
                    alert("Falha ao salvar. Tente novamente.");
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Salvar Alterações';
                }
            }

            async function darAlta(atendimento) {
                 const btn = document.getElementById('btn-dar-alta');
                btn.disabled = true;
                if (confirm(`Tem certeza que deseja dar alta para este assistido?`)) {
                    
                    const batch = writeBatch(db);
                    const tratamentoDocRef = doc(db, 'tratamentos_ae', atendimento.tratamentoId);
                    batch.update(tratamentoDocRef, { status: 'concluido_com_alta', dataFim: serverTimestamp() });
                    
                    const atendimentoDocRef = doc(db, 'atendimentos_ae', atendimento.id);
                    batch.update(atendimentoDocRef, {
                         tipo: 'alta',
                         colegiadoNotas: document.getElementById('colegiado-notas')?.value || "Atendimento de reavaliação finalizado com alta."
                    });
                    
                    await batch.commit();
                    alert('Alta registrada com sucesso! O tratamento foi encerrado. O fluxo do dia continuará para a entrevista final.');
                } else {
                     btn.disabled = false;
                }
            }
        }
    </script>
</body>
</html>