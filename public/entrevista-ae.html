<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Atendimento - AE</title>
    <style>
        :root { --cor-primaria: #007bff; --cor-borda: #ddd; --fundo-desabilitado: #e9ecef; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .container { width: 100%; max-width: 900px; background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 6px 24px rgba(0,0,0,0.1); margin: auto; }
        .nav-voltar { width: 100%; max-width: 900px; margin: auto; margin-bottom: 20px; }
        .btn, .btn-voltar { background-color: var(--cor-primaria); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; font-size: 1em; text-decoration: none; cursor: pointer; transition: background-color 0.3s; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-voltar { background-color: #6c757d; }
        .btn-success { background-color: #28a745; }
        .btn-danger { background-color: #dc3545; }
        .btn-secondary { background-color: #6c757d; }
        h1, h3 { color: #333; text-align: center; }
        fieldset { border: 1px solid var(--cor-borda); border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        legend { font-weight: bold; font-size: 1.2em; color: #0056b3; padding: 0 10px; }
        .form-item { display: flex; flex-direction: column; }
        .form-item label { margin-bottom: 5px; font-weight: bold; color: #555; }
        .form-item input, .form-item select, .form-item textarea, .form-item .readonly-input { padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 1em; width: 100%; box-sizing: border-box; }
        .form-item .readonly-input { background-color: var(--fundo-desabilitado); }
        .form-item input:disabled, .form-item select:disabled, .form-item textarea:disabled { background-color: var(--fundo-desabilitado); cursor: not-allowed; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end; }

        /* --- IN√çCIO DAS MODIFICA√á√ïES CSS --- */
        .checkboxes {
            /* display: none; position: absolute; */ /* REMOVIDO */
            /* REMOVIDO background, border, z-index, max-height, overflow, width, top, margin-top, left */
            /* NOVO: Organiza em colunas */
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* Cria colunas responsivas */
            gap: 5px 15px; /* Espa√ßamento vertical e horizontal */
            padding: 5px 0; /* Padding vertical leve */
            border: 1px solid var(--cor-borda); /* Adiciona borda para agrupar visualmente */
            border-radius: 6px;
            padding: 10px 15px; /* Padding interno */
            margin-top: 5px; /* Espa√ßo ap√≥s o label */
        }
        .checkboxes label {
            display: flex;
            align-items: center;
            gap: 5px; /* Espa√ßo BEM REDUZIDO entre checkbox e texto */
            padding: 3px 0; /* Padding vertical m√≠nimo */
            margin: 0;
            cursor: pointer;
            font-size: 0.95em;
        }
        .checkboxes label input[type="checkbox"] {
             margin: 0;
             flex-shrink: 0;
             /* For√ßa um tamanho se necess√°rio */
             width: 1em;
             height: 1em;
        }
        /* Remove o :hover que escondia a lista */
        /* .checkboxes.visible { display: block; } */ /* REMOVIDO */
        /* Remove estilos do select-box simulado */
        /* .multiselect, .select-box { ... } */ /* REMOVIDO (ou pode deixar se usar em outro lugar) */
        /* --- FIM DAS MODIFICA√á√ïES CSS --- */

        .erro { color: #dc3545; font-weight: bold; text-align: center; }
        .hidden { display: none; }
        .botoes-colegiado { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .data-aviso { font-weight: bold; color: #0056b3; }
        .colegiado-travado p { text-align:center; font-weight: bold; }
        .colegiado-travado .status-alta { color: #dc3545; }
        .colegiado-travado .status-novo-ciclo { color: #007bff; }

    </style>
</head>
<body>
    <nav class="nav-voltar"><a href="#" id="btn-voltar-fecha" class="btn-voltar">‚¨Ö Voltar para o Painel AE (Fecha Aba)</a></nav>
    <div id="acesso-negado" class="container hidden"><h1>Acesso Negado</h1></div>

    <div id="main-content" class="container">
        <h1>Detalhes do Atendimento</h1>
        <p style="text-align: center; margin-top: -10px;">Adicione ou edite as informa√ß√µes do atendimento.</p>
        <div id="formulario-container">
            <p>Carregando dados do atendimento...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, updateDoc, query, where, Timestamp, getDocs, writeBatch, serverTimestamp, limit, addDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { protegerPagina } from '/auth.js';

        const firebaseConfig = { /* ... (configura√ß√£o inalterada) ... */ };
        initializeApp(firebaseConfig);
        const auth = getAuth();

        protegerPagina(['entrevistador', 'tesoureiro', 'conselheiro', 'diretor', 'super-admin']).then(user => {
            inicializarPagina(user);
        }).catch(err => {
            document.getElementById('acesso-negado').classList.remove('hidden');
            document.getElementById('main-content').classList.add('hidden');
        });

        function inicializarPagina(user) {
            const db = getFirestore();
            const tratamentosRef = collection(db, 'tratamentos_ae');
            const atendimentosRef = collection(db, 'atendimentos_ae');
            const filaRef = collection(db, 'fila_atendimento_ae');
            const logAuditoriaRef = collection(db, 'log_auditoria');

            const formularioContainer = document.getElementById('formulario-container');
            const params = new URLSearchParams(window.location.search);
            const atendimentoIdParaEditar = params.get('atendimentoId');

            const btnVoltarFecha = document.getElementById('btn-voltar-fecha');
            if(btnVoltarFecha) {
                btnVoltarFecha.addEventListener('click', (e) => {
                    e.preventDefault();
                    window.close();
                    setTimeout(() => { window.location.href = '/arquivo-geral-ae.html'; }, 300);
                });
            }

            if (atendimentoIdParaEditar) {
                carregarFormularioParaEdicao(atendimentoIdParaEditar);
            } else {
                formularioContainer.innerHTML = `<p class="erro">Nenhum atendimento selecionado.</p>`;
            }

            async function registrarLog(acao, detalhes) { /* ... (inalterado) ... */ }

            // ===================================================================
            // IN√çCIO DA MODIFICA√á√ÉO JAVASCRIPT: manipularEstadoFormulario
            // ===================================================================
            function manipularEstadoFormulario(travado) {
                const form = formularioContainer.querySelector('fieldset');
                if (!form) return;

                // Trava/Destrava campos normais (input, select, textarea, radio)
                form.querySelectorAll('input:not(#colegiado-de):not([type="checkbox"]), select:not(#colegiado-de), textarea, input[name="evolucao"]').forEach(el => {
                    if (!el.classList.contains('readonly-input')) {
                        el.disabled = travado;
                    }
                });

                // Trava/Destrava Checkboxes de Encaminhamentos
                form.querySelectorAll('.checkboxes input[type="checkbox"]').forEach(checkbox => {
                    checkbox.disabled = travado;
                });
                // Remove a l√≥gica antiga do selectBox simulado
                // const selectBox = form.querySelector('.select-box');
                // if (selectBox) { travado ? selectBox.setAttribute('disabled', 'disabled') : selectBox.removeAttribute('disabled'); }


                // L√≥gica espec√≠fica para a se√ß√£o Colegiado (se existir)
                const colegiadoSection = form.querySelector('.colegiado-section');
                if (colegiadoSection) {
                    const decisaoSalva = colegiadoSection.classList.contains('colegiado-travado');
                    // Trava campos de decis√£o se j√° foi salvo OU se formul√°rio geral est√° travado
                    form.querySelectorAll('#colegiado-para, #colegiado-notas').forEach(el => el.disabled = (travado || decisaoSalva));
                    // Trava Checkboxes de Encaminhamentos tamb√©m se decis√£o salva
                     form.querySelectorAll('.checkboxes input[type="checkbox"]').forEach(checkbox => {
                         checkbox.disabled = (travado || decisaoSalva);
                     });
                }


                const btnSalvar = document.getElementById('btn-salvar-entrevista');
                if(btnSalvar) btnSalvar.style.display = travado ? 'none' : 'block';

                // Bot√£o Habilitar Edi√ß√£o
                const btnHabilitarExistente = document.getElementById('btn-habilitar-edicao');
                if(btnHabilitarExistente) btnHabilitarExistente.remove();
                if (travado) {
                    const btnHabilitar = document.createElement('button');
                    btnHabilitar.id = 'btn-habilitar-edicao';
                    btnHabilitar.className = 'btn btn-secondary';
                    btnHabilitar.style.width = '100%'; btnHabilitar.style.marginTop = '10px';
                    btnHabilitar.innerHTML = 'üîí Habilitar Edi√ß√£o'; btnHabilitar.type = 'button';
                    btnHabilitar.onclick = () => { if (confirm('Tem certeza?')) { manipularEstadoFormulario(false); } };
                    form.appendChild(btnHabilitar);
                }
            }
            // ===================================================================
            // FIM DA MODIFICA√á√ÉO JAVASCRIPT
            // ===================================================================

            async function salvarDecisaoColegiado(atendimento, atendimentoDocRef) { /* ... (inalterado) ... */ }
            async function darAlta(atendimento, atendimentoDocRef) { /* ... (inalterado) ... */ }
            const gerarOpcoesPasse = (selecionado = '') => { /* ... (inalterado) ... */ };

            function preencherFormulario(atendimento, nomeAssistido) {
                document.getElementById('assistido-nome').textContent = nomeAssistido;
                if (document.getElementById('entrevistador-nome')) { /* ... (l√≥gica inalterada) ... */ }
                if (document.getElementById('entrevista-notas')) { document.getElementById('entrevista-notas').value = atendimento.notas || ''; }
                if (document.querySelector('input[name="evolucao"]')) { /* ... (l√≥gica inalterada) ... */ }
                if (document.getElementById('colegiado-para')) { /* ... (l√≥gica inalterada) ... */ }
                if (document.getElementById('colegiado-notas')) { document.getElementById('colegiado-notas').value = atendimento.colegiadoNotas || ''; }

                // --- MODIFICA√á√ÉO: Preenche checkboxes diretamente ---
                 if (atendimento.encaminhamentos && atendimento.encaminhamentos.length > 0) {
                     // Remove a l√≥gica do selectBox simulado
                     // const selectBox = document.querySelector('.select-box');
                     // if(selectBox){ selectBox.textContent = atendimento.encaminhamentos.join(', '); }

                     // Marca os checkboxes correspondentes
                     atendimento.encaminhamentos.forEach(val => {
                         const checkbox = document.querySelector(`.checkboxes input[value="${val}"]`);
                         if (checkbox) checkbox.checked = true;
                     });
                 }
                 // --- FIM DA MODIFICA√á√ÉO ---
            }


            async function carregarFormularioParaEdicao(atendimentoId) {
                const atendimentoDocRef = doc(db, 'atendimentos_ae', atendimentoId);
                const atendimentoDoc = await getDoc(atendimentoDocRef);
                if (!atendimentoDoc.exists()) { formularioContainer.innerHTML = `<p class="erro">Atendimento n√£o encontrado.</p>`; return; }
                const atendimento = { id: atendimentoDoc.id, ...atendimentoDoc.data() };
                const assistidoDoc = await getDoc(doc(db, 'assistidos', atendimento.assistidoId));
                const nomeAssistido = assistidoDoc.exists() ? assistidoDoc.data().nome : "Assistido n√£o encontrado";
                const formHtml = criarFormulario(atendimento);
                formularioContainer.innerHTML = formHtml;
                preencherFormulario(atendimento, nomeAssistido);
                const isFaseDeDecisao = (atendimento.semana === 5 && atendimento.dataAtendimento === null);
                const travar = atendimento.detalhes_preenchidos === true || (isFaseDeDecisao && atendimento.decisaoColegiadoSalva === true);
                manipularEstadoFormulario(travar);
                document.getElementById('btn-salvar-decisao')?.addEventListener('click', () => salvarDecisaoColegiado(atendimento, atendimentoDocRef));
                document.getElementById('btn-salvar-entrevista')?.addEventListener('click', () => salvarEntrevistaCompleta(atendimento, atendimentoDocRef));
                document.getElementById('btn-dar-alta')?.addEventListener('click', () => darAlta(atendimento, atendimentoDocRef));

                // --- MODIFICA√á√ÉO: Remove l√≥gica do selectBox/checkboxes visibility ---
                // const selectBox = document.querySelector('.select-box');
                // const checkboxes = document.querySelector('.checkboxes');
                // if (selectBox && checkboxes) { ... listeners removidos ... }
                // --- FIM DA MODIFICA√á√ÉO ---
            }


            async function salvarEntrevistaCompleta(atendimento, atendimentoDocRef) {
                 const btn = document.getElementById('btn-salvar-entrevista');
                const entrevistadorNome = document.getElementById('entrevistador-nome').value.trim();
                const entrevistaNotas = document.getElementById('entrevista-notas').value.trim();
                const isReavaliacaoForm = !!document.getElementById('colegiado-notas');

                if (!entrevistadorNome || !entrevistaNotas) { alert('Campos "Entrevistador" e "Descri√ß√£o da Entrevista" s√£o obrigat√≥rios.'); return; }
                if (isReavaliacaoForm) {
                    const colegiadoNotas = document.getElementById('colegiado-notas')?.value.trim();
                    if (!colegiadoNotas) { alert('Para reavalia√ß√£o (ou 1¬™ semana p√≥s-migra√ß√£o), "Orienta√ß√µes do Colegiado" √© obrigat√≥rio.'); return; }
                }

                btn.disabled = true; btn.textContent = 'Salvando...';
                try {
                    const dadosParaAtualizar = {
                        entrevistador: entrevistadorNome,
                        notas: entrevistaNotas,
                        // horarioInicio e horarioFim j√° removidos
                        evolucao: document.querySelector('input[name="evolucao"]:checked')?.value || null,
                        colegiadoNotas: document.getElementById('colegiado-notas')?.value.trim() || null,
                        encaminhamentos: Array.from(document.querySelectorAll('.checkboxes input:checked')).map(cb => cb.value),
                        detalhes_preenchidos: true
                    };
                    await updateDoc(atendimentoDocRef, dadosParaAtualizar);
                    registrarLog('Preenchimento de Entrevista (AE)', { assistidoId: atendimento.assistidoId, atendimentoId: atendimento.id, semana: atendimento.semana, assistidoNome: document.getElementById('assistido-nome').textContent });
                    alert('Entrevista salva com sucesso!');
                    manipularEstadoFormulario(true);
                } catch (error) {
                    console.error("Erro ao salvar entrevista completa:", error); alert("Falha ao salvar. Tente novamente.");
                    btn.disabled = false; btn.textContent = 'Salvar Altera√ß√µes';
                }
            }

            // ===================================================================
            // IN√çCIO DA MODIFICA√á√ÉO JAVASCRIPT: Fun√ß√£o criarFormulario (layout checkboxes)
            // ===================================================================
            function criarFormulario(atendimento) {
                const semanaNum = atendimento.semana;
                const passeDe = atendimento.passeRecomendado;
                const isInicioRealDeTratamento = (semanaNum === 1 && !atendimento.decisao_pre_registrada && !atendimento.passePara && atendimento.tipo !== 'alta_programada');
                const isFaseDeDecisao5Semana = (semanaNum === 5 && atendimento.decisaoColegiadoSalva !== true && atendimento.dataAtendimento === null);
                const incluiSecaoColegiado = (semanaNum === 5 || (semanaNum === 1 && (atendimento.passePara || atendimento.tipo === 'alta_programada')));

                let legenda = '';
                if (isInicioRealDeTratamento) { legenda = "Entrevista de In√≠cio de Tratamento"; }
                else if (semanaNum === 1 && !isInicioRealDeTratamento) { legenda = "Detalhes do Atendimento da 1¬™ Semana (Novo Ciclo)"; }
                else if (atendimento.tipo === 'alta' || atendimento.tipo === 'alta_programada') { legenda = `Entrevista de Encerramento (Alta)`; }
                else { legenda = `Detalhes do Atendimento da ${semanaNum}¬™ Semana`; }

                const dataAtendimento = atendimento.dataAtendimento ? atendimento.dataAtendimento.toDate().toLocaleDateString('pt-br') : `<span class="data-aviso">Decis√£o Pr√©-Registro (Aguardando Presen√ßa)</span>`;

                let acompanhamentoHtml = '';
                if (!isInicioRealDeTratamento) {
                    // Campos de In√≠cio e Fim j√° removidos
                    acompanhamentoHtml = `<hr><h5>Detalhes do Passe</h5><div class="form-grid">
                            <div class="form-item"><label for="retorno-passe">Passe:</label><input type="text" id="retorno-passe" class="readonly-input" value="${passeDe || 'N/A'}" readonly></div>
                            </div>
                        <div class="form-item" style="margin-top:15px;"><label>Evolu√ß√£o:</label><div style="display:flex; gap: 15px;"><label><input type="radio" name="evolucao" value="melhorou"> Melhorou</label><label><input type="radio" name="evolucao" value="piorou"> Piorou</label><label><input type="radio" name="evolucao" value="na_mesma" checked> Na Mesma</label></div></div>`;
                }

                let colegiadoHtml = '';
                if (incluiSecaoColegiado) {
                    let botoesColegiadoHtml = ''; let statusColegiadoHtml = ''; let classeColegiado = 'colegiado-section';
                    if (isFaseDeDecisao5Semana) {
                        botoesColegiadoHtml = `<div class="botoes-colegiado"><button id="btn-salvar-decisao" type="button" class="btn btn-success">Salvar Decis√£o e Iniciar Novo Ciclo</button><button id="btn-dar-alta" type="button" class="btn btn-danger">Confirmar e Dar Alta</button></div>`;
                    } else if (atendimento.decisaoColegiadoSalva === true) {
                         classeColegiado += ' colegiado-travado';
                         if (atendimento.tipo === 'alta_programada' || atendimento.tipo === 'alta') { statusColegiadoHtml = `<p class="status-alta">ALTA PROGRAMADA. Aguardando presen√ßa para encerrar.</p>`; }
                         else if (atendimento.passePara) { statusColegiadoHtml = `<p class="status-novo-ciclo">NOVO CICLO (${atendimento.passePara}) PROGRAMADO. Aguardando presen√ßa para iniciar.</p>`; }
                    }

                    // --- HTML MODIFICADO: Remove .multiselect e .select-box ---
                    colegiadoHtml = `<hr><div class="${classeColegiado}"><h5>Colegiado</h5>
                            <div class="form-grid">
                               <div class="form-item"><label for="colegiado-de">DE (Passe Anterior):</label><select id="colegiado-de" class="readonly-input" disabled>${gerarOpcoesPasse(passeDe)}</select></div>
                               <div class="form-item"><label for="colegiado-para">PARA (Mudar o passe):</label><select id="colegiado-para">${gerarOpcoesPasse()}</select></div>
                            </div>
                            <div class="form-item" style="margin-top:15px;">
                                <label>Encaminhamentos (M√∫ltipla Escolha):</label>
                                {/* O div .checkboxes agora est√° diretamente aqui */}
                                <div class="checkboxes">
                                    <label><input type="checkbox" value="ENL"/> ENL</label><label><input type="checkbox" value="LEITURAS"/> Leituras</label><label><input type="checkbox" value="EAE"/> EAE</label><label><input type="checkbox" value="VOLUNTARIADO"/> Voluntariado</label><label><input type="checkbox" value="M√âDICO"/> M√©dico</label><label><input type="checkbox" value="ALIMENTO"/> Alimento</label><label><input type="checkbox" value="NATUREZA"/> Natureza</label><label><input type="checkbox" value="MOCIDADE"/> Mocidade</label><label><input type="checkbox" value="EVANGELIZA√á√ÉO"/> Evangeliza√ß√£o</label>
                                </div>
                            </div>
                            <div class="form-item" style="margin-top: 15px;"><label for="colegiado-notas">Orienta√ß√µes do Colegiado:</label><textarea id="colegiado-notas" rows="4"></textarea></div>
                            ${statusColegiadoHtml}
                            ${botoesColegiadoHtml}
                         </div>`;
                    // --- FIM DA MODIFICA√á√ÉO HTML ---
                }

                const botoesHtml = `<button id="btn-salvar-entrevista" type="button" class="btn btn-primary" style="width: 100%; margin-top: 20px;">Salvar Altera√ß√µes</button>`;
                return `<fieldset><legend>${legenda}</legend>
                        <div class="form-grid" style="background-color: #f8f9fa; padding: 10px; border-radius: 6px;">
                            <div class="form-item"><label>Assistido:</label><h3 id="assistido-nome" style="text-align:left; margin:0;">Carregando...</h3></div>
                            <div class="form-item"><label>Data do Atendimento:</label><p id="data-atendimento" style="margin:0;">${dataAtendimento}</p></div>
                        </div><hr>
                        <div class="form-grid">
                            <div class="form-item"><label for="entrevistador-nome">Entrevistador:</label><input type="text" id="entrevistador-nome"></div>
                        </div>
                        <div class="form-item" style="margin-top: 15px;"><label for="entrevista-notas">Descri√ß√£o da Entrevista:</label><textarea id="entrevista-notas" rows="6"></textarea></div>
                        ${acompanhamentoHtml}
                        ${colegiadoHtml}
                        ${botoesHtml}
                </fieldset>`;
            }
            // ===================================================================
            // FIM DA MODIFICA√á√ÉO JAVASCRIPT
            // ===================================================================

        } // Fim da fun√ß√£o inicializarPagina
    </script>
</body>
</html>