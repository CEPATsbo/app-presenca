<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estatísticas - Assistência Espiritual</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f6f9; color: #333; margin: 0; padding: 20px; }
        .nav-voltar { max-width: 1200px; margin: 0 auto 30px auto; text-align: left; }
        .btn-voltar { background-color: #e9ecef; color: #495057; border: 1px solid #dee2e6; padding: 10px 20px; border-radius: 8px; font-weight: bold; font-size: 1em; text-decoration: none; transition: background-color 0.2s; }
        .btn-voltar:hover { background-color: #dee2e6; }
        .dashboard-container { max-width: 1200px; margin: auto; }
        .header { text-align: center; border-bottom: 1px solid #ddd; padding-bottom: 20px; margin-bottom: 20px; }
        .header h1 { color: #007bff; margin: 0; }
        .filtros-container { display: flex; justify-content: center; align-items: flex-end; gap: 20px; margin-bottom: 30px; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .filtro-item { display: flex; flex-direction: column; }
        .filtro-item label { font-size: 0.9em; color: #555; margin-bottom: 5px; }
        .filtro-item select { padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 1em; }
        
        /* --- MODIFICADO: Grid de KPIs com mais colunas --- */
        .grid-kpi { 
            display: grid; 
            /* Ajustado para minmax(150px, 1fr) para caber mais cards */
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 15px; /* Gap menor */
            margin-bottom: 30px; 
        }
        .kpi-card { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
        .kpi-card .valor { font-size: 2.2em; /* Fonte ligeiramente menor */ font-weight: bold; color: #007bff; margin: 0; }
        .kpi-card .titulo { font-size: 0.9em; /* Fonte ligeiramente menor */ color: #555; margin: 5px 0 0 0; }
        /* --- NOVO: Cor específica para VL --- */
        .kpi-card .valor-vl { color: #8e44ad; } 

        .chart-card { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .chart-card h2 { margin-top: 0; }
        #feedback { text-align: center; padding: 50px; font-size: 1.2em; color: #666; }

        /* --- NOVO: Tabela de Passes --- */
        .tabela-passes {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .tabela-passes th, .tabela-passes td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: center;
        }
        .tabela-passes th {
            background-color: #f4f4f4;
            font-size: 0.9em;
        }
         .tabela-passes td {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
        }
    </style>
</head>
<body>
    <nav class="nav-voltar">
        <a href="/estatisticas.html" class="btn-voltar">⬅ Voltar para Estatísticas Gerais</a>
    </nav>

    <div id="acesso-negado" style="display: none;">
        <div class="dashboard-container" style="text-align: center;"><h1>Acesso Negado</h1><p>Você não tem permissão para acessar esta página.</p></div>
    </div>

    <div id="main-content" class="dashboard-container" style="display: none;">
        <div class="header"><h1>Estatísticas da Assistência Espiritual e Vinha de Luz</h1></div>
        
        <div class="filtros-container">
            <div class="filtro-item">
                <label for="filtro-ano">Selecione o Ano:</label>
                <select id="filtro-ano"></select>
            </div>
        </div>
        
        <div id="feedback">Carregando dados...</div>

        <div id="dashboard-content" style="display: none;">
            <div class="grid-kpi">
                <div class="kpi-card"><p id="kpi-total-ae" class="valor">0</p><p class="titulo">Atendimentos (AE)</p></div>
                <div class="kpi-card"><p id="kpi-novos-ae" class="valor">0</p><p class="titulo">Novos Tratamentos (AE)</p></div>
                <div class="kpi-card"><p id="kpi-total-vl" class="valor valor-vl">0</p><p class="titulo">Atendimentos (VL)</p></div>
                <div class="kpi-card"><p id="kpi-novos-vl" class="valor valor-vl">0</p><p class="titulo">Novos Tratamentos (VL)</p></div>
                <div class="kpi-card"><p id="kpi-altas" class="valor">0</p><p class="titulo">Altas (AE)</p></div>
                <div class="kpi-card"><p id="kpi-desistencias" class="valor">0</p><p class="titulo">Desistências (AE)</p></div>
                <div class="kpi-card"><p id="kpi-extensoes" class="valor">0</p><p class="titulo">Extensões de Ciclo (AE)</p></div>
                <div class="kpi-card"><p id="kpi-eae" class="valor">0</p><p class="titulo">Encaminhados ao EAE</p></div>
            </div>
            <div class="chart-card" style="margin-bottom: 30px;">
                <h2>Evolução Mensal (AE vs VL)</h2>
                <canvas id="grafico-principal"></canvas>
            </div>
            
            <div class="chart-card">
                <h2>Total de Passes Aplicados (AE) no Ano</h2>
                <table class="tabela-passes">
                    <thead>
                        <tr>
                            <th>P1</th>
                            <th>P2</th>
                            <th>P3A</th>
                            <th>P3B</th>
                            <th>P4A</th>
                            <th>P4B</th>
                            <th>CH</th>
                            <th>Avulso</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td id="kpi-passe-p1">0</td>
                            <td id="kpi-passe-p2">0</td>
                            <td id="kpi-passe-p3a">0</td>
                            <td id="kpi-passe-p3b">0</td>
                            <td id="kpi-passe-p4a">0</td>
                            <td id="kpi-passe-p4b">0</td>
                            <td id="kpi-passe-ch">0</td>
                            <td id="kpi-passe-avulso">0</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where, Timestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { protegerPagina } from '/auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU",
            authDomain: "voluntarios-ativos---cepat.firebaseapp.com",
            projectId: "voluntarios-ativos---cepat",
            storageBucket: "voluntarios-ativos---cepat.firebasestorage.app",
            messagingSenderId: "66122858261",
            appId: "1:66122858261:web:7fa21f1805463b5c08331c"
        };
        
        initializeApp(firebaseConfig);

        protegerPagina(['super-admin', 'diretor', 'tesoureiro', 'conselheiro', 'entrevistador', 'recepcionista', 'irradiador', 'secretario-escola', 'dirigente-escola', 'produtor-evento', 'bibliotecario']).then(user => {
            document.getElementById('main-content').style.display = 'block';
            inicializar();
        }).catch(error => {
            document.getElementById('feedback').style.display = 'none';
            document.getElementById('acesso-negado').style.display = 'block';
        });

        async function inicializar() {
            const db = getFirestore();
            
            // --- MODIFICADO: Busca coleções AE e VL separadamente ---
            const tratamentosAERef = collection(db, "tratamentos_ae");
            const atendimentosAERef = collection(db, "atendimentos_ae");
            const tratamentosVLRef = collection(db, "tratamentos_vl");
            const atendimentosVLRef = collection(db, "atendimentos_vl");

            const filtroAno = document.getElementById('filtro-ano');
            const feedback = document.getElementById('feedback');
            const dashboardContent = document.getElementById('dashboard-content');
            let graficoPrincipal;
            
            try {
                // --- MODIFICADO: Busca em 4 coleções ---
                const [
                    snapshotTratamentosAE, 
                    snapshotAtendimentosAE,
                    snapshotTratamentosVL,
                    snapshotAtendimentosVL
                ] = await Promise.all([
                    getDocs(tratamentosAERef),
                    getDocs(atendimentosAERef),
                    getDocs(tratamentosVLRef),
                    getDocs(atendimentosVLRef)
                ]);

                // --- MODIFICADO: Separa os dados ---
                const todosTratamentosAE = snapshotTratamentosAE.docs.map(doc => doc.data());
                const todosAtendimentosAE = snapshotAtendimentosAE.docs.map(doc => doc.data());
                const todosTratamentosVL = snapshotTratamentosVL.docs.map(doc => doc.data());
                const todosAtendimentosVL = snapshotAtendimentosVL.docs.map(doc => doc.data());
                
                // Combina tratamentos Apenas para popular o filtro de anos
                const todosTratamentos = [...todosTratamentosAE, ...todosTratamentosVL];
                
                if (todosTratamentos.length === 0) {
                    feedback.textContent = "Nenhum dado de tratamento (AE ou VL) encontrado.";
                    return;
                }
                
                const tratamentosComData = todosTratamentos.filter(t => t.dataInicio);
                if (tratamentosComData.length === 0) {
                     feedback.textContent = "Nenhum tratamento com data de início encontrado.";
                     return;
                }
                const anosDisponiveis = [...new Set(tratamentosComData.map(t => t.dataInicio.toDate().getFullYear()))];
                anosDisponiveis.sort((a,b) => b - a);

                anosDisponiveis.forEach(ano => {
                    const option = document.createElement('option');
                    option.value = ano; option.textContent = ano;
                    filtroAno.appendChild(option);
                });

                // --- MODIFICADO: Passa os dados separados para o renderizador ---
                filtroAno.addEventListener('change', () => renderizarDados(
                    filtroAno.value, 
                    todosTratamentosAE, todosAtendimentosAE, 
                    todosTratamentosVL, todosAtendimentosVL
                ));
                renderizarDados(
                    filtroAno.value, 
                    todosTratamentosAE, todosAtendimentosAE, 
                    todosTratamentosVL, todosAtendimentosVL
                );

                feedback.style.display = 'none';
                dashboardContent.style.display = 'block';

            } catch (error) {
                console.error("Erro ao carregar dados:", error);
                feedback.textContent = "Ocorreu um erro ao carregar os dados. Tente novamente mais tarde.";
                feedback.style.color = 'red';
            }

            // ===================================================================
            // INÍCIO DA MODIFICAÇÃO: Função renderizarDados
            // ===================================================================
            function renderizarDados(anoSelecionado, todosTratamentosAE, todosAtendimentosAE, todosTratamentosVL, todosAtendimentosVL) {
                const ano = parseInt(anoSelecionado);
                
                // 1. Filtra dados do AE por ano
                const tratamentosAEDoAno = todosTratamentosAE.filter(t => t.dataInicio && t.dataInicio.toDate().getFullYear() === ano);
                const atendimentosAEDoAno = todosAtendimentosAE.filter(a => a.dataAtendimento && a.dataAtendimento.toDate().getFullYear() === ano);
                
                // 2. Filtra dados do VL por ano
                const tratamentosVLDoAno = todosTratamentosVL.filter(t => t.dataInicio && t.dataInicio.toDate().getFullYear() === ano);
                const atendimentosVLDoAno = todosAtendimentosVL.filter(a => a.dataAtendimento && a.dataAtendimento.toDate().getFullYear() === ano);

                
                // 3. Calcula KPIs do AE
                const totalAtendimentosAE = atendimentosAEDoAno.filter(a => a.tipo !== 'falta').length;
                const novosTratamentosAE = tratamentosAEDoAno.length;
                const altasAE = tratamentosAEDoAno.filter(t => t.status === 'concluido_com_alta').length;
                const desistenciasAE = tratamentosAEDoAno.filter(t => t.status === 'encerrado_por_falta').length;
                const encaminhadosEAE = atendimentosAEDoAno.filter(a => a.encaminhamentos && a.encaminhamentos.includes('EAE')).length;
                // NOVO KPI: Extensões de Ciclo (AE)
                const extensoesAE = tratamentosAEDoAno.filter(t => t.status === 'concluido_por_reavaliacao').length;

                // 4. Calcula KPIs do VL
                const totalAtendimentosVL = atendimentosVLDoAno.filter(a => a.tipo !== 'falta').length;
                const novosTratamentosVL = tratamentosVLDoAno.length;

                // 5. Calcula KPIs de Passes (AE)
                const contagemPasses = { P1: 0, P2: 0, P3A: 0, P3B: 0, P4A: 0, P4B: 0, CH: 0, Avulso: 0 };
                atendimentosAEDoAno.forEach(a => {
                    if (a.tipo === 'avulso') {
                        contagemPasses['Avulso']++;
                    } else if (a.tipo !== 'falta' && a.passeRecomendado) {
                        const passe = a.passeRecomendado;
                        if (contagemPasses.hasOwnProperty(passe)) {
                            contagemPasses[passe]++;
                        }
                    }
                });

                // 6. Atualiza a UI (KPIs)
                document.getElementById('kpi-total-ae').textContent = totalAtendimentosAE;
                document.getElementById('kpi-novos-ae').textContent = novosTratamentosAE;
                document.getElementById('kpi-total-vl').textContent = totalAtendimentosVL;
                document.getElementById('kpi-novos-vl').textContent = novosTratamentosVL;
                document.getElementById('kpi-altas').textContent = altasAE;
                document.getElementById('kpi-desistencias').textContent = desistenciasAE;
                document.getElementById('kpi-extensoes').textContent = extensoesAE;
                document.getElementById('kpi-eae').textContent = encaminhadosEAE;
                
                // 7. Atualiza a UI (Tabela de Passes)
                document.getElementById('kpi-passe-p1').textContent = contagemPasses.P1;
                document.getElementById('kpi-passe-p2').textContent = contagemPasses.P2;
                document.getElementById('kpi-passe-p3a').textContent = contagemPasses.P3A;
                document.getElementById('kpi-passe-p3b').textContent = contagemPasses.P3B;
                document.getElementById('kpi-passe-p4a').textContent = contagemPasses.P4A;
                document.getElementById('kpi-passe-p4b').textContent = contagemPasses.P4B;
                document.getElementById('kpi-passe-ch').textContent = contagemPasses.CH;
                document.getElementById('kpi-passe-avulso').textContent = contagemPasses.Avulso;


                // 8. Prepara dados do Gráfico
                const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                const dadosGrafico = {
                    atendimentosAE: Array(12).fill(0),
                    novosAE: Array(12).fill(0),
                    atendimentosVL: Array(12).fill(0),
                    novosVL: Array(12).fill(0)
                };

                atendimentosAEDoAno.forEach(a => {
                    if(a.tipo !== 'falta') { dadosGrafico.atendimentosAE[a.dataAtendimento.toDate().getMonth()]++; }
                });
                tratamentosAEDoAno.forEach(t => {
                    dadosGrafico.novosAE[t.dataInicio.toDate().getMonth()]++;
                });
                atendimentosVLDoAno.forEach(a => {
                    if(a.tipo !== 'falta') { dadosGrafico.atendimentosVL[a.dataAtendimento.toDate().getMonth()]++; }
                });
                tratamentosVLDoAno.forEach(t => {
                    dadosGrafico.novosVL[t.dataInicio.toDate().getMonth()]++;
                });
                
                // Combina os totais (para as linhas que você já tinha)
                const atendimentosTotais = dadosGrafico.atendimentosAE.map((val, i) => val + dadosGrafico.atendimentosVL[i]);
                const novosTotais = dadosGrafico.novosAE.map((val, i) => val + dadosGrafico.novosVL[i]);

                // 9. Renderiza o Gráfico
                const ctx = document.getElementById('grafico-principal').getContext('2d');
                if (graficoPrincipal) {
                    graficoPrincipal.destroy();
                }
                graficoPrincipal = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: meses,
                        datasets: [
                        {
                            label: 'Total Atendimentos (AE+VL)',
                            data: atendimentosTotais,
                            borderColor: 'rgb(54, 162, 235)', // Azul
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            fill: false, tension: 0.1, borderWidth: 3
                        }, {
                            label: 'Total Novos Trat. (AE+VL)',
                            data: novosTotais,
                            borderColor: 'rgb(255, 99, 132)', // Vermelho
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            fill: false, tension: 0.1, borderWidth: 3
                        }, {
                            label: 'Atendimentos (AE)',
                            data: dadosGrafico.atendimentosAE,
                            borderColor: 'rgb(75, 192, 192)', // Verde-água
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            fill: false, tension: 0.1, borderWidth: 1, borderDash: [5, 5] // Linha tracejada
                        }, {
                            label: 'Novos Trat. (AE)',
                            data: dadosGrafico.novosAE,
                            borderColor: 'rgb(255, 159, 64)', // Laranja
                            backgroundColor: 'rgba(255, 159, 64, 0.1)',
                            fill: false, tension: 0.1, borderWidth: 1, borderDash: [5, 5]
                        }, {
                            label: 'Atendimentos (VL)',
                            data: dadosGrafico.atendimentosVL,
                            borderColor: 'rgb(153, 102, 255)', // Roxo
                            backgroundColor: 'rgba(153, 102, 255, 0.1)',
                            fill: false, tension: 0.1, borderWidth: 1, borderDash: [5, 5]
                        }, {
                            label: 'Novos Trat. (VL)',
                            data: dadosGrafico.novosVL,
                            borderColor: 'rgb(255, 205, 86)', // Amarelo
                            backgroundColor: 'rgba(255, 205, 86, 0.1)',
                            fill: false, tension: 0.1, borderWidth: 1, borderDash: [5, 5]
                        }]
                    },
                    options: {
                        scales: { y: { beginAtZero: true, ticks: { stepSize: 10 } } }
                    }
                });
            }
            // ===================================================================
            // FIM DA MODIFICAÇÃO
            // ===================================================================
        }
    </script>
</body>
</html>