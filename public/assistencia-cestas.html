<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cáritas - Entrega de Cestas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #2c3e50; --green: #27ae60; --orange: #e67e22; --red: #e74c3c; --bg: #f4f6f9; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .nav-header { width: 100%; max-width: 1000px; display: flex; justify-content: space-between; margin-bottom: 20px; }
        .btn-voltar { background-color: #6c757d; color: white; padding: 10px 15px; border-radius: 8px; text-decoration: none; font-weight: bold; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 1000px; box-sizing: border-box; }
        h1 { color: var(--primary); margin-top: 0; border-bottom: 2px solid var(--orange); padding-bottom: 10px; }
        .search-box { margin: 20px 0; display: flex; gap: 10px; }
        #input-busca { flex-grow: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1em; }
        .familia-row { display: grid; grid-template-columns: 1fr auto; gap: 20px; padding: 15px; border-bottom: 1px solid #eee; align-items: center; }
        .info-nome { font-weight: bold; color: #34495e; font-size: 1.1em; }
        .btn-entregar { background-color: var(--green); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-entregar:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; }
        .form-group { margin-top: 20px; display: flex; flex-direction: column; gap: 5px; }
        .form-group textarea { padding: 10px; border: 1px solid #ddd; border-radius: 8px; resize: none; font-family: inherit; }
    </style>
</head>
<body>

    <header class="nav-header">
        <a href="/modulo-caritas.html" class="btn-voltar"><i class="fas fa-arrow-left"></i> Painel Cáritas</a>
        <img src="/logo-cepat.png" alt="Logo" style="height: 50px;">
    </header>

    <main class="container">
        <h1><i class="fas fa-shopping-basket"></i> Entrega de Cestas</h1>
        <div class="search-box">
            <input type="text" id="input-busca" placeholder="Pesquisar família...">
        </div>
        <div id="lista-entrega">Carregando famílias...</div>
    </main>

    <div id="modal-confirmacao" class="modal">
        <div class="modal-content">
            <h3 id="modal-titulo">Confirmar Entrega</h3>
            <p id="modal-info"></p>
            <div class="form-group">
                <label><b>Observações:</b></label>
                <textarea id="obs-entrega" rows="3" placeholder="Algo a relatar sobre esta entrega?"></textarea>
            </div>
            <div style="margin-top: 25px; display: flex; gap: 10px;">
                <button onclick="fecharModal()" style="flex:1; padding: 12px; border-radius: 8px; border: 1px solid #ccc; cursor:pointer;">Cancelar</button>
                <button id="btn-finalizar" style="flex:1; background: var(--green); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">Confirmar e Dar Baixa</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, serverTimestamp, doc, updateDoc, getDoc, Timestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { protegerPagina } from '/auth.js';

        const firebaseConfig = { apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU", authDomain: "voluntarios-ativos---cepat.firebaseapp.com", projectId: "voluntarios-ativos---cepat", storageBucket: "voluntarios-ativos---cepat.firebasestorage.app", messagingSenderId: "66122858261", appId: "1:66122858261:web:7fa21f1805463b5c08331c" };
        const db = getFirestore(initializeApp(firebaseConfig));

        let todasFamilias = [], familiaSelecionada = null, configCesta = {};

        protegerPagina(['super-admin','diretor','caritas']).then(user => {
            inicializar(user);
        });

        function inicializar(user) {
            // Carrega receita para saber o que descontar do estoque
            onSnapshot(doc(db, "configuracoes", "cesta_padrao"), d => {
                if (d.exists()) configCesta = d.data().itens;
            });

            // Carrega famílias ativas
            onSnapshot(query(collection(db, "familiasAssistidas"), where("statusGeral", "==", "Ativa")), snap => {
                todasFamilias = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderizar(todasFamilias);
            });

            document.getElementById('input-busca').oninput = (e) => {
                const t = e.target.value.toLowerCase();
                renderizar(todasFamilias.filter(f => f.responsavel1.nome.toLowerCase().includes(t)));
            };

            window.abrirModal = (id, nome) => {
                familiaSelecionada = { id, nome };
                document.getElementById('modal-titulo').innerText = `Entrega: ${nome}`;
                document.getElementById('modal-info').innerText = "Ao confirmar, o sistema dará baixa automática no estoque conforme a receita configurada.";
                document.getElementById('modal-confirmacao').style.display = 'flex';
                document.getElementById('btn-finalizar').onclick = () => finalizarEntrega(user);
            };
        }

        async function finalizarEntrega(user) {
            const btn = document.getElementById('btn-finalizar');
            btn.disabled = true;
            btn.innerText = "Processando...";

            try {
                // 1. REGISTRAR ENTREGA
                await addDoc(collection(db, "entregasCestas"), {
                    familiaId: familiaSelecionada.id,
                    responsavel: familiaSelecionada.nome,
                    data: serverTimestamp(),
                    voluntario: user.email,
                    observacoes: document.getElementById('obs-entrega').value
                });

                // 2. ATUALIZAR ÚLTIMA ENTREGA NO CADASTRO DA FAMÍLIA
                await updateDoc(doc(db, "familiasAssistidas", familiaSelecionada.id), {
                    ultimaCesta: serverTimestamp()
                });

                // 3. DAR BAIXA NO ESTOQUE (PRODUTOS DA RECEITA)
                for (const [prodId, qtdParaBaixa] of Object.entries(configCesta)) {
                    const docRef = doc(db, "estoque_caritas", prodId);
                    const docSnap = await getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        const saldoAtual = docSnap.data().quantidade || 0;
                        await updateDoc(docRef, {
                            quantidade: Math.max(0, saldoAtual - qtdParaBaixa)
                        });
                    }
                }

                alert("Entrega confirmada! O estoque foi atualizado e o picking recalculado.");
                fecharModal();
            } catch (e) {
                alert("Erro ao processar: " + e.message);
                btn.disabled = false;
                btn.innerText = "Confirmar e Dar Baixa";
            }
        }

        function renderizar(dados) {
            const container = document.getElementById('lista-entrega');
            const hoje = new Date();
            container.innerHTML = dados.map(f => {
                const dataEntrega = f.ultimaCesta ? f.ultimaCesta.toDate() : null;
                const jaEntregue = dataEntrega && dataEntrega.getMonth() === hoje.getMonth() && dataEntrega.getFullYear() === hoje.getFullYear();
                
                return `
                    <div class="familia-row">
                        <div>
                            <div class="info-nome">${f.responsavel1.nome}</div>
                            <small>Última: ${dataEntrega ? dataEntrega.toLocaleDateString() : 'Nunca'}</small>
                        </div>
                        <button class="btn-entregar" onclick="abrirModal('${f.id}', '${f.responsavel1.nome}')" ${jaEntregue ? 'disabled' : ''}>
                            ${jaEntregue ? 'Entregue' : 'Confirmar'}
                        </button>
                    </div>`;
            }).join('');
        }

        window.fecharModal = () => {
            document.getElementById('modal-confirmacao').style.display = 'none';
            document.getElementById('obs-entrega').value = "";
        };
    </script>
</body>
</html>