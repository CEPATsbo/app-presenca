<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="refresh" content="3600">
    <title>Painel de Chamadas - Atendimento Espiritual</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
        :root { --cor-fundo: #0d47a1; --cor-texto-principal: #ffeb3b; --cor-texto-secundario: #ffffff; --cor-fundo-historico: #0a3a82; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: var(--cor-fundo); color: var(--cor-texto-principal); font-family: 'Roboto', sans-serif; overflow: hidden; }
        .hidden { display: none !important; }
        #tela-inicial { display: flex; justify-content: center; align-items: center; width: 100%; height: 100%; font-size: 3em; color: var(--cor-texto-secundario); cursor: pointer; background-color: var(--cor-fundo); position: absolute; z-index: 100; }
        #painel-principal { display: flex; flex-direction: column; width: 100%; height: 100%; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px 30px; font-size: 2em; color: var(--cor-texto-secundario); }
        .chamada-principal { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .chamada-principal.fade-in { animation: fadeIn 1s ease-in-out; }
        #nome-atual { font-size: clamp(4rem, 15vw, 12rem); font-weight: 700; margin: 0; line-height: 1.1; }
        #sala-atual { font-size: clamp(2rem, 8vw, 7rem); margin-top: 10px; }
        .historico-chamadas { display: flex; justify-content: center; gap: 20px; padding: 20px; width: 100%; box-sizing: border-box; }
        .historico-item { background-color: var(--cor-fundo-historico); color: var(--cor-texto-secundario); padding: 20px; border-radius: 10px; width: 100%; max-width: 350px; text-align: center; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .historico-item .nome { font-size: 2.5em; font-weight: bold; min-height: 1.2em; }
        .historico-item .sala { font-size: 1.5em; margin-top: 5px; opacity: 0.8; min-height: 1.2em; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>

    <div id="tela-inicial"><p>Toque para iniciar</p></div>
    <div id="painel-principal" class="hidden">
        <div class="header"><span id="logo">CE Paulo de Tarso</span><span id="relogio"></span></div>
        <div class="chamada-principal"><h1 id="nome-atual">Aguardando...</h1><p id="sala-atual"></p></div>
        <div class="historico-chamadas">
            <div id="historico-1" class="historico-item"><div class="nome"></div><div class="sala"></div></div>
            <div id="historico-2" class="historico-item"><div class="nome"></div><div class="sala"></div></div>
            <div id="historico-3" class="historico-item"><div class="nome"></div><div class="sala"></div></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, where, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU",
            authDomain: "voluntarios-ativos---cepat.firebaseapp.com",
            projectId: "voluntarios-ativos---cepat",
            storageBucket: "voluntarios-ativos---cepat.firebasestorage.app",
            messagingSenderId: "66122858261",
            appId: "1:66122858261:web:7fa21f1805463b5c08331c"
        };
        
        initializeApp(firebaseConfig);
        const db = getFirestore();

        const telaInicial = document.getElementById('tela-inicial');
        const painelPrincipal = document.getElementById('painel-principal');
        const nomeAtualEl = document.getElementById('nome-atual');
        const salaAtualEl = document.getElementById('sala-atual');
        const historicoItems = [ document.getElementById('historico-1'), document.getElementById('historico-2'), document.getElementById('historico-3') ];
        const chamadaPrincipalEl = document.querySelector('.chamada-principal');

        let ultimoNomeChamado = '';
        let somNotificacao = new Audio('/notification.mp3');
        somNotificacao.onerror = () => {
            console.warn("Arquivo notification.mp3 n達o encontrado. Os alertas sonoros n達o funcionar達o.");
            somNotificacao = null;
        };

        const mapaDeSalas = {
            'SALA 1': ['P1', 'P3A', 'P3B'],
            'SALA 2': ['P2', 'P4A', 'P4B', 'CH']
        };

        function getSalaPorPasse(passe) {
            if (!passe) return 'Encaminhamento';
            for (const sala in mapaDeSalas) {
                if (mapaDeSalas[sala].includes(passe.toUpperCase())) {
                    return sala;
                }
            }
            return 'Encaminhamento';
        }
        
        function getSalaDestino(chamada) {
            if (chamada.status === 'chamado_entrevista') return 'SALA DE ENTREVISTA';
            if (chamada.status === 'chamado_passe') return getSalaPorPasse(chamada.passeRecomendado);
            return '';
        }

        function atualizarPainel(chamadas) {
            const chamadaAtual = chamadas.length > 0 ? chamadas[chamadas.length - 1] : null;
            const historico = chamadas.slice(0, -1).reverse();

            if (chamadaAtual) {
                const nomeCompleto = chamadaAtual.nomeAssistido || '';
                const salaDestino = getSalaDestino(chamadaAtual) || '';
                
                if (ultimoNomeChamado !== nomeCompleto) {
                    if (somNotificacao) somNotificacao.play().catch(e => {}); // Tenta tocar o som
                    chamadaPrincipalEl.classList.remove('fade-in');
                    void chamadaPrincipalEl.offsetWidth; 
                    chamadaPrincipalEl.classList.add('fade-in');
                    ultimoNomeChamado = nomeCompleto;
                }
                nomeAtualEl.textContent = nomeCompleto;
                salaAtualEl.textContent = salaDestino;

            } else {
                nomeAtualEl.textContent = 'Aguardando...';
                salaAtualEl.textContent = '';
                ultimoNomeChamado = '';
            }

            historicoItems.forEach((item, index) => {
                const chamadaHist = historico[index];
                const nomeEl = item.querySelector('.nome');
                const salaEl = item.querySelector('.sala');
                if (chamadaHist) {
                    nomeEl.textContent = chamadaHist.nomeAssistido || '';
                    salaEl.textContent = getSalaDestino(chamadaHist) || '';
                } else {
                    nomeEl.textContent = '';
                    salaEl.textContent = '';
                }
            });
        }

        function escutarChamadas() {
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            const filaRef = collection(db, 'fila_atendimento_ae');
            const q = query(filaRef, where("chegadaEm", ">=", Timestamp.fromDate(hoje)), orderBy("chegadaEm"));

            onSnapshot(q, (snapshot) => {
                const chamadasValidas = snapshot.docs
                    .map(doc => doc.data())
                    .filter(data => data.status && (data.status === 'chamado_entrevista' || data.status === 'chamado_passe'));
                
                const ultimasChamadas = chamadasValidas.slice(-4);
                atualizarPainel(ultimasChamadas);
            }, (error) => {
                console.error("Erro ao escutar o painel:", error);
                nomeAtualEl.textContent = 'Erro de Conex達o';
            });
        }
        
        function atualizarRelogio() {
            const relogioEl = document.getElementById('relogio');
            if(relogioEl){
                const agora = new Date();
                const horas = String(agora.getHours()).padStart(2, '0');
                const minutos = String(agora.getMinutes()).padStart(2, '0');
                relogioEl.textContent = `${horas}:${minutos}`;
            }
        }

        telaInicial.addEventListener('click', () => {
            telaInicial.classList.add('hidden');
            painelPrincipal.classList.remove('hidden');
            if (somNotificacao) {
                somNotificacao.load(); 
                somNotificacao.play().catch(e => {});
                somNotificacao.pause();
                somNotificacao.currentTime = 0;
            }
            escutarChamadas();
            setInterval(atualizarRelogio, 1000);
            atualizarRelogio();
        }, { once: true });
    </script>
</body>
</html>