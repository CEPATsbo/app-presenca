<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Chamadas - Atendimento Espiritual</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@700&display=swap');
        :root { --cor-fundo: #0d47a1; --cor-texto-principal: #ffeb3b; --cor-texto-secundario: #ffffff; --cor-fundo-historico: #0a3a82; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: var(--cor-fundo); color: var(--cor-texto-principal); font-family: 'Roboto', sans-serif; overflow: hidden; }
        .hidden { display: none !important; }
        #painel-principal { display: flex; flex-direction: column; width: 100%; height: 100%; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px 30px; font-size: 2em; color: var(--cor-texto-secundario); }
        .chamada-principal { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .chamada-principal.fade-in { animation: fadeIn 1s ease-in-out; }
        #nome-atual { font-size: clamp(4rem, 15vw, 12rem); font-weight: 700; margin: 0; line-height: 1.1; }
        #sala-atual { font-size: clamp(2rem, 8vw, 7rem); margin-top: 10px; }
        .historico-chamadas { display: flex; justify-content: center; gap: 20px; padding: 20px; width: 100%; box-sizing: border-box; }
        .historico-item { background-color: var(--cor-fundo-historico); color: var(--cor-texto-secundario); padding: 20px; border-radius: 10px; width: 100%; max-width: 350px; text-align: center; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .historico-item .nome { font-size: 2.5em; font-weight: bold; min-height: 1.2em; }
        .historico-item .sala { font-size: 1.5em; margin-top: 5px; opacity: 0.8; min-height: 1.2em; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>
    <div id="painel-principal">
        <div class="header"><span id="logo">CE Paulo de Tarso</span><span id="relogio"></span></div>
        <div class="chamada-principal"><h1 id="nome-atual">Aguardando...</h1><p id="sala-atual"></p></div>
        <div class="historico-chamadas">
            <div id="historico-1" class="historico-item"><div class="nome"></div><div class="sala"></div></div>
            <div id="historico-2" class="historico-item"><div class="nome"></div><div class="sala"></div></div>
            <div id="historico-3" class="historico-item"><div class="nome"></div><div class="sala"></div></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = { /* ... seu config ... */ };
        initializeApp(firebaseConfig);
        const db = getFirestore();

        const nomeAtualEl = document.getElementById('nome-atual');
        const salaAtualEl = document.getElementById('sala-atual');
        const historicoItems = [ document.getElementById('historico-1'), document.getElementById('historico-2'), document.getElementById('historico-3') ];
        const chamadaPrincipalEl = document.querySelector('.chamada-principal');
        
        let ultimoTimestamp = null;
        let somNotificacao = null;
        try {
            somNotificacao = new Audio('/notification.mp3');
            somNotificacao.onerror = () => { somNotificacao = null; };
        } catch(e) { somNotificacao = null; }

        function atualizarPainel(dados) {
            const nome = dados.nome || 'Aguardando...';
            const sala = dados.sala || '';
            const historico = dados.historico || [];

            // Dispara a animação e o som apenas se for uma nova chamada
            if (dados.timestamp && dados.timestamp !== ultimoTimestamp) {
                if (somNotificacao) somNotificacao.play().catch(()=>{});
                chamadaPrincipalEl.classList.remove('fade-in');
                void chamadaPrincipalEl.offsetWidth;
                chamadaPrincipalEl.classList.add('fade-in');
                ultimoTimestamp = dados.timestamp;
            }

            nomeAtualEl.textContent = nome;
            salaAtualEl.textContent = sala;

            historicoItems.forEach((item, index) => {
                const chamadaHist = historico[index];
                const nomeEl = item.querySelector('.nome');
                const salaEl = item.querySelector('.sala');
                if (chamadaHist) {
                    nomeEl.textContent = chamadaHist.nome || '';
                    salaEl.textContent = chamadaHist.sala || '';
                } else {
                    nomeEl.textContent = '';
                    salaEl.textContent = '';
                }
            });
        }

        const painelEstadoRef = doc(db, 'painel_estado', 'atual');
        onSnapshot(painelEstadoRef, (doc) => {
            if (doc.exists()) {
                atualizarPainel(doc.data());
            } else {
                atualizarPainel({}); // Limpa o painel se o documento for apagado
            }
        });
        
        function atualizarRelogio() {
            const relogioEl = document.getElementById('relogio');
            if(relogioEl){
                const agora = new Date();
                const horas = String(agora.getHours()).padStart(2, '0');
                const minutos = String(agora.getMinutes()).padStart(2, '0');
                relogioEl.textContent = `${horas}:${minutos}`;
            }
        }
        
        document.body.addEventListener('click', () => {
            if(somNotificacao) {
                somNotificacao.play().catch(()=>{});
                somNotificacao.pause();
                somNotificacao.currentTime = 0;
            }
        }, { once: true });

        setInterval(atualizarRelogio, 1000);
        atualizarRelogio();
    </script>
</body>
</html>