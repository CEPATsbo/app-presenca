<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Cáritas - Relatório Mensal de Atividades</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: sans-serif; background: #f4f6f9; padding: 40px; }
        .folha { background: white; padding: 40px; max-width: 900px; margin: 0 auto; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .header { text-align: center; border-bottom: 2px solid #2c3e50; padding-bottom: 20px; margin-bottom: 30px; }
        .grid-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .card-stat { background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center; border: 1px solid #eee; }
        .card-stat h4 { margin: 0; color: #7f8c8d; font-size: 0.8em; text-transform: uppercase; }
        .card-stat p { margin: 10px 0 0 0; font-size: 1.8em; font-weight: bold; color: #e67e22; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { background: #eee; padding: 10px; text-align: left; font-size: 0.9em; }
        td { padding: 10px; border-bottom: 1px solid #eee; font-size: 0.9em; }
        .alerta-val { color: #e67e22; font-weight: bold; }
    </style>
</head>
<body>
    <div class="folha">
        <header class="header">
            <img src="/logo-cepat.png" style="height: 60px;">
            <h2>Relatório de Gestão Social - Cáritas</h2>
            <p id="data-mes">Resumo de Dezembro / 2025</p>
        </header>

        <section class="grid-stats">
            <div class="card-stat"><h4>Famílias Atendidas</h4><p id="rep-familias">0</p></div>
            <div class="card-stat"><h4>Cestas Entregues</h4><p id="rep-cestas">0</p></div>
            <div class="card-stat"><h4>Itens em Estoque</h4><p id="rep-itens">0</p></div>
        </section>

        <h3><i class="fas fa-exclamation-circle"></i> Atenção: Itens Próximos do Vencimento</h3>
        <table id="tabela-vencimentos">
            <thead><tr><th>Produto</th><th>Validade</th><th>Saldo</th><th>Status</th></tr></thead>
            <tbody></tbody>
        </table>

        <h3 style="margin-top:40px;"><i class="fas fa-history"></i> Histórico Recente de Doações</h3>
        <table id="tabela-logs">
            <thead><tr><th>Data</th><th>Doador</th><th>Item / Quantidade</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, Timestamp, orderBy } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        
        const firebaseConfig = { apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU", authDomain: "voluntarios-ativos---cepat.firebaseapp.com", projectId: "voluntarios-ativos---cepat", storageBucket: "voluntarios-ativos---cepat.firebasestorage.app", messagingSenderId: "66122858261", appId: "1:66122858261:web:7fa21f1805463b5c08331c" };
        const db = getFirestore(initializeApp(firebaseConfig));

        async function carregarRelatorio() {
            const inicioMes = Timestamp.fromDate(new Date(2025, 11, 1)); // Dezembro
            const hojeStr = new Date().toISOString().split('T')[0];

            // 1. Contagens
            const fams = await getDocs(query(collection(db, "familiasAssistidas"), where("statusGeral", "==", "Ativa")));
            document.getElementById('rep-familias').innerText = fams.size;

            const ents = await getDocs(query(collection(db, "entregasCestas"), where("data", ">=", inicioMes)));
            document.getElementById('rep-cestas').innerText = ents.size;

            const estoque = await getDocs(collection(db, "estoque_caritas"));
            document.getElementById('rep-itens').innerText = estoque.size;

            // 2. Tabela de Vencimentos (FEFO)
            let htmlVenc = "";
            estoque.forEach(doc => {
                const i = doc.data();
                if (i.validade && i.validade <= "2026-02-01") { // Mostra o que vence até Fev
                    const partes = i.validade.split('-');
                    htmlVenc += `<tr><td>${i.nome}</td><td class="alerta-val">${partes[2]}/${partes[1]}/${partes[0]}</td><td>${i.quantidade}</td><td>Prioridade</td></tr>`;
                }
            });
            document.getElementById('tabela-vencimentos').querySelector('tbody').innerHTML = htmlVenc || "<tr><td colspan='4'>Nenhum item crítico.</td></tr>";

            // 3. Logs de Doações
            const logs = await getDocs(query(collection(db, "log_auditoria"), where("acao", "==", "ENTRADA"), orderBy("timestamp", "desc")));
            let htmlLogs = "";
            logs.forEach(doc => {
                const l = doc.data();
                htmlLogs += `<tr><td>${l.timestamp.toDate().toLocaleDateString()}</td><td>${l.detalhes.split(':')[1]}</td><td>${l.detalhes.split(':')[2]}</td></tr>`;
            });
            document.getElementById('tabela-logs').querySelector('tbody').innerHTML = htmlLogs;
        }
        carregarRelatorio();
    </script>
</body>
</html>