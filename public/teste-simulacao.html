<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulação de Tempo - AE</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f6f9; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 600px; background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 6px 24px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        h1 { color: #333; text-align: center; }
        .form-item { display: flex; flex-direction: column; margin-bottom: 20px; }
        .form-item label { margin-bottom: 8px; font-weight: bold; color: #555; }
        .form-item input, .form-item select { padding: 12px; border-radius: 6px; border: 1px solid #ccc; font-size: 1em; width: 100%; box-sizing: border-box; }
        .btn { background-color: #007bff; color: white; border: none; padding: 15px 20px; border-radius: 8px; font-weight: bold; font-size: 1.1em; cursor: pointer; transition: background-color 0.3s; width: 100%; }
        .btn:disabled { background-color: #ccc; }
        #log { margin-top: 20px; background-color: #212529; color: #f8f9fa; padding: 15px; border-radius: 8px; font-family: 'Courier New', Courier, monospace; white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body>
    <div id="acesso-negado" class="container hidden">
        <h1>Acesso Negado</h1>
        <p style="text-align:center;">Você precisa ser 'diretor', 'tesoureiro' ou 'super-admin' para acessar esta página.</p>
    </div>

    <div id="main-content" class="container hidden">
        <h1>Máquina do Tempo (Simulação de Eventos)</h1>
        <p style="text-align: center; color: #666;">Use esta página para simular eventos em datas específicas.</p>

        <div class="form-item">
            <label for="assistido-id">ID do Assistido:</label>
            <input type="text" id="assistido-id" placeholder="Cole aqui o ID do documento do assistido">
        </div>

        <div class="form-item">
            <label for="acao">Ação a Simular:</label>
            <select id="acao">
                <option value="presenca">Adicionar à Fila (Presença)</option>
                <option value="falta">Marcar Falta</option>
            </select>
        </div>

        <div class="form-item">
            <label for="data-simulacao">Data da Simulação:</label>
            <input type="date" id="data-simulacao">
        </div>

        <button id="btn-simular" class="btn">Simular Ação</button>

        <div id="log" style="display: none;"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, query, where, getDocs, addDoc, Timestamp, orderBy, limit, writeBatch, increment, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { protegerPagina } from '/auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU",
            authDomain: "voluntarios-ativos---cepat.firebaseapp.com",
            projectId: "voluntarios-ativos---cepat",
            storageBucket: "voluntarios-ativos---cepat.firebasestorage.app",
            messagingSenderId: "66122858261",
            appId: "1:66122858261:web:7fa21f1805463b5c08331c"
        };
        initializeApp(firebaseConfig);
        const db = getFirestore();

        protegerPagina(['diretor', 'tesoureiro', 'super-admin']).then(user => {
            document.getElementById('main-content').classList.remove('hidden');
            inicializarPagina(user);
        }).catch(err => {
            document.getElementById('acesso-negado').classList.remove('hidden');
        });

        function inicializarPagina(user) {
            const ui = {
                assistidoIdInput: document.getElementById('assistido-id'),
                acaoSelect: document.getElementById('acao'),
                dataInput: document.getElementById('data-simulacao'),
                btnSimular: document.getElementById('btn-simular'),
                logDiv: document.getElementById('log'),
            };
            const atendimentosRef = collection(db, 'atendimentos_ae');
            const tratamentosRef = collection(db, 'tratamentos_ae');
            const filaRef = collection(db, 'fila_atendimento_ae');
            const logAuditoriaRef = collection(db, 'log_auditoria');

            const hoje = new Date();
            const offset = hoje.getTimezoneOffset();
            const hojeLocal = new Date(hoje.getTime() - (offset*60*1000));
            ui.dataInput.value = hojeLocal.toISOString().split("T")[0];

            function log(message, isError = false) {
                ui.logDiv.style.display = 'block';
                ui.logDiv.style.backgroundColor = isError ? '#8d2430' : '#212529';
                ui.logDiv.textContent = message;
            }

            async function registrarLogSimulacao(acao, detalhes) {
                 try {
                    await addDoc(logAuditoriaRef, {
                        timestamp: serverTimestamp(),
                        autor: { uid: user.uid, nome: `Simulador (${user.displayName || 'Usuário'})` },
                        acao: `Simulação: ${acao}`,
                        detalhes: detalhes
                    });
                } catch (error) {
                    console.error("Erro ao registrar log de simulação:", error);
                }
            }


            async function getContagemSemanasValidas(tratamentoId, dataLimite) {
                 if (!tratamentoId) return 0;
                 const qHistorico = query(
                    atendimentosRef,
                    where("tratamentoId", "==", tratamentoId),
                    where("dataAtendimento", "<", dataLimite)
                );
                const historicoSnapshot = await getDocs(qHistorico);
                let atendimentosPassadosValidos = 0;
                historicoSnapshot.forEach(doc => {
                     const data = doc.data();
                    if (data.tipo !== 'falta' && data.dataAtendimento !== null) {
                        atendimentosPassadosValidos++;
                    }
                });
                return atendimentosPassadosValidos;
            }

            ui.btnSimular.addEventListener('click', async () => {
                ui.btnSimular.disabled = true;
                ui.btnSimular.textContent = 'Processando...';
                log('Iniciando simulação...');

                const assistidoId = ui.assistidoIdInput.value.trim();
                const acao = ui.acaoSelect.value;
                const dataSimulada = ui.dataInput.value;

                if (!assistidoId || !dataSimulada) {
                    log('Erro: Preencha o ID do Assistido e a Data da Simulação.', true);
                    ui.btnSimular.disabled = false; ui.btnSimular.textContent = 'Simular Ação'; return;
                }

                try {
                    const assistidoRef = doc(db, 'assistidos', assistidoId);
                    const assistidoDoc = await getDoc(assistidoRef);
                    if (!assistidoDoc.exists()) { throw new Error(`Assistido com ID ${assistidoId} não encontrado.`); }
                    const nomeAssistido = assistidoDoc.data().nome;

                    const qTratamento = query( tratamentosRef, where('assistidoId', '==', assistidoId), where('status', '==', 'ativo'), orderBy('dataInicio', 'desc'), limit(1) );
                    const tratamentoSnapshot = await getDocs(qTratamento);
                    let tratamentoDoc = null;
                    let tratamento = null;
                    if (!tratamentoSnapshot.empty) {
                        tratamentoDoc = tratamentoSnapshot.docs[0];
                        tratamento = { id: tratamentoDoc.id, ...tratamentoDoc.data() };
                    } else if (acao === 'falta') {
                        const qUltimoTratamento = query(tratamentosRef, where('assistidoId', '==', assistidoId), orderBy('dataInicio', 'desc'), limit(1));
                        const ultimoTratamentoSnapshot = await getDocs(qUltimoTratamento);
                        if(ultimoTratamentoSnapshot.empty) { throw new Error(`Nenhum tratamento encontrado para o ID: ${assistidoId}`); }
                        tratamentoDoc = ultimoTratamentoSnapshot.docs[0];
                        tratamento = { id: tratamentoDoc.id, ...tratamentoDoc.data() };
                        log("Aviso: Tratamento não está ativo. Simulando falta no último tratamento encontrado.");
                    } else {
                         throw new Error(`Nenhum tratamento ATIVO encontrado para o ID: ${assistidoId} para simular presença.`);
                    }


                    const dataSimuladaObj = new Date(dataSimulada + 'T12:00:00');
                    const dataTimestamp = Timestamp.fromDate(dataSimuladaObj); // Usar timestamp para queries
                    const dataInicioSimulada = new Date(dataSimulada + 'T00:00:00');
                    const dataFimSimulada = new Date(dataSimulada + 'T23:59:59');

                    // ===================================================================
                    // INÍCIO DO BLOCO MODIFICADO: LÓGICA DE PRESENÇA (com placeholder condicional)
                    // ===================================================================
                    if (acao === 'presenca') {
                        if (tratamento.status !== 'ativo') { throw new Error(`O tratamento ${tratamento.id} não está ativo. Não é possível simular presença.`); }
                        const qCheckFila = query(filaRef, where("assistidoId", "==", assistidoId), where("chegadaEm", ">=", Timestamp.fromDate(dataInicioSimulada)), where("chegadaEm", "<=", Timestamp.fromDate(dataFimSimulada)), limit(1));
                        const checkFilaSnapshot = await getDocs(qCheckFila);
                        if(!checkFilaSnapshot.empty) { throw new Error(`Já existe um registro na fila para '${nomeAssistido}' no dia ${dataSimuladaObj.toLocaleDateString()}.`); }

                        const batch = writeBatch(db);
                        const semanasValidasAnteriores = await getContagemSemanasValidas(tratamento.id, dataTimestamp);
                        const semanaAtualCalculada = semanasValidasAnteriores + 1;

                        let atendimentoParaFilaRef = null;
                        let atendimentoParaFilaData = null;
                        let semanaParaFila = semanaAtualCalculada;
                        let passeParaFila = tratamento.passe_ciclo_atual;
                        let tipoAtendimentoParaFila = null;
                        let placeholder5SemanaDoc = null;

                        if (semanaAtualCalculada === 5) {
                             const qPlaceholder5Semana = query(atendimentosRef, where("tratamentoId", "==", tratamento.id), where("semana", "==", 5), where("dataAtendimento", "==", null), limit(1));
                             const placeholderSnapshot = await getDocs(qPlaceholder5Semana);
                             if (!placeholderSnapshot.empty) { placeholder5SemanaDoc = placeholderSnapshot.docs[0]; }
                        }

                        // CASO 1: Placeholder da 5ª semana encontrado!
                        if (placeholder5SemanaDoc) {
                            log('Placeholder da 5ª semana encontrado. Processando decisão...');
                            atendimentoParaFilaRef = placeholder5SemanaDoc.ref;
                            atendimentoParaFilaData = placeholder5SemanaDoc.data();
                            semanaParaFila = 5;
                            passeParaFila = atendimentoParaFilaData.passeRecomendado;

                            if (atendimentoParaFilaData.tipo === 'alta_programada') {
                                log('Tipo: Alta Programada detectada. Adicionando à fila para entrevista.');
                                batch.update(atendimentoParaFilaRef, { dataAtendimento: dataTimestamp });
                                tipoAtendimentoParaFila = 'alta_programada';
                            } else if (atendimentoParaFilaData.passePara) {
                                log('Tipo: Novo Ciclo Programado detectado. Ativando...');
                                const novoPasse = atendimentoParaFilaData.passePara;
                                const tratamentoAtualDocRef = doc(db, 'tratamentos_ae', tratamento.id);
                                batch.update(tratamentoAtualDocRef, { status: 'concluido_por_reavaliacao', dataFim: dataTimestamp });
                                const novoTratamentoRef = doc(tratamentosRef);
                                batch.set(novoTratamentoRef, { assistidoId: assistidoId, dataInicio: dataTimestamp, status: 'ativo', faltas_acumuladas: 0, passe_ciclo_atual: novoPasse });
                                batch.update(atendimentoParaFilaRef, { dataAtendimento: dataTimestamp, tratamentoId: novoTratamentoRef.id, semana: 1, passeRecomendado: novoPasse, tipo: 'tratamento_semanal' });
                                semanaParaFila = 1; passeParaFila = novoPasse; tratamento.id = novoTratamentoRef.id;
                                await registrarLogSimulacao('Ativação de Novo Ciclo', { assistidoId, nomeAssistido, tratamentoAntigoId: tratamentoDoc.id, tratamentoNovoId: novoTratamentoRef.id, novoPasse });
                           } else {
                                log('Placeholder da 5ª semana encontrado, mas sem decisão. Tratando como presença normal da 5ª semana.');
                                batch.update(atendimentoParaFilaRef, { dataAtendimento: dataTimestamp });
                           }
                        // CASO 2: Fluxo normal (Semanas 1-4 ou 5ª sem placeholder)
                        } else {
                            log(`Criando novo registro para Semana ${semanaAtualCalculada}...`);
                            // --- LÓGICA CONDICIONAL COPIADA DA RECEPÇÃO ---
                            let precisaEntrevista = false;
                            const passeDoCicloAtual = tratamento.passe_ciclo_atual;
                            if ([1, 4, 5].includes(semanaAtualCalculada) || passeDoCicloAtual === 'P3A' || passeDoCicloAtual === 'P3B') {
                               precisaEntrevista = true;
                            }
                            log(`Semana=${semanaAtualCalculada}, Passe=${passeDoCicloAtual}, PrecisaEntrevista=${precisaEntrevista}`);

                            const novoAtendimentoRef = doc(atendimentosRef);
                            batch.set(novoAtendimentoRef, {
                                assistidoId: assistidoId, tratamentoId: tratamento.id, tipo: 'tratamento_semanal',
                                dataAtendimento: dataTimestamp, semana: semanaAtualCalculada,
                                entrevistador: precisaEntrevista ? 'Aguardando Detalhes' : 'Passe Direto', // CONDICIONAL
                                passeRecomendado: passeDoCicloAtual, notas: '',
                                detalhes_preenchidos: !precisaEntrevista // CONDICIONAL
                            });
                            // --- FIM DA LÓGICA CONDICIONAL ---
                            atendimentoParaFilaRef = novoAtendimentoRef;
                            semanaParaFila = semanaAtualCalculada;
                            passeParaFila = passeDoCicloAtual;
                        }

                        // Adicionar à fila de atendimento
                        const dadosFila = {
                            assistidoId: assistidoId, nomeAssistido: nomeAssistido, tratamentoId: tratamento.id,
                            atendimentoId: atendimentoParaFilaRef.id, status: 'aguardando_entrevista_ou_passe', passeRecomendado: passeParaFila,
                            semana_atual: semanaParaFila, chegadaEm: dataTimestamp, recepcionista: { uid: user.uid, nome: `Simulação por ${user.displayName}` }
                        };
                        if(tipoAtendimentoParaFila) { dadosFila.tipoAtendimento = tipoAtendimentoParaFila; }
                        batch.set(doc(filaRef), dadosFila);

                        await batch.commit();
                        await registrarLogSimulacao('Marcação de Presença', { assistidoId, nomeAssistido, tratamentoId: tratamento.id, semana: semanaParaFila, data: dataSimulada });
                        log(`Sucesso: Presença de '${nomeAssistido}' (Semana ${semanaParaFila}, Passe ${passeParaFila}) simulada para ${dataSimuladaObj.toLocaleDateString()}.`);

                    // ===================================================================
                    // FIM DO BLOCO MODIFICADO
                    // ===================================================================

                    } else if (acao === 'falta') {
                        // --- Lógica de Falta (inalterada, já estava correta com a regra refinada) ---
                        const batch = writeBatch(db);
                        const tratamentoDocRef = doc(db, 'tratamentos_ae', tratamento.id);
                        const novoTotalFaltas = (tratamento.faltas_acumuladas || 0) + 1;
                        const passeDoCiclo = tratamento.passe_ciclo_atual;
                        const dataLimiteFalta = Timestamp.fromDate(dataSimuladaObj);
                        const semanasValidasAnterioresFalta = await getContagemSemanasValidas(tratamento.id, dataLimiteFalta);
                        const semanaAtualFalta = semanasValidasAnterioresFalta + 1;

                        batch.set(doc(atendimentosRef), { assistidoId: assistidoId, tratamentoId: tratamento.id, tipo: 'falta', dataAtendimento: dataTimestamp, semana: semanaAtualFalta });

                        let encerrarTratamento = false;
                        let motivo = '';
                        const logDetalhes = { assistidoId, nomeAssistido, tratamentoId: tratamento.id, totalFaltas: novoTotalFaltas, passe: passeDoCiclo, semana: semanaAtualFalta, data: dataSimulada };

                        if (tratamento.status === 'ativo') {
                           batch.update(tratamentoDocRef, { faltas_acumuladas: increment(1) });
                            if (semanaAtualFalta === 5) {
                                if (passeDoCiclo === 'P3A' || passeDoCiclo === 'P3B') {
                                     const qPlaceholder5Semana = query(atendimentosRef, where("tratamentoId", "==", tratamento.id), where("semana", "==", 5), where("dataAtendimento", "==", null), limit(1));
                                     const placeholderSnapshot = await getDocs(qPlaceholder5Semana);
                                     const decisao5Semana = (!placeholderSnapshot.empty) ? placeholderSnapshot.docs[0].data() : null;
                                     if (decisao5Semana) {
                                         if (decisao5Semana.tipo === 'alta_programada') { encerrarTratamento = false; }
                                         else if (decisao5Semana.passePara) {
                                             const proximoPasse = decisao5Semana.passePara;
                                             if (proximoPasse === 'P3A' || proximoPasse === 'P3B') { if (novoTotalFaltas >= 1) { encerrarTratamento = true; } }
                                             else { encerrarTratamento = false; }
                                         } else { encerrarTratamento = false; }
                                     } else { encerrarTratamento = false; }
                                } else { encerrarTratamento = false; }
                                if (!encerrarTratamento) { motivo = `Falta registrada (Semana 5). Total de faltas: ${novoTotalFaltas}.`; }
                                else { motivo = `Falta registrada (Semana 5). ATENÇÃO: Tratamento encerrado por falta (Tolerância Zero para P3A/P3B continuando P3).`; }
                            } else {
                                if (passeDoCiclo === 'P3A' || passeDoCiclo === 'P3B') {
                                    if (novoTotalFaltas >= 1) { encerrarTratamento = true; motivo = 'Tratamento encerrado automaticamente por falta (Tolerância Zero para P3A/P3B).'; }
                                    else { motivo = `Falta registrada com sucesso! Total de faltas: ${novoTotalFaltas}.`; }
                                } else {
                                    if (novoTotalFaltas >= 2) { encerrarTratamento = true; motivo = `Falta registrada. ATENÇÃO: Tratamento encerrado automaticamente por exceder o limite de 2 faltas.`; }
                                    else { motivo = `Falta registrada com sucesso! Total de faltas: ${novoTotalFaltas}.`; }
                                }
                            }
                            if (encerrarTratamento) {
                                batch.update(tratamentoDocRef, { status: 'encerrado_por_falta', dataFim: dataTimestamp });
                                await registrarLogSimulacao('Encerramento por Falta', logDetalhes);
                            } else { await registrarLogSimulacao('Marcação de Falta', logDetalhes); }
                        } else {
                             motivo = `Falta registrada no histórico para tratamento já encerrado (${tratamento.status}).`;
                             await registrarLogSimulacao('Marcação de Falta (Trat. Encerrado)', logDetalhes);
                        }
                        await batch.commit();
                        log(motivo);
                    }

                } catch (error) {
                    console.error("Erro na simulação:", error);
                    log(`ERRO: ${error.message}`, true);
                } finally {
                    ui.btnSimular.disabled = false;
                    ui.btnSimular.textContent = 'Simular Ação';
                }
            });
        }
    </script>
</body>
</html>