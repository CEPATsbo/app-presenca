<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulação de Tempo - AE</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f6f9; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 600px; background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 6px 24px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        h1 { color: #333; text-align: center; }
        .form-item { display: flex; flex-direction: column; margin-bottom: 20px; }
        .form-item label { margin-bottom: 8px; font-weight: bold; color: #555; }
        .form-item input, .form-item select { padding: 12px; border-radius: 6px; border: 1px solid #ccc; font-size: 1em; width: 100%; box-sizing: border-box; }
        .btn { background-color: #007bff; color: white; border: none; padding: 15px 20px; border-radius: 8px; font-weight: bold; font-size: 1.1em; cursor: pointer; transition: background-color 0.3s; width: 100%; }
        .btn:disabled { background-color: #ccc; }
        #log { margin-top: 20px; background-color: #212529; color: #f8f9fa; padding: 15px; border-radius: 8px; font-family: 'Courier New', Courier, monospace; white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body>
    <div id="acesso-negado" class="container hidden">
        <h1>Acesso Negado</h1>
        <p style="text-align:center;">Você precisa ser 'diretor' ou 'super-admin' para acessar esta página.</p>
    </div>

    <div id="main-content" class="container hidden">
        <h1>Máquina do Tempo (Simulação de Eventos)</h1>
        <p style="text-align: center; color: #666;">Use esta página para simular eventos em datas específicas.</p>

        <div class="form-item">
            <label for="assistido-id">ID do Assistido:</label>
            <input type="text" id="assistido-id" placeholder="Cole aqui o ID do documento do assistido">
        </div>
        
        <div class="form-item">
            <label for="acao">Ação a Simular:</label>
            <select id="acao">
                <option value="presenca">Adicionar à Fila (Presença)</option>
                <option value="falta">Marcar Falta</option>
            </select>
        </div>

        <div class="form-item">
            <label for="data-simulacao">Data da Simulação:</label>
            <input type="date" id="data-simulacao">
        </div>

        <button id="btn-simular" class="btn">Simular Ação</button>

        <div id="log" style="display: none;"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        // ===================================================================
        // IMPORTS MODIFICADOS (adicionado serverTimestamp)
        // ===================================================================
        import { getFirestore, collection, doc, getDoc, query, where, getDocs, addDoc, Timestamp, orderBy, limit, writeBatch, increment, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { protegerPagina } from '/auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU",
            authDomain: "voluntarios-ativos---cepat.firebaseapp.com",
            projectId: "voluntarios-ativos---cepat",
            storageBucket: "voluntarios-ativos---cepat.firebasestorage.app",
            messagingSenderId: "66122858261",
            appId: "1:66122858261:web:7fa21f1805463b5c08331c"
        };
        initializeApp(firebaseConfig);
        const db = getFirestore();

        protegerPagina(['diretor', 'tesoureiro', 'super-admin']).then(user => {
            document.getElementById('main-content').classList.remove('hidden');
            inicializarPagina(user);
        }).catch(err => {
            document.getElementById('acesso-negado').classList.remove('hidden');
        });

        function inicializarPagina(user) {
            const ui = {
                assistidoIdInput: document.getElementById('assistido-id'),
                acaoSelect: document.getElementById('acao'),
                dataInput: document.getElementById('data-simulacao'),
                btnSimular: document.getElementById('btn-simular'),
                logDiv: document.getElementById('log'),
            };
            const atendimentosRef = collection(db, 'atendimentos_ae');
            const tratamentosRef = collection(db, 'tratamentos_ae');
            const filaRef = collection(db, 'fila_atendimento_ae'); // Adicionado

            const hoje = new Date();
            const offset = hoje.getTimezoneOffset();
            const hojeLocal = new Date(hoje.getTime() - (offset*60*1000));
            ui.dataInput.value = hojeLocal.toISOString().split("T")[0];

            function log(message, isError = false) {
                ui.logDiv.style.display = 'block';
                ui.logDiv.style.backgroundColor = isError ? '#8d2430' : '#212529';
                ui.logDiv.textContent = message;
            }

            // ===================================================================
            // NOVA FUNÇÃO (Cálculo de Semanas Válidas)
            // ===================================================================
             async function getContagemSemanasValidas(tratamentoId, dataLimite) {
                 if (!tratamentoId) return 0;
                 const qHistorico = query(
                    atendimentosRef, 
                    where("tratamentoId", "==", tratamentoId),
                    where("tipo", "!=", "falta"),
                    where("dataAtendimento", "<", dataLimite) // Contar só atendimentos ANTES da data simulada
                );
                const historicoSnapshot = await getDocs(qHistorico);
                return historicoSnapshot.size;
            }

            ui.btnSimular.addEventListener('click', async () => {
                ui.btnSimular.disabled = true;
                ui.btnSimular.textContent = 'Processando...';
                log('Iniciando simulação...');

                const assistidoId = ui.assistidoIdInput.value.trim();
                const acao = ui.acaoSelect.value;
                const dataSimulada = ui.dataInput.value;

                if (!assistidoId || !dataSimulada) {
                    log('Erro: Preencha o ID do Assistido e a Data da Simulação.', true);
                    ui.btnSimular.disabled = false;
                    ui.btnSimular.textContent = 'Simular Ação';
                    return;
                }

                try {
                    const assistidoRef = doc(db, 'assistidos', assistidoId);
                    const assistidoDoc = await getDoc(assistidoRef);
                    if (!assistidoDoc.exists()) { throw new Error(`Assistido com ID ${assistidoId} não encontrado.`); }
                    const nomeAssistido = assistidoDoc.data().nome;

                    const qTratamento = query(
                        tratamentosRef,
                        where('assistidoId', '==', assistidoId),
                        where('status', '==', 'ativo'),
                        orderBy('dataInicio', 'desc'),
                        limit(1)
                    );
                    const tratamentoSnapshot = await getDocs(qTratamento);
                    if (tratamentoSnapshot.empty) { throw new Error(`Nenhum tratamento ATIVO encontrado para o ID: ${assistidoId}`); }
                    const tratamentoDoc = tratamentoSnapshot.docs[0];
                    const tratamento = { id: tratamentoDoc.id, ...tratamentoDoc.data() };
                    
                    // Usar a hora local para evitar problemas de fuso
                    const dataSimuladaObj = new Date(dataSimulada + 'T12:00:00'); 
                    const dataTimestamp = Timestamp.fromDate(dataSimuladaObj);

                    if (acao === 'presenca') {
                        const batch = writeBatch(db);
                        
                        // --- LÓGICA ATUALIZADA DA MÁQUINA DO TEMPO ---
                        
                        // 1. Calcular quantas semanas válidas ocorreram ANTES da data simulada
                        const semanasValidasAnteriores = await getContagemSemanasValidas(tratamento.id, dataTimestamp);
                        const semanaAtualCalculada = semanasValidasAnteriores + 1;

                        let atendimentoParaFilaRef = null;
                        let atendimentoParaFilaData = null;
                        let semanaParaFila = semanaAtualCalculada;
                        let passeParaFila = tratamento.passe_ciclo_atual;
                        let tipoAtendimentoParaFila = null; // Para casos especiais como alta

                        // 2. É a 5ª semana E JÁ EXISTE um placeholder pré-registrado?
                        let placeholder5SemanaDoc = null;
                        if (semanaAtualCalculada === 5) {
                             const qPlaceholder5Semana = query(atendimentosRef,
                                where("tratamentoId", "==", tratamento.id),
                                where("semana", "==", 5),
                                where("dataAtendimento", "==", null), // Só pega se ainda não foi preenchido
                                limit(1)
                            );
                            const placeholderSnapshot = await getDocs(qPlaceholder5Semana);
                            if (!placeholderSnapshot.empty) {
                                placeholder5SemanaDoc = placeholderSnapshot.docs[0];
                            }
                        }

                        // CASO 1: Placeholder da 5ª semana encontrado! Atualizar e usar seus dados.
                        if (placeholder5SemanaDoc) {
                            log('Placeholder da 5ª semana encontrado. Atualizando...');
                            atendimentoParaFilaRef = placeholder5SemanaDoc.ref;
                            atendimentoParaFilaData = placeholder5SemanaDoc.data();
                            
                            // Atualiza o placeholder com a data simulada
                            batch.update(atendimentoParaFilaRef, { dataAtendimento: dataTimestamp });
                            
                            semanaParaFila = 5;
                            passeParaFila = atendimentoParaFilaData.passeRecomendado; // Usa o passe guardado
                            
                            // Se for alta, marca o tipo na fila
                            if (atendimentoParaFilaData.tipo === 'alta_programada') {
                                tipoAtendimentoParaFila = 'alta_programada';
                                log('Tipo: Alta Programada detectada.');
                            } else if (atendimentoParaFilaData.passePara) {
                                // Se for novo ciclo, ele será ativado na Recepção real.
                                // A máquina do tempo só precisa adicionar à fila como semana 5 normal.
                                log('Tipo: Novo Ciclo Programado detectado. Será ativado na presença real.');
                            }

                        // CASO 2: Fluxo normal (Semanas 1-4 ou 5ª semana sem placeholder)
                        } else {
                            log(`Criando novo registro para Semana ${semanaAtualCalculada}...`);
                            // Cria um novo registro de atendimento
                            const novoAtendimentoRef = doc(atendimentosRef);
                            batch.set(novoAtendimentoRef, {
                                assistidoId: assistidoId,
                                tratamentoId: tratamento.id,
                                tipo: 'tratamento_semanal',
                                dataAtendimento: dataTimestamp,
                                semana: semanaAtualCalculada,
                                entrevistador: 'Aguardando Detalhes',
                                passeRecomendado: tratamento.passe_ciclo_atual,
                                notas: '',
                                detalhes_preenchidos: false // Importante para Arquivo Geral
                            });
                            atendimentoParaFilaRef = novoAtendimentoRef; // Usará este ID na fila
                            semanaParaFila = semanaAtualCalculada;
                            passeParaFila = tratamento.passe_ciclo_atual;
                        }

                        // 3. Adicionar à fila de atendimento
                        const dadosFila = {
                            assistidoId: assistidoId, 
                            nomeAssistido: nomeAssistido, 
                            tratamentoId: tratamento.id,
                            atendimentoId: atendimentoParaFilaRef.id,
                            status: 'aguardando_entrevista_ou_passe', 
                            passeRecomendado: passeParaFila,
                            semana_atual: semanaParaFila, 
                            chegadaEm: dataTimestamp,
                            recepcionista: { uid: user.uid, nome: `Simulação por ${user.displayName}` }
                        };
                        // Adiciona o tipo especial se for alta
                        if(tipoAtendimentoParaFila) {
                            dadosFila.tipoAtendimento = tipoAtendimentoParaFila;
                        }

                        batch.set(doc(filaRef), dadosFila);
                        
                        await batch.commit();
                        log(`Sucesso: '${nomeAssistido}' (Semana ${semanaParaFila}) adicionado à fila e ao histórico do dia ${dataSimuladaObj.toLocaleDateString()}.`);

                    } else if (acao === 'falta') {
                        // --- LÓGICA DE FALTA ATUALIZADA COM NOVAS REGRAS ---
                        const batch = writeBatch(db);
                        const tratamentoDocRef = doc(db, 'tratamentos_ae', tratamento.id);
                        const novoTotalFaltas = (tratamento.faltas_acumuladas || 0) + 1;
                        const passeDoCiclo = tratamento.passe_ciclo_atual;
                        
                        const dataLimiteFalta = Timestamp.fromDate(dataSimuladaObj); // Usar data simulada como limite
                        const semanasValidasAnterioresFalta = await getContagemSemanasValidas(tratamento.id, dataLimiteFalta);
                        const semanaAtualFalta = semanasValidasAnterioresFalta + 1;

                        batch.set(doc(atendimentosRef), {
                            assistidoId: assistidoId, 
                            tratamentoId: tratamento.id, 
                            tipo: 'falta',
                            dataAtendimento: dataTimestamp, // Data Simulada
                            semana: semanaAtualFalta 
                        });
                        
                        batch.update(tratamentoDocRef, { faltas_acumuladas: increment(1) });
                        
                        let encerrarTratamento = false;
                        let motivo = '';

                        if (passeDoCiclo === 'P3A' || passeDoCiclo === 'P3B') {
                            if (novoTotalFaltas >= 1) {
                                encerrarTratamento = true;
                                motivo = 'Tratamento encerrado automaticamente por falta (Tolerância Zero para P3A/P3B).';
                            }
                        } else {
                            if (semanaAtualFalta === 5) {
                                encerrarTratamento = false;
                                motivo = `Falta registrada (Semana 5). Total de faltas: ${novoTotalFaltas}.`;
                            } else if (novoTotalFaltas >= 2) {
                                encerrarTratamento = true;
                                motivo = `Falta registrada. ATENÇÃO: Tratamento encerrado automaticamente por exceder o limite de 2 faltas.`;
                            } else {
                                motivo = `Falta registrada com sucesso! Total de faltas: ${novoTotalFaltas}.`;
                            }
                        }

                        if (encerrarTratamento) {
                            batch.update(tratamentoDocRef, { 
                                status: 'encerrado_por_falta',
                                dataFim: dataTimestamp // Usar data simulada
                            });
                        }
                        
                        await batch.commit();
                        log(motivo);
                    }

                } catch (error) {
                    console.error("Erro na simulação:", error);
                    log(`ERRO: ${error.message}`, true);
                } finally {
                    ui.btnSimular.disabled = false;
                    ui.btnSimular.textContent = 'Simular Ação';
                }
            });
        }
    </script>
</body>
</html>