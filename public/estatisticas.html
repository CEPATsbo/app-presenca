<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estatísticas - C.E. Paulo de Tarso</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f6f9; color: #333; margin: 0; padding: 20px; }
        .nav-voltar { max-width: 1200px; margin: 0 auto 30px auto; text-align: left; }
        .btn-voltar, .btn-link-ae { background-color: #e9ecef; color: #495057; border: 1px solid #dee2e6; padding: 10px 20px; border-radius: 8px; font-weight: bold; font-size: 1em; text-decoration: none; transition: background-color 0.2s; display: inline-block; }
        .btn-voltar:hover, .btn-link-ae:hover { background-color: #dee2e6; }
        .dashboard-container { max-width: 1200px; margin: auto; }
        .header { text-align: center; border-bottom: 1px solid #ddd; padding-bottom: 20px; margin-bottom: 20px; }
        .header h1 { color: #1b5e20; margin: 0; }
        .filtros-container { display: flex; justify-content: center; align-items: flex-end; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .filtro-item { display: flex; flex-direction: column; }
        .filtro-item label { font-size: 0.9em; color: #555; margin-bottom: 5px; text-align: left; }
        .filtro-item input, .filtro-item select { padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 1em; }
        .grid-container { display: grid; grid-template-columns: 2fr 1fr; gap: 40px; align-items: flex-start; }
        .full-width-grid { display: grid; grid-template-columns: 1fr; gap: 40px; margin-top: 40px; }
        .chart-card { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .chart-card.sticky { position: -webkit-sticky; position: sticky; top: 20px; }
        .chart-card h2, .chart-card h3 { margin-top: 0; font-size: 1.3em; color: #444; }
        #loading-message { font-size: 1.5em; text-align: center; padding: 50px; }
        .chart-wrapper { position: relative; }
        #descricao-filtros { text-align: center; color: #555; font-style: italic; margin-bottom: 20px; min-height: 1.2em; }
        .feedback-grafico { text-align: center; padding: 20px; font-style: italic; color: #666; }
        .btn-link-ae { background-color: #007bff; color: white; border-color: #007bff; text-align: center; }

        /* Estilos Cáritas */
        .metricas-social-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; margin-top: 15px; }
        .metrica-social-box { background: #fff; padding: 20px; border-radius: 10px; border-top: 5px solid #e67e22; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .metrica-social-box h4 { margin: 0; color: #7f8c8d; font-size: 0.8em; text-transform: uppercase; }
        .metrica-social-box p { margin: 10px 0 0 0; font-size: 2em; font-weight: bold; color: #2c3e50; }
        .caritas-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .caritas-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <nav class="nav-voltar">
        <a href="/dashboard.html" class="btn-voltar">⬅ Voltar para o Dashboard</a>
    </nav>

    <div id="acesso-negado" style="display: none;">
        <div class="container" style="text-align: center;"><h1>Acesso Negado</h1><p>Você não tem permissão para acessar esta página.</p></div>
    </div>

    <div id="main-content" class="dashboard-container" style="display: none;">
        <div class="header"><h1>Dashboard de Estatísticas Integrado</h1></div>
        
        <div class="chart-card" style="text-align: center;">
            <h2>Estatísticas da Assistência Espiritual</h2>
            <p>Acesse o painel detalhado de atendimentos, altas e desistências.</p>
            <a href="/estatisticas-ae.html" class="btn-link-ae">Acessar Painel da Assistência Espiritual</a>
        </div>

        <div class="chart-card">
            <h2 style="text-align: center;">Indicadores da Assistência Social (Cáritas)</h2>
            <div class="metricas-social-row">
                <div class="metrica-social-box"><h4>Famílias Ativas</h4><p id="total-familias">--</p></div>
                <div class="metrica-social-box"><h4>Total Dependentes</h4><p id="total-filhos">--</p></div>
                <div class="metrica-social-box"><h4>Cestas Entregues</h4><p id="total-cestas">--</p></div>
                <div class="metrica-social-box"><h4>Padrinhos Ativos</h4><p id="total-padrinhos">--</p></div>
            </div>
            <div class="caritas-grid">
                <div>
                    <h3 style="text-align: center;">Faixa Etária dos Dependentes</h3>
                    <canvas id="grafico-idades-social"></canvas>
                </div>
                <div>
                    <h3 style="text-align: center;">Evolução de Entrega de Cestas (2025)</h3>
                    <canvas id="grafico-cestas-social"></canvas>
                </div>
            </div>
        </div>
        
        <div class="chart-card">
            <h2>Análise de Presença dos Voluntários</h2>
            <div class="filtros-container">
                <div class="filtro-item"><label for="data-inicio">De:</label><input type="date" id="data-inicio"></div>
                <div class="filtro-item"><label for="data-fim">Até:</label><input type="date" id="data-fim"></div>
                <div class="filtro-item"><label for="filtro-atividade">Filtrar Atividade:</label><select id="filtro-atividade"><option value="todas">-- Todas --</option></select></div>
            </div>
            <div id="descricao-filtros"></div>
        </div>

        <div id="charts-grid" class="grid-container" style="display: none;">
            <div class="chart-card">
                <h3>Frequência dos Voluntários</h3>
                <div class="chart-wrapper"><canvas id="grafico-frequencia"></canvas></div>
            </div>
            <div class="chart-card sticky">
                <h3>Atividades Realizadas no Período</h3>
                <canvas id="grafico-atividades"></canvas>
            </div>
        </div>

        <div id="novos-graficos-container" class="full-width-grid">
             <div class="chart-card">
                <h2>Evolução Financeira (Receitas vs. Despesas)</h2>
                <div id="financeiro-feedback" class="feedback-grafico"></div>
                <canvas id="grafico-financeiro"></canvas>
            </div>
             <div class="chart-card">
                <h2>Evolução dos Pedidos de Vibração</h2>
                <div id="vibracoes-feedback" class="feedback-grafico"></div>
                <canvas id="grafico-vibracoes"></canvas>
            </div>
        </div>

        <div id="loading-message">Carregando dados...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy, where, documentId, Timestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { protegerPagina } from '/auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU",
            authDomain: "voluntarios-ativos---cepat.firebaseapp.com",
            projectId: "voluntarios-ativos---cepat",
            storageBucket: "voluntarios-ativos---cepat.firebasestorage.app",
            messagingSenderId: "66122858261",
            appId: "1:66122858261:web:7fa21f1805463b5c08331c"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        protegerPagina(['super-admin', 'voluntario', 'diretor', 'tesoureiro','caritas', 'conselheiro', 'entrevistador', 'recepcionista', 'irradiador', 'secretario-escola', 'dirigente-escola', 'produtor-evento', 'bibliotecario'])
            .then(user => {
                document.getElementById('main-content').style.display = 'block';
                inicializar();
            })
            .catch(error => {
                document.getElementById('loading-message').style.display = 'none';
                document.getElementById('acesso-negado').style.display = 'block';
            });

        function inicializar() {
            let todosOsDados = [];
            let todasAsAtividades = new Map();
            let graficoFrequencia, graficoAtividades;
            let voluntariosOrdenadosGlobal = [];
            let atividadeDestaqueFixo = null;

            const ui = {
                dataInicio: document.getElementById('data-inicio'),
                dataFim: document.getElementById('data-fim'),
                filtroAtividade: document.getElementById('filtro-atividade'),
                descricaoFiltros: document.getElementById('descricao-filtros'),
                loadingMessage: document.getElementById('loading-message'),
                chartsGrid: document.getElementById('charts-grid'),
            };

            const COR_PADRAO_BARRAS = 'rgba(17, 122, 101, 0.4)';
            const COR_DESTAQUE_FADE = 'rgba(200, 200, 200, 0.3)';
            const COR_PADRAO_ATIVIDADE = '#a9a9a9';

            function normalizarAtividades(atividade) {
                if (Array.isArray(atividade)) return atividade;
                if (typeof atividade === 'string') return atividade.split(',').map(a => a.trim());
                return [];
            }

            // --- LÓGICA DE INTERATIVIDADE PRESERVADA (SEM RETROCESSO) ---
            function destacarBarras(atividade, corDestaque) {
                if (!graficoFrequencia) return;
                const novasCores = voluntariosOrdenadosGlobal.map(([nome]) => {
                    const dadosFiltrados = todosOsDados.filter(d => d.data >= ui.dataInicio.value && d.data <= ui.dataFim.value);
                    const participou = dadosFiltrados.some(p => p.nome === nome && normalizarAtividades(p.atividade).includes(atividade));
                    return participou ? corDestaque : COR_DESTAQUE_FADE;
                });
                graficoFrequencia.data.datasets[0].backgroundColor = novasCores;
                graficoFrequencia.update('none');
            }

            function restaurarCoresBarras() {
                if (!graficoFrequencia) return;
                if (atividadeDestaqueFixo) {
                    destacarBarras(atividadeDestaqueFixo, todasAsAtividades.get(atividadeDestaqueFixo) || COR_PADRAO_ATIVIDADE);
                } else {
                    graficoFrequencia.data.datasets[0].backgroundColor = COR_PADRAO_BARRAS;
                    graficoFrequencia.update('none');
                }
            }

            const handleLegendClick = (evt, item, legend) => {
                const ativ = legend.chart.data.labels[item.index];
                atividadeDestaqueFixo = (ativ === atividadeDestaqueFixo) ? null : ativ;
                restaurarCoresBarras();
            };

            const handleLegendHover = (evt, item, legend) => {
                if (atividadeDestaqueFixo) return;
                const ativ = legend.chart.data.labels[item.index];
                destacarBarras(ativ, todasAsAtividades.get(ativ) || COR_PADRAO_ATIVIDADE);
            };

            // --- RENDERIZAÇÃO DOS GRÁFICOS ---
            function renderizarGraficosPresenca(dados) {
                if (graficoFrequencia) graficoFrequencia.destroy();
                if (graficoAtividades) graficoAtividades.destroy();

                const counts = {};
                dados.forEach(d => counts[d.nome] = (counts[d.nome] || 0) + 1);
                voluntariosOrdenadosGlobal = Object.entries(counts).sort(([,a],[,b]) => b-a);

                const canvasFreq = document.getElementById('grafico-frequencia');
                canvasFreq.parentElement.style.height = `${Math.max(400, voluntariosOrdenadosGlobal.length * 35)}px`;
                
                graficoFrequencia = new Chart(canvasFreq, {
                    type: 'bar',
                    data: { labels: voluntariosOrdenadosGlobal.map(i => i[0]), datasets: [{ label: 'Presenças', data: voluntariosOrdenadosGlobal.map(i => i[1]), backgroundColor: COR_PADRAO_BARRAS }] },
                    options: { indexAxis: 'y', maintainAspectRatio: false, scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } }
                });

                const ativCounts = {};
                dados.forEach(d => normalizarAtividades(d.atividade).forEach(a => ativCounts[a] = (ativCounts[a] || 0) + 1));
                const labelsAtiv = Object.keys(ativCounts).sort();

                graficoAtividades = new Chart(document.getElementById('grafico-atividades'), {
                    type: 'doughnut',
                    data: { labels: labelsAtiv, datasets: [{ data: labelsAtiv.map(l => ativCounts[l]), backgroundColor: labelsAtiv.map(l => todasAsAtividades.get(l) || COR_PADRAO_ATIVIDADE) }] },
                    options: { plugins: { legend: { position: 'bottom', onClick: handleLegendClick, onHover: handleLegendHover, onLeave: () => { if(!atividadeDestaqueFixo) restaurarCoresBarras(); } } } }
                });
            }

            async function carregarDadosIniciais() {
                ui.loadingMessage.style.display = 'block';
                try {
                    const [presSnap, ativSnap] = await Promise.all([
                        getDocs(collection(db, "presencas")),
                        getDocs(query(collection(db, "atividades"), orderBy("nome")))
                    ]);
                    todosOsDados = presSnap.docs.map(doc => doc.data());
                    ativSnap.forEach(doc => {
                        const a = doc.data();
                        todasAsAtividades.set(a.nome, a.cor);
                        const opt = document.createElement('option');
                        opt.value = a.nome; opt.textContent = a.nome;
                        ui.filtroAtividade.appendChild(opt);
                    });

                    const hoje = new Date();
                    ui.dataFim.value = hoje.toISOString().split('T')[0];
                    const umMes = new Date(); umMes.setMonth(hoje.getMonth() - 1);
                    ui.dataInicio.value = umMes.toISOString().split('T')[0];
                    
                    aplicarFiltrosPresenca();
                    carregarGraficoFinanceiro();
                    carregarGraficoVibracoes();
                    carregarDadosCaritas(); // FUNÇÃO CORRIGIDA ABAIXO
                } catch (e) { console.error(e); }
            }

            function aplicarFiltrosPresenca() {
                let filtrados = todosOsDados.filter(d => d.data >= ui.dataInicio.value && d.data <= ui.dataFim.value);
                if (ui.filtroAtividade.value !== 'todas') filtrados = filtrados.filter(d => normalizarAtividades(d.atividade).includes(ui.filtroAtividade.value));
                
                if (filtrados.length === 0) {
                    ui.chartsGrid.style.display = 'none';
                    ui.loadingMessage.style.display = 'block';
                    ui.loadingMessage.textContent = "Nenhum dado encontrado.";
                } else {
                    ui.chartsGrid.style.display = 'grid';
                    ui.loadingMessage.style.display = 'none';
                    renderizarGraficosPresenca(filtrados);
                }
            }

            // --- FINANCEIRO E VIBRAÇÕES PRESERVADOS ---
            async function carregarGraficoFinanceiro() {
                const snap = await getDocs(query(collection(db, "balancetes"), where("status", "==", "aprovado"), orderBy(documentId())));
                if (snap.empty) return;
                document.getElementById('financeiro-feedback').style.display = 'none';
                const labels = [], rec = [], des = [];
                snap.forEach(doc => {
                    labels.push(doc.id);
                    let r = 0, d = 0;
                    Object.values(doc.data().receitas || {}).flat().forEach(i => r += i.valor || 0);
                    Object.values(doc.data().despesas || {}).flat().forEach(i => d += i.valor || 0);
                    rec.push(r); des.push(d);
                });
                new Chart(document.getElementById('grafico-financeiro'), { type: 'line', data: { labels, datasets: [{ label: 'Receitas', data: rec, borderColor: 'green' }, { label: 'Despesas', data: des, borderColor: 'red' }] } });
            }

            async function carregarGraficoVibracoes() {
                const snap = await getDocs(query(collection(db, "historico_vibracoes"), orderBy("semanaDeReferencia", "asc")));
                if (snap.empty) return;
                document.getElementById('vibracoes-feedback').style.display = 'none';
                const sem = {};
                snap.forEach(doc => {
                    const d = doc.data();
                    if(!sem[d.semanaDeReferencia]) sem[d.semanaDeReferencia] = { e: 0, d: 0 };
                    d.tipo === 'encarnado' ? sem[d.semanaDeReferencia].e++ : sem[d.semanaDeReferencia].d++;
                });
                const labels = Object.keys(sem);
                new Chart(document.getElementById('grafico-vibracoes'), { type: 'bar', data: { labels, datasets: [{ label: 'Encarnados', data: labels.map(l => sem[l].e), backgroundColor: 'teal' }, { label: 'Desencarnados', data: labels.map(l => sem[l].d), backgroundColor: 'blue' }] } });
            }

            // --- CORREÇÃO CÁRITAS: DATA E FILTRO 2025 ---
            async function carregarDadosCaritas() {
                try {
                    const [famSnap, cestaSnap] = await Promise.all([
                        getDocs(query(collection(db, "familiasAssistidas"), where("statusGeral", "==", "Ativa"))),
                        getDocs(collection(db, "entregasCestas"))
                    ]);
                    
                    let totalFilhos = 0; let totalPadrinhos = 0;
                    let faixas = { "0-3 anos": 0, "4-7 anos": 0, "8-13 anos": 0, "14+ anos": 0 };

                    famSnap.forEach(doc => {
                        const f = doc.data();
                        (f.filhos || []).forEach(filho => {
                            totalFilhos++;
                            if (filho.padrinho) totalPadrinhos++;
                            const idade = new Date().getFullYear() - new Date(filho.nascimento).getFullYear();
                            if (idade <= 3) faixas["0-3 anos"]++;
                            else if (idade <= 7) faixas["4-7 anos"]++;
                            else if (idade <= 13) faixas["8-13 anos"]++;
                            else faixas["14+ anos"]++;
                        });
                    });

                    document.getElementById('total-familias').textContent = famSnap.size;
                    document.getElementById('total-filhos').textContent = totalFilhos;
                    document.getElementById('total-cestas').textContent = cestaSnap.size;
                    document.getElementById('total-padrinhos').textContent = totalPadrinhos;

                    new Chart(document.getElementById('grafico-idades-social'), { type: 'pie', data: { labels: Object.keys(faixas), datasets: [{ data: Object.values(faixas), backgroundColor: ['#e67e22', '#3498db', '#27ae60', '#9b59b6'] }] } });

                    const contagemMensal = new Array(12).fill(0);
                    cestaSnap.forEach(doc => {
                        // CORREÇÃO: Usando 'data' e convertendo Timestamp
                        const d = doc.data().data?.toDate(); 
                        if (d && d.getFullYear() === 2025) contagemMensal[d.getMonth()]++;
                    });

                    new Chart(document.getElementById('grafico-cestas-social'), {
                        type: 'bar',
                        data: { labels: ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'], datasets: [{ label: 'Cestas', data: contagemMensal, backgroundColor: '#e67e22' }] },
                        options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
                    });
                } catch (e) { console.error(e); }
            }

            ui.dataInicio.onchange = aplicarFiltrosPresenca;
            ui.dataFim.onchange = aplicarFiltrosPresenca;
            ui.filtroAtividade.onchange = aplicarFiltrosPresenca;
            carregarDadosIniciais();
        }
    </script>
</body>
</html>