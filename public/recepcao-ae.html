<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recepção - Atendimento Espiritual</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f6f9; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 900px; background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 6px 24px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .nav-voltar { width: 100%; max-width: 900px; margin-bottom: 20px; }
        .btn, .btn-voltar { background-color: #007bff; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; font-size: 1em; text-decoration: none; cursor: pointer; transition: background-color 0.3s; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-voltar { background-color: #6c757d; }
        .btn-success { background-color: #28a745; }
        .btn-secondary { background-color: #6c757d; }
        .btn-danger { background-color: #dc3545; }
        .btn-info { background-color: #17a2b8; }
        .btn-primary { background-color: #007bff; }
        .btn-warning { background-color: #ffc107; color: #212529; }
        .btn-full { width: 100%; padding: 15px; font-size: 1.2em; }
        h1, h2, h3, h4 { color: #333; text-align: center; }
        .form-section, .actions-section { display: flex; flex-direction: column; gap: 15px; }
        .form-item { display: flex; flex-direction: column; }
        .form-item label { margin-bottom: 5px; font-weight: bold; color: #555; }
        .form-item input, .form-item select, .form-item textarea { padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 1em; width: 100%; box-sizing: border-box; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .info-box { background-color: #e9f5ff; padding: 20px; border-radius: 8px; border: 1px solid #bce0fd; margin-bottom: 20px; }
        .actions-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .hidden { display: none; }
        .bloco-semanal { border: 1px solid #ccc; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .bloco-semanal h4 { margin-top: 0; }
        .bloco-semanal.falta { background-color: #fff3cd; border-color: #ffeeba; }
        .checkbox-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        .checkbox-item { display: flex; align-items: center; gap: 8px; }
        .checkbox-item input[type="checkbox"] { width: auto; transform: scale(1.2); }
    </style>
</head>
<body>
    <nav class="nav-voltar"><a href="/dashboard.html" class="btn-voltar">⬅ Voltar para o Dashboard</a></nav>
    <div id="acesso-negado" class="container hidden"><h1>Acesso Negado</h1></div>

    <div id="main-content" class="container">
        <h1>Ficha de Atendimento Espiritual</h1>
        
        <div id="busca-section" class="form-section">
            <div class="form-grid">
                <div class="form-item" style="grid-column: 1 / -1;"><label for="search-nome">Buscar Assistido:</label><input type="text" id="search-nome"></div>
            </div>
            <ul id="search-results" style="list-style: none; padding: 0; max-height: 200px; overflow-y: auto;"></ul>
            <div id="dados-pessoais-section" class="info-box hidden"></div>
        </div>

        <div id="acoes-iniciais-section" class="hidden">
            <div class="actions-grid">
                <button id="btn-registrar-avulso" class="btn btn-info btn-full">Registrar Passe Avulso</button>
                <button id="btn-iniciar-tratamento" class="btn btn-success btn-full">Iniciar Tratamento (1ª Vez/Reinicio)</button>
            </div>
        </div>

        <div id="form-primeira-vez-section" class="bloco-semanal hidden">
            <h4>ENTREVISTA DE 1ª VEZ OU DE REINICIO</h4>
            <div class="form-grid">
                <div class="form-item"><label for="primeira-data">Data:</label><input type="date" id="primeira-data" disabled></div>
                <div class="form-item"><label for="primeira-entrevistador">Entrevistador:</label><input type="text" id="primeira-entrevistador"></div>
            </div>
            <div class="form-item" style="margin-top: 15px;"><label for="primeira-notas">Notas da Entrevista:</label><textarea id="primeira-notas" rows="4"></textarea></div>
            <div class="actions-grid" style="margin-top: 15px;">
                <button id="btn-cancelar-primeira" class="btn btn-secondary">Cancelar</button>
                <button id="btn-salvar-primeira" class="btn btn-success">Salvar e Iniciar Tratamento</button>
            </div>
        </div>

        <div id="tratamento-ativo-section" class="hidden">
            <h3 id="titulo-tratamento-ativo"></h3>
            <div id="historico-semanas"></div>
            <div id="acoes-retorno-section" class="actions-grid">
                <button id="btn-marcar-falta" class="btn btn-warning">Marcar Falta</button>
                <button id="btn-dar-alta" class="btn btn-danger">Finalizar Tratamento (Dar Alta)</button>
            </div>
            <div id="form-retorno-semana" class="bloco-semanal"></div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
import { getFirestore, collection, addDoc, doc, serverTimestamp, query, where, limit, getDocs, Timestamp, orderBy, updateDoc, increment, writeBatch } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-functions.js";
import { protegerPagina } from '/auth.js';

const firebaseConfig = {
    apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU",
    authDomain: "voluntarios-ativos---cepat.firebaseapp.com",
    projectId: "voluntarios-ativos---cepat",
    storageBucket: "voluntarios-ativos---cepat.firebasestorage.app",
    messagingSenderId: "66122858261",
    appId: "1:66122858261:web:7fa21f1805463b5c08331c"
};
initializeApp(firebaseConfig);

protegerPagina(['recepcionista', 'diretor', 'super-admin']).then(user => {
    document.getElementById('main-content').classList.remove('hidden');
    inicializarPagina(user);
}).catch(err => {
    document.getElementById('acesso-negado').classList.remove('hidden');
    document.getElementById('main-content').classList.add('hidden');
});

function inicializarPagina(user) {
    const db = getFirestore();
    const functions = getFunctions(undefined, 'southamerica-east1');
    const assistidosRef = collection(db, 'assistidos');
    const filaRef = collection(db, 'fila_atendimento_ae');
    const tratamentosRef = collection(db, 'tratamentos_ae');
    const atendimentosRef = collection(db, 'atendimentos_ae');
    const registrarLog = httpsCallable(functions, 'registrarLogDeAcesso');

    let assistidoSelecionado = null;
    let tratamentoAtivo = null;

    const ui = {
        buscaSection: document.getElementById('busca-section'),
        assistidoSection: document.getElementById('assistido-section'),
        dadosPessoaisSection: document.getElementById('dados-pessoais-section'),
        acoesIniciaisSection: document.getElementById('acoes-iniciais-section'),
        formPrimeiraVezSection: document.getElementById('form-primeira-vez-section'),
        tratamentoAtivoSection: document.getElementById('tratamento-ativo-section'),
        tituloTratamentoAtivo: document.getElementById('titulo-tratamento-ativo'),
        historicoSemanas: document.getElementById('historico-semanas'),
        acoesRetornoSection: document.getElementById('acoes-retorno-section'),
        formRetornoSemana: document.getElementById('form-retorno-semana'),
        searchInput: document.getElementById('search-nome'),
        searchResults: document.getElementById('search-results'),
        btnRegistrarAvulso: document.getElementById('btn-registrar-avulso'),
        btnIniciarTratamento: document.getElementById('btn-iniciar-tratamento'),
        btnMarcarFalta: document.getElementById('btn-marcar-falta'),
        btnDarAlta: document.getElementById('btn-dar-alta'),
    };
    
    const hojeFormatado = () => new Date().toISOString().split('T')[0];

    const resetarTudo = () => {
        assistidoSelecionado = null;
        tratamentoAtivo = null;
        ui.searchInput.value = '';
        ui.searchResults.innerHTML = '';
        ui.dadosPessoaisSection.classList.add('hidden');
        ui.acoesIniciaisSection.classList.add('hidden');
        ui.formPrimeiraVezSection.classList.add('hidden');
        ui.tratamentoAtivoSection.classList.add('hidden');
    };

    const renderizarPainel = async (assistido) => {
        ui.dadosPessoaisSection.innerHTML = `
            <h4>${assistido.nome}</h4>
            <p><strong>DN:</strong> ${assistido.dataNascimento ? new Date(assistido.dataNascimento + 'T03:00:00Z').toLocaleDateString('pt-BR') : 'N/A'} | <strong>Telefone:</strong> ${assistido.telefone || 'N/A'}</p>
        `;
        ui.dadosPessoaisSection.classList.remove('hidden');

        const qTratamento = query(tratamentosRef, where("assistidoId", "==", assistido.id), where("status", "==", "ativo"), limit(1));
        const snapshot = await getDocs(qTratamento);

        if (snapshot.empty) {
            tratamentoAtivo = null;
            ui.acoesIniciaisSection.classList.remove('hidden');
            ui.tratamentoAtivoSection.classList.add('hidden');
        } else {
            tratamentoAtivo = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
            ui.acoesIniciaisSection.classList.add('hidden');
            ui.tratamentoAtivoSection.classList.remove('hidden');
            await renderizarHistoricoEFormularioAtual();
        }
    };

    const renderizarHistoricoEFormularioAtual = async () => {
        const faltas = tratamentoAtivo.faltas_acumuladas || 0;
        ui.tituloTratamentoAtivo.textContent = `Acompanhamento do Tratamento (Faltas: ${faltas}/2)`;

        const qSemanas = query(atendimentosRef, where("tratamentoId", "==", tratamentoAtivo.id), orderBy("dataAtendimento", "asc"));
        const semanasSnapshot = await getDocs(qSemanas);
        ui.historicoSemanas.innerHTML = '';
        
        let ultimoPassePara = '';
        semanasSnapshot.forEach((doc, index) => {
            const semana = doc.data();
            const eFalta = semana.tipo === 'falta';
            const data = semana.dataAtendimento.toDate().toLocaleDateString('pt-BR');
            
            const blocoHtml = `
                <div class="bloco-semanal ${eFalta ? 'falta' : ''}">
                    <h4>${index + 1}ª Semana (${data}) - ${eFalta ? 'FALTA' : 'PRESENÇA'}</h4>
                    ${!eFalta ? `
                        <p><strong>Entrevistador:</strong> ${semana.entrevistador || 'N/A'}</p>
                        <p><strong>Passe Recebido:</strong> ${semana.passeRecomendado || 'N/A'}</p>
                        <p><strong>Colegiado (DE/PARA):</strong> ${semana.passeDe || 'N/A'} -> ${semana.passePara || 'N/A'}</p>
                    ` : ''}
                </div>
            `;
            ui.historicoSemanas.innerHTML += blocoHtml;
            if(!eFalta && semana.passePara) ultimoPassePara = semana.passePara;
        });

        // Habilita/Desabilita botão de falta
        ui.btnMarcarFalta.disabled = faltas >= 3;

        // Renderiza o formulário da semana atual
        ui.formRetornoSemana.innerHTML = criarFormularioSemanaAtual(semanasSnapshot.size + 1, ultimoPassePara);
        document.getElementById('btn-salvar-retorno').addEventListener('click', salvarRetorno);
    };

    const criarFormularioSemanaAtual = (semanaNum, passeDe) => {
        return `
            <h4>Registro da ${semanaNum}ª Semana</h4>
            <div class="form-grid">
                <div class="form-item"><label>Data:</label><input type="date" value="${hojeFormatado()}" disabled></div>
                <div class="form-item"><label for="retorno-entrevistador">Entrevistador:</label><input type="text" id="retorno-entrevistador"></div>
                <div class="form-item"><label for="retorno-passe">Passe:</label><select id="retorno-passe">${gerarOpcoesPasse()}</select></div>
                <div class="form-item"><label for="retorno-inicio">Início:</label><input type="time" id="retorno-inicio"></div>
                <div class="form-item"><label for="retorno-fim">Fim:</label><input type="time" id="retorno-fim"></div>
                <div class="form-item"><label for="retorno-faltas">Faltas (semana anterior):</label><input type="number" id="retorno-faltas" value="0" min="0"></div>
            </div>
            <div class="form-item" style="margin-top:15px;">
                <label>Evolução:</label>
                <div style="display:flex; gap: 15px;">
                    <label><input type="radio" name="evolucao" value="melhorou"> Melhorou</label>
                    <label><input type="radio" name="evolucao" value="piorou"> Piorou</label>
                    <label><input type="radio" name="evolucao" value="na_mesma" checked> Na Mesma</label>
                </div>
            </div>
            <hr>
            <h4>Colegiado</h4>
            <div class="form-grid">
                <div class="form-item"><label for="colegiado-de">DE:</label><select id="colegiado-de">${gerarOpcoesPasse(passeDe)}</select></div>
                <div class="form-item"><label for="colegiado-para">PARA:</label><select id="colegiado-para">${gerarOpcoesPasse()}</select></div>
            </div>
            <div class="form-item" style="margin-top:15px;">
                <label>Encaminhamentos:</label>
                <div class="checkbox-group" id="retorno-encaminhamentos">
                    <div class="checkbox-item"><input type="checkbox" value="ENL"> ENL</div>
                    <div class="checkbox-item"><input type="checkbox" value="Leituras"> Leituras</div>
                    <div class="checkbox-item"><input type="checkbox" value="EAE"> EAE</div>
                    <div class="checkbox-item"><input type="checkbox" value="Voluntariado"> Voluntariado</div>
                    <div class="checkbox-item"><input type="checkbox" value="Médico"> Médico</div>
                    <div class="checkbox-item"><input type="checkbox" value="Alimento"> Alimento</div>
                    <div class="checkbox-item"><input type="checkbox" value="Natureza"> Natureza</div>
                    <div class="checkbox-item"><input type="checkbox" value="Mocidade"> Mocidade</div>
                    <div class="checkbox-item"><input type="checkbox" value="Evangelização"> Evangelização</div>
                </div>
            </div>
            <button id="btn-salvar-retorno" class="btn btn-primary btn-full" style="margin-top:20px;">Salvar Semana</button>
        `;
    };

    const gerarOpcoesPasse = (selecionado = '') => {
        const passes = ['P1', 'P2', 'P3A', 'P3B', 'P4A', 'P4B', 'CH'];
        let html = '<option value="">Selecione...</option>';
        passes.forEach(p => {
            html += `<option value="${p}" ${p === selecionado ? 'selected' : ''}>${p}</option>`;
        });
        return html;
    };
    
    // --- Lógica Principal de Ações ---
    
    ui.searchInput.addEventListener('input', async (e) => {
        const termo = e.target.value.trim().toLowerCase();
        if (termo.length < 3) { ui.searchResults.innerHTML = ''; return; }
        const q = query(assistidosRef, where('nome_lower', '>=', termo), where('nome_lower', '<=', termo + '\uf8ff'), limit(5));
        const snapshot = await getDocs(q);
        ui.searchResults.innerHTML = '';
        snapshot.forEach(doc => {
            const assistido = { id: doc.id, ...doc.data() };
            const li = document.createElement('li');
            li.textContent = assistido.nome;
            li.addEventListener('click', () => {
                assistidoSelecionado = assistido;
                ui.searchInput.value = assistido.nome;
                ui.searchResults.innerHTML = '';
                renderizarPainel(assistido);
            });
            ui.searchResults.appendChild(li);
        });
    });

    ui.btnRegistrarAvulso.addEventListener('click', async () => {
        if (!assistidoSelecionado) return;
        
        const trintaDiasAtras = new Date();
        trintaDiasAtras.setDate(trintaDiasAtras.getDate() - 30);
        const qAvulso = query(atendimentosRef, where("assistidoId", "==", assistidoSelecionado.id), where("tipo", "==", "avulso"), where("dataAtendimento", ">=", Timestamp.fromDate(trintaDiasAtras)));
        if (!(await getDocs(qAvulso)).empty) {
            alert('Este assistido já recebeu um passe avulso nos últimos 30 dias.'); return;
        }

        if (confirm(`Confirmar registro de Passe Avulso (P2) para ${assistidoSelecionado.nome}?`)) {
            const batch = writeBatch(db);
            const filaDocRef = doc(filaRef);
            batch.set(filaDocRef, {
                assistidoId: assistidoSelecionado.id, nomeAssistido: assistidoSelecionado.nome,
                status: 'pronto_para_chamar', passeRecomendado: 'P2', tipoAtendimento: 'avulso',
                chegadaEm: serverTimestamp(), recepcionista: { uid: user.uid, nome: user.displayName }
            });

            const atendimentoDocRef = doc(atendimentosRef);
            batch.set(atendimentoDocRef, {
                assistidoId: assistidoSelecionado.id, tratamentoId: null, tipo: 'avulso',
                dataAtendimento: serverTimestamp(), passeRecomendado: 'P2'
            });

            await batch.commit();
            await registrarLog({ acao: 'REGISTROU_PASSE_AVULSO', detalhes: { assistidoId: assistidoSelecionado.id, nome: assistidoSelecionado.nome }});
            alert('Passe avulso registrado e enviado para a fila!');
            resetarTudo();
        }
    });

    ui.btnIniciarTratamento.addEventListener('click', () => {
        ui.acoesIniciaisSection.classList.add('hidden');
        ui.formPrimeiraVezSection.classList.remove('hidden');
        document.getElementById('primeira-data').value = hojeFormatado();
    });

    document.getElementById('btn-cancelar-primeira').addEventListener('click', () => {
        ui.acoesIniciaisSection.classList.remove('hidden');
        ui.formPrimeiraVezSection.classList.add('hidden');
    });

    document.getElementById('btn-salvar-primeira').addEventListener('click', async () => {
        const entrevistador = document.getElementById('primeira-entrevistador').value;
        if (!entrevistador) { alert('O nome do entrevistador é obrigatório.'); return; }

        const batch = writeBatch(db);

        const novoTratamentoRef = doc(tratamentosRef);
        batch.set(novoTratamentoRef, {
            assistidoId: assistidoSelecionado.id, dataInicio: serverTimestamp(), status: 'ativo',
            faltas_acumuladas: 0,
            primeiraEntrevista: {
                data: Timestamp.now(), entrevistador: entrevistador,
                notas: document.getElementById('primeira-notas').value
            }
        });

        const primeiroAtendimentoRef = doc(atendimentosRef);
        batch.set(primoAtendimentoRef, {
            assistidoId: assistidoSelecionado.id, tratamentoId: novoTratamentoRef.id,
            tipo: 'tratamento_semanal', dataAtendimento: serverTimestamp(),
            entrevistador: entrevistador, passeRecomendado: 'P2' // Regra: 1ª semana é sempre P2
        });

        const filaDocRef = doc(filaRef);
        batch.set(filaDocRef, {
            assistidoId: assistidoSelecionado.id, nomeAssistido: assistidoSelecionado.nome,
            status: 'pronto_para_chamar', passeRecomendado: 'P2', tipoAtendimento: 'tratamento_semanal',
            chegadaEm: serverTimestamp(), recepcionista: { uid: user.uid, nome: user.displayName }
        });

        await batch.commit();
        await registrarLog({ acao: 'INICIOU_TRATAMENTO_AE', detalhes: { assistidoId: assistidoSelecionado.id, nome: assistidoSelecionado.nome }});
        alert('Tratamento iniciado com sucesso!');
        ui.formPrimeiraVezSection.classList.add('hidden');
        await renderizarPainel(assistidoSelecionado);
    });

    async function salvarRetorno() {
        const entrevistador = document.getElementById('retorno-entrevistador').value;
        if(!entrevistador) { alert("O nome do entrevistador é obrigatório."); return; }

        const encaminhamentos = Array.from(document.querySelectorAll('#retorno-encaminhamentos input:checked')).map(cb => cb.value);
        const faltasNestaSemana = parseInt(document.getElementById('retorno-faltas').value) || 0;

        const batch = writeBatch(db);
        const atendimentoDocRef = doc(atendimentosRef);
        batch.set(atendimentoDocRef, {
            assistidoId: assistidoSelecionado.id, tratamentoId: tratamentoAtivo.id,
            tipo: 'tratamento_semanal', dataAtendimento: serverTimestamp(),
            entrevistador: entrevistador,
            passeRecomendado: document.getElementById('retorno-passe').value,
            horarioInicio: document.getElementById('retorno-inicio').value,
            horarioFim: document.getElementById('retorno-fim').value,
            faltas: faltasNestaSemana,
            evolucao: document.querySelector('input[name="evolucao"]:checked').value,
            passeDe: document.getElementById('colegiado-de').value,
            passePara: document.getElementById('colegiado-para').value,
            encaminhamentos: encaminhamentos
        });
        
        const filaDocRef = doc(filaRef);
        batch.set(filaDocRef, {
            assistidoId: assistidoSelecionado.id, nomeAssistido: assistidoSelecionado.nome,
            status: 'pronto_para_chamar', passeRecomendado: document.getElementById('retorno-passe').value,
            tipoAtendimento: 'tratamento_semanal', chegadaEm: serverTimestamp(),
            recepcionista: { uid: user.uid, nome: user.displayName }
        });
        
        await batch.commit();
        await registrarLog({ acao: 'REGISTROU_RETORNO_AE', detalhes: { assistidoId: assistidoSelecionado.id, tratamentoId: tratamentoAtivo.id }});
        alert('Retorno da semana salvo com sucesso!');
        await renderizarPainel(assistidoSelecionado);
    }
    
    ui.btnMarcarFalta.addEventListener('click', async () => {
        if (!tratamentoAtivo) return;
        if (confirm(`Confirmar uma falta para ${assistidoSelecionado.nome}?`)) {
            const tratamentoDocRef = doc(db, 'tratamentos_ae', tratamentoAtivo.id);
            const novoTotalFaltas = (tratamentoAtivo.faltas_acumuladas || 0) + 1;
            
            const batch = writeBatch(db);
            batch.update(tratamentoDocRef, { faltas_acumuladas: increment(1) });
            
            const faltaDocRef = doc(atendimentosRef);
            batch.set(faltaDocRef, {
                assistidoId: assistidoSelecionado.id, tratamentoId: tratamentoAtivo.id,
                tipo: 'falta', dataAtendimento: serverTimestamp()
            });

            if (novoTotalFaltas >= 3) {
                batch.update(tratamentoDocRef, { status: 'encerrado_por_falta' });
                alert('Falta registrada. ATENÇÃO: Tratamento encerrado automaticamente por exceder o limite de 2 faltas!');
                await batch.commit();
                resetarTudo();
            } else {
                alert(`Falta registrada com sucesso! Total de faltas: ${novoTotalFaltas}.`);
                await batch.commit();
                await renderizarPainel(assistidoSelecionado);
            }
            await registrarLog({ acao: 'REGISTROU_FALTA_AE', detalhes: { assistidoId: assistidoSelecionado.id, tratamentoId: tratamentoAtivo.id, totalFaltas: novoTotalFaltas }});
        }
    });

    ui.btnDarAlta.addEventListener('click', async () => {
        if (!tratamentoAtivo) return;
        if (confirm(`Tem certeza que deseja dar alta e finalizar o tratamento de ${assistidoSelecionado.nome}?`)) {
            const tratamentoDocRef = doc(db, 'tratamentos_ae', tratamentoAtivo.id);
            await updateDoc(tratamentoDocRef, { status: 'concluido', dataFim: serverTimestamp() });
            await registrarLog({ acao: 'FINALIZOU_TRATAMENTO_AE', detalhes: { assistidoId: assistidoSelecionado.id, tratamentoId: tratamentoAtivo.id }});
            alert('Tratamento finalizado com sucesso!');
            resetarTudo();
        }
    });
}
    </script>
</body>
</html>