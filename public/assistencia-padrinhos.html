<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cáritas - Padrinhos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, sans-serif; background-color: #f4f6f9; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 1000px; }
        .child-card { border: 1px solid #eee; padding: 15px; border-radius: 10px; margin-bottom: 15px; display: grid; grid-template-columns: 2fr 2fr auto; gap: 20px; align-items: center; }
        .info-p { margin: 5px 0 0 0; color: #7f8c8d; font-size: 0.9em; }
        .padrinho-form { display: flex; gap: 10px; }
        .padrinho-form input { padding: 8px; border: 1px solid #ddd; border-radius: 6px; }
        .btn-vincular { background: #e67e22; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .padrinho-ativo { background: #f1f8e9; border-color: #8bc34a; }
        .badge { background: #ef5350; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.75em; }
    </style>
</head>
<body>
    <div style="width:100%; max-width:1000px; margin-bottom:20px;">
        <a href="/modulo-caritas.html" style="text-decoration:none; color:#666;">⬅ Voltar</a>
    </div>
    <main class="container">
        <h1>Apadrinhamento de Crianças</h1>
        <div id="lista-padrinhos"></div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, where, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { protegerPagina } from '/auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU",
            authDomain: "voluntarios-ativos---cepat.firebaseapp.com",
            projectId: "voluntarios-ativos---cepat",
            storageBucket: "voluntarios-ativos---cepat.firebasestorage.app",
            messagingSenderId: "66122858261",
            appId: "1:66122858261:web:7fa21f1805463b5c08331c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        protegerPagina(['super-admin', 'diretor', 'tesoureiro', 'caritas'])
            .then(() => {
                onSnapshot(query(collection(db, "familiasAssistidas"), where("statusGeral", "==", "Ativa")), (snap) => {
                    let html = '';
                    snap.docs.forEach(docSnap => {
                        const fam = docSnap.data();
                        const famId = docSnap.id;
                        fam.filhos.forEach((filho, idx) => {
                            if (!filho.nascimento) return;
                            const idade = calcularIdade(filho.nascimento);
                            if (idade <= 13) {
                                const pad = filho.padrinho || { nome: '', tel: '' };
                                html += `
                                    <div class="child-card ${pad.nome ? 'padrinho-ativo' : ''}">
                                        <div>
                                            <b>${filho.nome}</b> <span class="badge">${idade} anos</span>
                                            <p class="info-p">Família: ${fam.responsavel1.nome}</p>
                                            <p class="info-p"><b>Roupa:</b> ${filho.tamanho || 'N/A'} | <b>Calçado:</b> ${filho.calcado || 'N/A'}</p>
                                        </div>
                                        <div class="padrinho-form">
                                            <input type="text" id="p-nome-${famId}-${idx}" placeholder="Padrinho" value="${pad.nome}">
                                            <input type="tel" id="p-tel-${famId}-${idx}" placeholder="Tel" value="${pad.tel}">
                                        </div>
                                        <button class="btn-vincular" onclick="vincular('${famId}', ${idx})">Salvar</button>
                                    </div>`;
                            }
                        });
                    });
                    document.getElementById('lista-padrinhos').innerHTML = html || '<p>Nenhuma criança.</p>';
                });

                window.vincular = async (id, idx) => {
                    const nome = document.getElementById(`p-nome-${id}-${idx}`).value;
                    const tel = document.getElementById(`p-tel-${id}-${idx}`).value;
                    try {
                        const ref = doc(db, "familiasAssistidas", id);
                        const snap = await getDoc(ref);
                        const filhos = snap.data().filhos;
                        filhos[idx].padrinho = { nome, tel };
                        await updateDoc(ref, { filhos });
                        alert("Padrinho salvo!");
                    } catch (e) { alert(e.message); }
                };
            });

        function calcularIdade(n) {
            const nasc = new Date(n); const hoje = new Date();
            let i = hoje.getFullYear() - nasc.getFullYear();
            if (hoje.getMonth() < nasc.getMonth() || (hoje.getMonth() === nasc.getMonth() && hoje.getDate() < nasc.getDate())) i--;
            return i;
        }
    </script>
</body>
</html>