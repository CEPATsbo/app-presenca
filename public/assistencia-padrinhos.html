<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cáritas - Gestão de Padrinhos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f4f6f9; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .nav-header { width: 100%; max-width: 1000px; display: flex; justify-content: space-between; margin-bottom: 20px; }
        .btn-voltar { background-color: #6c757d; color: white; padding: 10px 15px; border-radius: 8px; text-decoration: none; font-weight: bold; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 1000px; box-sizing: border-box; }
        h1 { color: #2c3e50; margin-top: 0; border-bottom: 2px solid #e67e22; padding-bottom: 10px; margin-bottom: 25px; }
        
        .child-card { border: 1px solid #eee; padding: 20px; border-radius: 12px; margin-bottom: 15px; display: grid; grid-template-columns: 1fr 1.5fr auto; gap: 20px; align-items: center; border-left: 6px solid #3498db; }
        .padrinho-ativo { border-left-color: #27ae60; background-color: #f1f8e9; }
        
        .info-crianca b { font-size: 1.2em; color: #2c3e50; }
        .info-p { margin: 5px 0; color: #7f8c8d; font-size: 0.9em; }
        .badge-idade { background: #ef5350; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; }
        
        .padrinho-form { display: flex; gap: 10px; }
        .padrinho-form input { padding: 10px; border: 1px solid #ddd; border-radius: 8px; flex-grow: 1; }
        
        .btn-vincular { background-color: #e67e22; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: background 0.2s; }
        .btn-vincular:hover { background-color: #d35400; }
        
        @media (max-width: 768px) {
            .child-card { grid-template-columns: 1fr; gap: 15px; }
            .padrinho-form { flex-direction: column; }
        }
    </style>
</head>
<body>
    <header class="nav-header">
        <a href="/modulo-caritas.html" class="btn-voltar"><i class="fas fa-arrow-left"></i> Painel Cáritas</a>
    </header>

    <main class="container">
        <h1><i class="fas fa-gift"></i> Apadrinhamento de Natal</h1>
        <p style="color: #666; margin-bottom: 30px;">Lista de crianças até 13 anos aguardando ou vinculadas a um padrinho.</p>
        
        <div id="lista-padrinhos">
            <p style="text-align:center; color:#999;">Buscando crianças elegíveis...</p>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, where, doc, updateDoc, getDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { protegerPagina } from '/auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU",
            authDomain: "voluntarios-ativos---cepat.firebaseapp.com",
            projectId: "voluntarios-ativos---cepat",
            storageBucket: "voluntarios-ativos---cepat.firebasestorage.app",
            messagingSenderId: "66122858261",
            appId: "1:66122858261:web:7fa21f1805463b5c08331c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Apenas cargos autorizados gerenciam padrinhos
        protegerPagina(['super-admin','diretor','tesoureiro','conselheiro','recepcionista','entrevistador','caritas'])
            .then(user => {
                const container = document.getElementById('lista-padrinhos');

                // Monitoramento em tempo real das famílias ativas
                onSnapshot(query(collection(db, "familiasAssistidas"), where("statusGeral", "==", "Ativa")), (snapshot) => {
                    let html = '';
                    snapshot.docs.forEach(docSnap => {
                        const familia = docSnap.data();
                        const familiaId = docSnap.id;
                        
                        (familia.filhos || []).forEach((filho, index) => {
                            const idade = calcularIdade(filho.nascimento);
                            // Filtro de idade da Campanha de Natal
                            if (idade <= 13) {
                                const padrinho = filho.padrinho || { nome: '', tel: '' };
                                const isAtivo = padrinho.nome !== '';
                                
                                html += `
                                    <div class="child-card ${isAtivo ? 'padrinho-ativo' : ''}">
                                        <div class="info-crianca">
                                            <b>${filho.nome}</b> <span class="badge-idade">${idade} anos</span>
                                            <p class="info-p"><i class="fas fa-home"></i> Resp: ${familia.responsavel1.nome}</p>
                                            <p class="info-p"><i class="fas fa-tshirt"></i> Roupa: ${filho.tamanho || 'N/A'} | Calçado: ${filho.calcado || 'N/A'}</p>
                                        </div>
                                        <div class="padrinho-form">
                                            <input type="text" id="p-nome-${familiaId}-${index}" placeholder="Nome do Padrinho" value="${padrinho.nome}">
                                            <input type="tel" id="p-tel-${familiaId}-${index}" placeholder="WhatsApp" value="${padrinho.tel}">
                                        </div>
                                        <button class="btn-vincular" onclick="vincularPadrinho('${familiaId}', ${index}, '${filho.nome}', '${user.displayName || user.email}')">
                                            <i class="fas fa-save"></i> Salvar
                                        </button>
                                    </div>`;
                            }
                        });
                    });
                    container.innerHTML = html || '<p style="text-align:center;">Nenhuma criança encontrada.</p>';
                });

                // Função de Vínculo com Registro de Auditoria Unificado
                window.vincularPadrinho = async (famId, filhoIdx, nomeCrianca, nomeUsuario) => {
                    const nomeP = document.getElementById(`p-nome-${famId}-${filhoIdx}`).value;
                    const telP = document.getElementById(`p-tel-${famId}-${filhoIdx}`).value;

                    try {
                        const famRef = doc(db, "familiasAssistidas", famId);
                        const famSnap = await getDoc(famRef);
                        const filhosAtuais = famSnap.data().filhos;
                        
                        // Atualiza apenas o filho específico no array
                        filhosAtuais[filhoIdx].padrinho = { nome: nomeP, tel: telP };
                        
                        await updateDoc(famRef, { filhos: filhosAtuais });

                        // REGISTRO DE AUDITORIA UNIFICADO (CORREÇÃO DE SINGULAR E OBJETO AUTOR)
                        await addDoc(collection(db, "log_auditoria"), {
                            timestamp: serverTimestamp(),
                            autor: { nome: nomeUsuario },
                            acao: "VINCULO_PADRINHO",
                            detalhes: `Vinculou padrinho(a) ${nomeP || 'Removido'} à criança ${nomeCrianca}`
                        });

                        alert("Dados do padrinho salvos com sucesso!");
                    } catch (e) {
                        console.error(e);
                        alert("Erro ao salvar: " + e.message);
                    }
                };
            });

        function calcularIdade(nascimento) {
            if (!nascimento) return 0;
            const nasc = new Date(nascimento);
            const hoje = new Date();
            let idade = hoje.getFullYear() - nasc.getFullYear();
            const m = hoje.getMonth() - nasc.getMonth();
            if (m < 0 || (m === 0 && hoje.getDate() < nasc.getDate())) idade--;
            return idade;
        }
    </script>
</body>
</html>