<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Conselho Fiscal</title>
    <script type="module" src="/auth-guard.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f6f9; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; box-sizing: border-box; }
        .admin-nav { width: 100%; max-width: 1100px; background-color: #fff; padding: 15px; margin-bottom: 30px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; display: flex; flex-wrap: wrap; justify-content: center; gap: 15px 25px; }
        .admin-nav a { color: #1565c0; text-decoration: none; font-weight: bold; font-size: 1.1em; }
        .admin-nav a.active, .admin-nav a:hover { text-decoration: underline; color: #0d47a1; }
        .main-container { display: flex; gap: 30px; width: 100%; max-width: 1600px; align-items: flex-start; }
        .balancete-container { background-color: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); flex-grow: 1; }
        .controles-container { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 100%; max-width: 350px; position: -webkit-sticky; position: sticky; top: 20px; }
        h1, h2, h3 { text-align: center; color: #333; margin-top: 0; }
        .cabecalho { text-align: center; margin-bottom: 20px; }
        .cabecalho h1 { font-size: 1.5em; margin: 0; }
        .cabecalho p { font-size: 0.9em; margin: 2px 0; }
        .seletor-periodo { margin-bottom: 20px; }
        .seletor-periodo label { font-weight: bold; display: block; margin-bottom: 5px; }
        .seletor-periodo select { width: 100%; font-size: 1.1em; padding: 8px; border: 1px solid #ccc; border-radius: 6px;}
        .corpo-balancete { display: flex; justify-content: space-between; gap: 40px; flex-wrap: wrap;}
        .coluna { width: 100%; min-width: 400px; flex: 1; }
        .coluna h2 { background-color: #e0e0e0; padding: 8px; text-align: center; font-size: 1.2em; margin: 0; }
        .tabela-balancete { width: 100%; border-collapse: collapse; }
        .tabela-balancete th, .tabela-balancete td { border: 1px solid #ccc; padding: 8px; font-size: 0.9em; }
        .tabela-balancete th { background-color: #f2f2f2; text-align: left; }
        .tabela-balancete .valor { text-align: right; }
        .categoria-header th { background-color: #dcedc8; font-weight: bold; }
        .total-row td { font-weight: bold; background-color: #f1f8e9; text-align: right; }
        .total-row td:first-child { text-align: left; }
        .rodape-assinaturas { margin-top: 60px; display: flex; justify-content: space-around; flex-wrap: wrap; gap: 40px; }
        .assinatura { text-align: center; width: 300px; }
        .assinatura .linha { border-top: 1px solid #333; padding-top: 5px; }
        .assinatura .cargo { font-size: 0.9em; }
        #status-balancete { padding: 12px; margin-bottom: 20px; border-radius: 6px; text-align: center; font-weight: bold; font-size: 1.1em; }
        .status-revisao { background-color: #E1F5FE; color: #0277BD; }
        .status-aprovado { background-color: #C8E6C9; color: #2E7D32; }
    </style>
</head>
<body>
    <nav class="admin-nav">
        </nav>

    <div class="main-container">
        <div class="balancete-container">
            <div class="cabecalho">
                <h1>C. E. PAULO DE TARSO</h1>
                <p>CNPJ Nº 12.253.749/0001-20</p>
                <p>RUA DO CROMO, 782, VL. PANTANO II - SANTA BARBARA D'OESTE - SP</p>
                <h3 id="titulo-balancete">BALANCETE</h3>
            </div>
            <div id="balancete-content" style="display: none;">
                <div class="corpo-balancete">
                    <div class="coluna">
                        <h2>RECEITAS</h2>
                        <table class="tabela-balancete">
                            <thead><tr><th style="width:70%;">RECEITAS</th><th>VALOR</th></tr></thead>
                            <tbody id="corpo-tabela-receitas"></tbody>
                            <tfoot><tr class="total-row"><td>TOTAL DE RECEITAS</td><td id="total-receitas"></td></tr></tfoot>
                        </table>
                    </div>
                    <div class="coluna">
                        <h2>DESPESAS</h2>
                        <table class="tabela-balancete">
                            <thead><tr><th style="width:70%;">DESPESAS</th><th>VALOR</th></tr></thead>
                            <tbody id="corpo-tabela-despesas"></tbody>
                            <tfoot><tr class="total-row"><td>TOTAL DE DESPESAS</td><td id="total-despesas"></td></tr></tfoot>
                        </table>
                    </div>
                </div>
                <div class="corpo-balancete" style="margin-top: 20px;">
                     <div class="coluna"><table class="tabela-balancete"><tr class="total-row"><td>SALDO NO PERÍODO</td><td id="saldo-periodo"></td></tr></table></div>
                     <div class="coluna"><table class="tabela-balancete">
                            <tbody><tr><td id="nome-saldo-anterior">SALDO ANTERIOR</td><td id="saldo-valor-anterior" class="valor"></td></tr></tbody>
                            <tfoot><tr class="total-row"><td>SALDO ATUAL</td><td id="saldo-atual"></td></tr></tfoot>
                        </table></div>
                </div>
            </div>
            <p id="mensagem-inicial">Selecione um balancete para iniciar a revisão.</p>
            <div class="rodape-assinaturas">
                </div>
        </div>

        <div class="controles-container">
            <h2>Painel do Conselho</h2>
            <div class="seletor-periodo">
                <label for="seletor-balancete">Selecione o Balancete para Revisão:</label>
                <select id="seletor-balancete"><option value="">-- Carregando... --</option></select>
            </div>
            <div id="status-balancete"></div>
            <div id="area-aprovacao">
                </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot, doc, getDoc, Timestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        
        const firebaseConfig = {
  apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU",
  authDomain: "voluntarios-ativos---cepat.firebaseapp.com",
  projectId: "voluntarios-ativos---cepat",
  storageBucket: "voluntarios-ativos---cepat.firebasestorage.app",
  messagingSenderId: "66122858261",
  appId: "1:66122858261:web:7fa21f1805463b5c08331c"
};
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const seletorBalancete = document.getElementById('seletor-balancete');
        const balanceteContent = document.getElementById('balancete-content');
        const mensagemInicial = document.getElementById('mensagem-inicial');
        const tituloBalancete = document.getElementById('titulo-balancete');
        const statusBar = document.getElementById('status-balancete');

        function formatarMoeda(valor) { return (valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }

        function renderizarBalancete(dados, mesAno) {
            const dataFormatada = new Date(`${mesAno}-02T00:00:00`).toLocaleString('pt-BR', { month: 'long', year: 'numeric' }).toUpperCase();
            tituloBalancete.textContent = `BALANCETE REFERENTE A ${dataFormatada}`;
            
            let totalReceitas = 0, totalDespesas = 0;
            const corpoReceitas = document.getElementById('corpo-tabela-receitas');
            const corpoDespesas = document.getElementById('corpo-tabela-despesas');
            corpoReceitas.innerHTML = ''; corpoDespesas.innerHTML = '';

            Object.entries(dados.receitas || {}).forEach(([cat, itens]) => {
                corpoReceitas.innerHTML += `<tr class="categoria-header"><th colspan="2">${cat}</th></tr>`;
                itens.forEach(item => {
                    corpoReceitas.innerHTML += `<tr><td>${item.nome}</td><td class="valor">${formatarMoeda(item.valor)}</td></tr>`;
                    totalReceitas += item.valor;
                });
            });
            Object.entries(dados.despesas || {}).forEach(([cat, itens]) => {
                corpoDespesas.innerHTML += `<tr class="categoria-header"><th colspan="2">${cat}</th></tr>`;
                itens.forEach(item => {
                    corpoDespesas.innerHTML += `<tr><td>${item.nome}</td><td class="valor">${formatarMoeda(item.valor)}</td></tr>`;
                    totalDespesas += item.valor;
                });
            });

            document.getElementById('total-receitas').textContent = formatarMoeda(totalReceitas);
            document.getElementById('total-despesas').textContent = formatarMoeda(totalDespesas);
            
            const saldoAnterior = dados.saldoAnterior || 0;
            const saldoPeriodo = totalReceitas - totalDespesas;
            const saldoAtual = saldoPeriodo + saldoAnterior;

            document.getElementById('nome-saldo-anterior').textContent = dados.nomes?.['nome-saldo-anterior'] || 'SALDO ANTERIOR';
            document.getElementById('saldo-valor-anterior').textContent = formatarMoeda(saldoAnterior);
            document.getElementById('saldo-periodo').textContent = formatarMoeda(saldoPeriodo);
            document.getElementById('saldo-atual').textContent = formatarMoeda(saldoAtual);
            
            balanceteContent.style.display = 'block';
            mensagemInicial.style.display = 'none';
        }
        
        async function carregarBalanceteSelecionado() {
            const mesAno = seletorBalancete.value;
            if (!mesAno) {
                balanceteContent.style.display = 'none';
                mensagemInicial.style.display = 'block';
                statusBar.innerHTML = '';
                return;
            }
            
            const balanceteRef = doc(db, "balancetes", mesAno);
            const docSnap = await getDoc(balanceteRef);

            if (docSnap.exists()) {
                renderizarBalancete(docSnap.data(), mesAno);
                const status = docSnap.data().status || 'em revisão';
                statusBar.textContent = `Status: ${status.replace('-', ' ')}`;
                statusBar.className = `status-bar status-${status.split(' ')[0]}`;
            }
        }

        function carregarListaDeBalancetes() {
            const q = query(collection(db, "balancetes"), where("status", "==", "em revisão"));
            onSnapshot(q, (snapshot) => {
                seletorBalancete.innerHTML = '<option value="">-- Selecione um período --</option>';
                if (snapshot.empty) {
                    seletorBalancete.innerHTML = '<option value="">Nenhum balancete em revisão</option>';
                    return;
                }
                snapshot.forEach(doc => {
                    const option = document.createElement('option');
                    option.value = doc.id; // Ex: "2025-07"
                    const dataFormatada = new Date(`${doc.id}-02T00:00:00`).toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
                    option.textContent = dataFormatada.charAt(0).toUpperCase() + dataFormatada.slice(1);
                    seletorBalancete.appendChild(option);
                });
            }, (error) => {
                console.error("Erro ao buscar balancetes para revisão:", error);
                seletorBalancete.innerHTML = '<option value="">Erro ao carregar</option>';
            });
        }
        
        seletorBalancete.addEventListener('change', carregarBalanceteSelecionado);
        carregarListaDeBalancetes();

    </script>
    <script type="module" src="/logout.js"></script>
</body>
</html>