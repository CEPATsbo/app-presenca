<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fechamento Anual - Módulo Financeiro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f6f9; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; box-sizing: border-box; }
        .balancete-container { background-color: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 100%; max-width: 1100px; margin-bottom: 30px; }
        h2 { border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px;}
        #acesso-negado { text-align: center; }
        .cabecalho { text-align: center; margin-bottom: 20px; }
        .cabecalho h1 { font-size: 1.5em; margin: 0; }
        .cabecalho p { font-size: 0.9em; margin: 2px 0; }
        .cabecalho h3 { font-weight: normal; }
        .status-bar { padding: 12px; margin-bottom: 20px; border-radius: 6px; text-align: center; font-weight: bold; font-size: 1.1em; }
        .status-aprovado { background-color: #C8E6C9; color: #2E7D32; }
        .status-pendente { background-color: #FFF9C4; color: #795548; }
        .seletor-container { display: flex; justify-content: center; align-items: flex-end; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 20px; flex-wrap: wrap; }
        .seletor-bloco { display: flex; flex-direction: column; gap: 5px; }
        .seletor-bloco label { font-weight: bold; text-align: center; color: #555; font-size: 0.9em; }
        .seletor-bloco select, .seletor-bloco button { font-size: 1.1em; padding: 8px; border: 1px solid #ccc; border-radius: 6px;}
        .seletor-bloco button { background-color: #007bff; color: white; cursor: pointer; }
        
        /* Ajuste de colunas para PDF */
        .corpo-balancete { display: flex; justify-content: space-between; gap: 20px; flex-wrap: nowrap !important; width: 100%; }
        .coluna { width: 48%; flex: 0 0 48%; }
        
        .coluna h2 { background-color: #e0e0e0; padding: 8px; text-align: center; font-size: 1.1em; margin: 0; }
        .tabela-balancete { width: 100%; border-collapse: collapse; margin-top: 15px;}
        .tabela-balancete th, .tabela-balancete td { border: 1px solid #ccc; padding: 8px 5px; font-size: 0.85em; }
        .tabela-balancete th { background-color: #f2f2f2; text-align: left; }
        .tabela-balancete td:last-child { text-align: right; width: 100px; white-space: nowrap; }
        .categoria-header th { background-color: #dcedc8; font-weight: bold; border-top: 2px solid #999; }
        .total-row td { font-weight: bold; background-color: #f1f8e9; text-align: right; }
        .total-row td:first-child { text-align: left; }
        .actions-container { text-align: center; margin-top: 40px; display: flex; justify-content: center; gap: 20px; }
        .actions-container button { padding: 15px 30px; font-size: 1.2em; cursor: pointer; border: none; border-radius: 6px; color: white; background-color: #4CAF50; font-weight: bold; }
        .nav-voltar { max-width: 1100px; margin: 0 auto 30px auto; text-align: left; }
        .btn-voltar { background-color: #e9ecef; color: #495057; border: 1px solid #dee2e6; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: bold; }
        
        /* Estilo específico para quando estiver gerando o PDF */
        .pdf-mode { width: 1100px !important; padding: 20px !important; }
    </style>
</head>
<body>
    <nav class="nav-voltar">
        <a href="/dashboard-financeiro.html" class="btn-voltar">⬅ Voltar ao Módulo Financeiro</a>
    </nav>
    
    <div id="acesso-negado" style="display: none;">
        <h1>Acesso Negado</h1>
        <p>Permissão insuficiente.</p>
    </div>
    
    <div id="main-content" class="balancete-container" style="display: none;">
        <div class="seletor-container">
            <div class="seletor-bloco">
                <label for="seletor-ano">Selecione o Ano para Consolidação</label>
                <select id="seletor-ano"></select>
            </div>
            <div class="seletor-bloco">
                <button id="btn-gerar-relatorio">Gerar Relatório Anual</button>
            </div>
        </div>

        <div id="resultado-relatorio"></div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, orderBy, documentId } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { protegerPagina } from '/auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU",
            authDomain: "voluntarios-ativos---cepat.firebaseapp.com",
            projectId: "voluntarios-ativos---cepat",
            storageBucket: "voluntarios-ativos---cepat.firebasestorage.app",
            messagingSenderId: "66122858261",
            appId: "1:66122858261:web:7fa21f1805463b5c08331c"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        protegerPagina(['super-admin', 'diretor', 'tesoureiro', 'conselheiro'])
            .then(user => {
                document.getElementById('main-content').style.display = 'block';
                inicializarPagina(user);
            })
            .catch(() => document.getElementById('acesso-negado').style.display = 'block');

        function inicializarPagina(user) {
            const seletorAno = document.getElementById('seletor-ano');
            const btnGerarRelatorio = document.getElementById('btn-gerar-relatorio');
            const resultadoRelatorio = document.getElementById('resultado-relatorio');
            
            function formatarMoeda(valor) { return (valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
            
            function popularSeletorAno() {
                const anoAtual = new Date().getFullYear();
                let optionsHtml = '';
                for (let i = 0; i < 5; i++) {
                    const ano = anoAtual - i;
                    optionsHtml += `<option value="${ano}">${ano}</option>`;
                }
                seletorAno.innerHTML = optionsHtml;
                seletorAno.value = anoAtual - 1;
            }

            btnGerarRelatorio.addEventListener('click', async () => {
                const ano = seletorAno.value;
                resultadoRelatorio.style.display = 'block';
                resultadoRelatorio.innerHTML = '<h3>Validando dados anuais...</h3>';
                
                try {
                    const q = query(collection(db, "balancetes"), orderBy(documentId()));
                    const snapshot = await getDocs(q);
                    const balancetes = snapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .filter(b => b.id.startsWith(ano));

                    if (balancetes.length === 0) {
                        resultadoRelatorio.innerHTML = `<div class="status-bar status-pendente">Nenhum balancete para ${ano}</div>`;
                        return;
                    }

                    const pendentes = balancetes.filter(b => b.status !== 'aprovado');
                    if (pendentes.length > 0) {
                        resultadoRelatorio.innerHTML = `<div class="status-bar status-pendente">Relatório Bloqueado: Existem ${pendentes.length} meses pendentes de aprovação em ${ano}.</div>`;
                    } else {
                        processarConsolidacao(balancetes, ano);
                    }
                } catch (error) { console.error(error); }
            });

            function processarConsolidacao(balancetes, ano) {
                const consolidado = { receitas: {}, despesas: {} };
                let totalRec = 0, totalDes = 0;
                balancetes.sort((a, b) => a.id.localeCompare(b.id)); 
                const saldoAnterior = balancetes[0].saldoAnterior || 0;

                balancetes.forEach(b => {
                    const mes = new Intl.DateTimeFormat('pt-BR', { month: 'short' }).format(new Date(`${b.id.split('_')[0]}-02`));
                    
                    // Soma Receitas
                    Object.entries(b.receitas).forEach(([cat, itens]) => {
                        if (!consolidado.receitas[cat]) consolidado.receitas[cat] = [];
                        itens.forEach(i => {
                            if (i.valor > 0) {
                                consolidado.receitas[cat].push({ nome: `${i.nome} (${mes})`, valor: i.valor });
                                totalRec += i.valor;
                            }
                        });
                    });
                    // Soma Despesas
                    Object.entries(b.despesas).forEach(([cat, itens]) => {
                        if (!consolidado.despesas[cat]) consolidado.despesas[cat] = [];
                        itens.forEach(i => {
                            if (i.valor > 0) {
                                consolidado.despesas[cat].push({ nome: `${i.nome} (${mes})`, valor: i.valor });
                                totalDes += i.valor;
                            }
                        });
                    });
                });

                let htmlRec = '', htmlDes = '';
                Object.keys(consolidado.receitas).sort().forEach(cat => {
                    htmlRec += `<tr class="categoria-header"><th colspan="2">${cat}</th></tr>`;
                    consolidado.receitas[cat].forEach(i => htmlRec += `<tr><td>${i.nome}</td><td>${formatarMoeda(i.valor)}</td></tr>`);
                });
                Object.keys(consolidado.despesas).sort().forEach(cat => {
                    htmlDes += `<tr class="categoria-header"><th colspan="2">${cat}</th></tr>`;
                    consolidado.despesas[cat].forEach(i => htmlDes += `<tr><td>${i.nome}</td><td>${formatarMoeda(i.valor)}</td></tr>`);
                });

                const saldoPer = totalRec - totalDes;
                const saldoAtu = saldoPer + saldoAnterior;

                resultadoRelatorio.innerHTML = `
                    <div id="balancete-para-pdf" style="background:white; padding: 20px; width: 1050px; margin: auto;">
                        <div class="cabecalho">
                            <h1>C. E. PAULO DE TARSO</h1>
                            <p>CNPJ Nº 12.253.749/0001-20</p>
                            <p>RUA DO CROMO, 782, VL. PANTANO II - SANTA BARBARA D'OESTE - SP</p>
                            <h3>BALANCETE CONSOLIDADO - ANO ${ano}</h3>
                        </div>
                        <div class="status-bar status-aprovado">Relatório Consolidado Gerado com Sucesso</div>
                        <div class="corpo-balancete">
                            <div class="coluna">
                                <h2>RECEITAS</h2>
                                <table class="tabela-balancete">
                                    <thead><tr><th>DESCRIÇÃO</th><th>VALOR</th></tr></thead>
                                    <tbody>${htmlRec}</tbody>
                                    <tfoot><tr class="total-row"><td>TOTAL RECEITAS</td><td>${formatarMoeda(totalRec)}</td></tr></tfoot>
                                </table>
                            </div>
                            <div class="coluna">
                                <h2>DESPESAS</h2>
                                <table class="tabela-balancete">
                                    <thead><tr><th>DESCRIÇÃO</th><th>VALOR</th></tr></thead>
                                    <tbody>${htmlDes}</tbody>
                                    <tfoot><tr class="total-row"><td>TOTAL DESPESAS</td><td>${formatarMoeda(totalDes)}</td></tr></tfoot>
                                </table>
                            </div>
                        </div>
                        <div class="corpo-balancete" style="margin-top:20px;">
                            <div class="coluna"><table class="tabela-balancete"><tr class="total-row"><td>SALDO DO PERÍODO</td><td>${formatarMoeda(saldoPer)}</td></tr></table></div>
                            <div class="coluna"><table class="tabela-balancete">
                                <tr><td>SALDO ANTERIOR (${ano})</td><td>${formatarMoeda(saldoAnterior)}</td></tr>
                                <tr class="total-row"><td>SALDO ATUAL</td><td>${formatarMoeda(saldoAtu)}</td></tr>
                            </table></div>
                        </div>
                    </div>
                    <div class="actions-container"><button id="btn-gerar-pdf">BAIXAR PDF CONSOLIDADO</button></div>
                `;
                document.getElementById('btn-gerar-pdf').onclick = () => gerarPdf(ano);
            }

            async function gerarPdf(ano) {
                const element = document.getElementById('balancete-para-pdf');
                const btn = document.getElementById('btn-gerar-pdf');
                btn.innerText = "GERANDO...";
                btn.disabled = true;

                try {
                    const canvas = await html2canvas(element, {
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        width: 1050, // Força largura fixa para evitar quebras de colunas no PDF
                        windowWidth: 1050
                    });

                    const imgData = canvas.toDataURL('image/jpeg', 0.95);
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const imgProps = pdf.getImageProperties(imgData);
                    const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
                    
                    let heightLeft = imgHeight;
                    let position = 0;

                    // Primeira Página
                    pdf.addImage(imgData, 'JPEG', 0, position, pdfWidth, imgHeight);
                    heightLeft -= pdfHeight;

                    // Páginas Adicionais (se o relatório for muito longo)
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'JPEG', 0, position, pdfWidth, imgHeight);
                        heightLeft -= pdfHeight;
                    }

                    pdf.save(`balancete_consolidado_${ano}.pdf`);
                } catch (err) {
                    console.error(err);
                    alert("Erro ao gerar PDF.");
                } finally {
                    btn.innerText = "BAIXAR PDF CONSOLIDADO";
                    btn.disabled = false;
                }
            }

            popularSeletorAno();
        }
    </script>
</body>
</html>