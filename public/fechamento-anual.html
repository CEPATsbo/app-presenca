<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fechamento Anual - Módulo Financeiro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f6f9; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; box-sizing: border-box; }
        .balancete-container { background-color: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 100%; max-width: 1100px; margin-bottom: 30px; }
        
        .cabecalho { text-align: center; margin-bottom: 20px; }
        .cabecalho h1 { font-size: 1.5em; margin: 0; }
        .cabecalho p { font-size: 0.9em; margin: 2px 0; }
        
        .status-bar { padding: 12px; margin-bottom: 20px; border-radius: 6px; text-align: center; font-weight: bold; font-size: 1.1em; }
        .status-aprovado { background-color: #C8E6C9; color: #2E7D32; }
        .status-pendente { background-color: #FFF9C4; color: #795548; }

        .seletor-container { display: flex; justify-content: center; align-items: flex-end; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 20px; }
        .seletor-bloco { display: flex; flex-direction: column; gap: 5px; }
        .seletor-bloco select, .seletor-bloco button { font-size: 1.1em; padding: 8px; border: 1px solid #ccc; border-radius: 6px;}
        
        /* Ajuste das Colunas */
        .corpo-balancete { display: flex; justify-content: space-between; gap: 20px; flex-wrap: nowrap !important; width: 100%; margin-bottom: 20px; }
        .coluna { width: 48.5%; flex: 0 0 48.5%; box-sizing: border-box; }
        
        .coluna h2 { background-color: #e0e0e0; padding: 8px; text-align: center; font-size: 1.1em; margin: 0; border-radius: 4px 4px 0 0; }
        .tabela-balancete { width: 100%; border-collapse: collapse; margin-top: 0;}
        .tabela-balancete th, .tabela-balancete td { border: 1px solid #ccc; padding: 8px 6px; font-size: 0.82em; }
        .tabela-balancete th { background-color: #f2f2f2; text-align: left; }
        .tabela-balancete td:last-child { text-align: right; width: 100px; white-space: nowrap; font-weight: 500; }
        
        .categoria-header th { background-color: #dcedc8; font-weight: bold; border-top: 2px solid #999; }
        .total-row td { font-weight: bold; background-color: #f1f8e9; text-align: right; border-top: 2px solid #666; }
        .total-row td:first-child { text-align: left; }

        .actions-container { text-align: center; margin-top: 40px; }
        .btn-principal { padding: 15px 30px; font-size: 1.2em; cursor: pointer; border: none; border-radius: 6px; color: white; background-color: #4CAF50; font-weight: bold; }
        
        .nav-voltar { max-width: 1100px; margin: 0 auto 30px auto; text-align: left; width: 100%; }
        .btn-voltar { background-color: #e9ecef; color: #495057; border: 1px solid #dee2e6; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: bold; }

        /* Container de exportação com proteção contra cortes laterais */
        #balancete-para-pdf { 
            background: white; 
            padding: 30px; /* Aumentado para garantir bordas brancas */
            width: 1020px; /* Reduzido para encaixar melhor no A4 */
            margin: auto; 
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <nav class="nav-voltar">
        <a href="/dashboard-financeiro.html" class="btn-voltar">⬅ Voltar ao Financeiro</a>
    </nav>
    
    <div id="main-content" class="balancete-container" style="display: none;">
        <div class="seletor-container">
            <div class="seletor-bloco">
                <label>Ano de Consolidação</label>
                <select id="seletor-ano"></select>
            </div>
            <button id="btn-gerar-relatorio" class="btn-principal" style="padding: 10px 20px; background-color: #007bff;">Gerar Visualização</button>
        </div>
        <div id="resultado-relatorio"></div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, query, getDocs, orderBy, documentId } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { protegerPagina } from '/auth.js';

        const firebaseConfig = { apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU", authDomain: "voluntarios-ativos---cepat.firebaseapp.com", projectId: "voluntarios-ativos---cepat", storageBucket: "voluntarios-ativos---cepat.firebasestorage.app", messagingSenderId: "66122858261", appId: "1:66122858261:web:7fa21f1805463b5c08331c" };
        const db = getFirestore(initializeApp(firebaseConfig));

        protegerPagina(['super-admin', 'diretor', 'tesoureiro']).then(() => {
            document.getElementById('main-content').style.display = 'block';
            popularAnos();
        });

        function popularAnos() {
            const sel = document.getElementById('seletor-ano');
            const ano = new Date().getFullYear();
            for(let i=0; i<5; i++) {
                let opt = document.createElement('option');
                opt.value = ano - i; opt.textContent = ano - i;
                sel.appendChild(opt);
            }
            sel.value = ano - 1;
        }

        document.getElementById('btn-gerar-relatorio').onclick = async () => {
            const ano = document.getElementById('seletor-ano').value;
            const res = document.getElementById('resultado-relatorio');
            res.innerHTML = '<h3>Processando balancetes...</h3>';

            const snap = await getDocs(query(collection(db, "balancetes"), orderBy(documentId())));
            const lista = snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(b => b.id.startsWith(ano));

            if (lista.length === 0) { res.innerHTML = "Sem dados."; return; }
            if (lista.some(b => b.status !== 'aprovado')) { 
                res.innerHTML = `<div class="status-bar status-pendente">Existem meses pendentes de aprovação em ${ano}.</div>`;
                return;
            }

            renderizar(lista, ano);
        };

        function renderizar(balancetes, ano) {
            const consolidado = { receitas: {}, despesas: {} };
            let totalRec = 0, totalDes = 0;
            balancetes.sort((a, b) => a.id.localeCompare(b.id));

            balancetes.forEach(b => {
                const mes = new Intl.DateTimeFormat('pt-BR', { month: 'short' }).format(new Date(`${b.id.split('_')[0]}-02`));
                // Receitas
                Object.entries(b.receitas).forEach(([cat, itens]) => {
                    if (!consolidado.receitas[cat]) consolidado.receitas[cat] = [];
                    itens.forEach(i => { if(i.valor > 0) { consolidado.receitas[cat].push({ n: `${i.nome} (${mes})`, v: i.valor }); totalRec += i.valor; } });
                });
                // Despesas
                Object.entries(b.despesas).forEach(([cat, itens]) => {
                    if (!consolidado.despesas[cat]) consolidado.despesas[cat] = [];
                    itens.forEach(i => { if(i.valor > 0) { consolidado.despesas[cat].push({ n: `${i.nome} (${mes})`, v: i.valor }); totalDes += i.valor; } });
                });
            });

            const fmt = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            let hRec = '', hDes = '';
            Object.keys(consolidado.receitas).sort().forEach(c => {
                hRec += `<tr class="categoria-header"><th colspan="2">${c}</th></tr>`;
                consolidado.receitas[c].forEach(i => hRec += `<tr><td>${i.n}</td><td>${fmt(i.v)}</td></tr>`);
            });
            Object.keys(consolidado.despesas).sort().forEach(c => {
                hDes += `<tr class="categoria-header"><th colspan="2">${c}</th></tr>`;
                consolidado.despesas[c].forEach(i => hDes += `<tr><td>${i.n}</td><td>${fmt(i.v)}</td></tr>`);
            });

            const saldoP = totalRec - totalDes;
            const saldoA = saldoP + (balancetes[0].saldoAnterior || 0);

            document.getElementById('resultado-relatorio').innerHTML = `
                <div id="balancete-para-pdf">
                    <div class="cabecalho">
                        <h1>C. E. PAULO DE TARSO</h1>
                        <p>CNPJ Nº 12.253.749/0001-20 | Santa Bárbara d'Oeste - SP</p>
                        <h3 style="margin-top:15px; color:#1b5e20;">BALANCETE CONSOLIDADO - ANO ${ano}</h3>
                    </div>
                    <div class="status-bar status-aprovado">Relatório Consolidado Gerado com Sucesso</div>
                    <div class="corpo-balancete">
                        <div class="coluna">
                            <h2>RECEITAS</h2>
                            <table class="tabela-balancete">
                                <thead><tr><th>DESCRIÇÃO</th><th>VALOR</th></tr></thead>
                                <tbody>${hRec}</tbody>
                                <tfoot><tr class="total-row"><td>TOTAL RECEITAS</td><td>${fmt(totalRec)}</td></tr></tfoot>
                            </table>
                        </div>
                        <div class="coluna">
                            <h2>DESPESAS</h2>
                            <table class="tabela-balancete">
                                <thead><tr><th>DESCRIÇÃO</th><th>VALOR</th></tr></thead>
                                <tbody>${hDes}</tbody>
                                <tfoot><tr class="total-row"><td>TOTAL DESPESAS</td><td>${fmt(totalDes)}</td></tr></tfoot>
                            </table>
                        </div>
                    </div>
                    <div class="corpo-balancete" style="margin-top:20px; background:#f8f9fa; padding:10px; border-radius:8px;">
                        <div class="coluna"><table class="tabela-balancete"><tr class="total-row"><td>SALDO DO PERÍODO</td><td>${fmt(saldoP)}</td></tr></table></div>
                        <div class="coluna"><table class="tabela-balancete">
                            <tr><td style="font-weight:bold;">SALDO ANTERIOR</td><td>${fmt(balancetes[0].saldoAnterior || 0)}</td></tr>
                            <tr class="total-row"><td>SALDO ATUAL</td><td>${fmt(saldoA)}</td></tr>
                        </table></div>
                    </div>
                </div>
                <div class="actions-container"><button id="btn-gerar-pdf" class="btn-principal">BAIXAR PDF CONSOLIDADO</button></div>
            `;
            document.getElementById('btn-gerar-pdf').onclick = () => gerarPdf(ano);
        }

        async function gerarPdf(ano) {
            const el = document.getElementById('balancete-para-pdf');
            const btn = document.getElementById('btn-gerar-pdf');
            btn.innerText = "GERANDO..."; btn.disabled = true;

            try {
                const canvas = await html2canvas(el, {
                    scale: 2.5, // Aumentada a escala para maior nitidez
                    useCORS: true,
                    logging: false,
                    width: 1020, // Largura controlada para evitar corte lateral
                    windowWidth: 1020
                });

                const imgData = canvas.toDataURL('image/jpeg', 0.98);
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                
                // Ajuste de proporção para caber na largura do PDF com margem
                const imgWidth = pdfWidth - 20; // 10mm de margem em cada lado
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                let heightLeft = imgHeight;
                let position = 10; // Margem superior inicial

                // Adiciona imagem centralizada com margem lateral corrigida
                pdf.addImage(imgData, 'JPEG', 10, position, imgWidth, imgHeight);
                heightLeft -= (pdfHeight - 20);

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight + 10;
                    pdf.addPage();
                    pdf.addImage(imgData, 'JPEG', 10, position, imgWidth, imgHeight);
                    heightLeft -= (pdfHeight - 20);
                }

                pdf.save(`balancete_consolidado_${ano}.pdf`);
            } catch (err) { console.error(err); } finally {
                btn.innerText = "BAIXAR PDF CONSOLIDADO"; btn.disabled = false;
            }
        }
    </script>
</body>
</html>