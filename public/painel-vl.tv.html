<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Chamadas - Vinha de Luz</title>
    <style>
        :root { --cor-primaria: #8e44ad; } /* Cor VL */
        html, body { 
            margin: 0; 
            padding: 0; 
            width: 100%; 
            height: 100%; 
            overflow: hidden; 
            background-color: #f0f2f5; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: #333;
        }
        .container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            text-align: center;
        }
        #chamada-wrapper {
            background-color: white;
            border-radius: 20px;
            padding: 40px 60px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0;
            transform: scale(0.9);
        }
        #chamada-wrapper.visivel {
            opacity: 1;
            transform: scale(1);
        }
        #nome-assistido {
            font-size: 7vw; /* Tamanho grande e responsivo */
            font-weight: bold;
            color: var(--cor-primaria);
            margin: 0;
        }
        #texto-guia {
            font-size: 3vw;
            color: #555;
            margin-top: 10px;
        }
        #logo-placeholder {
            font-size: 2vw;
            color: #aaa;
            position: absolute;
            top: 20px;
            left: 20px;
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div id="acesso-negado" class="container hidden"><h1>Acesso Negado</h1></div>
    <div id="main-content" class="container hidden">
        <div id="logo-placeholder">Vinha de Luz - Painel</div>
        
        <div id="chamada-wrapper">
            <h1 id="nome-assistido"></h1>
            <p id="texto-guia">Dirija-se ao atendimento</p>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { 
            getFirestore, collection, query, where, orderBy, limit, 
            onSnapshot, doc, updateDoc, serverTimestamp
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { protegerPagina } from '/auth.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU",
            authDomain: "voluntarios-ativos---cepat.firebaseapp.com",
            projectId: "voluntarios-ativos---cepat",
            storageBucket: "voluntarios-ativos---cepat.firebasestorage.app",
            messagingSenderId: "66122858261",
            appId: "1:66122858261:web:7fa21f1805463b5c08331c"
        };
        initializeApp(firebaseConfig);
        
        // Permissões
        protegerPagina(['recepcionista', 'diretor', 'tesoureiro', 'entrevistador', 'super-admin']).then(user => {
            document.getElementById('main-content').classList.remove('hidden');
            inicializarPagina();
        }).catch(err => { 
            document.getElementById('acesso-negado').classList.remove('hidden');
            document.getElementById('main-content').classList.add('hidden');
        });

        function inicializarPagina() {
            const db = getFirestore();
            const filaVlRef = collection(db, 'fila_atendimento_vl');
            
            const ui = {
                wrapper: document.getElementById('chamada-wrapper'),
                nomeAssistido: document.getElementById('nome-assistido')
                // Referência do áudio REMOVIDA
            };

            let ultimoChamadoId = null; 
            let timerLimparTela;

            const q = query(
                filaVlRef, 
                where('status', '==', 'Chamado'), 
                orderBy('chamadoEm', 'desc'), 
                limit(1)
            );

            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    ui.wrapper.classList.remove('visivel');
                    return;
                }
                
                const docChamado = snapshot.docs[0];
                const assistido = { id: docChamado.id, ...docChamado.data() };

                if (assistido.id !== ultimoChamadoId) {
                    clearTimeout(timerLimparTela); 
                    
                    ultimoChamadoId = assistido.id;
                    ui.nomeAssistido.textContent = assistido.nomeAssistido;
                    ui.wrapper.classList.add('visivel');
                    
                    // Comandos de áudio REMOVIDOS
                    
                    timerLimparTela = setTimeout(() => {
                        ui.wrapper.classList.remove('visivel');
                    }, 10000); 
                }
            }, (error) => {
                console.error("Erro ao escutar a fila de chamados:", error);
                ui.nomeAssistido.textContent = "Erro de Conexão";
                ui.wrapper.classList.add('visivel');
            });
        }
    </script>
</body>
</html>