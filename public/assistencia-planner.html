<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cáritas - Planner de Escala</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f4f6f9; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .nav-header { width: 100%; max-width: 900px; display: flex; justify-content: space-between; margin-bottom: 20px; }
        .btn-voltar { background-color: #6c757d; color: white; padding: 10px 15px; border-radius: 8px; text-decoration: none; font-weight: bold; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 900px; box-sizing: border-box; }
        h1 { color: #2c3e50; margin: 0; border-bottom: 2px solid #e67e22; padding-bottom: 10px; }
        .instrucao { background: #fff3e0; padding: 15px; border-radius: 8px; border-left: 5px solid #e67e22; margin: 20px 0; font-size: 0.95em; color: #856404; }
        
        .form-escala { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full-width { grid-column: 1 / -1; }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-group label { font-weight: bold; color: #34495e; font-size: 0.9em; }
        .form-group input, .form-group select, .form-group textarea { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1em; width: 100%; box-sizing: border-box; }
        
        .readonly-field { background: #f1f1f1; cursor: not-allowed; }
        .ajuste-manual-container { display: flex; align-items: center; gap: 10px; margin-top: 5px; font-size: 0.85em; color: #e67e22; font-weight: bold; }
        
        .section-titulo { background: #f8f9fa; padding: 10px; border-radius: 6px; font-weight: bold; color: #e67e22; margin-top: 10px; }
        .footer-actions { margin-top: 30px; display: flex; justify-content: flex-end; gap: 15px; border-top: 1px solid #eee; padding-top: 20px; }
        .btn-salvar { background-color: #27ae60; color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1.1em; }
        .btn-salvar:disabled { background-color: #95a5a6; cursor: not-allowed; }
    </style>
</head>
<body>
    <header class="nav-header">
        <a href="/modulo-caritas.html" class="btn-voltar"><i class="fas fa-arrow-left"></i> Painel Cáritas</a>
    </header>

    <main class="container" id="conteudo-principal">
        <h1><i class="fas fa-calendar-check"></i> Escala do Domingo Social</h1>
        
        <div class="instrucao">
            <i class="fas fa-info-circle"></i> <strong>Regra de Agendamento:</strong> Por padrão, o trabalho ocorre no <strong>3º domingo</strong>. É possível antecipar para o 2º, mas nunca adiar para o 4º.
        </div>

        <form id="form-escala" class="form-escala">
            <div class="form-group">
                <label>Mês de Referência (Escala Futura)</label>
                <select id="mes-referencia" required></select>
            </div>

            <div class="form-group">
                <label>Data do Trabalho (3º Domingo)</label>
                <input type="date" id="data-trabalho" class="readonly-field" readonly required>
                <div class="ajuste-manual-container">
                    <input type="checkbox" id="permitir-ajuste"> 
                    <label for="permitir-ajuste">Ajustar data manualmente (Exceção)</label>
                </div>
            </div>
            
            <div class="form-group full-width">
                <label>Sugestão de Tema (12 Temas Base)</label>
                <select id="sugestao-tema">
                    <option value="">-- Selecione um dos 12 temas ou escreva no campo abaixo --</option>
                    <option value="1) A vida não acabou: recomeços possíveis - [Reflexão sobre ciclos, quedas e retomadas, sem culpa.]">1) A vida não acabou: recomeços possíveis</option>
                    <option value="2) Quando falta fora, a gente precisa segurar dentro - [Como cuidar do emocional quando a vida está apertada.]">2) Quando falta fora, a gente precisa segurar dentro</option>
                    <option value="3) Coragem também é pedir ajuda - [Acolhimento da vulnerabilidade sem vergonha.]">3) Coragem também é pedir ajuda</option>
                    <option value="4) Família não é perfeição: é presença - [Como fortalecer vínculos mesmo com dificuldades e conflitos.]">4) Família não é perfeição: é presença</option>
                    <option value="5) Pequenos passos também são vitória - [Sair da paralisia e valorizar avanços possíveis.]">5) Pequenos passos também são vitória</option>
                    <option value="6) Humildade e dignidade caminham juntas - [Você pode precisar hoje sem perder seu valor.]">6) Humildade e dignidade caminham juntas</option>
                    <option value="7) A esperança não é ilusão: é força de atravessar - [Esperança como sustentação afetiva e espiritual.]">7) A esperança não é ilusão: é força de atravessar</option>
                    <option value="8) Fraternidade: ninguém se salva sozinho - [Comunidade, rede de apoio, união e solidariedade real.]">8) Fraternidade: ninguém se salva sozinho</option>
                    <option value="9) O que eu posso controlar quando quase nada está sob controle? - [Foco no possível: atitude, escolhas pequenas, cuidado diário.]">9) O que eu posso controlar quando quase nada está sob controle?</option>
                    <option value="10) Perdão que alivia (sem esquecer e sem se humilhar) - [Perdão como libertação emocional, não como submissão.]">10) Perdão que alivia (sem esquecer e sem se humilhar)</option>
                    <option value="11) Amor como atitude: carinho no meio do caos - [Amor não como “romantismo”, mas como gesto, cuidado e respeito.]">11) Amor como atitude: carinho no meio do caos</option>
                    <option value="12) Gratidão sem negar a dor - [Gratidão madura: reconhecer o bem que existe, sem fingir que está tudo bem.]">12) Gratidão sem negar a dor</option>
                </select>
            </div>

            <div class="form-group full-width">
                <label>Tema da Preleção (Texto Final) *</label>
                <textarea id="tema-prelecao" rows="2" placeholder="O texto selecionado acima aparecerá aqui para ajustes..." required></textarea>
            </div>

            <div class="full-width section-titulo">Passe de Harmonização e Sustentação</div>
            <div class="form-group">
                <label>Médium 1</label>
                <select id="escala-medium1" class="select-voluntario"><option value="">Carregando...</option></select>
            </div>
            <div class="form-group">
                <label>Médium 2</label>
                <select id="escala-medium2" class="select-voluntario"><option value="">Carregando...</option></select>
            </div>

            <div class="full-width section-titulo">Palestra e Acolhimento</div>
            <div class="form-group">
                <label>Preletor(a)</label>
                <select id="escala-preletor" class="select-voluntario"><option value="">Carregando...</option></select>
            </div>
            <div class="form-group">
                <label>Entrevistador(a)</label>
                <select id="escala-entrevistador" class="select-voluntario"><option value="">Carregando...</option></select>
            </div>

            <div class="full-width section-titulo">Escola de Pais e Evangelização Infantil</div>
            <div class="form-group">
                <label>Membro Escola de Pais</label>
                <select id="escala-escola-pais" class="select-voluntario"><option value="">Carregando...</option></select>
            </div>
            <div class="form-group"></div>
            <div class="form-group">
                <label>Evangelizador(a) 1</label>
                <select id="escala-evangelizador1" class="select-voluntario"><option value="">Carregando...</option></select>
            </div>
            <div class="form-group">
                <label>Evangelizador(a) 2</label>
                <select id="escala-evangelizador2" class="select-voluntario"><option value="">Carregando...</option></select>
            </div>

            <div class="footer-actions full-width">
                <button type="submit" class="btn-salvar" id="btn-gravar">Gravar Escala Mensal</button>
            </div>
        </form>
    </main>

    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where, orderBy, serverTimestamp, Timestamp, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { protegerPagina } from '/auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU",
            authDomain: "voluntarios-ativos---cepat.firebaseapp.com",
            projectId: "voluntarios-ativos---cepat",
            storageBucket: "voluntarios-ativos---cepat.firebasestorage.app",
            messagingSenderId: "66122858261",
            appId: "1:66122858261:web:7fa21f1805463b5c08331c"
        };

        const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApp();
        const db = getFirestore(app);

        protegerPagina(['super-admin','diretor','tesoureiro','conselheiro','recepcionista','entrevistador','caritas'])
            .then(user => {
                inicializarPlanner(user);
            })
            .catch(() => window.location.href = '/dashboard.html');

        async function inicializarPlanner(user) {
            const selectMes = document.getElementById('mes-referencia');
            const inputData = document.getElementById('data-trabalho');
            const checkAjuste = document.getElementById('permitir-ajuste');
            const sugestaoTema = document.getElementById('sugestao-tema');
            const temaFinal = document.getElementById('tema-prelecao');
            const form = document.getElementById('form-escala');

            popularMeses(selectMes);
            await carregarVoluntarios();

            // Lógica de sugestão de temas
            sugestaoTema.onchange = () => {
                if (sugestaoTema.value) {
                    temaFinal.value = sugestaoTema.value;
                }
            };

            // Lógica ao mudar o mês: Calcular data e buscar escala existente
            selectMes.onchange = async () => {
                const [mes, ano] = selectMes.value.split('|').map(Number);
                const mesTexto = selectMes.options[selectMes.selectedIndex].text;
                
                // 1. Calcular Terceiro Domingo
                const dataCalculada = calcularTerceiroDomingo(mes, ano);
                const offset = dataCalculada.getTimezoneOffset() * 60000;
                const dataLocal = new Date(dataCalculada.getTime() - offset);
                inputData.value = dataLocal.toISOString().split('T')[0];

                // 2. Buscar no Firestore se já existe planejamento
                const idDocumento = mesTexto.replace(/\s+/g, '').replace(/\//g, '_');
                
                // Limpa campos antes de preencher
                temaFinal.value = "";
                sugestaoTema.value = "";
                document.querySelectorAll('.select-voluntario').forEach(s => s.value = "");

                try {
                    const docSnap = await getDoc(doc(db, "escalaCaritas", idDocumento));
                    if (docSnap.exists()) {
                        const dados = docSnap.data();
                        temaFinal.value = dados.tema || "";
                        if (dados.equipe) {
                            document.getElementById('escala-medium1').value = dados.equipe.mediuns[0] || "";
                            document.getElementById('escala-medium2').value = dados.equipe.mediuns[1] || "";
                            document.getElementById('escala-preletor').value = dados.equipe.preletor || "";
                            document.getElementById('escala-entrevistador').value = dados.equipe.entrevistador || "";
                            document.getElementById('escala-escola-pais').value = dados.equipe.escolaPais || "";
                            document.getElementById('escala-evangelizador1').value = dados.equipe.evangelizadores[0] || "";
                            document.getElementById('escala-evangelizador2').value = dados.equipe.evangelizadores[1] || "";
                        }
                    }
                } catch (err) {
                    console.error("Erro ao carregar escala salva:", err);
                }
            };

            selectMes.dispatchEvent(new Event('change'));

            checkAjuste.onchange = () => {
                inputData.readOnly = !checkAjuste.checked;
                inputData.style.background = checkAjuste.checked ? "#fff" : "#f1f1f1";
                if (!checkAjuste.checked) selectMes.dispatchEvent(new Event('change'));
            };

            form.onsubmit = async (e) => {
                e.preventDefault();
                const btn = document.getElementById('btn-gravar');
                btn.disabled = true;
                btn.textContent = "Gravando...";

                const mesTexto = selectMes.options[selectMes.selectedIndex].text;
                const idDocumento = mesTexto.replace(/\s+/g, '').replace(/\//g, '_');

                const escala = {
                    dataTrabalho: Timestamp.fromDate(new Date(inputData.value + 'T12:00:00')),
                    mesReferencia: mesTexto,
                    tema: temaFinal.value,
                    equipe: {
                        mediuns: [document.getElementById('escala-medium1').value, document.getElementById('escala-medium2').value],
                        preletor: document.getElementById('escala-preletor').value,
                        entrevistador: document.getElementById('escala-entrevistador').value,
                        escolaPais: document.getElementById('escala-escola-pais').value,
                        evangelizadores: [document.getElementById('escala-evangelizador1').value, document.getElementById('escala-evangelizador2').value]
                    },
                    ultimaEdicaoEm: serverTimestamp(),
                    editadoPor: user.uid
                };

                try {
                    await setDoc(doc(db, "escalaCaritas", idDocumento), escala, { merge: true });
                    alert("Escala de " + mesTexto + " gravada com sucesso!");
                    btn.disabled = false;
                    btn.textContent = "Gravar Escala Mensal";
                } catch (error) {
                    alert("Erro ao salvar: " + error.message);
                    btn.disabled = false;
                    btn.textContent = "Gravar Escala Mensal";
                }
            };
        }

        function popularMeses(select) {
            const mesesExtenso = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            const hoje = new Date();
            let mes = hoje.getMonth();
            let ano = hoje.getFullYear();
            for (let i = 0; i < 12; i++) {
                const opt = document.createElement('option');
                opt.value = `${mes}|${ano}`;
                opt.textContent = `${mesesExtenso[mes]} / ${ano}`;
                select.appendChild(opt);
                mes++;
                if (mes > 11) { mes = 0; ano++; }
            }
        }

        function calcularTerceiroDomingo(mes, ano) {
            let d = new Date(ano, mes, 1);
            let count = 0;
            while (count < 3) {
                if (d.getDay() === 0) count++;
                if (count < 3) d.setDate(d.getDate() + 1);
            }
            return d;
        }

        async function carregarVoluntarios() {
            const selects = document.querySelectorAll('.select-voluntario');
            try {
                const q = query(collection(db, "voluntarios"), where("statusVoluntario", "==", "ativo"), orderBy("nome"));
                const snap = await getDocs(q);
                let options = '<option value="">Selecione...</option>';
                snap.forEach(doc => { options += `<option value="${doc.data().nome}">${doc.data().nome}</option>`; });
                selects.forEach(s => s.innerHTML = options);
            } catch (err) { console.error("Erro voluntários:", err); }
        }
    </script>
</body>
</html>