<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV Cantina - Amor e Luz</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f6f9; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; box-sizing: border-box; }
        .nav-voltar { max-width: 1200px; width:100%; margin: 0 auto 30px auto; text-align: left; }
        .btn-voltar { background-color: #e9ecef; color: #495057; border: 1px solid #dee2e6; padding: 10px 20px; border-radius: 8px; font-weight: bold; font-size: 1em; text-decoration: none; }
        .container { background-color: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); width: 100%; max-width: 1200px; margin-bottom: 30px; }
        h1, h2 { text-align: center; color: #333; margin: 0; }
        
        /* O seletor de evento foi removido */
        
        .pdv-container { 
            display: grid; /* Alterado de 'none' para 'grid' */
            grid-template-columns: 2fr 1fr; 
            gap: 30px; 
        }
        
        /* Ocultar o PDV até que o JS o mostre, para evitar layout quebrado */
        #pdv-container.hidden {
            display: none;
        }

        .menu-categorias { display: flex; flex-direction: column; gap: 20px; }
        .categoria-bloco h3 { background-color: #34495e; color: white; padding: 10px; margin: 0 0 10px 0; border-radius: 6px; }
        .itens-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
        .item-btn { padding: 15px; font-size: 1em; border: 1px solid #ddd; border-radius: 6px; background-color: #f8f9fa; cursor: pointer; text-align: left; line-height: 1.4; }
        .item-btn strong { display: block; }
        .item-btn small { color: #28a745; font-weight: bold; }
        .carrinho-container { background-color: #f8f9fa; padding: 20px; border-radius: 8px; display: flex; flex-direction: column; }
        #lista-carrinho { list-style-type: none; padding: 0; flex-grow: 1; }
        .carrinho-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #ddd; }
        .carrinho-item button { background: #dc3545; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; }
        .total-container { margin-top: 20px; text-align: right; font-size: 1.5em; font-weight: bold; }
        .botoes-finalizar { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .btn-finalizar { width: 100%; padding: 15px; font-size: 1.1em; color: white; border: none; border-radius: 8px; cursor: pointer; }
        #btn-finalizar-vista { background-color: #28a745; }
        #btn-finalizar-prazo { background-color: #ffc107; color: #333; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; }
        .modal-content p, .modal-content label { margin-bottom: 10px; display: block; }
        .modal-content input, .modal-content select { width: 100%; font-size: 1.1em; padding: 8px; box-sizing: border-box; }
        .modal-content input { margin-top: 10px; }
        .painel-totais { border: 2px solid #28a745; padding: 15px; border-radius: 8px; margin-bottom: 20px; background-color: #e8f5e9; }
        .painel-totais p { margin: 5px 0; font-size: 1.1em; font-weight: 500; display: flex; justify-content: space-between; }
        .painel-totais strong { color: #1b5e20; }
    </style>
</head>
<body>
    <nav class="nav-voltar">
        <a href="/dashboard.html" class="btn-voltar">⬅ Voltar para o Dashboard</a>
    </nav>
    <div id="acesso-negado" style="display: none;"><h1>Acesso Negado</h1></div>

    <div id="main-content" class="container" style="display: none;">
        <h1>PDV Cantina "Amor e Luz"</h1>
        
        <div id="pdv-container" class="pdv-container hidden"> <div id="menu-categorias" class="menu-categorias"></div>
            <div class="carrinho-container">
                <div id="painel-totais"></div>
                <h2>Carrinho</h2>
                <ul id="lista-carrinho"></ul>
                <div id="total-container" class="total-container">Total: R$ 0,00</div>
                <div class="botoes-finalizar">
                    <button id="btn-finalizar-vista" class="btn-finalizar">Receber e Finalizar</button>
                    <button id="btn-finalizar-prazo" class="btn-finalizar">Registrar Pendência</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-pendencia" class="modal-overlay">
        <div class="modal-content">
            <h2>Registrar Pendência</h2>
            <p>Selecione um voluntário da lista:</p>
            <select id="seletor-voluntario"></select>
            <hr style="margin: 20px 0;">
            <label for="nome-externo">Ou digite o nome do comprador:</label>
            <input type="text" id="nome-externo" placeholder="Nome do visitante...">
            <div style="text-align: right; margin-top: 20px;">
                <button type="button" id="btn-cancelar-pendencia" class="btn-secondary">Cancelar</button>
                <button id="btn-confirmar-pendencia" class="btn-primary">Confirmar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp, getApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, where, orderBy, Timestamp, getDocs } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-functions.js";
        import { protegerPagina } from '/auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU",
            authDomain: "voluntarios-ativos---cepat.firebaseapp.com",
            projectId: "voluntarios-ativos---cepat",
            storageBucket: "voluntarios-ativos---cepat.firebasestorage.app",
            messagingSenderId: "66122858261",
            appId: "1:66122858261:web:7fa21f1805463b5c08331c"
        };
        initializeApp(firebaseConfig);

        protegerPagina(['super-admin', 'diretor', 'tesoureiro', 'conselheiro', 'produtor-evento'])
            .then(user => {
                document.getElementById('main-content').style.display = 'block';
                inicializarPagina(user);
                const registrarLogDeAcesso = httpsCallable(getFunctions(getApp(), 'southamerica-east1'), 'registrarLogDeAcesso');
                registrarLogDeAcesso({ acao: 'ACESSOU_PDV_CANTINA' });
            });

        function inicializarPagina(user) {
            const db = getFirestore();
            const functions = getFunctions(undefined, 'southamerica-east1');
            const registrarVendaCantina = httpsCallable(functions, 'registrarVendaCantina');

            // O seletor de evento foi removido
            const pdvContainer = document.getElementById('pdv-container');
            const menuCategorias = document.getElementById('menu-categorias');
            const listaCarrinho = document.getElementById('lista-carrinho');
            const totalContainer = document.getElementById('total-container');
            const painelTotais = document.getElementById('painel-totais');
            const btnFinalizarVista = document.getElementById('btn-finalizar-vista');
            const btnFinalizarPrazo = document.getElementById('btn-finalizar-prazo');
            const modalPendencia = document.getElementById('modal-pendencia');
            const seletorVoluntario = document.getElementById('seletor-voluntario');
            const nomeExternoInput = document.getElementById('nome-externo');
            const btnConfirmarPendencia = document.getElementById('btn-confirmar-pendencia');
            const btnCancelarPendencia = document.getElementById('btn-cancelar-pendencia');
            
            let carrinho = [];
            let cardapioDoDia = []; // Renomeado de 'cardapioDoEvento'
            let unsubTotais = null;

            // Lógica de carregar eventos e iniciar PDV removida
            
            // Carrega voluntários para o modal de pendência
            onSnapshot(query(collection(db, "voluntarios"), orderBy("nome")), (snapshot) => {
                seletorVoluntario.innerHTML = '<option value="">Selecione o voluntário</option>';
                snapshot.forEach(doc => {
                    seletorVoluntario.innerHTML += `<option value="${doc.id}" data-nome="${doc.data().nome}">${doc.data().nome}</option>`;
                });
            });
            
            // Carrega o menu do dia imediatamente
            const qItens = query(
                collection(db, "cantina_itens"), 
                where("disponivelHoje", "==", true),
                orderBy("categoria")
            );
            onSnapshot(qItens, (snapshot) => {
                cardapioDoDia = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                renderizarMenu();
            });

            // Mostra o PDV
            pdvContainer.classList.remove('hidden');
            
            // Escuta os totais do DIA ATUAL
            escutarTotaisDoDia();

            function renderizarMenu() {
                menuCategorias.innerHTML = '';
                const porCategoria = cardapioDoDia.reduce((acc, item) => {
                    if (!acc[item.categoria]) acc[item.categoria] = [];
                    acc[item.categoria].push(item);
                    return acc;
                }, {});
                Object.keys(porCategoria).sort().forEach(categoria => {
                    const bloco = document.createElement('div');
                    bloco.className = 'categoria-bloco';
                    bloco.innerHTML = `<h3>${categoria}</h3>`;
                    const grid = document.createElement('div');
                    grid.className = 'itens-grid';
                    
                    // Ordena por nome dentro da categoria
                    porCategoria[categoria].sort((a,b) => a.nome.localeCompare(b.nome)).forEach(item => {
                        const btn = document.createElement('button');
                        btn.className = 'item-btn';
                        btn.dataset.id = item.id;
                        btn.innerHTML = `<strong>${item.nome}</strong><small>${Number(item.preco).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</small>`;
                        btn.onclick = () => adicionarAoCarrinho(item);
                        grid.appendChild(btn);
                    });
                    bloco.appendChild(grid);
                    menuCategorias.appendChild(bloco);
                });
            }

            function adicionarAoCarrinho(item) {
                const itemExistente = carrinho.find(i => i.id === item.id);
                if (itemExistente) {
                    itemExistente.qtd++;
                } else {
                    carrinho.push({ ...item, qtd: 1 });
                }
                renderizarCarrinho();
            }
            
            function removerDoCarrinho(itemId) {
                const itemIndex = carrinho.findIndex(i => i.id === itemId);
                if (itemIndex > -1) {
                    carrinho[itemIndex].qtd--;
                    if (carrinho[itemIndex].qtd === 0) {
                        carrinho.splice(itemIndex, 1);
                    }
                }
                renderizarCarrinho();
            }

            function renderizarCarrinho() {
                listaCarrinho.innerHTML = '';
                let total = 0;
                carrinho.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'carrinho-item';
                    li.innerHTML = `
                        <span>${item.qtd}x ${item.nome}</span>
                        <span>${Number(item.preco * item.qtd).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>
                        <button data-id="${item.id}">-</button>
                    `;
                    li.querySelector('button').onclick = () => removerDoCarrinho(item.id);
                    listaCarrinho.appendChild(li);
                    total += item.preco * item.qtd;
                });
                totalContainer.textContent = `Total: ${total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`;
            }

            async function finalizarVenda(tipoVenda, comprador = null) {
                if (carrinho.length === 0) return alert('O carrinho está vazio.');
                const totalVenda = carrinho.reduce((acc, item) => acc + (item.preco * item.qtd), 0);
                
                // MUDANÇA CRÍTICA: eventoId e eventoTitulo foram removidos
                const dadosVenda = {
                    total: totalVenda,
                    itens: carrinho.map(i => ({itemId: i.id, nome: i.nome, qtd: i.qtd, precoUnitario: i.preco})),
                    tipoVenda: tipoVenda,
                    comprador: comprador
                };

                try {
                    await registrarVendaCantina(dadosVenda);
                    alert('Venda registrada com sucesso!');
                    carrinho = [];
                    renderizarCarrinho();
                    if(modalPendencia.style.display === 'flex') {
                        modalPendencia.style.display = 'none';
                        seletorVoluntario.value = '';
                        nomeExternoInput.value = '';
                    }
                } catch(error) {
                    console.error("Erro ao registrar venda: ", error);
                    alert(`Erro ao registrar venda: ${error.message}`);
                }
            }

            btnFinalizarVista.addEventListener('click', () => finalizarVenda('vista'));

            btnFinalizarPrazo.addEventListener('click', () => {
                if (carrinho.length === 0) return alert('O carrinho está vazio.');
                modalPendencia.style.display = 'flex';
            });

            btnCancelarPendencia.addEventListener('click', () => {
                modalPendencia.style.display = 'none';
                seletorVoluntario.value = '';
                nomeExternoInput.value = '';
            });

            btnConfirmarPendencia.addEventListener('click', () => {
                const voluntarioId = seletorVoluntario.value;
                const nomeExterno = nomeExternoInput.value.trim();

                if (!voluntarioId && !nomeExterno) {
                    return alert('Por favor, selecione um voluntário ou digite um nome.');
                }
                
                let dadosComprador = {};
                if (voluntarioId) {
                    const voluntarioNome = seletorVoluntario.options[seletorVoluntario.selectedIndex].dataset.nome;
                    dadosComprador = { id: voluntarioId, nome: voluntarioNome, tipo: 'voluntario' };
                } else {
                    dadosComprador = { id: null, nome: nomeExterno, tipo: 'externo' };
                }
                
                finalizarVenda('prazo', dadosComprador);
            });

            // Função renomeada e lógica de query alterada
            function escutarTotaisDoDia() {
                if (unsubTotais) unsubTotais(); 

                // Garante que o período de 24h seja no fuso local (São Paulo)
                const hojeInicio = new Date();
                hojeInicio.setHours(0, 0, 0, 0);
                const hojeFim = new Date();
                hojeFim.setHours(23, 59, 59, 999);

                // Converte para Timestamps do Firestore para a query
                const inicioTimestamp = Timestamp.fromDate(hojeInicio);
                const fimTimestamp = Timestamp.fromDate(hojeFim);

                const qVista = query(
                    collection(db, "cantina_vendas_avista"), 
                    where("registradoEm", ">=", inicioTimestamp),
                    where("registradoEm", "<=", fimTimestamp)
                );
                const qPrazo = query(
                    collection(db, "contas_a_receber"), 
                    where("registradoEm", ">=", inicioTimestamp),
                    where("registradoEm", "<=", fimTimestamp)
                );

                const unsubVista = onSnapshot(qVista, () => atualizarPainel());
                const unsubPrazo = onSnapshot(qPrazo, () => atualizarPainel());
                
                unsubTotais = () => { unsubVista(); unsubPrazo(); };

                async function atualizarPainel() {
                    const [snapshotVista, snapshotPrazo] = await Promise.all([getDocs(qVista), getDocs(qPrazo)]);
                    
                    let totalVista = 0;
                    snapshotVista.forEach(doc => totalVista += doc.data().total);

                    let totalPrazo = 0;
                    snapshotPrazo.forEach(doc => totalPrazo += doc.data().total);

                    const totalGeral = totalVista + totalPrazo;

                    painelTotais.innerHTML = `
                        <div class="painel-totais">
                            <p>Recebido (à vista): <strong>${totalVista.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</strong></p>
                            <p>Pendências (a receber): <strong>${totalPrazo.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</strong></p>
                            <hr>
                            <p>Total Geral do Dia: <strong>${totalGeral.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</strong></p>
                        </div>
                    `;
                }
                atualizarPainel();
            }
        }
    </script>
</body>
</html>