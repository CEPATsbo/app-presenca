<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Gerenciar Biblioteca</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f6f9; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; box-sizing: border-box; }
        .nav-voltar { max-width: 1000px; width:100%; margin: 0 auto 30px auto; text-align: left; }
        .btn-voltar { background-color: #e9ecef; color: #495057; border: 1px solid #dee2e6; padding: 10px 20px; border-radius: 8px; font-weight: bold; font-size: 1em; text-decoration: none; }
        .container { background-color: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); width: 100%; max-width: 1000px; margin-bottom: 30px; }
        h1, h2 { text-align: center; color: #333; margin-top: 0; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .form-item { display: flex; flex-direction: column; }
        .form-item label { margin-bottom: 5px; font-weight: bold; color: #555; }
        .form-item input, .form-item select { padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 1em; }
        .radio-group { display: flex; gap: 20px; align-items: center; }
        .form-actions { grid-column: 1 / -1; display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn { padding: 12px 25px; border: none; border-radius: 6px; font-size: 1em; font-weight: bold; cursor: pointer; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .header-acervo { display: flex; justify-content: space-between; align-items: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px 15px; border-bottom: 1px solid #eee; text-align: left; }
        th { background-color: #f8f9fa; }
        .actions-table button { margin-right: 5px; padding: 5px 10px; border-radius: 4px; cursor: pointer; border: 1px solid #ccc; }
        .btn-edit { background-color: #ffc107; color: #333; }
        .btn-delete { background-color: #dc3545; color: white; }
        .estoque-zerado { color: #dc3545; font-weight: bold; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 700px; }
        .modal-content h2 { margin-top: 0; }
        .isbn-wrapper { position: relative; }
        .spinner {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: none;
        }
        @keyframes spin { 0% { transform: translateY(-50%) rotate(0deg); } 100% { transform: translateY(-50%) rotate(360deg); } }
    .btn-estornar {
        background-color: #dc3545;
        color: white;
        border: none;

    }
    .btn-estornar:disabled {
        background-color: #aaa;
    }
    #relatorio-interativo-container {
        border: 1px solid #ddd;
        background-color: #f9f9f9;
        border-radius: 4px;
    }
    #relatorio-interativo-container table {
        margin-top: 0;
    }
    #relatorio-interativo-container th {
        background-color: #f0f0f0;
    }
    #relatorio-interativo-container td {
        vertical-align: middle;
        }
        #relatorio-interativo-container .btn-estornar {
            padding: 6px 10px;
            font-size: 0.9em;
        }
        /* ================================================= */
/* === INÍCIO: NOVO CSS PARA CORRIGIR O MODAL === */
/* SUBSTITUA TODAS AS REGRAS ANTERIORES DO MODAL */
/* (como .modal-form-layout) POR ISTO:             */
/* ================================================= */

/* Garante que o H2 (título) tenha um bom espaçamento */
#modal-relatorio .modal-content h2 {
    text-align: center;
    margin-top: 0;
    margin-bottom: 25px; /* Adiciona um espaço abaixo do título */
}

/* Este é o container dos seletores de Mês/Ano */
.modal-form-layout {
    display: grid;
    grid-template-columns: 1fr 1fr; /* Duas colunas iguais */
    gap: 20px; /* Espaço entre as colunas */
}

/*
 * ESTA É A MUDANÇA PRINCIPAL.
 * Anula o CSS global e força o rótulo e o seletor
 * a ficarem LADO A LADO.
*/
.modal-form-layout .form-item {
    display: flex;
    flex-direction: row;  /* Rótulo e seletor na mesma linha */
    align-items: center; /* Alinha eles verticalmente */
    gap: 10px;           /* Espaço entre o rótulo e o seletor */
}

/* * Ajuste para o RÓTULO (Mês, Ano)
*/
.modal-form-layout .form-item label {
    flex-shrink: 0;   /* Impede que o rótulo "achate" */
    margin-bottom: 0; /* Remove a margem inferior do layout antigo */
}

/*
 * Ajuste para o SELETOR (Dropdown)
*/
.modal-form-layout .form-item select {
    width: 100%; /* Faz o seletor ocupar o resto do espaço */
}

/* Container dos botões, alinhados à direita */
.modal-actions {
    display: flex;
    justify-content: flex-end; /* Alinha botões à direita */
    gap: 10px; /* Espaço entre os botões */
    margin-top: 30px; /* Mais espaço acima dos botões */
    margin-bottom: 20px; /* Espaço ABAIXO (para o <hr> e a tabela) */
}

/* === FIM: NOVO CSS PARA CORRIGIR O MODAL === */
    </style>
</head>
<body>
    <nav class="nav-voltar">
        <a href="/dashboard.html" class="btn-voltar">⬅ Voltar para o Dashboard</a>
    </nav>
    <div id="acesso-negado" style="display: none;"><h1>Acesso Negado</h1></div>

    <div id="main-content" class="container" style="display: none;">
        <h1>Gerenciar Acervo da Biblioteca</h1>

        <form id="form-livro">
            <input type="hidden" id="livroId">
            <div class="form-grid">
                <div class="form-item isbn-wrapper" style="grid-column: 1 / -1;">
                    <label for="isbn">ISBN (Escaneie o Código de Barras)</label>
                    <input type="text" id="isbn">
                    <div class="spinner" id="isbn-spinner"></div>
                </div>
                <div class="form-item" style="grid-column: 1 / -1;"><label for="titulo">Título do Livro</label><input type="text" id="titulo" required></div>
                <div class="form-item"><label for="autor">Autor(a)</label><input type="text" id="autor" required></div>
                <div class="form-item"><label for="editora">Editora</label><input type="text" id="editora"></div>
                <div class="form-item"><label for="anoPublicacao">Ano</label><input type="text" id="anoPublicacao"></div>
                <div class="form-item"><label for="categoria">Categoria</label><select id="categoria"><option value="Doutrinário">Doutrinário</option><option value="Romance">Romance</option><option value="Biografia">Biografia</option><option value="Infantil">Infantil</option><option value="Outros">Outros</option></select></div>
                <div class="form-item">
                    <label>Finalidade</label>
                    <div class="radio-group">
                        <label><input type="radio" name="finalidade" value="Empréstimo" checked> Para Empréstimo</label>
                        <label><input type="radio" name="finalidade" value="Venda"> Para Venda</label>
                    </div>
                </div>
                <div class="form-item" id="campo-preco" style="display: none;">
                    <label for="preco">Preço de Venda (R$)</label>
                    <input type="number" id="preco" step="0.01">
                </div>
                <div class="form-item">
                    <label for="quantidade">Quantidade em Estoque</label>
                    <input type="number" id="quantidade" value="1" min="0" required>
                </div>
            </div>
            <div class="form-actions">
                <button type="button" id="btn-cancelar" class="btn btn-secondary" style="display: none;">Cancelar</button>
                <button type="submit" class="btn btn-primary">Salvar Livro</button>
            </div>
        </form>

        <hr style="margin: 40px 0;">

        <div class="header-acervo">
            <h2>Acervo Cadastrado</h2>
            <button id="btn-relatorio" class="btn btn-secondary">Gerar Relatório</button>
        </div>
        <table id="tabela-livros">
            <thead>
                <tr>
                    <th>Título / Autor</th>
                    <th>Finalidade</th>
                    <th>Status / Preço</th>
                    <th>Estoque</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="modal-relatorio" class="modal-overlay">
        <div class="modal-content">
            <h2>Gerar Relatório da Biblioteca</h2>
            <div class="modal-form-layout">
                <div class="form-item">
                    <label for="relatorio-mes">Mês</label>
                    <select id="relatorio-mes"></select>
                </div>
                <div class="form-item">
                    <label for="relatorio-ano">Ano</label>
                    <select id="relatorio-ano"></select>
                </div>
            </div>
            <div class="modal-actions">
                                <button type="button" id="btn-cancelar-relatorio" class="btn btn-secondary">Cancelar</button>
                <button id="btn-confirmar-relatorio" class="btn btn-primary">Gerar</button>
            </div>

                        <hr id="divisor-relatorio" style="display:none; margin: 20px 0; border: 0; border-top: 1px solid #eee;">
            <div id="relatorio-interativo-container" style="max-height: 40vh; overflow-y: auto;">
                            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, setDoc, getDoc, deleteDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-functions.js";
        import { protegerPagina } from '/auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU",
            authDomain: "voluntarios-ativos---cepat.firebaseapp.com",
            projectId: "voluntarios-ativos---cepat",
            storageBucket: "voluntarios-ativos---cepat.firebasestorage.app",
            messagingSenderId: "66122858261",
            appId: "1:66122858261:web:7fa21f1805463b5c08331c"
        };
        initializeApp(firebaseConfig);

        protegerPagina(['super-admin', 'tesoureiro', 'diretor', 'conselheiro', 'bibliotecario'])
            .then(user => {
                document.getElementById('main-content').style.display = 'block';
                inicializarPagina(user);
            })
            .catch(error => {
                document.getElementById('acesso-negado').style.display = 'block';
            });
        
        function inicializarPagina(user) {
            const db = getFirestore();
            const functions = getFunctions(undefined, 'southamerica-east1');
            const registrarLogDeAcesso = httpsCallable(functions, 'registrarLogDeAcesso');
            const gerarRelatorioBiblioteca = httpsCallable(functions, 'gerarRelatorioBiblioteca');
            const buscarDadosLivroPorISBN = httpsCallable(functions, 'buscarDadosLivroPorISBN');
            const estornarVendaBiblioteca = httpsCallable(functions, 'estornarVendaBiblioteca');
            const form = document.getElementById('form-livro');
            const tabelaLivros = document.getElementById('tabela-livros').querySelector('tbody');
            const campoPreco = document.getElementById('campo-preco');
            const radiosFinalidade = document.querySelectorAll('input[name="finalidade"]');
            const modalRelatorio = document.getElementById('modal-relatorio');
            const btnRelatorio = document.getElementById('btn-relatorio');
            const btnCancelarRelatorio = document.getElementById('btn-cancelar-relatorio');
            const btnConfirmarRelatorio = document.getElementById('btn-confirmar-relatorio');
            const seletorMes = document.getElementById('relatorio-mes');
            const seletorAno = document.getElementById('relatorio-ano');
            const inputIsbn = document.getElementById('isbn');
            const isbnSpinner = document.getElementById('isbn-spinner');

            // AJUSTE: Focar no campo ISBN ao carregar a página
            inputIsbn.focus();

            inputIsbn.addEventListener('change', async (e) => {
                const isbnValue = e.target.value.replace(/[^0-9X]/gi, '').trim();

                if (isbnValue.length >= 10) {
                    isbnSpinner.style.display = 'block';
                    try {
                        const result = await buscarDadosLivroPorISBN({ isbn: isbnValue });
                        const data = result.data;
                        document.getElementById('titulo').value = data.titulo || '';
                        document.getElementById('autor').value = data.autor || '';
                        document.getElementById('editora').value = data.editora || '';
                        document.getElementById('anoPublicacao').value = data.anoPublicacao || '';
                        alert('Dados do livro preenchidos automaticamente!');
                    } catch (error) {
                        console.error("Erro ao buscar dados do ISBN:", error);
                        alert(`Não foi possível encontrar dados para o ISBN ${isbnValue}. Por favor, preencha manualmente.`);
                    } finally {
                        isbnSpinner.style.display = 'none';
                    }
                }
            });

            radiosFinalidade.forEach(radio => {
                radio.addEventListener('change', () => {
                    const paraVenda = document.querySelector('input[name="finalidade"]:checked').value === 'Venda';
                    campoPreco.style.display = paraVenda ? 'flex' : 'none';
                    document.getElementById('preco').required = paraVenda;
                });
            });

            const qLivros = query(collection(db, "biblioteca_livros"), orderBy("titulo"));
            onSnapshot(qLivros, (snapshot) => {
                tabelaLivros.innerHTML = '';
                snapshot.forEach(doc => {
                    const livro = doc.data();
                    const tr = document.createElement('tr');
                    let statusPreco = '';
                    if (livro.finalidade === 'Venda') {
                        statusPreco = Number(livro.preco || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                    } else {
                       statusPreco = (livro.quantidade > 0) ? `<span style="color:green; font-weight:bold;">Disponível</span>` : `<span style="color:red; font-weight:bold;">Emprestado</span>`;
                    }
                    const estoqueClasse = (livro.quantidade === 0) ? 'estoque-zerado' : '';
                    tr.innerHTML = `
                        <td><strong>${livro.titulo}</strong><br><small>${livro.autor}</small></td>
                        <td>${livro.finalidade}</td>
                        <td>${statusPreco}</td>
                        <td class="${estoqueClasse}">${livro.quantidade}</td>
                        <td class="actions-table">
                            <button class="btn-edit" data-id="${doc.id}">Editar</button>
                            <button class="btn-delete" data-id="${doc.id}">Apagar</button>
                        </td>
                    `;
                    tabelaLivros.appendChild(tr);
                });
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const finalidade = document.querySelector('input[name="finalidade"]:checked').value;
                const livro = {
                    titulo: document.getElementById('titulo').value,
                    autor: document.getElementById('autor').value,
                    editora: document.getElementById('editora').value,
                    isbn: document.getElementById('isbn').value.replace(/[^0-9X]/gi, '').trim(),
                    anoPublicacao: document.getElementById('anoPublicacao').value,
                    categoria: document.getElementById('categoria').value,
                    finalidade: finalidade,
                    preco: finalidade === 'Venda' ? parseFloat(document.getElementById('preco').value) || 0 : null,
                    quantidade: parseInt(document.getElementById('quantidade').value) || 0,
                };
                const id = document.getElementById('livroId').value;

                if (id) {
                    await setDoc(doc(db, 'biblioteca_livros', id), livro, { merge: true });
                    registrarLogDeAcesso({ acao: 'EDITOU_LIVRO_BIBLIOTECA', detalhes: { livroId: id, titulo: livro.titulo } });
                    alert('Livro atualizado com sucesso!');
                } else {
                    livro.criadoEm = serverTimestamp();
                    const docRef = await addDoc(collection(db, 'biblioteca_livros'), livro);
                    registrarLogDeAcesso({ acao: 'CRIOU_LIVRO_BIBLIOTECA', detalhes: { livroId: docRef.id, titulo: livro.titulo } });
                    alert('Livro salvo com sucesso!');
                }
                form.reset();
                campoPreco.style.display = 'none';
                document.getElementById('livroId').value = '';
                document.getElementById('btn-cancelar').style.display = 'none';
                
                // AJUSTE: Retornar o foco para o campo ISBN após salvar
                inputIsbn.focus();
            });

            tabelaLivros.addEventListener('click', async (e) => {
                const target = e.target;
                const id = target.dataset.id;
                if (!id) return;

                if (target.classList.contains('btn-edit')) {
                    const docRef = doc(db, 'biblioteca_livros', id);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        document.getElementById('livroId').value = id;
                        document.getElementById('titulo').value = data.titulo;
                        document.getElementById('autor').value = data.autor;
                        document.getElementById('editora').value = data.editora || '';
                        document.getElementById('isbn').value = data.isbn || '';
                        document.getElementById('anoPublicacao').value = data.anoPublicacao || '';
                        document.getElementById('categoria').value = data.categoria;
                        document.getElementById('quantidade').value = data.quantidade || 0;
                        document.querySelector(`input[name="finalidade"][value="${data.finalidade}"]`).checked = true;
                        
                        const paraVenda = data.finalidade === 'Venda';
                        campoPreco.style.display = paraVenda ? 'flex' : 'none';
                        document.getElementById('preco').required = paraVenda;
                        if (paraVenda) {
                            document.getElementById('preco').value = data.preco;
                        }
                        
                        document.getElementById('btn-cancelar').style.display = 'inline-block';
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                        // AJUSTE: Focar no campo ISBN ao editar
                        inputIsbn.focus();
                    }
                } else if (target.classList.contains('btn-delete')) {
                    if (confirm('Tem certeza que deseja apagar este livro do acervo?')) {
                        const docRef = doc(db, 'biblioteca_livros', id);
                        const docSnap = await getDoc(docRef);
                        const tituloLivro = docSnap.exists() ? docSnap.data().titulo : 'Livro Desconhecido';
                        
                        await deleteDoc(docRef);
                        registrarLogDeAcesso({ acao: 'APAGOU_LIVRO_BIBLIOTECA', detalhes: { livroId: id, titulo: tituloLivro } });
                    }
                }
            });

            document.getElementById('btn-cancelar').addEventListener('click', () => {
                form.reset();
                campoPreco.style.display = 'none';
                document.getElementById('livroId').value = '';
                document.getElementById('btn-cancelar').style.display = 'none';
                // AJUSTE: Focar no campo ISBN ao cancelar
                inputIsbn.focus();
            });
            
             btnRelatorio.addEventListener('click', () => { 
                preencherFiltrosRelatorio(); 
                modalRelatorio.style.display = 'flex'; 
             }); 

             btnCancelarRelatorio.addEventListener('click', () => { 
                modalRelatorio.style.display = 'none';
                document.getElementById('relatorio-interativo-container').innerHTML = '';
                document.getElementById('divisor-relatorio').style.display = 'none'; 
             }); 

             btnConfirmarRelatorio.addEventListener('click', async () => { 
                const mes = seletorMes.value; 
                const ano = seletorAno.value; 
                btnConfirmarRelatorio.disabled = true; 
                btnConfirmarRelatorio.textContent = 'Gerando...'; 

                // Limpa o relatório anterior
                document.getElementById('relatorio-interativo-container').innerHTML = '';
                document.getElementById('divisor-relatorio').style.display = 'none';

                try { 
                    const resultado = await gerarRelatorioBiblioteca({ mes: parseInt(mes), ano: parseInt(ano) }); 
                    // 1. Renderiza o relatório interativo na tela
                    renderizarRelatorioInterativo(resultado.data);
                    // 2. Gera o PDF como antes
                    gerarPDF(resultado.data, mes, ano);
                } catch (error) { 
                    console.error("Erro ao gerar relatório:", error); 
                    alert("Não foi possível gerar o relatório. Verifique o console."); 
                } finally { 
                    btnConfirmarRelatorio.disabled = false;
                    btnConfirmarRelatorio.textContent = 'Gerar'; 
                } 
             }); 
             
             function preencherFiltrosRelatorio() { 
                const meses = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"]; 
                seletorMes.innerHTML = meses.map((nome, index) => `<option value="${index + 1}">${nome}</option>`).join(''); 
                
                const anoAtual = new Date().getFullYear(); 
                seletorAno.innerHTML = ''; 
                for (let i = anoAtual; i >= anoAtual - 5; i--) { 
                    seletorAno.innerHTML += `<option value="${i}">${i}</option>`; 
                } 

                seletorMes.value = new Date().getMonth() + 1; 
                seletorAno.value = anoAtual; 
             } 

             function gerarPDF(dados, mes, ano) { 
                const { jsPDF } = window.jspdf; 
                const doc = new jsPDF(); 
                const meses = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"]; 
                const mesNome = meses[mes - 1]; 

                doc.setFontSize(18); 
                doc.text(`Relatório da Biblioteca - ${mesNome} de ${ano}`, 14, 22); 

                doc.setFontSize(14); 
                doc.text("Resumo de Vendas", 14, 35); 
                const corpoVendas = dados.vendas.map(v => { 
                    const dataVenda = new Date(v.registradoEm).toLocaleDateString('pt-BR'); 
                    const statusVenda = v.tipoVenda === 'prazo' ? `${v.status.charAt(0).toUpperCase() + v.status.slice(1)}` : 'Recebido'; 
                    return [ 
                        dataVenda, 
                        v.compradorNome || 'Venda à vista', 
                        v.itens.map(i => `${i.qtd}x ${i.titulo}`).join('\n'), 
                        statusVenda, 
                        Number(v.total).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) 
                    ]; 
                }); 
                doc.autoTable({ 
                    startY: 40, 
                    head: [['Data', 'Comprador', 'Itens', 'Status', 'Total']], 
                    body: corpoVendas, 
                }); 

                const finalYVendas = doc.lastAutoTable.finalY || 40; 
                doc.setFontSize(14); 
                doc.text("Resumo de Empréstimos e Devoluções", 14, finalYVendas + 15); 
                const corpoEmprestimos = dados.emprestimos.map(e => { 
                    const dataEmprestimo = new Date(e.dataEmprestimo).toLocaleDateString('pt-BR'); 
                    const dataDevolucao = e.dataDevolucao ? new Date(e.dataDevolucao).toLocaleDateString('pt-BR') : 'Emprestado'; 
                    return [ 
                        dataEmprestimo, 
                        e.livroTitulo, 
                        e.leitor.nome, 
                        dataDevolucao 
                    ]; 
                }); 
                doc.autoTable({ 
                    startY: finalYVendas + 20, 
                    head: [['Data Empréstimo', 'Livro', 'Leitor', 'Status / Data Devolução']], 
                    body: corpoEmprestimos, 
                }); 

                doc.save(`relatorio_biblioteca_${mes}_${ano}.pdf`); 
             } 
             function renderizarRelatorioInterativo(dados) {
                const container = document.getElementById('relatorio-interativo-container');
                const divisor = document.getElementById('divisor-relatorio');
                container.innerHTML = ''; 
                
                if (!dados.vendas || dados.vendas.length === 0) {
                    container.innerHTML = '<p style="text-align:center;">Nenhuma venda encontrada para este período.</p>';
                    divisor.style.display = 'block';
                    return;
                }

                const tabela = document.createElement('table');
                tabela.innerHTML = `
                    <thead>
                        <tr>
                            <th>Data/Comprador</th>
                            <th>Itens</th>
                            <th>Total</th>
                            <th style="width: 80px;">Ação</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                `;
                
                const tbody = tabela.querySelector('tbody');
                dados.vendas.sort((a, b) => new Date(b.registradoEm) - new Date(a.registradoEm));
                
                dados.vendas.forEach(v => {
                    const tr = document.createElement('tr');
                    const dataVenda = new Date(v.registradoEm).toLocaleString('pt-BR', {day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'});
                    const itensStr = v.itens.map(i => `${i.qtd}x ${i.titulo}`).join('<br>');
                    const totalStr = Number(v.total).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                    
                    tr.innerHTML = `
                        <td>
                            <strong>${dataVenda}</strong>
                            <br><small>${v.compradorNome || 'Venda à vista'}</small>
                        </td>
                        <td><small>${itensStr}</small></td>
                        <td><strong>${totalStr}</strong></td>
                        <td>
                            <button class="btn-delete btn-estornar" data-id="${v.id}" data-tipo="${v.tipoVenda}" title="Estornar esta venda">
                                Estornar
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

                container.appendChild(tabela);
                divisor.style.display = 'block';
             }

             document.getElementById('relatorio-interativo-container').addEventListener('click', async (e) => {
                if (!e.target.classList.contains('btn-estornar')) return;

                const btn = e.target;
                const vendaId = btn.dataset.id;
                const tipoVenda = btn.dataset.tipo;

                if (!confirm('Tem certeza que deseja ESTORNAR esta venda?\n\nO ESTOQUE será devolvido e o REGISTRO FINANCEIRO será APAGADO.\n\nEsta ação NÃO pode ser desfeita.')) {
                    return;
                }

                btn.disabled = true;
                btn.textContent = '...';

                try {
                    await estornarVendaBiblioteca({ vendaId, tipoVenda });
                    alert('Venda estornada com sucesso!');
                    
                    btn.closest('tr').remove();
                    
                } catch (error) {
                    console.error("Erro ao estornar:", error);
                    alert(`Falha ao estornar: ${error.message}`);
                    btn.disabled = false;
                    btn.textContent = 'Estornar';
                }
             });

    }
    </script>
</body>
</html>