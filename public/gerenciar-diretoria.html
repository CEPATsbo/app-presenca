<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Gerenciar Gestão</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f6f9; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .nav-voltar { max-width: 900px; width:100%; margin: 0 auto 30px auto; text-align: left; }
        .btn-voltar { background-color: #e9ecef; color: #495057; border: 1px solid #dee2e6; padding: 10px 20px; border-radius: 8px; font-weight: bold; font-size: 1em; text-decoration: none; }
        .container { background-color: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); width: 100%; max-width: 900px; margin-bottom: 30px; }
        h1, h2 { text-align: center; color: #333; margin-top: 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; vertical-align: middle; }
        th { background-color: #f2f2f2; }
        .log-details { font-size: 0.8em; color: #666; white-space: pre-wrap; word-break: break-all; background-color: #f9f9f9; padding: 5px; border-radius: 4px; }
        .filtros-logs { display: flex; align-items: flex-end; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .form-item { display: flex; flex-direction: column; }
        .form-item label { margin-bottom: 5px; font-weight: bold; color: #555; }
        .form-item input { padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 1em; }
        .filtros-logs button { width: auto; padding: 10px 20px; font-size: 1em; background-color: #1976d2; color: white; border: none; border-radius: 6px; cursor: pointer; }
    </style>
</head>
<body>
    <nav class="nav-voltar">
        <a href="/dashboard.html" class="btn-voltar">⬅ Voltar para o Dashboard</a>
    </nav>

    <div id="main-content" style="display: none;">
        
        <div class="container">
            <h2>Gestão Atual</h2>
            <p style="text-align: center; margin-top: -10px; margin-bottom: 20px;">Lista de voluntários com cargos administrativos. A promoção/revogação agora é feita em "Gerenciar Voluntários".</p>
            <table style="width: 100%;">
                <thead><tr><th>Nome</th><th>Email</th><th>Cargo</th></tr></thead>
                <tbody id="tabela-diretoria"></tbody>
            </table>
        </div>
        <div class="container">
            <h2>Log de Auditoria do Sistema</h2>
            <div class="filtros-logs">
                <div class="form-item"><label for="log-data-inicio">De:</label><input type="date" id="log-data-inicio"></div>
                <div class="form-item"><label for="log-data-fim">Até:</label><input type="date" id="log-data-fim"></div>
                <button id="btn-filtrar-logs">Filtrar Logs</button>
            </div>
            <table>
                <thead><tr><th>Data/Hora</th><th>Autor</th><th>Ação</th><th>Detalhes</th></tr></thead>
                <tbody id="tabela-logs"></tbody>
            </table>
        </div>
    </div>
    
    <div id="acesso-negado" style="display: none;">
        <div class="container" style="text-align: center;">
            <h1>Acesso Negado</h1>
            <p>Você não tem permissão para visualizar esta página.</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp, getApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot, getDocs, Timestamp, orderBy, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { protegerPagina } from '/auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU",
            authDomain: "voluntarios-ativos---cepat.firebaseapp.com",
            projectId: "voluntarios-ativos---cepat",
            storageBucket: "voluntarios-ativos---cepat.firebasestorage.app",
            messagingSenderId: "66122858261",
            appId: "1:66122858261:web:7fa21f1805463b5c08331c"
        };
        initializeApp(firebaseConfig);

        protegerPagina(['super-admin', 'diretor', 'tesoureiro', 'conselheiro'])
            .then(user => {
                document.getElementById('main-content').style.display = 'block';
                inicializarPagina(user);
            })
            .catch(error => {
                console.log(error.message);
                document.getElementById('acesso-negado').style.display = 'block';
            });

        function inicializarPagina(user) {
            const app = getApp();
            const db = getFirestore(app);
            
            const tabelaDiretoria = document.getElementById('tabela-diretoria');
            const tabelaLogs = document.getElementById('tabela-logs');
            const btnFiltrarLogs = document.getElementById('btn-filtrar-logs');

            const mapaNomesCargos = {
                'super-admin': 'Super Administrador',
                'diretor': 'Diretor(a)',
                'tesoureiro': 'Tesoureiro(a)',
                'conselheiro': 'Conselheiro(a)',
                'produtor-evento': 'Produtor(a) de Evento',
                'irradiador': 'Irradiador(a)',
                'bibliotecario': 'Bibliotecário(a)',
                'recepcionista': 'Recepcionista (AE)',
                'entrevistador': 'Entrevistador(a) (AE)',
                'dirigente-escola': 'Dirigente de Escola',
                'secretario-escola': 'Secretário(a) de Escola',
                'voluntario': 'Voluntário(a)'
            };

            carregarDiretoria();
            setupLogFilters();

            // ### AJUSTE: Função 'carregarDiretoria' modificada para 2 consultas ###
            async function carregarDiretoria() {
                tabelaDiretoria.innerHTML = `<tr><td colspan="3">Carregando gestão...</td></tr>`;

                // Lista de 11 cargos dividida em duas
                const cargosGestao_Parte1 = [
                    "diretor", "super-admin", "tesoureiro", "conselheiro", 
                    "bibliotecario", "produtor-evento" // 6 itens
                ];
                const cargosGestao_Parte2 = [
                    "irradiador", "recepcionista", "entrevistador",
                    "dirigente-escola", "secretario-escola" // 5 itens
                ];
                
                const colRef = collection(db, "voluntarios");
                
                // Cria as duas consultas
                const q1 = query(colRef, where("role", "in", cargosGestao_Parte1));
                const q2 = query(colRef, where("role", "in", cargosGestao_Parte2));

                try {
                    // Executa as duas consultas em paralelo
                    const [snapshot1, snapshot2] = await Promise.all([
                        getDocs(q1),
                        getDocs(q2)
                    ]);

                    // Junta os resultados das duas consultas
                    const todosOsDocumentos = [...snapshot1.docs, ...snapshot2.docs];

                    tabelaDiretoria.innerHTML = '';
                    if (todosOsDocumentos.length === 0) {
                        tabelaDiretoria.innerHTML = '<tr><td colspan="3">Nenhum membro da gestão encontrado.</td></tr>';
                        return;
                    }
                    
                    // Ordena os resultados combinados pelo nome (no lado do cliente)
                    todosOsDocumentos.sort((a,b) => a.data().nome.localeCompare(b.data().nome)).forEach(doc => {
                        const v = doc.data();
                        const tr = document.createElement('tr');
                        const nomeCargo = mapaNomesCargos[v.role] || v.role;

                        tr.innerHTML = `
                            <td>${v.nome}</td>
                            <td>${v.email || 'N/A'}</td>
                            <td>${nomeCargo}</td>
                        `;
                        tabelaDiretoria.appendChild(tr);
                    });
                } catch (error) {
                    console.error("Erro ao carregar diretoria:", error);
                    tabelaDiretoria.innerHTML = '<tr><td colspan="3" style="color: red;">Erro ao carregar dados.</td></tr>';
                    // Se o erro for de índice, o Firestore geralmente sugere o link no console
                    if (error.code === 'failed-precondition') {
                         console.error("ERRO: O Firestore está exigindo um índice. Por favor, crie o índice que ele sugere no link de erro no console.");
                    }
                }
            }
            // ### FIM DO AJUSTE ###

            // Funções de Log (sem alterações)
            function setupLogFilters() {
                 const hoje = new Date();
                document.getElementById('log-data-fim').value = hoje.toISOString().split('T')[0];
                document.getElementById('log-data-inicio').value = hoje.toISOString().split('T')[0];
                btnFiltrarLogs.addEventListener('click', carregarLogsDeAuditoria);
                carregarLogsDeAuditoria();
            }

            async function carregarLogsDeAuditoria() {
                tabelaLogs.innerHTML = `<tr><td colspan="4">Carregando logs...</td></tr>`;
                const dataInicioInput = document.getElementById('log-data-inicio').value;
                const dataFimInput = document.getElementById('log-data-fim').value;

                if (!dataInicioInput || !dataFimInput) {
                    tabelaLogs.innerHTML = `<tr><td colspan="4">Por favor, selecione as datas de início e fim.</td></tr>`;
                    return;
                }
                
                const dataInicio = new Date(dataInicioInput + 'T00:00:00');
                const dataFim = new Date(dataFimInput + 'T23:59:59');
                
                const q = query(collection(db, "log_auditoria"), where("timestamp", ">=", Timestamp.fromDate(dataInicio)), where("timestamp", "<=", Timestamp.fromDate(dataFim)), orderBy("timestamp", "desc"));
                try {
                    const snapshot = await getDocs(q);
                    tabelaLogs.innerHTML = "";
                    if (snapshot.empty) { tabelaLogs.innerHTML = `<tr><td colspan="4">Nenhum registro para este período.</td></tr>`; return; }
                    snapshot.forEach(doc => {
                        const log = doc.data();
                        const data = log.timestamp ? log.timestamp.toDate().toLocaleString('pt-BR') : 'N/A';
                        const autor = log.autor ? log.autor.nome : 'Desconhecido';
                        const acao = log.acao || 'N/A';
                        const detalhes = log.detalhes ? JSON.stringify(log.detalhes, null, 2) : '{}';
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${data}</td><td>${autor}</td><td>${acao}</td><td><pre class="log-details">${detalhes}</pre></td>`;
                        tabelaLogs.appendChild(tr);
                    });
                } catch (error) { console.error("Erro ao buscar logs:", error); tabelaLogs.innerHTML = `<tr><td colspan="4" style="color: red;">Erro ao carregar.</td></tr>`; }
            }
        }
    </script>
</body>
</html>