<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imprimir TASV - CEPAT</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f4f6f9; margin: 0; padding: 20px; }
        .no-print { max-width: 900px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .controls { display: flex; justify-content: space-between; align-items: center; margin: 20px 0; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; border-bottom: 1px solid #ddd; text-align: left; }
        th { background-color: #f8f9fa; color: #555; }
        .btn-print { background-color: #2e7d32; color: white; border: none; padding: 12px 25px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1em; }
        .btn-print:disabled { background-color: #ccc; }
        #acesso-negado { display: none; text-align: center; padding: 50px; }
        
        /* CORREÇÃO PARA A IMPRESSÃO DA LISTA */
        @media print {
            .no-print { display: none !important; } /* O !important é essencial aqui */
            body { background: white; padding: 0; }
            .print-page { 
                display: block !important; 
                page-break-after: always; 
                padding: 1.5cm;
                color: black;
                background: white;
            }
        }

        .print-page { display: none; font-size: 11pt; line-height: 1.5; }
        .header-termo { text-align: center; margin-bottom: 25px; border-bottom: 1px solid #000; padding-bottom: 15px; }
        .header-termo h2 { margin: 5px 0; font-size: 14pt; }
        .secao-titulo { font-weight: bold; margin-top: 15px; text-decoration: underline; display: block; }
        .log-certificacao { margin-top: 30px; padding: 15px; border: 1px solid #000; background-color: #f9f9f9; font-family: "Courier New", Courier, monospace; font-size: 9pt; }
        .assinatura-area { margin-top: 40px; text-align: center; }
        .linha-assinatura { border-top: 1px solid #000; width: 300px; margin: 0 auto; padding-top: 5px; }
    </style>
</head>
<body>

    <div id="acesso-negado">
        <h1>Acesso Negado</h1>
        <p>Você não tem permissão para acessar esta ferramenta de impressão.</p>
        <a href="dashboard.html">Voltar ao Painel</a>
    </div>

    <div class="no-print" id="conteudo-pagina" style="display: none;">
        <a href="secretaria.html" style="text-decoration: none; color: #1976d2; font-weight: bold;">⬅ Voltar para Secretaria</a>
        <h1 style="margin-top: 15px;">Impressão de Termos de Voluntariado</h1>
        
        <div class="controls">
            <label style="font-weight: bold; cursor: pointer;"><input type="checkbox" id="select-all"> Selecionar Todos</label>
            <button class="btn-print" id="btn-preparar">
                <i class="fas fa-print"></i> Gerar e Imprimir Selecionados
            </button>
        </div>

        <table>
            <thead>
                <tr>
                    <th width="40">Sel.</th>
                    <th>Nome do Voluntário</th>
                    <th>Data da Assinatura</th>
                    <th>Ano Ref.</th>
                </tr>
            </thead>
            <tbody id="tabela-corpo">
                <tr><td colspan="4">Carregando voluntários...</td></tr>
            </tbody>
        </table>
    </div>

    <div id="container-impressao"></div>

    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, doc, getDoc, orderBy } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { protegerPagina } from '/auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBV7RPjk3cFTqL-aIpflJcUojKg1ZXMLuU",
            authDomain: "voluntarios-ativos---cepat.firebaseapp.com",
            projectId: "voluntarios-ativos---cepat",
            storageBucket: "voluntarios-ativos---cepat.firebasestorage.app",
            appId: "1:66122858261:web:7fa21f1805463b5c08331c"
        };

        // Resolve o erro de Duplicate App
        const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApp();
        const db = getFirestore(app);
        const auth = getAuth(app);
        const anoVigente = 2026;

        protegerPagina(['super-admin', 'diretor', 'tesoureiro'])
            .then(() => {
                document.getElementById('conteudo-pagina').style.display = 'block';
                carregarLista();
            })
            .catch(() => {
                document.getElementById('acesso-negado').style.display = 'block';
            });

    async function carregarLista() {
        const corpo = document.getElementById('tabela-corpo');
        try {
            const q = query(
                collection(db, "voluntarios"), 
                where("tasvAssinadoAno", "==", anoVigente), 
                orderBy("nome")
            );
            const snap = await getDocs(q);
            corpo.innerHTML = '';

            if (snap.empty) {
                corpo.innerHTML = '<tr><td colspan="4">Nenhum termo assinado em '+anoVigente+'.</td></tr>';
                return;
            }

            snap.forEach(d => {
                const v = d.data();
                const dataFormat = v.tasvDataAssinatura ? v.tasvDataAssinatura.toDate().toLocaleString('pt-BR') : 'Sem data';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox" class="vol-check" data-id="${d.id}"></td>
                    <td>${v.nome}</td>
                    <td>${dataFormat}</td>
                    <td>${v.tasvAssinadoAno}</td>
                `;
                corpo.appendChild(tr);
            });
        } catch (e) {
            console.error("Erro ao carregar lista:", e);
            corpo.innerHTML = '<tr><td colspan="4" style="color:red">Erro de permissão ao acessar lista.</td></tr>';
        }
    }

    async function obterHtmlTermo(volId) {
        const volSnap = await getDoc(doc(db, "voluntarios", volId));
        const vol = volSnap.data();

        const logQ = query(
            collection(db, "log_auditoria"), 
            where("acao", "==", "ASSINATURA_DIGITAL_TASV"),
            where("autor.id_voluntario", "==", volId),
            where("detalhes.ano_referencia", "==", anoVigente)
        );
        
        const logSnap = await getDocs(logQ);
        let log = { timestamp: { toDate: () => new Date() }, detalhes: { navegador: "N/A" } };
        if (!logSnap.empty) log = logSnap.docs[0].data();

        const dataHoje = new Date().toLocaleDateString('pt-BR', { day: 'numeric', month: 'long', year: 'numeric' });

        return `
            <div class="print-page">
                <div class="header-termo">
                    <h2>CASA ESPÍRITA PAULO DE TARSO</h2>
                    <p>CNPJ 12.253.749/0001-20 | Rua do Cromo 989, Vila Pântano - Santa Bárbara D'Oeste - 13457-151</p>
                    <h3>TERMO DE ADESÃO AO SERVIÇO VOLUNTÁRIO - ${anoVigente}</h3>
                </div>

                <p>Pelo presente instrumento, a entidade e o(a) voluntário(a) 
                <strong>${vol.nome.toUpperCase()}</strong>, residente em <strong>${vol.endereco || 'Não informado'}</strong>, 
                celebram este termo sob a <strong>Lei nº 9.608/1998</strong>.</p>

                <span class="secao-titulo">CLÁUSULA PRIMEIRA - DO OBJETO</span>
                <p>O serviço voluntário é prestado de forma gratuita e não gera vínculo empregatício nem obrigações trabalhistas ou previdenciárias.</p>

                <span class="secao-titulo">CLÁUSULA SEGUNDA - PRIVACIDADE</span>
                <p>O voluntário autoriza o tratamento de seus dados para fins de gestão interna, conforme a LGPD.</p>

                <div class="log-certificacao">
                    <strong>EVIDÊNCIA TÉCNICA DE ASSINATURA DIGITAL</strong><br>
                    DATA DO ACEITE: ${log.timestamp.toDate().toLocaleString('pt-BR')}<br>
                    ID VOLUNTÁRIO: ${volId}<br>
                    BROWSER: ${log.detalhes.navegador}<br>
                    AUTENTICAÇÃO: Firebase Auth (UID: ${vol.authUid})
                </div>

                <p style="margin-top: 40px;">Santa Bárbara D'Oeste, SP, ${dataHoje}.</p>

                <div class="assinatura-area">
                    <div class="linha-assinatura"></div>
                    <small><strong>${vol.nome}</strong><br>Assinado Eletronicamente (Lei 14.063/2020)</small>
                </div>
            </div>
        `;
    }

    document.getElementById('btn-preparar').addEventListener('click', async () => {
        const checks = document.querySelectorAll('.vol-check:checked');
        if (checks.length === 0) return alert("Selecione os voluntários na lista.");

        const btn = document.getElementById('btn-preparar');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando...';

        const container = document.getElementById('container-impressao');
        container.innerHTML = '';

        try {
            for (const c of checks) {
                const html = await obterHtmlTermo(c.dataset.id);
                container.innerHTML += html;
            }
            window.print();
        } catch (error) {
            console.error("Erro na geração:", error);
            alert("Erro de permissão ao gerar documentos. Verifique as regras do Firestore.");
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-print"></i> Gerar e Imprimir Selecionados';
        }
    });

    document.getElementById('select-all').addEventListener('change', (e) => {
        document.querySelectorAll('.vol-check').forEach(c => c.checked = e.target.checked);
    });
</script>
</body>
</html>